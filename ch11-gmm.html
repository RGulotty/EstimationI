<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>11. GMM – Estimation I: Computational Companion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3bbbbd466991e281563892c5dce73c3d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
  MathJax = {
    tex: {
      macros: {
        E: "\\mathbb{E}",
        Var: "\\text{Var}",
        Cov: "\\text{Cov}",
        plim: "\\text{plim}",
        inprob: "\\xrightarrow{p}",
        indist: "\\xrightarrow{d}",
        bhat: "\\hat{\\boldsymbol{\\beta}}",
        N: "\\mathcal{N}",
        tr: "\\text{tr}",
        rank: "\\text{rank}",
        SE: "\\text{SE}",
        diag: "\\text{diag}"
      }
    }
  };
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Estimation I: Computational Companion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./ch01-review.html">
 <span class="dropdown-text">1. Probability and Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch02-cef-blp.html">
 <span class="dropdown-text">2. The CEF and Best Linear Predictor</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch03-ols.html">
 <span class="dropdown-text">3. Multivariate OLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch04-sensitivity.html">
 <span class="dropdown-text">4. Sensitivity and Leverage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch05-gls.html">
 <span class="dropdown-text">5. Efficiency and GLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch06-small-sample.html">
 <span class="dropdown-text">6. Small Sample Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch07-probit.html">
 <span class="dropdown-text">7. Probit and MLE</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch08-asymptotics.html">
 <span class="dropdown-text">8. Asymptotics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch09-testing.html">
 <span class="dropdown-text">9. Hypothesis Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch10-iv.html">
 <span class="dropdown-text">10. Instrumental Variables and 2SLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch11-gmm.html">
 <span class="dropdown-text">11. GMM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch12-panel.html">
 <span class="dropdown-text">12. Panel Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch13-fixed-effects.html">
 <span class="dropdown-text">13. Fixed Effects and Modern DiD</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/UChicago-pol-methods/EstimationI"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#everything-is-a-moment-condition" id="toc-everything-is-a-moment-condition" class="nav-link active" data-scroll-target="#everything-is-a-moment-condition"><span class="header-section-number">1</span> Everything is a moment condition</a></li>
  <li><a href="#the-overidentification-problem" id="toc-the-overidentification-problem" class="nav-link" data-scroll-target="#the-overidentification-problem"><span class="header-section-number">2</span> The overidentification problem</a>
  <ul class="collapse">
  <li><a href="#the-gmm-criterion-function" id="toc-the-gmm-criterion-function" class="nav-link" data-scroll-target="#the-gmm-criterion-function"><span class="header-section-number">2.1</span> The GMM criterion function</a></li>
  </ul></li>
  <li><a href="#sec-efficient-gmm" id="toc-sec-efficient-gmm" class="nav-link" data-scroll-target="#sec-efficient-gmm"><span class="header-section-number">3</span> Efficient GMM by hand</a></li>
  <li><a href="#using-the-gmm-package" id="toc-using-the-gmm-package" class="nav-link" data-scroll-target="#using-the-gmm-package"><span class="header-section-number">4</span> Using the gmm package</a></li>
  <li><a href="#when-does-efficient-gmm-help-a-simulation" id="toc-when-does-efficient-gmm-help-a-simulation" class="nav-link" data-scroll-target="#when-does-efficient-gmm-help-a-simulation"><span class="header-section-number">5</span> When does efficient GMM help? A simulation</a></li>
  <li><a href="#sec-j-test" id="toc-sec-j-test" class="nav-link" data-scroll-target="#sec-j-test"><span class="header-section-number">6</span> The J-test for overidentification</a>
  <ul class="collapse">
  <li><a href="#when-the-j-test-rejects" id="toc-when-the-j-test-rejects" class="nav-link" data-scroll-target="#when-the-j-test-rejects"><span class="header-section-number">6.1</span> When the J-test rejects</a></li>
  <li><a href="#j-test-rejection-rates-by-simulation" id="toc-j-test-rejection-rates-by-simulation" class="nav-link" data-scroll-target="#j-test-rejection-rates-by-simulation"><span class="header-section-number">6.2</span> J-test rejection rates by simulation</a></li>
  </ul></li>
  <li><a href="#nonlinear-gmm-custom-moment-functions" id="toc-nonlinear-gmm-custom-moment-functions" class="nav-link" data-scroll-target="#nonlinear-gmm-custom-moment-functions"><span class="header-section-number">7</span> Nonlinear GMM: custom moment functions</a></li>
  <li><a href="#application-missing-data-and-gmm" id="toc-application-missing-data-and-gmm" class="nav-link" data-scroll-target="#application-missing-data-and-gmm"><span class="header-section-number">8</span> Application: missing data and GMM</a>
  <ul class="collapse">
  <li><a href="#the-setup" id="toc-the-setup" class="nav-link" data-scroll-target="#the-setup"><span class="header-section-number">8.1</span> The setup</a></li>
  <li><a href="#simulating-the-wls-like-data" id="toc-simulating-the-wls-like-data" class="nav-link" data-scroll-target="#simulating-the-wls-like-data"><span class="header-section-number">8.2</span> Simulating the WLS-like data</a></li>
  <li><a href="#complete-case-and-dummy-variable-approaches" id="toc-complete-case-and-dummy-variable-approaches" class="nav-link" data-scroll-target="#complete-case-and-dummy-variable-approaches"><span class="header-section-number">8.3</span> Complete case and dummy variable approaches</a></li>
  <li><a href="#gmm-with-three-blocks-of-moment-conditions" id="toc-gmm-with-three-blocks-of-moment-conditions" class="nav-link" data-scroll-target="#gmm-with-three-blocks-of-moment-conditions"><span class="header-section-number">8.4</span> GMM with three blocks of moment conditions</a></li>
  <li><a href="#starting-values-and-estimation" id="toc-starting-values-and-estimation" class="nav-link" data-scroll-target="#starting-values-and-estimation"><span class="header-section-number">8.5</span> Starting values and estimation</a></li>
  <li><a href="#comparing-all-methods" id="toc-comparing-all-methods" class="nav-link" data-scroll-target="#comparing-all-methods"><span class="header-section-number">8.6</span> Comparing all methods</a></li>
  <li><a href="#j-test-for-the-missing-data-model" id="toc-j-test-for-the-missing-data-model" class="nav-link" data-scroll-target="#j-test-for-the-missing-data-model"><span class="header-section-number">8.7</span> J-test for the missing data model</a></li>
  <li><a href="#monte-carlo-comparing-estimator-properties" id="toc-monte-carlo-comparing-estimator-properties" class="nav-link" data-scroll-target="#monte-carlo-comparing-estimator-properties"><span class="header-section-number">8.8</span> Monte Carlo: comparing estimator properties</a></li>
  </ul></li>
  <li><a href="#gmm-as-a-unifying-framework" id="toc-gmm-as-a-unifying-framework" class="nav-link" data-scroll-target="#gmm-as-a-unifying-framework"><span class="header-section-number">9</span> GMM as a unifying framework</a>
  <ul class="collapse">
  <li><a href="#recovering-ols-as-gmm" id="toc-recovering-ols-as-gmm" class="nav-link" data-scroll-target="#recovering-ols-as-gmm"><span class="header-section-number">9.1</span> Recovering OLS as GMM</a></li>
  </ul></li>
  <li><a href="#connection-to-mte" id="toc-connection-to-mte" class="nav-link" data-scroll-target="#connection-to-mte"><span class="header-section-number">10</span> Connection to MTE</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">11</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">11. GMM</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Generalized method of moments</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This chapter demonstrates the Generalized Method of Moments (GMM) framework computationally. We show that OLS, IV, and 2SLS are all special cases, then build up to efficient GMM estimation, the J-test, and a missing data application. The key reference is Hansen, Chapter 13.</p>
<p><strong>Questions this chapter answers:</strong></p>
<ol type="1">
<li>How does GMM unify OLS, IV, and 2SLS under a single framework of moment conditions?</li>
<li>What is the optimal weighting matrix, and how does efficient GMM achieve the semiparametric variance bound?</li>
<li>How does the J-test detect misspecification in overidentified models?</li>
<li>How can nonlinear GMM handle problems like missing data?</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gmm)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="everything-is-a-moment-condition" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="everything-is-a-moment-condition"><span class="header-section-number">1</span> Everything is a moment condition</h2>
<p>Every estimator we have studied solves a set of moment conditions <span class="math inline">\(\mathbb{E}[g_i(\beta)] = 0\)</span>. The sample analog sets <span class="math inline">\(\bar{g}_n(\hat\beta) = \frac{1}{n}\sum g_i(\hat\beta) = 0\)</span>.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Estimator</th>
<th>Moment condition</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OLS</td>
<td><span class="math inline">\(\mathbb{E}[X_i(Y_i - X_i'\beta)] = 0\)</span></td>
<td>the <a href="./ch03-ols.html#eq-ols">OLS estimator</a></td>
</tr>
<tr class="even">
<td>IV</td>
<td><span class="math inline">\(\mathbb{E}[Z_i(Y_i - X_i'\beta)] = 0\)</span></td>
<td><span class="math inline">\((Z'X)^{-1}Z'Y\)</span></td>
</tr>
<tr class="odd">
<td>2SLS</td>
<td>Same as IV, with <span class="math inline">\(W = (Z'Z)^{-1}\)</span></td>
<td><span class="math inline">\((X'P_Z X)^{-1}X'P_Z Y\)</span></td>
</tr>
</tbody>
</table>
<div id="def-gmm" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 1 (GMM Estimator (Hansen 13.1))</strong></span> The GMM estimator minimizes <span class="math inline">\(J(\beta) = n\,\bar{g}_n(\beta)' W\, \bar{g}_n(\beta)\)</span>, where <span class="math inline">\(\bar{g}_n(\beta) = \frac{1}{n}\sum g_i(\beta)\)</span> and <span class="math inline">\(W\)</span> is a positive definite weight matrix. Different choices of <span class="math inline">\(W\)</span> yield different estimators; the optimal <span class="math inline">\(W = \Omega^{-1}\)</span> minimizes asymptotic variance.</p>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>GMM Unifies Everything
</div>
</div>
<div class="callout-body-container callout-body">
<p>Every estimator in this course — OLS, GLS, IV, 2SLS, probit MLE — is a GMM estimator with specific moment conditions and weight matrices. The GMM framework provides a single set of tools for estimation, inference, and specification testing.</p>
</div>
</div>
<p>Let’s verify this computationally. We simulate an IV model with one endogenous regressor and one instrument:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># DGP: Y = 1 + 0.5*X + e, where X is endogenous</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fl">0.8</span> <span class="sc">*</span> Z <span class="sc">+</span> u          <span class="co"># X correlated with u</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fu">rnorm</span>(n)   <span class="co"># e correlated with u through shared u</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> X <span class="sc">+</span> e</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>OLS is biased because <span class="math inline">\(\text{Cov}(X, e) \neq 0\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS: E[X(Y - Xb)] = 0</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>beta_ols <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, X)) <span class="sc">%*%</span> <span class="fu">cbind</span>(<span class="dv">1</span>, X)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, X)) <span class="sc">%*%</span> Y</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"OLS slope:"</span>, <span class="fu">round</span>(beta_ols[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">" (biased, true = 0.5)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>OLS slope: 0.8725  (biased, true = 0.5)</code></pre>
</div>
</div>
<p>IV uses the instrument <span class="math inline">\(Z\)</span> to form moment conditions <span class="math inline">\(\mathbb{E}[Z(Y - X\beta)] = 0\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IV: E[Z(Y - Xb)] = 0, just-identified (ell = k)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, X)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>Zmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, Z)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>beta_iv <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(Zmat) <span class="sc">%*%</span> Xmat) <span class="sc">%*%</span> <span class="fu">t</span>(Zmat) <span class="sc">%*%</span> Y</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IV slope:"</span>, <span class="fu">round</span>(beta_iv[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">" (consistent)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>IV slope: 0.4949  (consistent)</code></pre>
</div>
</div>
<p>When the number of moment conditions <span class="math inline">\(\ell\)</span> equals the number of parameters <span class="math inline">\(k\)</span>, we can solve exactly. But what happens when <span class="math inline">\(\ell &gt; k\)</span>?</p>
</section>
<section id="the-overidentification-problem" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="the-overidentification-problem"><span class="header-section-number">2</span> The overidentification problem</h2>
<p>With more instruments than parameters, no <span class="math inline">\(\beta\)</span> can simultaneously zero out all moment conditions. We need a principled way to get as close as possible.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now add a second instrument</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>Z2 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> X <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="dv">2</span>)  <span class="co"># second instrument (weaker)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>Zmat2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, Z, Z2)           <span class="co"># 3 instruments, 2 parameters</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Can't solve Z'(Y - Xb) = 0 exactly (3 equations, 2 unknowns)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check: the IV formula with the full Z matrix is not square</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Z'X dimensions:"</span>, <span class="fu">nrow</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Xmat), <span class="st">"x"</span>, <span class="fu">ncol</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Xmat), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Z'X dimensions: 3 x 2 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(not square -- can't invert directly)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>(not square -- can't invert directly)</code></pre>
</div>
</div>
<section id="the-gmm-criterion-function" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="the-gmm-criterion-function"><span class="header-section-number">2.1</span> The GMM criterion function</h3>
<p>For a positive definite weight matrix <span class="math inline">\(W\)</span>, the GMM criterion is:</p>
<p><span id="eq-gmm-criterion"><span class="math display">\[J(\beta) = n\,\bar{g}_n(\beta)' W\, \bar{g}_n(\beta) \tag{1}\]</span></span></p>
<p>The GMM estimator minimizes this weighted quadratic form.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GMM criterion function for the linear IV model</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>gmm_criterion <span class="ot">&lt;-</span> <span class="cf">function</span>(beta, Y, X, Z, W) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  g_bar <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Z <span class="sc">*</span> <span class="fu">as.numeric</span>(Y <span class="sc">-</span> X <span class="sc">%*%</span> beta))  <span class="co"># sample moments</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  n <span class="sc">*</span> <span class="fu">t</span>(g_bar) <span class="sc">%*%</span> W <span class="sc">%*%</span> g_bar</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Closed-form GMM estimator: (X'Z W Z'X)^{-1} (X'Z W Z'Y)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>gmm_linear <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, X, Z, W) {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  XZ <span class="ot">&lt;-</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> Z</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(XZ <span class="sc">%*%</span> W <span class="sc">%*%</span> <span class="fu">t</span>(XZ)) <span class="sc">%*%</span> XZ <span class="sc">%*%</span> W <span class="sc">%*%</span> <span class="fu">t</span>(Z) <span class="sc">%*%</span> Y</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Different weight matrices yield different estimators:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identity matrix</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>W_ident <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">3</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>beta_gmm_ident <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_ident)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (Z'Z)^{-1} -- this gives 2SLS</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>W_2sls <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Zmat2)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>beta_gmm_2sls <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_2sls)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify 2SLS matches</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>PZ <span class="ot">&lt;-</span> Zmat2 <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Zmat2) <span class="sc">%*%</span> <span class="fu">t</span>(Zmat2)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>beta_2sls <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(Xmat) <span class="sc">%*%</span> PZ <span class="sc">%*%</span> Xmat) <span class="sc">%*%</span> <span class="fu">t</span>(Xmat) <span class="sc">%*%</span> PZ <span class="sc">%*%</span> Y</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM (W = I):     slope ="</span>, <span class="fu">round</span>(beta_gmm_ident[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>GMM (W = I):     slope = 0.6327 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM (W = 2SLS):  slope ="</span>, <span class="fu">round</span>(beta_gmm_2sls[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>GMM (W = 2SLS):  slope = 0.5307 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2SLS directly:   slope ="</span>, <span class="fu">round</span>(beta_2sls[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>2SLS directly:   slope = 0.5307 </code></pre>
</div>
</div>
<div id="thm-gmm-2sls" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (2SLS as GMM (Hansen 13.2))</strong></span> When <span class="math inline">\(W = (Z'Z/n)^{-1}\)</span>, the GMM estimator for the linear IV model reduces to 2SLS: <span class="math inline">\(\hat\beta_{2SLS} = (X'P_Z X)^{-1}X'P_Z Y\)</span>. Under homoskedasticity, 2SLS is efficient among all GMM estimators.</p>
</div>
<p>The choice of <span class="math inline">\(W\)</span> matters when the model is overidentified—but the optimal choice is <span class="math inline">\(W = \Omega^{-1}\)</span>, where <span class="math inline">\(\Omega = \mathbb{E}[Z_i Z_i' e_i^2]\)</span> is the variance of the moment conditions.</p>
</section>
</section>
<section id="sec-efficient-gmm" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-efficient-gmm"><span class="header-section-number">3</span> Efficient GMM by hand</h2>
<p>The optimal weight matrix <span class="math inline">\(W = \Omega^{-1}\)</span> minimizes the asymptotic variance of the GMM estimator. The two-step procedure is:</p>
<div id="thm-efficient-gmm" class="theorem">
<p><span class="theorem-title"><strong>Theorem 2 (Efficient GMM (Hansen 13.4-13.5))</strong></span> The efficient GMM estimator uses <span class="math inline">\(W = \hat\Omega^{-1}\)</span>, where <span class="math inline">\(\hat\Omega = \frac{1}{n}\sum g_i(\tilde\beta)g_i(\tilde\beta)'\)</span> and <span class="math inline">\(\tilde\beta\)</span> is a preliminary consistent estimator. This achieves the semiparametric efficiency bound among all estimators using the same moment conditions.</p>
</div>
<ol type="1">
<li>Estimate <span class="math inline">\(\beta\)</span> by 2SLS (using <span class="math inline">\(W = (Z'Z)^{-1}\)</span>). Compute residuals <span class="math inline">\(\tilde{e}_i\)</span>.</li>
<li>Estimate <span class="math inline">\(\hat\Omega = \frac{1}{n}\sum Z_i Z_i' \tilde{e}_i^2\)</span>, set <span class="math inline">\(\hat{W} = \hat\Omega^{-1}\)</span>, and re-estimate.</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: 2SLS</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>beta_step1 <span class="ot">&lt;-</span> beta_2sls</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>e_step1 <span class="ot">&lt;-</span> Y <span class="sc">-</span> Xmat <span class="sc">%*%</span> beta_step1</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Estimate optimal weight matrix</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>Omega_hat <span class="ot">&lt;-</span> (<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">as.numeric</span>(e_step1<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%*%</span> Zmat2) <span class="sc">/</span> n</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>W_opt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Omega_hat)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-estimate with optimal W</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>beta_step2 <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_opt)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Step 1 (2SLS) slope:     "</span>, <span class="fu">round</span>(beta_step1[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Step 1 (2SLS) slope:      0.5307 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Step 2 (efficient) slope:"</span>, <span class="fu">round</span>(beta_step2[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Step 2 (efficient) slope: 0.529 </code></pre>
</div>
</div>
<p>We can iterate—updating <span class="math inline">\(\hat\Omega\)</span> and re-estimating—until convergence:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterated GMM</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>beta_iter <span class="ot">&lt;-</span> beta_2sls</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  e_s <span class="ot">&lt;-</span> Y <span class="sc">-</span> Xmat <span class="sc">%*%</span> beta_iter</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  Omega_s <span class="ot">&lt;-</span> (<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">as.numeric</span>(e_s<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%*%</span> Zmat2) <span class="sc">/</span> n</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  W_s <span class="ot">&lt;-</span> <span class="fu">solve</span>(Omega_s)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  beta_new <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_s)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(beta_new <span class="sc">-</span> beta_iter)) <span class="sc">&lt;</span> <span class="fl">1e-8</span>) {</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Converged in"</span>, s, <span class="st">"iterations</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  beta_iter <span class="ot">&lt;-</span> beta_new</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Converged in 5 iterations</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Iterated GMM slope:"</span>, <span class="fu">round</span>(beta_iter[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Iterated GMM slope: 0.529 </code></pre>
</div>
</div>
</section>
<section id="using-the-gmm-package" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="using-the-gmm-package"><span class="header-section-number">4</span> Using the gmm package</h2>
<p>The <code>gmm</code> package handles moment function specification, weighting, and inference. For a linear IV model, we can pass the formula directly:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear IV via gmm()</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Formula: Y ~ X | Z  (endogenous ~ instruments)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Y =</span> Y, <span class="at">X =</span> X, <span class="at">Z1 =</span> Z, <span class="at">Z2 =</span> Z2)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Two-step GMM</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>fit_2step <span class="ot">&lt;-</span> <span class="fu">gmm</span>(Y <span class="sc">~</span> X, <span class="sc">~</span> Z1 <span class="sc">+</span> Z2, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"twoStep"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_2step)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
gmm(g = Y ~ X, x = ~Z1 + Z2, type = "twoStep", data = dat)


Method:  twoStep 

Kernel:  Quadratic Spectral(with bw =  0.57799 )

Coefficients:
             Estimate    Std. Error  t value     Pr(&gt;|t|)  
(Intercept)  9.4738e-01  4.6839e-02  2.0226e+01  5.7701e-91
X            5.3688e-01  5.7361e-02  9.3595e+00  8.0104e-21

J-Test: degrees of freedom is 1 
                J-test    P-value 
Test E(g)=0:    4.620103  0.031599

Initial values of the coefficients
(Intercept)           X 
  0.9419577   0.5306796 </code></pre>
</div>
</div>
<p>Compare to the iterative version:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fit_iter <span class="ot">&lt;-</span> <span class="fu">gmm</span>(Y <span class="sc">~</span> X, <span class="sc">~</span> Z1 <span class="sc">+</span> Z2, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"iterative"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Two-step slope:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_2step)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Two-step slope: 0.5369 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Iterated slope:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_iter)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Iterated slope: 0.5369 </code></pre>
</div>
</div>
<p>And verify against <code>iv_robust</code> (which computes 2SLS):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fit_iv <span class="ot">&lt;-</span> <span class="fu">iv_robust</span>(Y <span class="sc">~</span> X <span class="sc">|</span> Z1 <span class="sc">+</span> Z2, <span class="at">data =</span> dat)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2SLS (iv_robust):"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_iv)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>2SLS (iv_robust): 0.5307 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Two-step GMM:    "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_2step)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Two-step GMM:     0.5369 </code></pre>
</div>
</div>
<p>Under homoskedasticity, 2SLS and efficient GMM give the same estimates (Hansen Thm 13.6). The differences here arise because we simulated heteroskedastic-style errors.</p>
</section>
<section id="when-does-efficient-gmm-help-a-simulation" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="when-does-efficient-gmm-help-a-simulation"><span class="header-section-number">5</span> When does efficient GMM help? A simulation</h2>
<p>2SLS is efficient only under homoskedasticity. Under heteroskedasticity, efficient GMM can reduce variance. Let’s demonstrate with a Monte Carlo:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>beta_true <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="fu">character</span>(), <span class="at">estimate =</span> <span class="fu">numeric</span>())</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  z2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2 <span class="sc">+</span> u</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Heteroskedastic errors: variance depends on z1</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  sigma_i <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fu">abs</span>(z1)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> sigma_i <span class="sc">*</span> <span class="fu">rnorm</span>(n_sim) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> u</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> beta_true <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2SLS</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  iv_fit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">iv_robust</span>(y <span class="sc">~</span> x <span class="sc">|</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d, <span class="at">se_type =</span> <span class="st">"classical"</span>),</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Two-step GMM</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  gmm_fit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gmm</span>(y <span class="sc">~</span> x, <span class="sc">~</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d, <span class="at">type =</span> <span class="st">"twoStep"</span>),</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(iv_fit) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(gmm_fit)) {</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results,</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"2SLS"</span>, <span class="at">estimate =</span> <span class="fu">coef</span>(iv_fit)[<span class="st">"x"</span>]),</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"Efficient GMM"</span>, <span class="at">estimate =</span> <span class="fu">coef</span>(gmm_fit)[<span class="st">"x"</span>])</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variances</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>var_table <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(estimate <span class="sc">~</span> method, <span class="at">data =</span> results,</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>                       <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">c</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x), <span class="at">var =</span> <span class="fu">var</span>(x)))</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>var_table <span class="ot">&lt;-</span> <span class="fu">cbind</span>(var_table[<span class="dv">1</span>], <span class="fu">as.data.frame</span>(var_table[[<span class="dv">2</span>]]))</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(var_table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"method"</span>, <span class="st">"mean"</span>, <span class="st">"variance"</span>)</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>var_table<span class="sc">$</span>efficiency_ratio <span class="ot">&lt;-</span> var_table<span class="sc">$</span>variance <span class="sc">/</span> <span class="fu">min</span>(var_table<span class="sc">$</span>variance)</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(var_table, <span class="at">digits =</span> <span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>         method   mean variance efficiency_ratio
1          2SLS 0.5025  0.03440            1.067
2 Efficient GMM 0.5000  0.03224            1.000</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> beta_true, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"2SLS vs efficient GMM under heteroskedasticity"</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"n = "</span>, n_sim, <span class="st">", "</span>, B, <span class="st">" replications"</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)), <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch11-gmm_files/figure-html/efficiency-plot-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>2SLS vs.&nbsp;efficient GMM under heteroskedasticity</figcaption>
</figure>
</div>
</div>
</div>
<p>Under heteroskedasticity, efficient GMM has lower variance because it weights moment conditions by the inverse of their variance—upweighting informative, low-noise moments and downweighting noisy ones. Just as the <a href="./ch05-gls.html#thm-gauss-markov">Gauss-Markov theorem</a> bounds OLS among linear unbiased estimators, the efficient GMM achieves the semiparametric bound among all estimators using the same moment conditions.</p>
</section>
<section id="sec-j-test" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-j-test"><span class="header-section-number">6</span> The J-test for overidentification</h2>
<p>When <span class="math inline">\(\ell &gt; k\)</span> (more moment conditions than parameters), the model imposes testable restrictions. If the moment conditions are correctly specified, the minimized criterion value should be small.</p>
<p><span id="eq-j-test"><span class="math display">\[J = n\,\bar{g}_n(\hat\beta)'\hat\Omega^{-1}\bar{g}_n(\hat\beta) \xrightarrow{d} \chi^2_{\ell - k} \tag{2}\]</span></span></p>
<div id="thm-j-test" class="theorem">
<p><span class="theorem-title"><strong>Theorem 3 (J-Test for Overidentification (Hansen 13.14))</strong></span> Under correct specification, the minimized GMM criterion <span class="math inline">\(J = n\,\bar{g}_n(\hat\beta)'\hat\Omega^{-1}\bar{g}_n(\hat\beta) \xrightarrow{d} \chi^2_{\ell - k}\)</span>, where <span class="math inline">\(\ell\)</span> is the number of moment conditions and <span class="math inline">\(k\)</span> is the number of parameters. Rejection indicates that the moment conditions are mutually inconsistent.</p>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># J-test from our earlier fit (valid instruments)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">specTest</span>(fit_2step)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 ##  J-Test: degrees of freedom is 1  ## 

                J-test    P-value 
Test E(g)=0:    4.620103  0.031599</code></pre>
</div>
</div>
<p>Here <span class="math inline">\(\ell - k = 3 - 2 = 1\)</span> degree of freedom. A large p-value means we fail to reject: the overidentifying restrictions are consistent with the data.</p>
<section id="when-the-j-test-rejects" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="when-the-j-test-rejects"><span class="header-section-number">6.1</span> When the J-test rejects</h3>
<p>If an instrument is invalid (correlated with the error), the J-test should detect this:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>z2_bad <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2_bad <span class="sc">+</span> u</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> z2_bad <span class="sc">+</span> <span class="fu">rnorm</span>(n)  <span class="co"># z2_bad enters the error!</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>d_bad <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2_bad)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>fit_bad <span class="ot">&lt;-</span> <span class="fu">gmm</span>(y <span class="sc">~</span> x, <span class="sc">~</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d_bad, <span class="at">type =</span> <span class="st">"twoStep"</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="fu">specTest</span>(fit_bad)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 ##  J-Test: degrees of freedom is 1  ## 

                J-test      P-value   
Test E(g)=0:    1.4055e+01  1.7758e-04</code></pre>
</div>
</div>
<p>The J-test has a limitation: if all instruments are invalid in the same direction, the test may not detect the problem. It tests whether the instruments <em>disagree</em> with each other, not whether any individual instrument is valid.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>J-Test Limitations
</div>
</div>
<div class="callout-body-container callout-body">
<p>The J-test only detects when instruments <em>disagree</em> with each other. If all instruments are invalid in the same direction, the test has no power. It tests internal consistency of the overidentifying restrictions, not the validity of any individual instrument.</p>
</div>
</div>
</section>
<section id="j-test-rejection-rates-by-simulation" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="j-test-rejection-rates-by-simulation"><span class="header-section-number">6.2</span> J-test rejection rates by simulation</h3>
<p>Let’s verify the J-test has correct size (under valid instruments) and power (under an invalid instrument):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>rejections <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">scenario =</span> <span class="fu">character</span>(), <span class="at">rejected =</span> <span class="fu">logical</span>())</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"valid"</span>, <span class="st">"invalid"</span>)) {</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    z2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2 <span class="sc">+</span> u</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"valid"</span>) {</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>      e <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>      e <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2 <span class="sc">+</span> <span class="fu">rnorm</span>(n_sim)  <span class="co"># z2 in error</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">gmm</span>(y <span class="sc">~</span> x, <span class="sc">~</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d, <span class="at">type =</span> <span class="st">"twoStep"</span>),</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fit)) {</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>      jtest <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">specTest</span>(fit), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(jtest)) {</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        pval <span class="ot">&lt;-</span> jtest<span class="sc">$</span>test[<span class="dv">1</span>, <span class="dv">2</span>]  <span class="co"># p-value</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        rejections <span class="ot">&lt;-</span> <span class="fu">rbind</span>(rejections,</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>(<span class="at">scenario =</span> scenario, <span class="at">rejected =</span> pval <span class="sc">&lt;</span> <span class="fl">0.05</span>))</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>rej_rates <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(rejected <span class="sc">~</span> scenario, <span class="at">data =</span> rejections, mean)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rej_rates)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"rejection_rate"</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>rej_rates</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  scenario rejection_rate
1  invalid          0.998
2    valid          0.068</code></pre>
</div>
</div>
<p>Under valid instruments, the rejection rate should be near 0.05 (the nominal size). Under the invalid instrument, the rejection rate should be substantially higher.</p>
</section>
</section>
<section id="nonlinear-gmm-custom-moment-functions" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="nonlinear-gmm-custom-moment-functions"><span class="header-section-number">7</span> Nonlinear GMM: custom moment functions</h2>
<p>The <code>gmm</code> package also accepts user-defined moment functions for nonlinear models. The moment function takes parameters <span class="math inline">\(\theta\)</span> and data <span class="math inline">\(x\)</span>, and returns an <span class="math inline">\(n \times \ell\)</span> matrix of moment contributions.</p>
<p>Here’s a simple example: estimating the mean and variance of a distribution simultaneously using moment conditions <span class="math inline">\(\mathbb{E}[Y - \mu] = 0\)</span> and <span class="math inline">\(\mathbb{E}[(Y - \mu)^2 - \sigma^2] = 0\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Moment function: E[Y - mu] = 0 and E[(Y - mu)^2 - sigma2] = 0</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>g_meanvar <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> theta[<span class="dv">1</span>]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="ot">&lt;-</span> theta[<span class="dv">2</span>]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> x <span class="sc">-</span> mu</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  m2 <span class="ot">&lt;-</span> (x <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> sigma2</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(m1, m2)  <span class="co"># n x 2 matrix</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>y_data <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># GMM estimation (just-identified: 2 moments, 2 parameters)</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>fit_mv <span class="ot">&lt;-</span> <span class="fu">gmm</span>(g_meanvar, <span class="at">x =</span> y_data, <span class="at">t0 =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM estimates:  mu ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_mv)[<span class="dv">1</span>], <span class="dv">3</span>),</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">" sigma2 ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_mv)[<span class="dv">2</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>GMM estimates:  mu = 3.071  sigma2 = 3.436 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample moments: mean ="</span>, <span class="fu">round</span>(<span class="fu">mean</span>(y_data), <span class="dv">3</span>),</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">" var ="</span>, <span class="fu">round</span>(<span class="fu">var</span>(y_data) <span class="sc">*</span> (<span class="dv">200-1</span>)<span class="sc">/</span><span class="dv">200</span>, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample moments: mean = 3.071  var = 3.436 </code></pre>
</div>
</div>
<p>The GMM estimates match the sample moments exactly because this is a just-identified model.</p>
</section>
<section id="application-missing-data-and-gmm" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="application-missing-data-and-gmm"><span class="header-section-number">8</span> Application: missing data and GMM</h2>
<p>This section implements the Abrevaya &amp; Donald (2017) approach to missing data using GMM. The idea is to exploit moment conditions from <em>both</em> complete and incomplete observations.</p>
<section id="the-setup" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="the-setup"><span class="header-section-number">8.1</span> The setup</h3>
<p>Suppose we want to estimate: <span class="math display">\[y_i = \beta_0 + \alpha \cdot x_i + \beta_1 \cdot z_i + \varepsilon_i\]</span></p>
<p>where <span class="math inline">\(x_i\)</span> is sometimes missing but <span class="math inline">\(z_i\)</span> is always observed. If <span class="math inline">\(x_i\)</span> has a linear projection on <span class="math inline">\(z_i\)</span>: <span class="math display">\[x_i = \gamma_0 + \gamma_1 \cdot z_i + \xi_i\]</span></p>
<p>then for observations where <span class="math inline">\(x_i\)</span> is missing, we can substitute: <span class="math display">\[y_i = (\beta_0 + \alpha\gamma_0) + (\beta_1 + \alpha\gamma_1) z_i + (\varepsilon_i + \alpha\xi_i)\]</span></p>
<p>This gives us three blocks of moment conditions—and more conditions than parameters (overidentification).</p>
</section>
<section id="simulating-the-wls-like-data" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="simulating-the-wls-like-data"><span class="header-section-number">8.2</span> Simulating the WLS-like data</h3>
<p>We simulate data similar to the Wisconsin Longitudinal Study, where education (<span class="math inline">\(y\)</span>) depends on a BMI-related rating (<span class="math inline">\(x\)</span>, sometimes missing) and IQ (<span class="math inline">\(z\)</span>, always observed):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">314</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n_wls <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>beta_0_true <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>alpha_true <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.04</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>beta_iq_true <span class="ot">&lt;-</span> <span class="fl">0.06</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>gamma_0_true <span class="ot">&lt;-</span> <span class="fl">3.5</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>gamma_iq_true <span class="ot">&lt;-</span> <span class="fl">0.005</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>iq <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_wls, <span class="at">mean =</span> <span class="dv">100</span>, <span class="at">sd =</span> <span class="dv">15</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>xi <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_wls, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>bmi <span class="ot">&lt;-</span> gamma_0_true <span class="sc">+</span> gamma_iq_true <span class="sc">*</span> iq <span class="sc">+</span> xi</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_wls, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>educ <span class="ot">&lt;-</span> beta_0_true <span class="sc">+</span> alpha_true <span class="sc">*</span> bmi <span class="sc">+</span> beta_iq_true <span class="sc">*</span> iq <span class="sc">+</span> eps</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Missingness: depends on iq (MAR) but not on eps or xi</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>prob_missing <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> iq)  <span class="co"># ~20% missing overall</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>missing <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_wls, <span class="dv">1</span>, prob_missing)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction missing:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(missing), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fraction missing: 0.273 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set bmi to 0 for missing observations (placeholder)</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>bmi_obs <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(missing <span class="sc">==</span> <span class="dv">0</span>, bmi, <span class="dv">0</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>wls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">educ =</span> educ, <span class="at">bmi =</span> bmi_obs, <span class="at">iq =</span> iq, <span class="at">bmimissing =</span> missing)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="complete-case-and-dummy-variable-approaches" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="complete-case-and-dummy-variable-approaches"><span class="header-section-number">8.3</span> Complete case and dummy variable approaches</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete case: drop missing observations</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>cc_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ <span class="sc">~</span> bmi <span class="sc">+</span> iq, <span class="at">data =</span> <span class="fu">subset</span>(wls, bmimissing <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dummy variable: fill in 0, add missing indicator</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>dv_fit <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(educ <span class="sc">~</span> bmi <span class="sc">+</span> iq <span class="sc">+</span> bmimissing, <span class="at">data =</span> wls)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Complete case:   alpha ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cc_fit)[<span class="st">"bmi"</span>], <span class="dv">4</span>),</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE ="</span>, <span class="fu">round</span>(<span class="fu">summary</span>(cc_fit)<span class="sc">$</span>coefficients[<span class="st">"bmi"</span>, <span class="st">"Std. Error"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Complete case:   alpha = -0.0573  SE = 0.0248 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dummy variable:  alpha ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(dv_fit)[<span class="st">"bmi"</span>], <span class="dv">4</span>),</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE ="</span>, <span class="fu">round</span>(dv_fit<span class="sc">$</span>std.error[<span class="st">"bmi"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dummy variable:  alpha = -0.0573  SE = 0.0249 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True alpha:     "</span>, alpha_true, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>True alpha:      -0.04 </code></pre>
</div>
</div>
</section>
<section id="gmm-with-three-blocks-of-moment-conditions" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="gmm-with-three-blocks-of-moment-conditions"><span class="header-section-number">8.4</span> GMM with three blocks of moment conditions</h3>
<p>Now we implement the Abrevaya &amp; Donald GMM estimator. The five parameters are <span class="math inline">\(\theta = (\beta_0, \alpha, \beta_{iq}, \gamma_0, \gamma_{iq})\)</span> and we have seven moment conditions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Moment function: 7 conditions for 5 parameters</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>g_missing <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  beta_0  <span class="ot">&lt;-</span> theta[<span class="dv">1</span>]</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  alpha   <span class="ot">&lt;-</span> theta[<span class="dv">2</span>]</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  beta_iq <span class="ot">&lt;-</span> theta[<span class="dv">3</span>]</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  gamma_0 <span class="ot">&lt;-</span> theta[<span class="dv">4</span>]</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  gamma_iq <span class="ot">&lt;-</span> theta[<span class="dv">5</span>]</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  educ <span class="ot">&lt;-</span> x[, <span class="dv">1</span>]</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  bmi  <span class="ot">&lt;-</span> x[, <span class="dv">2</span>]</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  iq   <span class="ot">&lt;-</span> x[, <span class="dv">3</span>]</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  m    <span class="ot">&lt;-</span> x[, <span class="dv">4</span>]  <span class="co"># missing indicator</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block 1: structural equation, observed cases only</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  resid1 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> m) <span class="sc">*</span> (educ <span class="sc">-</span> beta_0 <span class="sc">-</span> alpha <span class="sc">*</span> bmi <span class="sc">-</span> beta_iq <span class="sc">*</span> iq)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block 2: projection equation, observed cases only</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  resid2 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> m) <span class="sc">*</span> (bmi <span class="sc">-</span> gamma_0 <span class="sc">-</span> gamma_iq <span class="sc">*</span> iq)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block 3: substituted equation, missing cases only</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>  resid3 <span class="ot">&lt;-</span> m <span class="sc">*</span> (educ <span class="sc">-</span> (gamma_0 <span class="sc">*</span> alpha <span class="sc">+</span> beta_0) <span class="sc">-</span> (gamma_iq <span class="sc">*</span> alpha <span class="sc">+</span> beta_iq) <span class="sc">*</span> iq)</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    resid1,              <span class="co"># m1: E[(1-m)(y - b0 - a*x - b1*z)] = 0</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    resid1 <span class="sc">*</span> bmi,        <span class="co"># m2: E[(1-m)(y - ...)*x] = 0</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    resid1 <span class="sc">*</span> iq,         <span class="co"># m3: E[(1-m)(y - ...)*z] = 0</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    resid2,              <span class="co"># m4: E[(1-m)(x - g0 - g1*z)] = 0</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    resid2 <span class="sc">*</span> iq,         <span class="co"># m5: E[(1-m)(x - ...)*z] = 0</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    resid3,              <span class="co"># m6: E[m(y - delta'z)] = 0</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    resid3 <span class="sc">*</span> iq          <span class="co"># m7: E[m(y - delta'z)*z] = 0</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The instruments for each block multiply the residuals: Block 1 uses <span class="math inline">\((1, x, z)\)</span>, Block 2 uses <span class="math inline">\((1, z)\)</span>, Block 3 uses <span class="math inline">\((1, z)\)</span>. Total: <span class="math inline">\(3 + 2 + 2 = 7\)</span> moment conditions for 5 parameters, giving us <strong>2 overidentifying restrictions</strong>.</p>
</section>
<section id="starting-values-and-estimation" class="level3" data-number="8.5">
<h3 data-number="8.5" class="anchored" data-anchor-id="starting-values-and-estimation"><span class="header-section-number">8.5</span> Starting values and estimation</h3>
<p>Good starting values help the optimizer. We use complete-case regressions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting values from complete cases</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>cc_reg <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ <span class="sc">~</span> bmi <span class="sc">+</span> iq, <span class="at">data =</span> <span class="fu">subset</span>(wls, bmimissing <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>proj_reg <span class="ot">&lt;-</span> <span class="fu">lm</span>(bmi <span class="sc">~</span> iq, <span class="at">data =</span> <span class="fu">subset</span>(wls, bmimissing <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>start_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_0   =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_reg)[<span class="st">"(Intercept)"</span>]),</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha    =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_reg)[<span class="st">"bmi"</span>]),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_iq  =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_reg)[<span class="st">"iq"</span>]),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma_0  =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_reg)[<span class="st">"(Intercept)"</span>]),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma_iq =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_reg)[<span class="st">"iq"</span>])</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data matrix</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>x_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wls[, <span class="fu">c</span>(<span class="st">"educ"</span>, <span class="st">"bmi"</span>, <span class="st">"iq"</span>, <span class="st">"bmimissing"</span>)])</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Two-step GMM</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>gmm_fit <span class="ot">&lt;-</span> <span class="fu">gmm</span>(</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  g_missing,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x_mat,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0 =</span> start_vals,</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"twoStep"</span>,</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">wmatrix =</span> <span class="st">"ident"</span>,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="st">"HAC"</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gmm_fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
gmm(g = g_missing, x = x_mat, t0 = start_vals, type = "twoStep", 
    wmatrix = "ident", vcov = "HAC")


Method:  One step GMM with W = identity 

Kernel:  Quadratic Spectral

Coefficients:
          Estimate      Std. Error    t value       Pr(&gt;|t|)    
beta_0      1.1602e+01    2.1935e+00    5.2894e+00    1.2271e-07
alpha      -1.7500e-02    1.2947e-01   -1.3516e-01    8.9248e-01
beta_iq     6.3019e-02    1.6528e-02    3.8129e+00    1.3734e-04
gamma_0     3.4071e+00    1.1759e-01    2.8975e+01   1.3572e-184
gamma_iq    5.8239e-03    1.1712e-03    4.9726e+00    6.6058e-07

J-Test: degrees of freedom is 2 
                J-test      P-value   
Test E(g)=0:    1.9454e+01  5.9644e-05

#############
Information related to the numerical optimization
Convergence code =  1 
Function eval. =  502 
Gradian eval. =  NA </code></pre>
</div>
</div>
</section>
<section id="comparing-all-methods" class="level3" data-number="8.6">
<h3 data-number="8.6" class="anchored" data-anchor-id="comparing-all-methods"><span class="header-section-number">8.6</span> Comparing all methods</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"Complete Case"</span>, <span class="st">"Dummy Variable"</span>, <span class="st">"GMM"</span>),</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fu">c</span>(</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    alpha_true,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(cc_fit)[<span class="st">"bmi"</span>],</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(dv_fit)[<span class="st">"bmi"</span>],</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(gmm_fit)[<span class="st">"alpha"</span>]</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_alpha =</span> <span class="fu">c</span>(</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(cc_fit)<span class="sc">$</span>coefficients[<span class="st">"bmi"</span>, <span class="st">"Std. Error"</span>],</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    dv_fit<span class="sc">$</span>std.error[<span class="st">"bmi"</span>],</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">vcov</span>(gmm_fit)[<span class="st">"alpha"</span>, <span class="st">"alpha"</span>])</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_iq =</span> <span class="fu">c</span>(</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    beta_iq_true,</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(cc_fit)[<span class="st">"iq"</span>],</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(dv_fit)[<span class="st">"iq"</span>],</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(gmm_fit)[<span class="st">"beta_iq"</span>]</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>comparison<span class="sc">$</span>alpha <span class="ot">&lt;-</span> <span class="fu">round</span>(comparison<span class="sc">$</span>alpha, <span class="dv">4</span>)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>comparison<span class="sc">$</span>SE_alpha <span class="ot">&lt;-</span> <span class="fu">round</span>(comparison<span class="sc">$</span>SE_alpha, <span class="dv">4</span>)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>comparison<span class="sc">$</span>beta_iq <span class="ot">&lt;-</span> <span class="fu">round</span>(comparison<span class="sc">$</span>beta_iq, <span class="dv">4</span>)</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>comparison</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Method   alpha SE_alpha beta_iq
1           True -0.0400       NA  0.0600
2  Complete Case -0.0573   0.0248  0.0578
3 Dummy Variable -0.0573   0.0249  0.0577
4            GMM -0.0175   0.1295  0.0630</code></pre>
</div>
</div>
<p>GMM uses all observations (both complete and incomplete cases), which can improve efficiency. The complete case estimator is consistent but throws away data. The dummy variable approach can be inconsistent depending on the missingness mechanism.</p>
</section>
<section id="j-test-for-the-missing-data-model" class="level3" data-number="8.7">
<h3 data-number="8.7" class="anchored" data-anchor-id="j-test-for-the-missing-data-model"><span class="header-section-number">8.7</span> J-test for the missing data model</h3>
<p>The J-test checks whether the overidentifying restrictions are satisfied—that is, whether the linear projection assumption holds equally for observed and missing subgroups:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">specTest</span>(gmm_fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 ##  J-Test: degrees of freedom is 2  ## 

                J-test      P-value   
Test E(g)=0:    1.9454e+01  5.9644e-05</code></pre>
</div>
</div>
<p>With 7 moments and 5 parameters, the J-test has <span class="math inline">\(7 - 5 = 2\)</span> degrees of freedom. A large p-value means we fail to reject the model specification.</p>
</section>
<section id="monte-carlo-comparing-estimator-properties" class="level3" data-number="8.8">
<h3 data-number="8.8" class="anchored" data-anchor-id="monte-carlo-comparing-estimator-properties"><span class="header-section-number">8.8</span> Monte Carlo: comparing estimator properties</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">77</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>B_mc <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>n_mc <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>mc_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="fu">character</span>(), <span class="at">alpha_hat =</span> <span class="fu">numeric</span>())</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B_mc) {</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  iq_b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="dv">100</span>, <span class="dv">15</span>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  xi_b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  bmi_b <span class="ot">&lt;-</span> gamma_0_true <span class="sc">+</span> gamma_iq_true <span class="sc">*</span> iq_b <span class="sc">+</span> xi_b</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  eps_b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  educ_b <span class="ot">&lt;-</span> beta_0_true <span class="sc">+</span> alpha_true <span class="sc">*</span> bmi_b <span class="sc">+</span> beta_iq_true <span class="sc">*</span> iq_b <span class="sc">+</span> eps_b</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  prob_m <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> iq_b)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  m_b <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_mc, <span class="dv">1</span>, prob_m)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  bmi_obs_b <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(m_b <span class="sc">==</span> <span class="dv">0</span>, bmi_b, <span class="dv">0</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Complete case</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>  cc_b <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ_b[m_b <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">~</span> bmi_b[m_b <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">+</span> iq_b[m_b <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dummy variable</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  dv_b <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ_b <span class="sc">~</span> bmi_obs_b <span class="sc">+</span> iq_b <span class="sc">+</span> m_b)</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># GMM</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  x_b <span class="ot">&lt;-</span> <span class="fu">cbind</span>(educ_b, bmi_obs_b, iq_b, m_b)</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  proj_b <span class="ot">&lt;-</span> <span class="fu">lm</span>(bmi_b[m_b <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">~</span> iq_b[m_b <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  start_b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta_0 =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">1</span>]),</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">2</span>]),</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">beta_iq =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">3</span>]),</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">gamma_0 =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_b)[<span class="dv">1</span>]),</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">gamma_iq =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_b)[<span class="dv">2</span>]))</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  gmm_b <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gmm</span>(g_missing, <span class="at">x =</span> x_b, <span class="at">t0 =</span> start_b, <span class="at">type =</span> <span class="st">"twoStep"</span>,</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">wmatrix =</span> <span class="st">"ident"</span>, <span class="at">vcov =</span> <span class="st">"HAC"</span>),</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>  mc_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mc_results,</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"Complete Case"</span>, <span class="at">alpha_hat =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">2</span>])),</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"Dummy Variable"</span>, <span class="at">alpha_hat =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(dv_b)[<span class="dv">2</span>]))</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gmm_b)) {</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>    mc_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mc_results,</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"GMM"</span>, <span class="at">alpha_hat =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(gmm_b)[<span class="st">"alpha"</span>])))</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>mc_summary <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(alpha_hat <span class="sc">~</span> method, <span class="at">data =</span> mc_results,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">c</span>(</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bias =</span> <span class="fu">mean</span>(x) <span class="sc">-</span> alpha_true,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">variance =</span> <span class="fu">var</span>(x),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mse =</span> <span class="fu">mean</span>((x <span class="sc">-</span> alpha_true)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                        ))</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>mc_summary <span class="ot">&lt;-</span> <span class="fu">cbind</span>(mc_summary[<span class="dv">1</span>], <span class="fu">round</span>(<span class="fu">as.data.frame</span>(mc_summary[[<span class="dv">2</span>]]), <span class="dv">6</span>))</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mc_summary) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Method"</span>, <span class="st">"Bias"</span>, <span class="st">"Variance"</span>, <span class="st">"MSE"</span>)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>mc_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Method     Bias Variance      MSE
1  Complete Case 0.004402 0.003086 0.003095
2 Dummy Variable 0.004618 0.003053 0.003064
3            GMM 0.107638 0.340920 0.351369</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mc_results, <span class="fu">aes</span>(<span class="at">x =</span> alpha_hat, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> alpha_true, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Estimator comparison with missing data"</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"True alpha = "</span>, alpha_true, <span class="st">", n = "</span>, n_mc,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", "</span>, B_mc, <span class="st">" replications"</span>),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(alpha)), <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>, <span class="st">"forestgreen"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch11-gmm_files/figure-html/missing-mc-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="gmm-as-a-unifying-framework" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="gmm-as-a-unifying-framework"><span class="header-section-number">9</span> GMM as a unifying framework</h2>
<p>The progression through the course is a series of generalizations, each nesting the previous:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 28%">
<col style="width: 25%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th>Estimator</th>
<th>Moment condition</th>
<th>Weight matrix</th>
<th>When efficient</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OLS</td>
<td><span class="math inline">\(\mathbb{E}[X_i e_i] = 0\)</span></td>
<td><span class="math inline">\((X'X)^{-1}\)</span> (implicit)</td>
<td>Homoskedastic, exogenous</td>
</tr>
<tr class="even">
<td>GLS</td>
<td><span class="math inline">\(\mathbb{E}[\bar{X}_i \Sigma^{-1} e_i] = 0\)</span></td>
<td>Known <span class="math inline">\(\Sigma\)</span></td>
<td>Known error structure</td>
</tr>
<tr class="odd">
<td>IV</td>
<td><span class="math inline">\(\mathbb{E}[Z_i e_i] = 0\)</span></td>
<td><span class="math inline">\(\ell = k\)</span> (unique)</td>
<td>Just-identified</td>
</tr>
<tr class="even">
<td>2SLS</td>
<td><span class="math inline">\(\mathbb{E}[Z_i e_i] = 0\)</span></td>
<td><span class="math inline">\((Z'Z)^{-1}\)</span></td>
<td>Homoskedastic</td>
</tr>
<tr class="odd">
<td><strong>GMM</strong></td>
<td><span class="math inline">\(\mathbb{E}[g_i(\beta)] = 0\)</span></td>
<td><span class="math inline">\(\hat\Omega^{-1}\)</span></td>
<td><strong>Always</strong> (semiparametric bound)</td>
</tr>
</tbody>
</table>
<p>Every test we have seen—<span class="math inline">\(t\)</span>-tests, <span class="math inline">\(F\)</span>-tests, Hausman tests, Sargan tests—is a special case of a GMM test, often valid under weaker assumptions.</p>
<section id="recovering-ols-as-gmm" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="recovering-ols-as-gmm"><span class="header-section-number">9.1</span> Recovering OLS as GMM</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS via gmm package (instruments = regressors)</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>ols_gmm <span class="ot">&lt;-</span> <span class="fu">gmm</span>(Y <span class="sc">~</span> X, <span class="sc">~</span> X, <span class="at">data =</span> dat)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>ols_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> X, <span class="at">data =</span> dat)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM (as OLS):"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(ols_gmm)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>GMM (as OLS): 0.8725 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"lm():        "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(ols_lm)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>lm():         0.8725 </code></pre>
</div>
</div>
<p>When the instruments are the regressors themselves (<span class="math inline">\(Z = X\)</span>), the model is just-identified and GMM reduces to OLS regardless of the weight matrix.</p>
</section>
</section>
<section id="connection-to-mte" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="connection-to-mte"><span class="header-section-number">10</span> Connection to MTE</h2>
<p>The Marginal Treatment Effect (MTE) framework (Heckman &amp; Vytlacil, 2005) uses GMM to estimate treatment effects that vary across the population:</p>
<p><span class="math display">\[\Delta^{MTE}(u_D) = \mathbb{E}[Y_1 - Y_0 \mid U_D = u_D]\]</span></p>
<p>where <span class="math inline">\(U_D\)</span> indexes resistance to treatment. The LATE estimated by IV is a weighted average of the MTE curve over the complier population. GMM estimation of MTE involves:</p>
<ul>
<li><strong>Nonlinear moment conditions</strong>: <span class="math inline">\(\mathbb{E}[Y \mid X, Z]\)</span> depends on <span class="math inline">\(\int_0^{P(Z)} \Delta^{MTE}(u)\,du\)</span>, which is nonlinear in the MTE parameters.</li>
<li><strong>Overidentification from multiple instruments</strong>: more instruments than MTE parameters.</li>
<li><strong>J-test</strong>: tests whether the MTE specification (e.g., polynomial degree) fits the data.</li>
</ul>
<p>The <code>ivmte</code> package (Shea &amp; Torgovitsky) implements this under the hood. Conceptually, the call looks like:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Not run -- requires ivmte package and appropriate data</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ivmte)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">ivmte</span>(</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"y"</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="st">"d"</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">instrument =</span> <span class="st">"z"</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="st">"ate"</span>,             <span class="co"># or "att", "late", "prte"</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> <span class="sc">~</span> u <span class="sc">+</span> <span class="fu">I</span>(u<span class="sc">^</span><span class="dv">2</span>),         <span class="co"># MTE polynomial for control</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">m1 =</span> <span class="sc">~</span> u <span class="sc">+</span> <span class="fu">I</span>(u<span class="sc">^</span><span class="dv">2</span>),         <span class="co"># MTE polynomial for treated</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">propensity =</span> d <span class="sc">~</span> z</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The key insight from GMM: by specifying moment conditions rather than a full parametric model, we can estimate flexible treatment effect heterogeneity while maintaining testable restrictions via the J-test.</p>
</section>
<section id="summary" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="summary"><span class="header-section-number">11</span> Summary</h2>
<ul>
<li><strong>GMM is a unifying framework</strong>: OLS, GLS, IV, and 2SLS are all special cases of GMM with specific weight matrices.</li>
<li><strong>Efficient GMM</strong> sets <span class="math inline">\(W = \hat\Omega^{-1}\)</span> (the inverse of the moment covariance), minimizing asymptotic variance. Two-step and iterated procedures achieve this.</li>
<li><strong>2SLS is efficient only under homoskedasticity</strong>. Under heteroskedasticity, efficient GMM provides tighter estimates.</li>
<li><strong>The J-test</strong> is a natural diagnostic for overidentified models. It tests whether the moment conditions are mutually consistent.</li>
<li><strong>Nonlinear GMM</strong> (custom moment functions) handles problems like missing data (Abrevaya &amp; Donald) and MTE estimation.</li>
<li><strong>The semiparametric efficiency bound</strong> (Chamberlain, 1987): efficient GMM extracts the maximum information from moment conditions without distributional assumptions.</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/UChicago-pol-methods\.github\.io\/EstimationI\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "11. GMM"</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Generalized method of moments"</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>This chapter demonstrates the Generalized Method of Moments (GMM) framework computationally. We show that OLS, IV, and 2SLS are all special cases, then build up to efficient GMM estimation, the J-test, and a missing data application. The key reference is Hansen, Chapter 13.</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>**Questions this chapter answers:**</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>How does GMM unify OLS, IV, and 2SLS under a single framework of moment conditions?</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>What is the optimal weighting matrix, and how does efficient GMM achieve the semiparametric variance bound?</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>How does the J-test detect misspecification in overidentified models?</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>How can nonlinear GMM handle problems like missing data?</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gmm)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Everything is a moment condition</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>Every estimator we have studied solves a set of moment conditions $\mathbb{E}<span class="co">[</span><span class="ot">g_i(\beta)</span><span class="co">]</span> = 0$. The sample analog sets $\bar{g}_n(\hat\beta) = \frac{1}{n}\sum g_i(\hat\beta) = 0$.</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Estimator <span class="pp">|</span> Moment condition <span class="pp">|</span> Solution <span class="pp">|</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------|-----------------|----------|</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> OLS <span class="pp">|</span> $\mathbb{E}<span class="co">[</span><span class="ot">X_i(Y_i - X_i'\beta)</span><span class="co">]</span> = 0$ <span class="pp">|</span> the <span class="co">[</span><span class="ot">OLS estimator</span><span class="co">](ch03-ols.qmd#eq-ols)</span> <span class="pp">|</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> IV <span class="pp">|</span> $\mathbb{E}<span class="co">[</span><span class="ot">Z_i(Y_i - X_i'\beta)</span><span class="co">]</span> = 0$ <span class="pp">|</span> $(Z'X)^{-1}Z'Y$ <span class="pp">|</span></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 2SLS <span class="pp">|</span> Same as IV, with $W = (Z'Z)^{-1}$ <span class="pp">|</span> $(X'P_Z X)^{-1}X'P_Z Y$ <span class="pp">|</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>::: {#def-gmm}</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a><span class="fu">## GMM Estimator (Hansen 13.1)</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>The GMM estimator minimizes $J(\beta) = n\,\bar{g}_n(\beta)' W\, \bar{g}_n(\beta)$, where $\bar{g}_n(\beta) = \frac{1}{n}\sum g_i(\beta)$ and $W$ is a positive definite weight matrix. Different choices of $W$ yield different estimators; the optimal $W = \Omega^{-1}$ minimizes asymptotic variance.</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## GMM Unifies Everything</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>Every estimator in this course — OLS, GLS, IV, 2SLS, probit MLE — is a GMM estimator with specific moment conditions and weight matrices. The GMM framework provides a single set of tools for estimation, inference, and specification testing.</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>Let's verify this computationally. We simulate an IV model with one endogenous regressor and one instrument:</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: moment-conditions-setup</span></span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a><span class="co"># DGP: Y = 1 + 0.5*X + e, where X is endogenous</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fl">0.8</span> <span class="sc">*</span> Z <span class="sc">+</span> u          <span class="co"># X correlated with u</span></span>
<span id="cb75-61"><a href="#cb75-61" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fu">rnorm</span>(n)   <span class="co"># e correlated with u through shared u</span></span>
<span id="cb75-62"><a href="#cb75-62" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> X <span class="sc">+</span> e</span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>OLS is biased because $\text{Cov}(X, e) \neq 0$:</span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ols-moment</span></span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS: E[X(Y - Xb)] = 0</span></span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a>beta_ols <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, X)) <span class="sc">%*%</span> <span class="fu">cbind</span>(<span class="dv">1</span>, X)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, X)) <span class="sc">%*%</span> Y</span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"OLS slope:"</span>, <span class="fu">round</span>(beta_ols[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">" (biased, true = 0.5)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>IV uses the instrument $Z$ to form moment conditions $\mathbb{E}<span class="co">[</span><span class="ot">Z(Y - X\beta)</span><span class="co">]</span> = 0$:</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: iv-moment</span></span>
<span id="cb75-82"><a href="#cb75-82" aria-hidden="true" tabindex="-1"></a><span class="co"># IV: E[Z(Y - Xb)] = 0, just-identified (ell = k)</span></span>
<span id="cb75-83"><a href="#cb75-83" aria-hidden="true" tabindex="-1"></a>Xmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, X)</span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a>Zmat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, Z)</span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a>beta_iv <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(Zmat) <span class="sc">%*%</span> Xmat) <span class="sc">%*%</span> <span class="fu">t</span>(Zmat) <span class="sc">%*%</span> Y</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IV slope:"</span>, <span class="fu">round</span>(beta_iv[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">" (consistent)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a>When the number of moment conditions $\ell$ equals the number of parameters $k$, we can solve exactly. But what happens when $\ell &gt; k$?</span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a><span class="fu">## The overidentification problem</span></span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-93"><a href="#cb75-93" aria-hidden="true" tabindex="-1"></a>With more instruments than parameters, no $\beta$ can simultaneously zero out all moment conditions. We need a principled way to get as close as possible.</span>
<span id="cb75-94"><a href="#cb75-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: overid-setup</span></span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Now add a second instrument</span></span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true" tabindex="-1"></a>Z2 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> X <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="dv">2</span>)  <span class="co"># second instrument (weaker)</span></span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true" tabindex="-1"></a>Zmat2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, Z, Z2)           <span class="co"># 3 instruments, 2 parameters</span></span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Can't solve Z'(Y - Xb) = 0 exactly (3 equations, 2 unknowns)</span></span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Check: the IV formula with the full Z matrix is not square</span></span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Z'X dimensions:"</span>, <span class="fu">nrow</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Xmat), <span class="st">"x"</span>, <span class="fu">ncol</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Xmat), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(not square -- can't invert directly)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-107"><a href="#cb75-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-108"><a href="#cb75-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true" tabindex="-1"></a><span class="fu">### The GMM criterion function</span></span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true" tabindex="-1"></a>For a positive definite weight matrix $W$, the GMM criterion is:</span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true" tabindex="-1"></a>$$J(\beta) = n\,\bar{g}_n(\beta)' W\, \bar{g}_n(\beta)$$ {#eq-gmm-criterion}</span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true" tabindex="-1"></a>The GMM estimator minimizes this weighted quadratic form.</span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-criterion</span></span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true" tabindex="-1"></a><span class="co"># GMM criterion function for the linear IV model</span></span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true" tabindex="-1"></a>gmm_criterion <span class="ot">&lt;-</span> <span class="cf">function</span>(beta, Y, X, Z, W) {</span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true" tabindex="-1"></a>  g_bar <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Z <span class="sc">*</span> <span class="fu">as.numeric</span>(Y <span class="sc">-</span> X <span class="sc">%*%</span> beta))  <span class="co"># sample moments</span></span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true" tabindex="-1"></a>  n <span class="sc">*</span> <span class="fu">t</span>(g_bar) <span class="sc">%*%</span> W <span class="sc">%*%</span> g_bar</span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Closed-form GMM estimator: (X'Z W Z'X)^{-1} (X'Z W Z'Y)</span></span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true" tabindex="-1"></a>gmm_linear <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, X, Z, W) {</span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true" tabindex="-1"></a>  XZ <span class="ot">&lt;-</span> <span class="fu">t</span>(X) <span class="sc">%*%</span> Z</span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(XZ <span class="sc">%*%</span> W <span class="sc">%*%</span> <span class="fu">t</span>(XZ)) <span class="sc">%*%</span> XZ <span class="sc">%*%</span> W <span class="sc">%*%</span> <span class="fu">t</span>(Z) <span class="sc">%*%</span> Y</span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-135"><a href="#cb75-135" aria-hidden="true" tabindex="-1"></a>Different weight matrices yield different estimators:</span>
<span id="cb75-136"><a href="#cb75-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-139"><a href="#cb75-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-140"><a href="#cb75-140" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: weight-comparison</span></span>
<span id="cb75-141"><a href="#cb75-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Identity matrix</span></span>
<span id="cb75-142"><a href="#cb75-142" aria-hidden="true" tabindex="-1"></a>W_ident <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">3</span>)</span>
<span id="cb75-143"><a href="#cb75-143" aria-hidden="true" tabindex="-1"></a>beta_gmm_ident <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_ident)</span>
<span id="cb75-144"><a href="#cb75-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-145"><a href="#cb75-145" aria-hidden="true" tabindex="-1"></a><span class="co"># (Z'Z)^{-1} -- this gives 2SLS</span></span>
<span id="cb75-146"><a href="#cb75-146" aria-hidden="true" tabindex="-1"></a>W_2sls <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Zmat2)</span>
<span id="cb75-147"><a href="#cb75-147" aria-hidden="true" tabindex="-1"></a>beta_gmm_2sls <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_2sls)</span>
<span id="cb75-148"><a href="#cb75-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-149"><a href="#cb75-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify 2SLS matches</span></span>
<span id="cb75-150"><a href="#cb75-150" aria-hidden="true" tabindex="-1"></a>PZ <span class="ot">&lt;-</span> Zmat2 <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> Zmat2) <span class="sc">%*%</span> <span class="fu">t</span>(Zmat2)</span>
<span id="cb75-151"><a href="#cb75-151" aria-hidden="true" tabindex="-1"></a>beta_2sls <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(Xmat) <span class="sc">%*%</span> PZ <span class="sc">%*%</span> Xmat) <span class="sc">%*%</span> <span class="fu">t</span>(Xmat) <span class="sc">%*%</span> PZ <span class="sc">%*%</span> Y</span>
<span id="cb75-152"><a href="#cb75-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-153"><a href="#cb75-153" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM (W = I):     slope ="</span>, <span class="fu">round</span>(beta_gmm_ident[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-154"><a href="#cb75-154" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM (W = 2SLS):  slope ="</span>, <span class="fu">round</span>(beta_gmm_2sls[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-155"><a href="#cb75-155" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2SLS directly:   slope ="</span>, <span class="fu">round</span>(beta_2sls[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-156"><a href="#cb75-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-157"><a href="#cb75-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-158"><a href="#cb75-158" aria-hidden="true" tabindex="-1"></a>::: {#thm-gmm-2sls}</span>
<span id="cb75-159"><a href="#cb75-159" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2SLS as GMM (Hansen 13.2)</span></span>
<span id="cb75-160"><a href="#cb75-160" aria-hidden="true" tabindex="-1"></a>When $W = (Z'Z/n)^{-1}$, the GMM estimator for the linear IV model reduces to 2SLS: $\hat\beta_{2SLS} = (X'P_Z X)^{-1}X'P_Z Y$. Under homoskedasticity, 2SLS is efficient among all GMM estimators.</span>
<span id="cb75-161"><a href="#cb75-161" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-162"><a href="#cb75-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-163"><a href="#cb75-163" aria-hidden="true" tabindex="-1"></a>The choice of $W$ matters when the model is overidentified---but the optimal choice is $W = \Omega^{-1}$, where $\Omega = \mathbb{E}<span class="co">[</span><span class="ot">Z_i Z_i' e_i^2</span><span class="co">]</span>$ is the variance of the moment conditions.</span>
<span id="cb75-164"><a href="#cb75-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-165"><a href="#cb75-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## Efficient GMM by hand {#sec-efficient-gmm}</span></span>
<span id="cb75-166"><a href="#cb75-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-167"><a href="#cb75-167" aria-hidden="true" tabindex="-1"></a>The optimal weight matrix $W = \Omega^{-1}$ minimizes the asymptotic variance of the GMM estimator. The two-step procedure is:</span>
<span id="cb75-168"><a href="#cb75-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-169"><a href="#cb75-169" aria-hidden="true" tabindex="-1"></a>::: {#thm-efficient-gmm}</span>
<span id="cb75-170"><a href="#cb75-170" aria-hidden="true" tabindex="-1"></a><span class="fu">## Efficient GMM (Hansen 13.4-13.5)</span></span>
<span id="cb75-171"><a href="#cb75-171" aria-hidden="true" tabindex="-1"></a>The efficient GMM estimator uses $W = \hat\Omega^{-1}$, where $\hat\Omega = \frac{1}{n}\sum g_i(\tilde\beta)g_i(\tilde\beta)'$ and $\tilde\beta$ is a preliminary consistent estimator. This achieves the semiparametric efficiency bound among all estimators using the same moment conditions.</span>
<span id="cb75-172"><a href="#cb75-172" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-173"><a href="#cb75-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-174"><a href="#cb75-174" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Estimate $\beta$ by 2SLS (using $W = (Z'Z)^{-1}$). Compute residuals $\tilde{e}_i$.</span>
<span id="cb75-175"><a href="#cb75-175" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Estimate $\hat\Omega = \frac{1}{n}\sum Z_i Z_i' \tilde{e}_i^2$, set $\hat{W} = \hat\Omega^{-1}$, and re-estimate.</span>
<span id="cb75-176"><a href="#cb75-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-179"><a href="#cb75-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-180"><a href="#cb75-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: two-step-by-hand</span></span>
<span id="cb75-181"><a href="#cb75-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: 2SLS</span></span>
<span id="cb75-182"><a href="#cb75-182" aria-hidden="true" tabindex="-1"></a>beta_step1 <span class="ot">&lt;-</span> beta_2sls</span>
<span id="cb75-183"><a href="#cb75-183" aria-hidden="true" tabindex="-1"></a>e_step1 <span class="ot">&lt;-</span> Y <span class="sc">-</span> Xmat <span class="sc">%*%</span> beta_step1</span>
<span id="cb75-184"><a href="#cb75-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-185"><a href="#cb75-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Estimate optimal weight matrix</span></span>
<span id="cb75-186"><a href="#cb75-186" aria-hidden="true" tabindex="-1"></a>Omega_hat <span class="ot">&lt;-</span> (<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">as.numeric</span>(e_step1<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%*%</span> Zmat2) <span class="sc">/</span> n</span>
<span id="cb75-187"><a href="#cb75-187" aria-hidden="true" tabindex="-1"></a>W_opt <span class="ot">&lt;-</span> <span class="fu">solve</span>(Omega_hat)</span>
<span id="cb75-188"><a href="#cb75-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-189"><a href="#cb75-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-estimate with optimal W</span></span>
<span id="cb75-190"><a href="#cb75-190" aria-hidden="true" tabindex="-1"></a>beta_step2 <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_opt)</span>
<span id="cb75-191"><a href="#cb75-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-192"><a href="#cb75-192" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Step 1 (2SLS) slope:     "</span>, <span class="fu">round</span>(beta_step1[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-193"><a href="#cb75-193" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Step 2 (efficient) slope:"</span>, <span class="fu">round</span>(beta_step2[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-194"><a href="#cb75-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-195"><a href="#cb75-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-196"><a href="#cb75-196" aria-hidden="true" tabindex="-1"></a>We can iterate---updating $\hat\Omega$ and re-estimating---until convergence:</span>
<span id="cb75-197"><a href="#cb75-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-200"><a href="#cb75-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-201"><a href="#cb75-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: iterated-gmm</span></span>
<span id="cb75-202"><a href="#cb75-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterated GMM</span></span>
<span id="cb75-203"><a href="#cb75-203" aria-hidden="true" tabindex="-1"></a>beta_iter <span class="ot">&lt;-</span> beta_2sls</span>
<span id="cb75-204"><a href="#cb75-204" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb75-205"><a href="#cb75-205" aria-hidden="true" tabindex="-1"></a>  e_s <span class="ot">&lt;-</span> Y <span class="sc">-</span> Xmat <span class="sc">%*%</span> beta_iter</span>
<span id="cb75-206"><a href="#cb75-206" aria-hidden="true" tabindex="-1"></a>  Omega_s <span class="ot">&lt;-</span> (<span class="fu">t</span>(Zmat2) <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="fu">as.numeric</span>(e_s<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%*%</span> Zmat2) <span class="sc">/</span> n</span>
<span id="cb75-207"><a href="#cb75-207" aria-hidden="true" tabindex="-1"></a>  W_s <span class="ot">&lt;-</span> <span class="fu">solve</span>(Omega_s)</span>
<span id="cb75-208"><a href="#cb75-208" aria-hidden="true" tabindex="-1"></a>  beta_new <span class="ot">&lt;-</span> <span class="fu">gmm_linear</span>(Y, Xmat, Zmat2, W_s)</span>
<span id="cb75-209"><a href="#cb75-209" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(beta_new <span class="sc">-</span> beta_iter)) <span class="sc">&lt;</span> <span class="fl">1e-8</span>) {</span>
<span id="cb75-210"><a href="#cb75-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Converged in"</span>, s, <span class="st">"iterations</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-211"><a href="#cb75-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb75-212"><a href="#cb75-212" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-213"><a href="#cb75-213" aria-hidden="true" tabindex="-1"></a>  beta_iter <span class="ot">&lt;-</span> beta_new</span>
<span id="cb75-214"><a href="#cb75-214" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-215"><a href="#cb75-215" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Iterated GMM slope:"</span>, <span class="fu">round</span>(beta_iter[<span class="dv">2</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-216"><a href="#cb75-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-217"><a href="#cb75-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-218"><a href="#cb75-218" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using the gmm package</span></span>
<span id="cb75-219"><a href="#cb75-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-220"><a href="#cb75-220" aria-hidden="true" tabindex="-1"></a>The <span class="in">`gmm`</span> package handles moment function specification, weighting, and inference. For a linear IV model, we can pass the formula directly:</span>
<span id="cb75-221"><a href="#cb75-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-224"><a href="#cb75-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-225"><a href="#cb75-225" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-package-linear</span></span>
<span id="cb75-226"><a href="#cb75-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear IV via gmm()</span></span>
<span id="cb75-227"><a href="#cb75-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Formula: Y ~ X | Z  (endogenous ~ instruments)</span></span>
<span id="cb75-228"><a href="#cb75-228" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Y =</span> Y, <span class="at">X =</span> X, <span class="at">Z1 =</span> Z, <span class="at">Z2 =</span> Z2)</span>
<span id="cb75-229"><a href="#cb75-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-230"><a href="#cb75-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Two-step GMM</span></span>
<span id="cb75-231"><a href="#cb75-231" aria-hidden="true" tabindex="-1"></a>fit_2step <span class="ot">&lt;-</span> <span class="fu">gmm</span>(Y <span class="sc">~</span> X, <span class="sc">~</span> Z1 <span class="sc">+</span> Z2, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"twoStep"</span>)</span>
<span id="cb75-232"><a href="#cb75-232" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_2step)</span>
<span id="cb75-233"><a href="#cb75-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-234"><a href="#cb75-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-235"><a href="#cb75-235" aria-hidden="true" tabindex="-1"></a>Compare to the iterative version:</span>
<span id="cb75-236"><a href="#cb75-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-239"><a href="#cb75-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-240"><a href="#cb75-240" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-iterative</span></span>
<span id="cb75-241"><a href="#cb75-241" aria-hidden="true" tabindex="-1"></a>fit_iter <span class="ot">&lt;-</span> <span class="fu">gmm</span>(Y <span class="sc">~</span> X, <span class="sc">~</span> Z1 <span class="sc">+</span> Z2, <span class="at">data =</span> dat, <span class="at">type =</span> <span class="st">"iterative"</span>)</span>
<span id="cb75-242"><a href="#cb75-242" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Two-step slope:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_2step)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-243"><a href="#cb75-243" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Iterated slope:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_iter)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-244"><a href="#cb75-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-245"><a href="#cb75-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-246"><a href="#cb75-246" aria-hidden="true" tabindex="-1"></a>And verify against <span class="in">`iv_robust`</span> (which computes 2SLS):</span>
<span id="cb75-247"><a href="#cb75-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-250"><a href="#cb75-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-251"><a href="#cb75-251" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compare-iv-robust</span></span>
<span id="cb75-252"><a href="#cb75-252" aria-hidden="true" tabindex="-1"></a>fit_iv <span class="ot">&lt;-</span> <span class="fu">iv_robust</span>(Y <span class="sc">~</span> X <span class="sc">|</span> Z1 <span class="sc">+</span> Z2, <span class="at">data =</span> dat)</span>
<span id="cb75-253"><a href="#cb75-253" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"2SLS (iv_robust):"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_iv)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-254"><a href="#cb75-254" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Two-step GMM:    "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_2step)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-255"><a href="#cb75-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-256"><a href="#cb75-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-257"><a href="#cb75-257" aria-hidden="true" tabindex="-1"></a>Under homoskedasticity, 2SLS and efficient GMM give the same estimates (Hansen Thm 13.6). The differences here arise because we simulated heteroskedastic-style errors.</span>
<span id="cb75-258"><a href="#cb75-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-259"><a href="#cb75-259" aria-hidden="true" tabindex="-1"></a><span class="fu">## When does efficient GMM help? A simulation</span></span>
<span id="cb75-260"><a href="#cb75-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-261"><a href="#cb75-261" aria-hidden="true" tabindex="-1"></a>2SLS is efficient only under homoskedasticity. Under heteroskedasticity, efficient GMM can reduce variance. Let's demonstrate with a Monte Carlo:</span>
<span id="cb75-262"><a href="#cb75-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-265"><a href="#cb75-265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-266"><a href="#cb75-266" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: efficiency-sim</span></span>
<span id="cb75-267"><a href="#cb75-267" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb75-268"><a href="#cb75-268" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb75-269"><a href="#cb75-269" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb75-270"><a href="#cb75-270" aria-hidden="true" tabindex="-1"></a>beta_true <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb75-271"><a href="#cb75-271" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="fu">character</span>(), <span class="at">estimate =</span> <span class="fu">numeric</span>())</span>
<span id="cb75-272"><a href="#cb75-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-273"><a href="#cb75-273" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb75-274"><a href="#cb75-274" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-275"><a href="#cb75-275" aria-hidden="true" tabindex="-1"></a>  z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-276"><a href="#cb75-276" aria-hidden="true" tabindex="-1"></a>  z2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-277"><a href="#cb75-277" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2 <span class="sc">+</span> u</span>
<span id="cb75-278"><a href="#cb75-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-279"><a href="#cb75-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Heteroskedastic errors: variance depends on z1</span></span>
<span id="cb75-280"><a href="#cb75-280" aria-hidden="true" tabindex="-1"></a>  sigma_i <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fu">abs</span>(z1)</span>
<span id="cb75-281"><a href="#cb75-281" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> sigma_i <span class="sc">*</span> <span class="fu">rnorm</span>(n_sim) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> u</span>
<span id="cb75-282"><a href="#cb75-282" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> beta_true <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb75-283"><a href="#cb75-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-284"><a href="#cb75-284" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2)</span>
<span id="cb75-285"><a href="#cb75-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-286"><a href="#cb75-286" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2SLS</span></span>
<span id="cb75-287"><a href="#cb75-287" aria-hidden="true" tabindex="-1"></a>  iv_fit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb75-288"><a href="#cb75-288" aria-hidden="true" tabindex="-1"></a>    <span class="fu">iv_robust</span>(y <span class="sc">~</span> x <span class="sc">|</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d, <span class="at">se_type =</span> <span class="st">"classical"</span>),</span>
<span id="cb75-289"><a href="#cb75-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb75-290"><a href="#cb75-290" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-291"><a href="#cb75-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-292"><a href="#cb75-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Two-step GMM</span></span>
<span id="cb75-293"><a href="#cb75-293" aria-hidden="true" tabindex="-1"></a>  gmm_fit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb75-294"><a href="#cb75-294" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gmm</span>(y <span class="sc">~</span> x, <span class="sc">~</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d, <span class="at">type =</span> <span class="st">"twoStep"</span>),</span>
<span id="cb75-295"><a href="#cb75-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb75-296"><a href="#cb75-296" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-297"><a href="#cb75-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-298"><a href="#cb75-298" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(iv_fit) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(gmm_fit)) {</span>
<span id="cb75-299"><a href="#cb75-299" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results,</span>
<span id="cb75-300"><a href="#cb75-300" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"2SLS"</span>, <span class="at">estimate =</span> <span class="fu">coef</span>(iv_fit)[<span class="st">"x"</span>]),</span>
<span id="cb75-301"><a href="#cb75-301" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"Efficient GMM"</span>, <span class="at">estimate =</span> <span class="fu">coef</span>(gmm_fit)[<span class="st">"x"</span>])</span>
<span id="cb75-302"><a href="#cb75-302" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-303"><a href="#cb75-303" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-304"><a href="#cb75-304" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-305"><a href="#cb75-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-306"><a href="#cb75-306" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variances</span></span>
<span id="cb75-307"><a href="#cb75-307" aria-hidden="true" tabindex="-1"></a>var_table <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(estimate <span class="sc">~</span> method, <span class="at">data =</span> results,</span>
<span id="cb75-308"><a href="#cb75-308" aria-hidden="true" tabindex="-1"></a>                       <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">c</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x), <span class="at">var =</span> <span class="fu">var</span>(x)))</span>
<span id="cb75-309"><a href="#cb75-309" aria-hidden="true" tabindex="-1"></a>var_table <span class="ot">&lt;-</span> <span class="fu">cbind</span>(var_table[<span class="dv">1</span>], <span class="fu">as.data.frame</span>(var_table[[<span class="dv">2</span>]]))</span>
<span id="cb75-310"><a href="#cb75-310" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(var_table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"method"</span>, <span class="st">"mean"</span>, <span class="st">"variance"</span>)</span>
<span id="cb75-311"><a href="#cb75-311" aria-hidden="true" tabindex="-1"></a>var_table<span class="sc">$</span>efficiency_ratio <span class="ot">&lt;-</span> var_table<span class="sc">$</span>variance <span class="sc">/</span> <span class="fu">min</span>(var_table<span class="sc">$</span>variance)</span>
<span id="cb75-312"><a href="#cb75-312" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(var_table, <span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb75-313"><a href="#cb75-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-314"><a href="#cb75-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-317"><a href="#cb75-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-318"><a href="#cb75-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: efficiency-plot</span></span>
<span id="cb75-319"><a href="#cb75-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "2SLS vs. efficient GMM under heteroskedasticity"</span></span>
<span id="cb75-320"><a href="#cb75-320" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb75-321"><a href="#cb75-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb75-322"><a href="#cb75-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> beta_true, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb75-323"><a href="#cb75-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"2SLS vs efficient GMM under heteroskedasticity"</span>,</span>
<span id="cb75-324"><a href="#cb75-324" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"n = "</span>, n_sim, <span class="st">", "</span>, B, <span class="st">" replications"</span>),</span>
<span id="cb75-325"><a href="#cb75-325" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)), <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb75-326"><a href="#cb75-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb75-327"><a href="#cb75-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>))</span>
<span id="cb75-328"><a href="#cb75-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-329"><a href="#cb75-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-330"><a href="#cb75-330" aria-hidden="true" tabindex="-1"></a>Under heteroskedasticity, efficient GMM has lower variance because it weights moment conditions by the inverse of their variance---upweighting informative, low-noise moments and downweighting noisy ones. Just as the <span class="co">[</span><span class="ot">Gauss-Markov theorem</span><span class="co">](ch05-gls.qmd#thm-gauss-markov)</span> bounds OLS among linear unbiased estimators, the efficient GMM achieves the semiparametric bound among all estimators using the same moment conditions.</span>
<span id="cb75-331"><a href="#cb75-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-332"><a href="#cb75-332" aria-hidden="true" tabindex="-1"></a><span class="fu">## The J-test for overidentification {#sec-j-test}</span></span>
<span id="cb75-333"><a href="#cb75-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-334"><a href="#cb75-334" aria-hidden="true" tabindex="-1"></a>When $\ell &gt; k$ (more moment conditions than parameters), the model imposes testable restrictions. If the moment conditions are correctly specified, the minimized criterion value should be small.</span>
<span id="cb75-335"><a href="#cb75-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-336"><a href="#cb75-336" aria-hidden="true" tabindex="-1"></a>$$J = n\,\bar{g}_n(\hat\beta)'\hat\Omega^{-1}\bar{g}_n(\hat\beta) \xrightarrow{d} \chi^2_{\ell - k}$$ {#eq-j-test}</span>
<span id="cb75-337"><a href="#cb75-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-338"><a href="#cb75-338" aria-hidden="true" tabindex="-1"></a>::: {#thm-j-test}</span>
<span id="cb75-339"><a href="#cb75-339" aria-hidden="true" tabindex="-1"></a><span class="fu">## J-Test for Overidentification (Hansen 13.14)</span></span>
<span id="cb75-340"><a href="#cb75-340" aria-hidden="true" tabindex="-1"></a>Under correct specification, the minimized GMM criterion $J = n\,\bar{g}_n(\hat\beta)'\hat\Omega^{-1}\bar{g}_n(\hat\beta) \xrightarrow{d} \chi^2_{\ell - k}$, where $\ell$ is the number of moment conditions and $k$ is the number of parameters. Rejection indicates that the moment conditions are mutually inconsistent.</span>
<span id="cb75-341"><a href="#cb75-341" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-342"><a href="#cb75-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-345"><a href="#cb75-345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-346"><a href="#cb75-346" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: j-test-valid</span></span>
<span id="cb75-347"><a href="#cb75-347" aria-hidden="true" tabindex="-1"></a><span class="co"># J-test from our earlier fit (valid instruments)</span></span>
<span id="cb75-348"><a href="#cb75-348" aria-hidden="true" tabindex="-1"></a><span class="fu">specTest</span>(fit_2step)</span>
<span id="cb75-349"><a href="#cb75-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-350"><a href="#cb75-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-351"><a href="#cb75-351" aria-hidden="true" tabindex="-1"></a>Here $\ell - k = 3 - 2 = 1$ degree of freedom. A large p-value means we fail to reject: the overidentifying restrictions are consistent with the data.</span>
<span id="cb75-352"><a href="#cb75-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-353"><a href="#cb75-353" aria-hidden="true" tabindex="-1"></a><span class="fu">### When the J-test rejects</span></span>
<span id="cb75-354"><a href="#cb75-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-355"><a href="#cb75-355" aria-hidden="true" tabindex="-1"></a>If an instrument is invalid (correlated with the error), the J-test should detect this:</span>
<span id="cb75-356"><a href="#cb75-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-359"><a href="#cb75-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-360"><a href="#cb75-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: j-test-invalid</span></span>
<span id="cb75-361"><a href="#cb75-361" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb75-362"><a href="#cb75-362" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb75-363"><a href="#cb75-363" aria-hidden="true" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb75-364"><a href="#cb75-364" aria-hidden="true" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb75-365"><a href="#cb75-365" aria-hidden="true" tabindex="-1"></a>z2_bad <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb75-366"><a href="#cb75-366" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2_bad <span class="sc">+</span> u</span>
<span id="cb75-367"><a href="#cb75-367" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> z2_bad <span class="sc">+</span> <span class="fu">rnorm</span>(n)  <span class="co"># z2_bad enters the error!</span></span>
<span id="cb75-368"><a href="#cb75-368" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb75-369"><a href="#cb75-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-370"><a href="#cb75-370" aria-hidden="true" tabindex="-1"></a>d_bad <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2_bad)</span>
<span id="cb75-371"><a href="#cb75-371" aria-hidden="true" tabindex="-1"></a>fit_bad <span class="ot">&lt;-</span> <span class="fu">gmm</span>(y <span class="sc">~</span> x, <span class="sc">~</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d_bad, <span class="at">type =</span> <span class="st">"twoStep"</span>)</span>
<span id="cb75-372"><a href="#cb75-372" aria-hidden="true" tabindex="-1"></a><span class="fu">specTest</span>(fit_bad)</span>
<span id="cb75-373"><a href="#cb75-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-374"><a href="#cb75-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-375"><a href="#cb75-375" aria-hidden="true" tabindex="-1"></a>The J-test has a limitation: if all instruments are invalid in the same direction, the test may not detect the problem. It tests whether the instruments *disagree* with each other, not whether any individual instrument is valid.</span>
<span id="cb75-376"><a href="#cb75-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-377"><a href="#cb75-377" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb75-378"><a href="#cb75-378" aria-hidden="true" tabindex="-1"></a><span class="fu">## J-Test Limitations</span></span>
<span id="cb75-379"><a href="#cb75-379" aria-hidden="true" tabindex="-1"></a>The J-test only detects when instruments *disagree* with each other. If all instruments are invalid in the same direction, the test has no power. It tests internal consistency of the overidentifying restrictions, not the validity of any individual instrument.</span>
<span id="cb75-380"><a href="#cb75-380" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-381"><a href="#cb75-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-382"><a href="#cb75-382" aria-hidden="true" tabindex="-1"></a><span class="fu">### J-test rejection rates by simulation</span></span>
<span id="cb75-383"><a href="#cb75-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-384"><a href="#cb75-384" aria-hidden="true" tabindex="-1"></a>Let's verify the J-test has correct size (under valid instruments) and power (under an invalid instrument):</span>
<span id="cb75-385"><a href="#cb75-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-388"><a href="#cb75-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-389"><a href="#cb75-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: j-test-sim</span></span>
<span id="cb75-390"><a href="#cb75-390" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb75-391"><a href="#cb75-391" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb75-392"><a href="#cb75-392" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb75-393"><a href="#cb75-393" aria-hidden="true" tabindex="-1"></a>rejections <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">scenario =</span> <span class="fu">character</span>(), <span class="at">rejected =</span> <span class="fu">logical</span>())</span>
<span id="cb75-394"><a href="#cb75-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-395"><a href="#cb75-395" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"valid"</span>, <span class="st">"invalid"</span>)) {</span>
<span id="cb75-396"><a href="#cb75-396" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb75-397"><a href="#cb75-397" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-398"><a href="#cb75-398" aria-hidden="true" tabindex="-1"></a>    z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-399"><a href="#cb75-399" aria-hidden="true" tabindex="-1"></a>    z2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-400"><a href="#cb75-400" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fl">0.6</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2 <span class="sc">+</span> u</span>
<span id="cb75-401"><a href="#cb75-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-402"><a href="#cb75-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scenario <span class="sc">==</span> <span class="st">"valid"</span>) {</span>
<span id="cb75-403"><a href="#cb75-403" aria-hidden="true" tabindex="-1"></a>      e <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb75-404"><a href="#cb75-404" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb75-405"><a href="#cb75-405" aria-hidden="true" tabindex="-1"></a>      e <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> u <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> z2 <span class="sc">+</span> <span class="fu">rnorm</span>(n_sim)  <span class="co"># z2 in error</span></span>
<span id="cb75-406"><a href="#cb75-406" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-407"><a href="#cb75-407" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb75-408"><a href="#cb75-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-409"><a href="#cb75-409" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2)</span>
<span id="cb75-410"><a href="#cb75-410" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">gmm</span>(y <span class="sc">~</span> x, <span class="sc">~</span> z1 <span class="sc">+</span> z2, <span class="at">data =</span> d, <span class="at">type =</span> <span class="st">"twoStep"</span>),</span>
<span id="cb75-411"><a href="#cb75-411" aria-hidden="true" tabindex="-1"></a>                    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb75-412"><a href="#cb75-412" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fit)) {</span>
<span id="cb75-413"><a href="#cb75-413" aria-hidden="true" tabindex="-1"></a>      jtest <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">specTest</span>(fit), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb75-414"><a href="#cb75-414" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(jtest)) {</span>
<span id="cb75-415"><a href="#cb75-415" aria-hidden="true" tabindex="-1"></a>        pval <span class="ot">&lt;-</span> jtest<span class="sc">$</span>test[<span class="dv">1</span>, <span class="dv">2</span>]  <span class="co"># p-value</span></span>
<span id="cb75-416"><a href="#cb75-416" aria-hidden="true" tabindex="-1"></a>        rejections <span class="ot">&lt;-</span> <span class="fu">rbind</span>(rejections,</span>
<span id="cb75-417"><a href="#cb75-417" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>(<span class="at">scenario =</span> scenario, <span class="at">rejected =</span> pval <span class="sc">&lt;</span> <span class="fl">0.05</span>))</span>
<span id="cb75-418"><a href="#cb75-418" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb75-419"><a href="#cb75-419" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-420"><a href="#cb75-420" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-421"><a href="#cb75-421" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-422"><a href="#cb75-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-423"><a href="#cb75-423" aria-hidden="true" tabindex="-1"></a>rej_rates <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(rejected <span class="sc">~</span> scenario, <span class="at">data =</span> rejections, mean)</span>
<span id="cb75-424"><a href="#cb75-424" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rej_rates)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"rejection_rate"</span></span>
<span id="cb75-425"><a href="#cb75-425" aria-hidden="true" tabindex="-1"></a>rej_rates</span>
<span id="cb75-426"><a href="#cb75-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-427"><a href="#cb75-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-428"><a href="#cb75-428" aria-hidden="true" tabindex="-1"></a>Under valid instruments, the rejection rate should be near 0.05 (the nominal size). Under the invalid instrument, the rejection rate should be substantially higher.</span>
<span id="cb75-429"><a href="#cb75-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-430"><a href="#cb75-430" aria-hidden="true" tabindex="-1"></a><span class="fu">## Nonlinear GMM: custom moment functions</span></span>
<span id="cb75-431"><a href="#cb75-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-432"><a href="#cb75-432" aria-hidden="true" tabindex="-1"></a>The <span class="in">`gmm`</span> package also accepts user-defined moment functions for nonlinear models. The moment function takes parameters $\theta$ and data $x$, and returns an $n \times \ell$ matrix of moment contributions.</span>
<span id="cb75-433"><a href="#cb75-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-434"><a href="#cb75-434" aria-hidden="true" tabindex="-1"></a>Here's a simple example: estimating the mean and variance of a distribution simultaneously using moment conditions $\mathbb{E}<span class="co">[</span><span class="ot">Y - \mu</span><span class="co">]</span> = 0$ and $\mathbb{E}<span class="co">[</span><span class="ot">(Y - \mu)^2 - \sigma^2</span><span class="co">]</span> = 0$:</span>
<span id="cb75-435"><a href="#cb75-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-438"><a href="#cb75-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-439"><a href="#cb75-439" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nonlinear-moments</span></span>
<span id="cb75-440"><a href="#cb75-440" aria-hidden="true" tabindex="-1"></a><span class="co"># Moment function: E[Y - mu] = 0 and E[(Y - mu)^2 - sigma2] = 0</span></span>
<span id="cb75-441"><a href="#cb75-441" aria-hidden="true" tabindex="-1"></a>g_meanvar <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb75-442"><a href="#cb75-442" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> theta[<span class="dv">1</span>]</span>
<span id="cb75-443"><a href="#cb75-443" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="ot">&lt;-</span> theta[<span class="dv">2</span>]</span>
<span id="cb75-444"><a href="#cb75-444" aria-hidden="true" tabindex="-1"></a>  m1 <span class="ot">&lt;-</span> x <span class="sc">-</span> mu</span>
<span id="cb75-445"><a href="#cb75-445" aria-hidden="true" tabindex="-1"></a>  m2 <span class="ot">&lt;-</span> (x <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> sigma2</span>
<span id="cb75-446"><a href="#cb75-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(m1, m2)  <span class="co"># n x 2 matrix</span></span>
<span id="cb75-447"><a href="#cb75-447" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-448"><a href="#cb75-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-449"><a href="#cb75-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb75-450"><a href="#cb75-450" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb75-451"><a href="#cb75-451" aria-hidden="true" tabindex="-1"></a>y_data <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="at">mean =</span> <span class="dv">3</span>, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb75-452"><a href="#cb75-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-453"><a href="#cb75-453" aria-hidden="true" tabindex="-1"></a><span class="co"># GMM estimation (just-identified: 2 moments, 2 parameters)</span></span>
<span id="cb75-454"><a href="#cb75-454" aria-hidden="true" tabindex="-1"></a>fit_mv <span class="ot">&lt;-</span> <span class="fu">gmm</span>(g_meanvar, <span class="at">x =</span> y_data, <span class="at">t0 =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb75-455"><a href="#cb75-455" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM estimates:  mu ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_mv)[<span class="dv">1</span>], <span class="dv">3</span>),</span>
<span id="cb75-456"><a href="#cb75-456" aria-hidden="true" tabindex="-1"></a>    <span class="st">" sigma2 ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fit_mv)[<span class="dv">2</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-457"><a href="#cb75-457" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample moments: mean ="</span>, <span class="fu">round</span>(<span class="fu">mean</span>(y_data), <span class="dv">3</span>),</span>
<span id="cb75-458"><a href="#cb75-458" aria-hidden="true" tabindex="-1"></a>    <span class="st">" var ="</span>, <span class="fu">round</span>(<span class="fu">var</span>(y_data) <span class="sc">*</span> (<span class="dv">200-1</span>)<span class="sc">/</span><span class="dv">200</span>, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-459"><a href="#cb75-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-460"><a href="#cb75-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-461"><a href="#cb75-461" aria-hidden="true" tabindex="-1"></a>The GMM estimates match the sample moments exactly because this is a just-identified model.</span>
<span id="cb75-462"><a href="#cb75-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-463"><a href="#cb75-463" aria-hidden="true" tabindex="-1"></a><span class="fu">## Application: missing data and GMM</span></span>
<span id="cb75-464"><a href="#cb75-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-465"><a href="#cb75-465" aria-hidden="true" tabindex="-1"></a>This section implements the Abrevaya &amp; Donald (2017) approach to missing data using GMM. The idea is to exploit moment conditions from *both* complete and incomplete observations.</span>
<span id="cb75-466"><a href="#cb75-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-467"><a href="#cb75-467" aria-hidden="true" tabindex="-1"></a><span class="fu">### The setup</span></span>
<span id="cb75-468"><a href="#cb75-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-469"><a href="#cb75-469" aria-hidden="true" tabindex="-1"></a>Suppose we want to estimate:</span>
<span id="cb75-470"><a href="#cb75-470" aria-hidden="true" tabindex="-1"></a>$$y_i = \beta_0 + \alpha \cdot x_i + \beta_1 \cdot z_i + \varepsilon_i$$</span>
<span id="cb75-471"><a href="#cb75-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-472"><a href="#cb75-472" aria-hidden="true" tabindex="-1"></a>where $x_i$ is sometimes missing but $z_i$ is always observed. If $x_i$ has a linear projection on $z_i$:</span>
<span id="cb75-473"><a href="#cb75-473" aria-hidden="true" tabindex="-1"></a>$$x_i = \gamma_0 + \gamma_1 \cdot z_i + \xi_i$$</span>
<span id="cb75-474"><a href="#cb75-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-475"><a href="#cb75-475" aria-hidden="true" tabindex="-1"></a>then for observations where $x_i$ is missing, we can substitute:</span>
<span id="cb75-476"><a href="#cb75-476" aria-hidden="true" tabindex="-1"></a>$$y_i = (\beta_0 + \alpha\gamma_0) + (\beta_1 + \alpha\gamma_1) z_i + (\varepsilon_i + \alpha\xi_i)$$</span>
<span id="cb75-477"><a href="#cb75-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-478"><a href="#cb75-478" aria-hidden="true" tabindex="-1"></a>This gives us three blocks of moment conditions---and more conditions than parameters (overidentification).</span>
<span id="cb75-479"><a href="#cb75-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-480"><a href="#cb75-480" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulating the WLS-like data</span></span>
<span id="cb75-481"><a href="#cb75-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-482"><a href="#cb75-482" aria-hidden="true" tabindex="-1"></a>We simulate data similar to the Wisconsin Longitudinal Study, where education ($y$) depends on a BMI-related rating ($x$, sometimes missing) and IQ ($z$, always observed):</span>
<span id="cb75-483"><a href="#cb75-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-486"><a href="#cb75-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-487"><a href="#cb75-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: missing-data-sim</span></span>
<span id="cb75-488"><a href="#cb75-488" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">314</span>)</span>
<span id="cb75-489"><a href="#cb75-489" aria-hidden="true" tabindex="-1"></a>n_wls <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb75-490"><a href="#cb75-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-491"><a href="#cb75-491" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb75-492"><a href="#cb75-492" aria-hidden="true" tabindex="-1"></a>beta_0_true <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb75-493"><a href="#cb75-493" aria-hidden="true" tabindex="-1"></a>alpha_true <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.04</span></span>
<span id="cb75-494"><a href="#cb75-494" aria-hidden="true" tabindex="-1"></a>beta_iq_true <span class="ot">&lt;-</span> <span class="fl">0.06</span></span>
<span id="cb75-495"><a href="#cb75-495" aria-hidden="true" tabindex="-1"></a>gamma_0_true <span class="ot">&lt;-</span> <span class="fl">3.5</span></span>
<span id="cb75-496"><a href="#cb75-496" aria-hidden="true" tabindex="-1"></a>gamma_iq_true <span class="ot">&lt;-</span> <span class="fl">0.005</span></span>
<span id="cb75-497"><a href="#cb75-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-498"><a href="#cb75-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb75-499"><a href="#cb75-499" aria-hidden="true" tabindex="-1"></a>iq <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_wls, <span class="at">mean =</span> <span class="dv">100</span>, <span class="at">sd =</span> <span class="dv">15</span>)</span>
<span id="cb75-500"><a href="#cb75-500" aria-hidden="true" tabindex="-1"></a>xi <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_wls, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb75-501"><a href="#cb75-501" aria-hidden="true" tabindex="-1"></a>bmi <span class="ot">&lt;-</span> gamma_0_true <span class="sc">+</span> gamma_iq_true <span class="sc">*</span> iq <span class="sc">+</span> xi</span>
<span id="cb75-502"><a href="#cb75-502" aria-hidden="true" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_wls, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb75-503"><a href="#cb75-503" aria-hidden="true" tabindex="-1"></a>educ <span class="ot">&lt;-</span> beta_0_true <span class="sc">+</span> alpha_true <span class="sc">*</span> bmi <span class="sc">+</span> beta_iq_true <span class="sc">*</span> iq <span class="sc">+</span> eps</span>
<span id="cb75-504"><a href="#cb75-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-505"><a href="#cb75-505" aria-hidden="true" tabindex="-1"></a><span class="co"># Missingness: depends on iq (MAR) but not on eps or xi</span></span>
<span id="cb75-506"><a href="#cb75-506" aria-hidden="true" tabindex="-1"></a>prob_missing <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> iq)  <span class="co"># ~20% missing overall</span></span>
<span id="cb75-507"><a href="#cb75-507" aria-hidden="true" tabindex="-1"></a>missing <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_wls, <span class="dv">1</span>, prob_missing)</span>
<span id="cb75-508"><a href="#cb75-508" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fraction missing:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(missing), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-509"><a href="#cb75-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-510"><a href="#cb75-510" aria-hidden="true" tabindex="-1"></a><span class="co"># Set bmi to 0 for missing observations (placeholder)</span></span>
<span id="cb75-511"><a href="#cb75-511" aria-hidden="true" tabindex="-1"></a>bmi_obs <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(missing <span class="sc">==</span> <span class="dv">0</span>, bmi, <span class="dv">0</span>)</span>
<span id="cb75-512"><a href="#cb75-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-513"><a href="#cb75-513" aria-hidden="true" tabindex="-1"></a>wls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">educ =</span> educ, <span class="at">bmi =</span> bmi_obs, <span class="at">iq =</span> iq, <span class="at">bmimissing =</span> missing)</span>
<span id="cb75-514"><a href="#cb75-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-515"><a href="#cb75-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-516"><a href="#cb75-516" aria-hidden="true" tabindex="-1"></a><span class="fu">### Complete case and dummy variable approaches</span></span>
<span id="cb75-517"><a href="#cb75-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-520"><a href="#cb75-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-521"><a href="#cb75-521" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: complete-case</span></span>
<span id="cb75-522"><a href="#cb75-522" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete case: drop missing observations</span></span>
<span id="cb75-523"><a href="#cb75-523" aria-hidden="true" tabindex="-1"></a>cc_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ <span class="sc">~</span> bmi <span class="sc">+</span> iq, <span class="at">data =</span> <span class="fu">subset</span>(wls, bmimissing <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb75-524"><a href="#cb75-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-525"><a href="#cb75-525" aria-hidden="true" tabindex="-1"></a><span class="co"># Dummy variable: fill in 0, add missing indicator</span></span>
<span id="cb75-526"><a href="#cb75-526" aria-hidden="true" tabindex="-1"></a>dv_fit <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(educ <span class="sc">~</span> bmi <span class="sc">+</span> iq <span class="sc">+</span> bmimissing, <span class="at">data =</span> wls)</span>
<span id="cb75-527"><a href="#cb75-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-528"><a href="#cb75-528" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Complete case:   alpha ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cc_fit)[<span class="st">"bmi"</span>], <span class="dv">4</span>),</span>
<span id="cb75-529"><a href="#cb75-529" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE ="</span>, <span class="fu">round</span>(<span class="fu">summary</span>(cc_fit)<span class="sc">$</span>coefficients[<span class="st">"bmi"</span>, <span class="st">"Std. Error"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-530"><a href="#cb75-530" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dummy variable:  alpha ="</span>, <span class="fu">round</span>(<span class="fu">coef</span>(dv_fit)[<span class="st">"bmi"</span>], <span class="dv">4</span>),</span>
<span id="cb75-531"><a href="#cb75-531" aria-hidden="true" tabindex="-1"></a>    <span class="st">" SE ="</span>, <span class="fu">round</span>(dv_fit<span class="sc">$</span>std.error[<span class="st">"bmi"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-532"><a href="#cb75-532" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True alpha:     "</span>, alpha_true, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-533"><a href="#cb75-533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-534"><a href="#cb75-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-535"><a href="#cb75-535" aria-hidden="true" tabindex="-1"></a><span class="fu">### GMM with three blocks of moment conditions</span></span>
<span id="cb75-536"><a href="#cb75-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-537"><a href="#cb75-537" aria-hidden="true" tabindex="-1"></a>Now we implement the Abrevaya &amp; Donald GMM estimator. The five parameters are $\theta = (\beta_0, \alpha, \beta_{iq}, \gamma_0, \gamma_{iq})$ and we have seven moment conditions:</span>
<span id="cb75-538"><a href="#cb75-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-541"><a href="#cb75-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-542"><a href="#cb75-542" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-moment-function</span></span>
<span id="cb75-543"><a href="#cb75-543" aria-hidden="true" tabindex="-1"></a><span class="co"># Moment function: 7 conditions for 5 parameters</span></span>
<span id="cb75-544"><a href="#cb75-544" aria-hidden="true" tabindex="-1"></a>g_missing <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb75-545"><a href="#cb75-545" aria-hidden="true" tabindex="-1"></a>  beta_0  <span class="ot">&lt;-</span> theta[<span class="dv">1</span>]</span>
<span id="cb75-546"><a href="#cb75-546" aria-hidden="true" tabindex="-1"></a>  alpha   <span class="ot">&lt;-</span> theta[<span class="dv">2</span>]</span>
<span id="cb75-547"><a href="#cb75-547" aria-hidden="true" tabindex="-1"></a>  beta_iq <span class="ot">&lt;-</span> theta[<span class="dv">3</span>]</span>
<span id="cb75-548"><a href="#cb75-548" aria-hidden="true" tabindex="-1"></a>  gamma_0 <span class="ot">&lt;-</span> theta[<span class="dv">4</span>]</span>
<span id="cb75-549"><a href="#cb75-549" aria-hidden="true" tabindex="-1"></a>  gamma_iq <span class="ot">&lt;-</span> theta[<span class="dv">5</span>]</span>
<span id="cb75-550"><a href="#cb75-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-551"><a href="#cb75-551" aria-hidden="true" tabindex="-1"></a>  educ <span class="ot">&lt;-</span> x[, <span class="dv">1</span>]</span>
<span id="cb75-552"><a href="#cb75-552" aria-hidden="true" tabindex="-1"></a>  bmi  <span class="ot">&lt;-</span> x[, <span class="dv">2</span>]</span>
<span id="cb75-553"><a href="#cb75-553" aria-hidden="true" tabindex="-1"></a>  iq   <span class="ot">&lt;-</span> x[, <span class="dv">3</span>]</span>
<span id="cb75-554"><a href="#cb75-554" aria-hidden="true" tabindex="-1"></a>  m    <span class="ot">&lt;-</span> x[, <span class="dv">4</span>]  <span class="co"># missing indicator</span></span>
<span id="cb75-555"><a href="#cb75-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-556"><a href="#cb75-556" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block 1: structural equation, observed cases only</span></span>
<span id="cb75-557"><a href="#cb75-557" aria-hidden="true" tabindex="-1"></a>  resid1 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> m) <span class="sc">*</span> (educ <span class="sc">-</span> beta_0 <span class="sc">-</span> alpha <span class="sc">*</span> bmi <span class="sc">-</span> beta_iq <span class="sc">*</span> iq)</span>
<span id="cb75-558"><a href="#cb75-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-559"><a href="#cb75-559" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block 2: projection equation, observed cases only</span></span>
<span id="cb75-560"><a href="#cb75-560" aria-hidden="true" tabindex="-1"></a>  resid2 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> m) <span class="sc">*</span> (bmi <span class="sc">-</span> gamma_0 <span class="sc">-</span> gamma_iq <span class="sc">*</span> iq)</span>
<span id="cb75-561"><a href="#cb75-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-562"><a href="#cb75-562" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Block 3: substituted equation, missing cases only</span></span>
<span id="cb75-563"><a href="#cb75-563" aria-hidden="true" tabindex="-1"></a>  resid3 <span class="ot">&lt;-</span> m <span class="sc">*</span> (educ <span class="sc">-</span> (gamma_0 <span class="sc">*</span> alpha <span class="sc">+</span> beta_0) <span class="sc">-</span> (gamma_iq <span class="sc">*</span> alpha <span class="sc">+</span> beta_iq) <span class="sc">*</span> iq)</span>
<span id="cb75-564"><a href="#cb75-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-565"><a href="#cb75-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(</span>
<span id="cb75-566"><a href="#cb75-566" aria-hidden="true" tabindex="-1"></a>    resid1,              <span class="co"># m1: E[(1-m)(y - b0 - a*x - b1*z)] = 0</span></span>
<span id="cb75-567"><a href="#cb75-567" aria-hidden="true" tabindex="-1"></a>    resid1 <span class="sc">*</span> bmi,        <span class="co"># m2: E[(1-m)(y - ...)*x] = 0</span></span>
<span id="cb75-568"><a href="#cb75-568" aria-hidden="true" tabindex="-1"></a>    resid1 <span class="sc">*</span> iq,         <span class="co"># m3: E[(1-m)(y - ...)*z] = 0</span></span>
<span id="cb75-569"><a href="#cb75-569" aria-hidden="true" tabindex="-1"></a>    resid2,              <span class="co"># m4: E[(1-m)(x - g0 - g1*z)] = 0</span></span>
<span id="cb75-570"><a href="#cb75-570" aria-hidden="true" tabindex="-1"></a>    resid2 <span class="sc">*</span> iq,         <span class="co"># m5: E[(1-m)(x - ...)*z] = 0</span></span>
<span id="cb75-571"><a href="#cb75-571" aria-hidden="true" tabindex="-1"></a>    resid3,              <span class="co"># m6: E[m(y - delta'z)] = 0</span></span>
<span id="cb75-572"><a href="#cb75-572" aria-hidden="true" tabindex="-1"></a>    resid3 <span class="sc">*</span> iq          <span class="co"># m7: E[m(y - delta'z)*z] = 0</span></span>
<span id="cb75-573"><a href="#cb75-573" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-574"><a href="#cb75-574" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-575"><a href="#cb75-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-576"><a href="#cb75-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-577"><a href="#cb75-577" aria-hidden="true" tabindex="-1"></a>The instruments for each block multiply the residuals: Block 1 uses $(1, x, z)$, Block 2 uses $(1, z)$, Block 3 uses $(1, z)$. Total: $3 + 2 + 2 = 7$ moment conditions for 5 parameters, giving us **2 overidentifying restrictions**.</span>
<span id="cb75-578"><a href="#cb75-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-579"><a href="#cb75-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### Starting values and estimation</span></span>
<span id="cb75-580"><a href="#cb75-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-581"><a href="#cb75-581" aria-hidden="true" tabindex="-1"></a>Good starting values help the optimizer. We use complete-case regressions:</span>
<span id="cb75-582"><a href="#cb75-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-585"><a href="#cb75-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-586"><a href="#cb75-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-starting-values</span></span>
<span id="cb75-587"><a href="#cb75-587" aria-hidden="true" tabindex="-1"></a><span class="co"># Starting values from complete cases</span></span>
<span id="cb75-588"><a href="#cb75-588" aria-hidden="true" tabindex="-1"></a>cc_reg <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ <span class="sc">~</span> bmi <span class="sc">+</span> iq, <span class="at">data =</span> <span class="fu">subset</span>(wls, bmimissing <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb75-589"><a href="#cb75-589" aria-hidden="true" tabindex="-1"></a>proj_reg <span class="ot">&lt;-</span> <span class="fu">lm</span>(bmi <span class="sc">~</span> iq, <span class="at">data =</span> <span class="fu">subset</span>(wls, bmimissing <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb75-590"><a href="#cb75-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-591"><a href="#cb75-591" aria-hidden="true" tabindex="-1"></a>start_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb75-592"><a href="#cb75-592" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_0   =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_reg)[<span class="st">"(Intercept)"</span>]),</span>
<span id="cb75-593"><a href="#cb75-593" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha    =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_reg)[<span class="st">"bmi"</span>]),</span>
<span id="cb75-594"><a href="#cb75-594" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_iq  =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_reg)[<span class="st">"iq"</span>]),</span>
<span id="cb75-595"><a href="#cb75-595" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma_0  =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_reg)[<span class="st">"(Intercept)"</span>]),</span>
<span id="cb75-596"><a href="#cb75-596" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma_iq =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_reg)[<span class="st">"iq"</span>])</span>
<span id="cb75-597"><a href="#cb75-597" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-598"><a href="#cb75-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-599"><a href="#cb75-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-602"><a href="#cb75-602" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-603"><a href="#cb75-603" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-estimation</span></span>
<span id="cb75-604"><a href="#cb75-604" aria-hidden="true" tabindex="-1"></a><span class="co"># Data matrix</span></span>
<span id="cb75-605"><a href="#cb75-605" aria-hidden="true" tabindex="-1"></a>x_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(wls[, <span class="fu">c</span>(<span class="st">"educ"</span>, <span class="st">"bmi"</span>, <span class="st">"iq"</span>, <span class="st">"bmimissing"</span>)])</span>
<span id="cb75-606"><a href="#cb75-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-607"><a href="#cb75-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Two-step GMM</span></span>
<span id="cb75-608"><a href="#cb75-608" aria-hidden="true" tabindex="-1"></a>gmm_fit <span class="ot">&lt;-</span> <span class="fu">gmm</span>(</span>
<span id="cb75-609"><a href="#cb75-609" aria-hidden="true" tabindex="-1"></a>  g_missing,</span>
<span id="cb75-610"><a href="#cb75-610" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x_mat,</span>
<span id="cb75-611"><a href="#cb75-611" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0 =</span> start_vals,</span>
<span id="cb75-612"><a href="#cb75-612" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"twoStep"</span>,</span>
<span id="cb75-613"><a href="#cb75-613" aria-hidden="true" tabindex="-1"></a>  <span class="at">wmatrix =</span> <span class="st">"ident"</span>,</span>
<span id="cb75-614"><a href="#cb75-614" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="st">"HAC"</span></span>
<span id="cb75-615"><a href="#cb75-615" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-616"><a href="#cb75-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-617"><a href="#cb75-617" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gmm_fit)</span>
<span id="cb75-618"><a href="#cb75-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-619"><a href="#cb75-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-620"><a href="#cb75-620" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing all methods</span></span>
<span id="cb75-621"><a href="#cb75-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-624"><a href="#cb75-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-625"><a href="#cb75-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: comparison-table</span></span>
<span id="cb75-626"><a href="#cb75-626" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb75-627"><a href="#cb75-627" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"Complete Case"</span>, <span class="st">"Dummy Variable"</span>, <span class="st">"GMM"</span>),</span>
<span id="cb75-628"><a href="#cb75-628" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fu">c</span>(</span>
<span id="cb75-629"><a href="#cb75-629" aria-hidden="true" tabindex="-1"></a>    alpha_true,</span>
<span id="cb75-630"><a href="#cb75-630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(cc_fit)[<span class="st">"bmi"</span>],</span>
<span id="cb75-631"><a href="#cb75-631" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(dv_fit)[<span class="st">"bmi"</span>],</span>
<span id="cb75-632"><a href="#cb75-632" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(gmm_fit)[<span class="st">"alpha"</span>]</span>
<span id="cb75-633"><a href="#cb75-633" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb75-634"><a href="#cb75-634" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_alpha =</span> <span class="fu">c</span>(</span>
<span id="cb75-635"><a href="#cb75-635" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>,</span>
<span id="cb75-636"><a href="#cb75-636" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(cc_fit)<span class="sc">$</span>coefficients[<span class="st">"bmi"</span>, <span class="st">"Std. Error"</span>],</span>
<span id="cb75-637"><a href="#cb75-637" aria-hidden="true" tabindex="-1"></a>    dv_fit<span class="sc">$</span>std.error[<span class="st">"bmi"</span>],</span>
<span id="cb75-638"><a href="#cb75-638" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">vcov</span>(gmm_fit)[<span class="st">"alpha"</span>, <span class="st">"alpha"</span>])</span>
<span id="cb75-639"><a href="#cb75-639" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb75-640"><a href="#cb75-640" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_iq =</span> <span class="fu">c</span>(</span>
<span id="cb75-641"><a href="#cb75-641" aria-hidden="true" tabindex="-1"></a>    beta_iq_true,</span>
<span id="cb75-642"><a href="#cb75-642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(cc_fit)[<span class="st">"iq"</span>],</span>
<span id="cb75-643"><a href="#cb75-643" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(dv_fit)[<span class="st">"iq"</span>],</span>
<span id="cb75-644"><a href="#cb75-644" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(gmm_fit)[<span class="st">"beta_iq"</span>]</span>
<span id="cb75-645"><a href="#cb75-645" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-646"><a href="#cb75-646" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-647"><a href="#cb75-647" aria-hidden="true" tabindex="-1"></a>comparison<span class="sc">$</span>alpha <span class="ot">&lt;-</span> <span class="fu">round</span>(comparison<span class="sc">$</span>alpha, <span class="dv">4</span>)</span>
<span id="cb75-648"><a href="#cb75-648" aria-hidden="true" tabindex="-1"></a>comparison<span class="sc">$</span>SE_alpha <span class="ot">&lt;-</span> <span class="fu">round</span>(comparison<span class="sc">$</span>SE_alpha, <span class="dv">4</span>)</span>
<span id="cb75-649"><a href="#cb75-649" aria-hidden="true" tabindex="-1"></a>comparison<span class="sc">$</span>beta_iq <span class="ot">&lt;-</span> <span class="fu">round</span>(comparison<span class="sc">$</span>beta_iq, <span class="dv">4</span>)</span>
<span id="cb75-650"><a href="#cb75-650" aria-hidden="true" tabindex="-1"></a>comparison</span>
<span id="cb75-651"><a href="#cb75-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-652"><a href="#cb75-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-653"><a href="#cb75-653" aria-hidden="true" tabindex="-1"></a>GMM uses all observations (both complete and incomplete cases), which can improve efficiency. The complete case estimator is consistent but throws away data. The dummy variable approach can be inconsistent depending on the missingness mechanism.</span>
<span id="cb75-654"><a href="#cb75-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-655"><a href="#cb75-655" aria-hidden="true" tabindex="-1"></a><span class="fu">### J-test for the missing data model</span></span>
<span id="cb75-656"><a href="#cb75-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-657"><a href="#cb75-657" aria-hidden="true" tabindex="-1"></a>The J-test checks whether the overidentifying restrictions are satisfied---that is, whether the linear projection assumption holds equally for observed and missing subgroups:</span>
<span id="cb75-658"><a href="#cb75-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-661"><a href="#cb75-661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-662"><a href="#cb75-662" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: j-test-missing</span></span>
<span id="cb75-663"><a href="#cb75-663" aria-hidden="true" tabindex="-1"></a><span class="fu">specTest</span>(gmm_fit)</span>
<span id="cb75-664"><a href="#cb75-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-665"><a href="#cb75-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-666"><a href="#cb75-666" aria-hidden="true" tabindex="-1"></a>With 7 moments and 5 parameters, the J-test has $7 - 5 = 2$ degrees of freedom. A large p-value means we fail to reject the model specification.</span>
<span id="cb75-667"><a href="#cb75-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-668"><a href="#cb75-668" aria-hidden="true" tabindex="-1"></a><span class="fu">### Monte Carlo: comparing estimator properties</span></span>
<span id="cb75-669"><a href="#cb75-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-672"><a href="#cb75-672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-673"><a href="#cb75-673" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: missing-mc</span></span>
<span id="cb75-674"><a href="#cb75-674" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">77</span>)</span>
<span id="cb75-675"><a href="#cb75-675" aria-hidden="true" tabindex="-1"></a>B_mc <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb75-676"><a href="#cb75-676" aria-hidden="true" tabindex="-1"></a>n_mc <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb75-677"><a href="#cb75-677" aria-hidden="true" tabindex="-1"></a>mc_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="fu">character</span>(), <span class="at">alpha_hat =</span> <span class="fu">numeric</span>())</span>
<span id="cb75-678"><a href="#cb75-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-679"><a href="#cb75-679" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B_mc) {</span>
<span id="cb75-680"><a href="#cb75-680" aria-hidden="true" tabindex="-1"></a>  iq_b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="dv">100</span>, <span class="dv">15</span>)</span>
<span id="cb75-681"><a href="#cb75-681" aria-hidden="true" tabindex="-1"></a>  xi_b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc)</span>
<span id="cb75-682"><a href="#cb75-682" aria-hidden="true" tabindex="-1"></a>  bmi_b <span class="ot">&lt;-</span> gamma_0_true <span class="sc">+</span> gamma_iq_true <span class="sc">*</span> iq_b <span class="sc">+</span> xi_b</span>
<span id="cb75-683"><a href="#cb75-683" aria-hidden="true" tabindex="-1"></a>  eps_b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_mc, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb75-684"><a href="#cb75-684" aria-hidden="true" tabindex="-1"></a>  educ_b <span class="ot">&lt;-</span> beta_0_true <span class="sc">+</span> alpha_true <span class="sc">*</span> bmi_b <span class="sc">+</span> beta_iq_true <span class="sc">*</span> iq_b <span class="sc">+</span> eps_b</span>
<span id="cb75-685"><a href="#cb75-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-686"><a href="#cb75-686" aria-hidden="true" tabindex="-1"></a>  prob_m <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">0.01</span> <span class="sc">*</span> iq_b)</span>
<span id="cb75-687"><a href="#cb75-687" aria-hidden="true" tabindex="-1"></a>  m_b <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_mc, <span class="dv">1</span>, prob_m)</span>
<span id="cb75-688"><a href="#cb75-688" aria-hidden="true" tabindex="-1"></a>  bmi_obs_b <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(m_b <span class="sc">==</span> <span class="dv">0</span>, bmi_b, <span class="dv">0</span>)</span>
<span id="cb75-689"><a href="#cb75-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-690"><a href="#cb75-690" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Complete case</span></span>
<span id="cb75-691"><a href="#cb75-691" aria-hidden="true" tabindex="-1"></a>  cc_b <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ_b[m_b <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">~</span> bmi_b[m_b <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">+</span> iq_b[m_b <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb75-692"><a href="#cb75-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-693"><a href="#cb75-693" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dummy variable</span></span>
<span id="cb75-694"><a href="#cb75-694" aria-hidden="true" tabindex="-1"></a>  dv_b <span class="ot">&lt;-</span> <span class="fu">lm</span>(educ_b <span class="sc">~</span> bmi_obs_b <span class="sc">+</span> iq_b <span class="sc">+</span> m_b)</span>
<span id="cb75-695"><a href="#cb75-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-696"><a href="#cb75-696" aria-hidden="true" tabindex="-1"></a>  <span class="co"># GMM</span></span>
<span id="cb75-697"><a href="#cb75-697" aria-hidden="true" tabindex="-1"></a>  x_b <span class="ot">&lt;-</span> <span class="fu">cbind</span>(educ_b, bmi_obs_b, iq_b, m_b)</span>
<span id="cb75-698"><a href="#cb75-698" aria-hidden="true" tabindex="-1"></a>  proj_b <span class="ot">&lt;-</span> <span class="fu">lm</span>(bmi_b[m_b <span class="sc">==</span> <span class="dv">0</span>] <span class="sc">~</span> iq_b[m_b <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb75-699"><a href="#cb75-699" aria-hidden="true" tabindex="-1"></a>  start_b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta_0 =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">1</span>]),</span>
<span id="cb75-700"><a href="#cb75-700" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">2</span>]),</span>
<span id="cb75-701"><a href="#cb75-701" aria-hidden="true" tabindex="-1"></a>               <span class="at">beta_iq =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">3</span>]),</span>
<span id="cb75-702"><a href="#cb75-702" aria-hidden="true" tabindex="-1"></a>               <span class="at">gamma_0 =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_b)[<span class="dv">1</span>]),</span>
<span id="cb75-703"><a href="#cb75-703" aria-hidden="true" tabindex="-1"></a>               <span class="at">gamma_iq =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(proj_b)[<span class="dv">2</span>]))</span>
<span id="cb75-704"><a href="#cb75-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-705"><a href="#cb75-705" aria-hidden="true" tabindex="-1"></a>  gmm_b <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb75-706"><a href="#cb75-706" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gmm</span>(g_missing, <span class="at">x =</span> x_b, <span class="at">t0 =</span> start_b, <span class="at">type =</span> <span class="st">"twoStep"</span>,</span>
<span id="cb75-707"><a href="#cb75-707" aria-hidden="true" tabindex="-1"></a>        <span class="at">wmatrix =</span> <span class="st">"ident"</span>, <span class="at">vcov =</span> <span class="st">"HAC"</span>),</span>
<span id="cb75-708"><a href="#cb75-708" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb75-709"><a href="#cb75-709" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-710"><a href="#cb75-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-711"><a href="#cb75-711" aria-hidden="true" tabindex="-1"></a>  mc_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mc_results,</span>
<span id="cb75-712"><a href="#cb75-712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"Complete Case"</span>, <span class="at">alpha_hat =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(cc_b)[<span class="dv">2</span>])),</span>
<span id="cb75-713"><a href="#cb75-713" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"Dummy Variable"</span>, <span class="at">alpha_hat =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(dv_b)[<span class="dv">2</span>]))</span>
<span id="cb75-714"><a href="#cb75-714" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-715"><a href="#cb75-715" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gmm_b)) {</span>
<span id="cb75-716"><a href="#cb75-716" aria-hidden="true" tabindex="-1"></a>    mc_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mc_results,</span>
<span id="cb75-717"><a href="#cb75-717" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">method =</span> <span class="st">"GMM"</span>, <span class="at">alpha_hat =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(gmm_b)[<span class="st">"alpha"</span>])))</span>
<span id="cb75-718"><a href="#cb75-718" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-719"><a href="#cb75-719" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-720"><a href="#cb75-720" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-721"><a href="#cb75-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-724"><a href="#cb75-724" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-725"><a href="#cb75-725" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: missing-mc-results</span></span>
<span id="cb75-726"><a href="#cb75-726" aria-hidden="true" tabindex="-1"></a>mc_summary <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(alpha_hat <span class="sc">~</span> method, <span class="at">data =</span> mc_results,</span>
<span id="cb75-727"><a href="#cb75-727" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">c</span>(</span>
<span id="cb75-728"><a href="#cb75-728" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bias =</span> <span class="fu">mean</span>(x) <span class="sc">-</span> alpha_true,</span>
<span id="cb75-729"><a href="#cb75-729" aria-hidden="true" tabindex="-1"></a>                          <span class="at">variance =</span> <span class="fu">var</span>(x),</span>
<span id="cb75-730"><a href="#cb75-730" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mse =</span> <span class="fu">mean</span>((x <span class="sc">-</span> alpha_true)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb75-731"><a href="#cb75-731" aria-hidden="true" tabindex="-1"></a>                        ))</span>
<span id="cb75-732"><a href="#cb75-732" aria-hidden="true" tabindex="-1"></a>mc_summary <span class="ot">&lt;-</span> <span class="fu">cbind</span>(mc_summary[<span class="dv">1</span>], <span class="fu">round</span>(<span class="fu">as.data.frame</span>(mc_summary[[<span class="dv">2</span>]]), <span class="dv">6</span>))</span>
<span id="cb75-733"><a href="#cb75-733" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mc_summary) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Method"</span>, <span class="st">"Bias"</span>, <span class="st">"Variance"</span>, <span class="st">"MSE"</span>)</span>
<span id="cb75-734"><a href="#cb75-734" aria-hidden="true" tabindex="-1"></a>mc_summary</span>
<span id="cb75-735"><a href="#cb75-735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-736"><a href="#cb75-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-739"><a href="#cb75-739" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-740"><a href="#cb75-740" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: missing-mc-plot</span></span>
<span id="cb75-741"><a href="#cb75-741" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mc_results, <span class="fu">aes</span>(<span class="at">x =</span> alpha_hat, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb75-742"><a href="#cb75-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb75-743"><a href="#cb75-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> alpha_true, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb75-744"><a href="#cb75-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Estimator comparison with missing data"</span>,</span>
<span id="cb75-745"><a href="#cb75-745" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"True alpha = "</span>, alpha_true, <span class="st">", n = "</span>, n_mc,</span>
<span id="cb75-746"><a href="#cb75-746" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", "</span>, B_mc, <span class="st">" replications"</span>),</span>
<span id="cb75-747"><a href="#cb75-747" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(alpha)), <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb75-748"><a href="#cb75-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb75-749"><a href="#cb75-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>, <span class="st">"forestgreen"</span>))</span>
<span id="cb75-750"><a href="#cb75-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-751"><a href="#cb75-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-752"><a href="#cb75-752" aria-hidden="true" tabindex="-1"></a><span class="fu">## GMM as a unifying framework</span></span>
<span id="cb75-753"><a href="#cb75-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-754"><a href="#cb75-754" aria-hidden="true" tabindex="-1"></a>The progression through the course is a series of generalizations, each nesting the previous:</span>
<span id="cb75-755"><a href="#cb75-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-756"><a href="#cb75-756" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Estimator <span class="pp">|</span> Moment condition <span class="pp">|</span> Weight matrix <span class="pp">|</span> When efficient <span class="pp">|</span></span>
<span id="cb75-757"><a href="#cb75-757" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------|-----------------|---------------|----------------|</span></span>
<span id="cb75-758"><a href="#cb75-758" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> OLS <span class="pp">|</span> $\mathbb{E}<span class="co">[</span><span class="ot">X_i e_i</span><span class="co">]</span> = 0$ <span class="pp">|</span> $(X'X)^{-1}$ (implicit) <span class="pp">|</span> Homoskedastic, exogenous <span class="pp">|</span></span>
<span id="cb75-759"><a href="#cb75-759" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GLS <span class="pp">|</span> $\mathbb{E}<span class="co">[</span><span class="ot">\bar{X}_i \Sigma^{-1} e_i</span><span class="co">]</span> = 0$ <span class="pp">|</span> Known $\Sigma$ <span class="pp">|</span> Known error structure <span class="pp">|</span></span>
<span id="cb75-760"><a href="#cb75-760" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> IV <span class="pp">|</span> $\mathbb{E}<span class="co">[</span><span class="ot">Z_i e_i</span><span class="co">]</span> = 0$ <span class="pp">|</span> $\ell = k$ (unique) <span class="pp">|</span> Just-identified <span class="pp">|</span></span>
<span id="cb75-761"><a href="#cb75-761" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 2SLS <span class="pp">|</span> $\mathbb{E}<span class="co">[</span><span class="ot">Z_i e_i</span><span class="co">]</span> = 0$ <span class="pp">|</span> $(Z'Z)^{-1}$ <span class="pp">|</span> Homoskedastic <span class="pp">|</span></span>
<span id="cb75-762"><a href="#cb75-762" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **GMM** | $\mathbb{E}[g_i(\beta)] = 0$ | $\hat\Omega^{-1}$ | **Always** (semiparametric bound) <span class="pp">|</span></span>
<span id="cb75-763"><a href="#cb75-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-764"><a href="#cb75-764" aria-hidden="true" tabindex="-1"></a>Every test we have seen---$t$-tests, $F$-tests, Hausman tests, Sargan tests---is a special case of a GMM test, often valid under weaker assumptions.</span>
<span id="cb75-765"><a href="#cb75-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-766"><a href="#cb75-766" aria-hidden="true" tabindex="-1"></a><span class="fu">### Recovering OLS as GMM</span></span>
<span id="cb75-767"><a href="#cb75-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-770"><a href="#cb75-770" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-771"><a href="#cb75-771" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ols-as-gmm</span></span>
<span id="cb75-772"><a href="#cb75-772" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS via gmm package (instruments = regressors)</span></span>
<span id="cb75-773"><a href="#cb75-773" aria-hidden="true" tabindex="-1"></a>ols_gmm <span class="ot">&lt;-</span> <span class="fu">gmm</span>(Y <span class="sc">~</span> X, <span class="sc">~</span> X, <span class="at">data =</span> dat)</span>
<span id="cb75-774"><a href="#cb75-774" aria-hidden="true" tabindex="-1"></a>ols_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> X, <span class="at">data =</span> dat)</span>
<span id="cb75-775"><a href="#cb75-775" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"GMM (as OLS):"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(ols_gmm)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-776"><a href="#cb75-776" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"lm():        "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(ols_lm)[<span class="st">"X"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-777"><a href="#cb75-777" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-778"><a href="#cb75-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-779"><a href="#cb75-779" aria-hidden="true" tabindex="-1"></a>When the instruments are the regressors themselves ($Z = X$), the model is just-identified and GMM reduces to OLS regardless of the weight matrix.</span>
<span id="cb75-780"><a href="#cb75-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-781"><a href="#cb75-781" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connection to MTE</span></span>
<span id="cb75-782"><a href="#cb75-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-783"><a href="#cb75-783" aria-hidden="true" tabindex="-1"></a>The Marginal Treatment Effect (MTE) framework (Heckman &amp; Vytlacil, 2005) uses GMM to estimate treatment effects that vary across the population:</span>
<span id="cb75-784"><a href="#cb75-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-785"><a href="#cb75-785" aria-hidden="true" tabindex="-1"></a>$$\Delta^{MTE}(u_D) = \mathbb{E}<span class="co">[</span><span class="ot">Y_1 - Y_0 \mid U_D = u_D</span><span class="co">]</span>$$</span>
<span id="cb75-786"><a href="#cb75-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-787"><a href="#cb75-787" aria-hidden="true" tabindex="-1"></a>where $U_D$ indexes resistance to treatment. The LATE estimated by IV is a weighted average of the MTE curve over the complier population. GMM estimation of MTE involves:</span>
<span id="cb75-788"><a href="#cb75-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-789"><a href="#cb75-789" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Nonlinear moment conditions**: $\mathbb{E}<span class="co">[</span><span class="ot">Y \mid X, Z</span><span class="co">]</span>$ depends on $\int_0^{P(Z)} \Delta^{MTE}(u)\,du$, which is nonlinear in the MTE parameters.</span>
<span id="cb75-790"><a href="#cb75-790" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Overidentification from multiple instruments**: more instruments than MTE parameters.</span>
<span id="cb75-791"><a href="#cb75-791" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**J-test**: tests whether the MTE specification (e.g., polynomial degree) fits the data.</span>
<span id="cb75-792"><a href="#cb75-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-793"><a href="#cb75-793" aria-hidden="true" tabindex="-1"></a>The <span class="in">`ivmte`</span> package (Shea &amp; Torgovitsky) implements this under the hood. Conceptually, the call looks like:</span>
<span id="cb75-794"><a href="#cb75-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-795"><a href="#cb75-795" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb75-796"><a href="#cb75-796" aria-hidden="true" tabindex="-1"></a><span class="co"># Not run -- requires ivmte package and appropriate data</span></span>
<span id="cb75-797"><a href="#cb75-797" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ivmte)</span>
<span id="cb75-798"><a href="#cb75-798" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">ivmte</span>(</span>
<span id="cb75-799"><a href="#cb75-799" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df,</span>
<span id="cb75-800"><a href="#cb75-800" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="st">"y"</span>,</span>
<span id="cb75-801"><a href="#cb75-801" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> <span class="st">"d"</span>,</span>
<span id="cb75-802"><a href="#cb75-802" aria-hidden="true" tabindex="-1"></a>  <span class="at">instrument =</span> <span class="st">"z"</span>,</span>
<span id="cb75-803"><a href="#cb75-803" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="st">"ate"</span>,             <span class="co"># or "att", "late", "prte"</span></span>
<span id="cb75-804"><a href="#cb75-804" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> <span class="sc">~</span> u <span class="sc">+</span> <span class="fu">I</span>(u<span class="sc">^</span><span class="dv">2</span>),         <span class="co"># MTE polynomial for control</span></span>
<span id="cb75-805"><a href="#cb75-805" aria-hidden="true" tabindex="-1"></a>  <span class="at">m1 =</span> <span class="sc">~</span> u <span class="sc">+</span> <span class="fu">I</span>(u<span class="sc">^</span><span class="dv">2</span>),         <span class="co"># MTE polynomial for treated</span></span>
<span id="cb75-806"><a href="#cb75-806" aria-hidden="true" tabindex="-1"></a>  <span class="at">propensity =</span> d <span class="sc">~</span> z</span>
<span id="cb75-807"><a href="#cb75-807" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-808"><a href="#cb75-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-809"><a href="#cb75-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-810"><a href="#cb75-810" aria-hidden="true" tabindex="-1"></a>The key insight from GMM: by specifying moment conditions rather than a full parametric model, we can estimate flexible treatment effect heterogeneity while maintaining testable restrictions via the J-test.</span>
<span id="cb75-811"><a href="#cb75-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-812"><a href="#cb75-812" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb75-813"><a href="#cb75-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-814"><a href="#cb75-814" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**GMM is a unifying framework**: OLS, GLS, IV, and 2SLS are all special cases of GMM with specific weight matrices.</span>
<span id="cb75-815"><a href="#cb75-815" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Efficient GMM** sets $W = \hat\Omega^{-1}$ (the inverse of the moment covariance), minimizing asymptotic variance. Two-step and iterated procedures achieve this.</span>
<span id="cb75-816"><a href="#cb75-816" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**2SLS is efficient only under homoskedasticity**. Under heteroskedasticity, efficient GMM provides tighter estimates.</span>
<span id="cb75-817"><a href="#cb75-817" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The J-test** is a natural diagnostic for overidentified models. It tests whether the moment conditions are mutually consistent.</span>
<span id="cb75-818"><a href="#cb75-818" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Nonlinear GMM** (custom moment functions) handles problems like missing data (Abrevaya &amp; Donald) and MTE estimation.</span>
<span id="cb75-819"><a href="#cb75-819" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The semiparametric efficiency bound** (Chamberlain, 1987): efficient GMM extracts the maximum information from moment conditions without distributional assumptions.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>