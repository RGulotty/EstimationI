<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>7. Probit and MLE – Estimation I: Computational Companion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3bbbbd466991e281563892c5dce73c3d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
  MathJax = {
    tex: {
      macros: {
        E: "\\mathbb{E}",
        Var: "\\text{Var}",
        Cov: "\\text{Cov}",
        plim: "\\text{plim}",
        inprob: "\\xrightarrow{p}",
        indist: "\\xrightarrow{d}",
        bhat: "\\hat{\\boldsymbol{\\beta}}",
        N: "\\mathcal{N}",
        tr: "\\text{tr}",
        rank: "\\text{rank}",
        SE: "\\text{SE}",
        diag: "\\text{diag}"
      }
    }
  };
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Estimation I: Computational Companion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./ch01-review.html">
 <span class="dropdown-text">1. Probability and Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch02-cef-blp.html">
 <span class="dropdown-text">2. The CEF and Best Linear Predictor</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch03-ols.html">
 <span class="dropdown-text">3. Multivariate OLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch04-sensitivity.html">
 <span class="dropdown-text">4. Sensitivity and Leverage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch05-gls.html">
 <span class="dropdown-text">5. Efficiency and GLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch06-small-sample.html">
 <span class="dropdown-text">6. Small Sample Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch07-probit.html">
 <span class="dropdown-text">7. Probit and MLE</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch08-asymptotics.html">
 <span class="dropdown-text">8. Asymptotics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch09-testing.html">
 <span class="dropdown-text">9. Hypothesis Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch10-iv.html">
 <span class="dropdown-text">10. Instrumental Variables and 2SLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch11-gmm.html">
 <span class="dropdown-text">11. GMM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch12-panel.html">
 <span class="dropdown-text">12. Panel Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch13-fixed-effects.html">
 <span class="dropdown-text">13. Fixed Effects and Modern DiD</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/UChicago-pol-methods/EstimationI"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-linear-probability-model" id="toc-the-linear-probability-model" class="nav-link active" data-scroll-target="#the-linear-probability-model"><span class="header-section-number">1</span> The linear probability model</a>
  <ul class="collapse">
  <li><a href="#predictions-outside-01" id="toc-predictions-outside-01" class="nav-link" data-scroll-target="#predictions-outside-01"><span class="header-section-number">1.1</span> Predictions outside <span class="math inline">\([0,1]\)</span></a></li>
  </ul></li>
  <li><a href="#the-probit-model" id="toc-the-probit-model" class="nav-link" data-scroll-target="#the-probit-model"><span class="header-section-number">2</span> The probit model</a>
  <ul class="collapse">
  <li><a href="#latent-variable-representation" id="toc-latent-variable-representation" class="nav-link" data-scroll-target="#latent-variable-representation"><span class="header-section-number">2.1</span> Latent variable representation</a></li>
  <li><a href="#fitting-probit-with-glm" id="toc-fitting-probit-with-glm" class="nav-link" data-scroll-target="#fitting-probit-with-glm"><span class="header-section-number">2.2</span> Fitting probit with <code>glm()</code></a></li>
  <li><a href="#identification-and-scale" id="toc-identification-and-scale" class="nav-link" data-scroll-target="#identification-and-scale"><span class="header-section-number">2.3</span> Identification and scale</a></li>
  </ul></li>
  <li><a href="#writing-the-probit-likelihood-by-hand" id="toc-writing-the-probit-likelihood-by-hand" class="nav-link" data-scroll-target="#writing-the-probit-likelihood-by-hand"><span class="header-section-number">3</span> Writing the probit likelihood by hand</a>
  <ul class="collapse">
  <li><a href="#profile-likelihood" id="toc-profile-likelihood" class="nav-link" data-scroll-target="#profile-likelihood"><span class="header-section-number">3.1</span> Profile likelihood</a></li>
  </ul></li>
  <li><a href="#the-score-function" id="toc-the-score-function" class="nav-link" data-scroll-target="#the-score-function"><span class="header-section-number">4</span> The score function</a>
  <ul class="collapse">
  <li><a href="#comparing-estimating-equations" id="toc-comparing-estimating-equations" class="nav-link" data-scroll-target="#comparing-estimating-equations"><span class="header-section-number">4.1</span> Comparing estimating equations</a></li>
  </ul></li>
  <li><a href="#newtonraphson-from-scratch" id="toc-newtonraphson-from-scratch" class="nav-link" data-scroll-target="#newtonraphson-from-scratch"><span class="header-section-number">5</span> Newton–Raphson from scratch</a>
  <ul class="collapse">
  <li><a href="#visualizing-convergence" id="toc-visualizing-convergence" class="nav-link" data-scroll-target="#visualizing-convergence"><span class="header-section-number">5.1</span> Visualizing convergence</a></li>
  </ul></li>
  <li><a href="#sec-marginal-effects" id="toc-sec-marginal-effects" class="nav-link" data-scroll-target="#sec-marginal-effects"><span class="header-section-number">6</span> Marginal effects</a>
  <ul class="collapse">
  <li><a href="#where-marginal-effects-differ-most" id="toc-where-marginal-effects-differ-most" class="nav-link" data-scroll-target="#where-marginal-effects-differ-most"><span class="header-section-number">6.1</span> Where marginal effects differ most</a></li>
  </ul></li>
  <li><a href="#fisher-information-and-standard-errors" id="toc-fisher-information-and-standard-errors" class="nav-link" data-scroll-target="#fisher-information-and-standard-errors"><span class="header-section-number">7</span> Fisher information and standard errors</a>
  <ul class="collapse">
  <li><a href="#model-based-standard-errors" id="toc-model-based-standard-errors" class="nav-link" data-scroll-target="#model-based-standard-errors"><span class="header-section-number">7.1</span> Model-based standard errors</a></li>
  <li><a href="#sandwich-standard-errors" id="toc-sandwich-standard-errors" class="nav-link" data-scroll-target="#sandwich-standard-errors"><span class="header-section-number">7.2</span> Sandwich standard errors</a></li>
  </ul></li>
  <li><a href="#lpm-vs.-probit-applied-comparison" id="toc-lpm-vs.-probit-applied-comparison" class="nav-link" data-scroll-target="#lpm-vs.-probit-applied-comparison"><span class="header-section-number">8</span> LPM vs.&nbsp;probit: applied comparison</a>
  <ul class="collapse">
  <li><a href="#fitted-probabilities" id="toc-fitted-probabilities" class="nav-link" data-scroll-target="#fitted-probabilities"><span class="header-section-number">8.1</span> Fitted probabilities</a></li>
  <li><a href="#when-does-the-choice-matter" id="toc-when-does-the-choice-matter" class="nav-link" data-scroll-target="#when-does-the-choice-matter"><span class="header-section-number">8.2</span> When does the choice matter?</a></li>
  </ul></li>
  <li><a href="#logit-the-main-alternative" id="toc-logit-the-main-alternative" class="nav-link" data-scroll-target="#logit-the-main-alternative"><span class="header-section-number">9</span> Logit: the main alternative</a></li>
  <li><a href="#simulation-verifying-asymptotic-normality" id="toc-simulation-verifying-asymptotic-normality" class="nav-link" data-scroll-target="#simulation-verifying-asymptotic-normality"><span class="header-section-number">10</span> Simulation: verifying asymptotic normality</a></li>
  <li><a href="#prediction-and-classification" id="toc-prediction-and-classification" class="nav-link" data-scroll-target="#prediction-and-classification"><span class="header-section-number">11</span> Prediction and classification</a></li>
  <li><a href="#connecting-to-gmm" id="toc-connecting-to-gmm" class="nav-link" data-scroll-target="#connecting-to-gmm"><span class="header-section-number">12</span> Connecting to GMM</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">13</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">7. Probit and MLE</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Binary outcomes and maximum likelihood estimation</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Chapter 6 developed the likelihood for the normal linear model, where MLE turned out to be OLS. This chapter applies the same MLE toolkit to a genuinely nonlinear problem: modeling binary outcomes. We start with the linear probability model (LPM), motivate the probit link, write the probit likelihood and score by hand, implement Newton–Raphson, and compare everything to R’s built-in <code>glm()</code>. The running theme is that the score equation <span class="math inline">\(\sum s_i(\beta) = 0\)</span> is just another moment condition — the same logic that gave us OLS, but now for a nonlinear model.</p>
<p><strong>Questions this chapter answers:</strong></p>
<ol type="1">
<li>Why does the linear probability model predict outside <span class="math inline">\([0, 1]\)</span>, and how does probit fix this?</li>
<li>What is the probit model, and how does it arise from a latent variable representation?</li>
<li>How do we interpret probit coefficients — and why are marginal effects needed?</li>
<li>How does Newton-Raphson find the MLE, and why does it converge so fast?</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(carData)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We use the Mroz (1987) dataset: 753 married women, with labor force participation (<code>lfp</code>) as the binary outcome.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Mroz)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Mroz<span class="sc">$</span>lfp_bin <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(Mroz<span class="sc">$</span>lfp <span class="sc">==</span> <span class="st">"yes"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(Mroz<span class="sc">$</span>lfp_bin)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5684</code></pre>
</div>
</div>
<p>About 57% of women in the sample participate in the labor force.</p>
<section id="the-linear-probability-model" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="the-linear-probability-model"><span class="header-section-number">1</span> The linear probability model</h2>
<p>When <span class="math inline">\(Y \in \{0,1\}\)</span>, the conditional expectation is a probability:</p>
<p><span class="math display">\[E[Y \mid X] = P(Y = 1 \mid X)\]</span></p>
<p>The best linear predictor (Chapter 2) still exists — OLS estimates it by solving the usual normal equations. This is the <strong>linear probability model</strong> (LPM):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lpm <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc, <span class="at">data =</span> Mroz, <span class="at">se_type =</span> <span class="st">"HC2"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lpm)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm_robust(formula = lfp_bin ~ k5 + k618 + age + wc + inc, data = Mroz, 
    se_type = "HC2")

Standard error type:  HC2 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|) CI Lower CI Upper  DF
(Intercept)  1.28867    0.11527   11.18 6.12e-27  1.06239  1.51495 747
k5          -0.30255    0.03297   -9.18 4.28e-19 -0.36728 -0.23783 747
k618        -0.01670    0.01462   -1.14 2.54e-01 -0.04540  0.01200 747
age         -0.01320    0.00243   -5.43 7.77e-08 -0.01798 -0.00843 747
wcyes        0.22065    0.03707    5.95 4.05e-09  0.14788  0.29341 747
inc         -0.00627    0.00153   -4.10 4.50e-05 -0.00927 -0.00327 747

Multiple R-squared:  0.131 ,    Adjusted R-squared:  0.125 
F-statistic: 28.8 on 5 and 747 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
<p>Binary outcomes have built-in heteroskedasticity: <span class="math inline">\(\text{Var}(Y \mid X) = p(X)(1 - p(X))\)</span> depends on <span class="math inline">\(X\)</span> by construction, so we use HC2 standard errors throughout.</p>
<section id="predictions-outside-01" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="predictions-outside-01"><span class="header-section-number">1.1</span> Predictions outside <span class="math inline">\([0,1]\)</span></h3>
<p>The LPM is a linear function — nothing stops it from predicting probabilities below 0 or above 1:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lpm_ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc, <span class="at">data =</span> Mroz)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>p_hat_lpm <span class="ot">&lt;-</span> <span class="fu">fitted</span>(lpm_ols)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">min =</span> <span class="fu">min</span>(p_hat_lpm), <span class="at">max =</span> <span class="fu">max</span>(p_hat_lpm),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">outside_01 =</span> <span class="fu">sum</span>(p_hat_lpm <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> p_hat_lpm <span class="sc">&gt;</span> <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>       min        max outside_01 
    -0.286      1.024     11.000 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_lpm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">fitted =</span> p_hat_lpm, <span class="at">age =</span> Mroz<span class="sc">$</span>age, <span class="at">y =</span> Mroz<span class="sc">$</span>lfp_bin)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_lpm, <span class="fu">aes</span>(age, fitted)) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LPM fitted values vs. age"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Dashed lines mark 0 and 1 --- LPM can exceed these bounds"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"P̂(lfp = 1)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch07-probit_files/figure-html/lpm-plot-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>LPM fitted values vs.&nbsp;age — dashed lines mark the [0, 1] bounds</figcaption>
</figure>
</div>
</div>
</div>
<p>This motivates models that constrain predictions to <span class="math inline">\([0, 1]\)</span>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>LPM Predictions Outside [0, 1]
</div>
</div>
<div class="callout-body-container callout-body">
<p>The linear probability model can predict probabilities below 0 or above 1 because it fits a line through binary data. While this doesn’t affect the interpretation of coefficients as average marginal effects, it limits the model’s use for prediction.</p>
</div>
</div>
</section>
</section>
<section id="the-probit-model" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="the-probit-model"><span class="header-section-number">2</span> The probit model</h2>
<section id="latent-variable-representation" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="latent-variable-representation"><span class="header-section-number">2.1</span> Latent variable representation</h3>
<p>Suppose there is an unobserved continuous variable:</p>
<p><span class="math display">\[Y_i^* = X_i'\beta + \varepsilon_i, \qquad \varepsilon_i \sim N(0, 1)\]</span></p>
<p>We observe <span class="math inline">\(Y_i = \mathbf{1}\{Y_i^* &gt; 0\}\)</span>. Then:</p>
<p><span class="math display">\[P(Y_i = 1 \mid X_i) = P(\varepsilon_i &gt; -X_i'\beta) = \Phi(X_i'\beta)\]</span></p>
<p>where <span class="math inline">\(\Phi\)</span> is the standard normal CDF. This is the <strong>probit model</strong> — a single-index model with link function <span class="math inline">\(G = \Phi\)</span>.</p>
<div id="def-probit" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 1 (Probit Model)</strong></span> The probit model specifies <span class="math inline">\(P(Y_i = 1 | X_i) = \Phi(X_i'\beta)\)</span>, where <span class="math inline">\(\Phi\)</span> is the standard normal CDF. It arises from a latent variable <span class="math inline">\(Y_i^* = X_i'\beta + \varepsilon_i\)</span> with <span class="math inline">\(\varepsilon_i \sim N(0,1)\)</span> and <span class="math inline">\(Y_i = \mathbf{1}\{Y_i^* &gt; 0\}\)</span>.</p>
</div>
</section>
<section id="fitting-probit-with-glm" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="fitting-probit-with-glm"><span class="header-section-number">2.2</span> Fitting probit with <code>glm()</code></h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>probit <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> Mroz, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(probit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = lfp_bin ~ k5 + k618 + age + wc + inc, family = binomial(link = "probit"), 
    data = Mroz)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.28263    0.36748    6.21  5.2e-10 ***
k5          -0.87865    0.11331   -7.75  8.9e-15 ***
k618        -0.05185    0.04055   -1.28      0.2    
age         -0.03814    0.00749   -5.09  3.5e-07 ***
wcyes        0.63741    0.11742    5.43  5.7e-08 ***
inc         -0.01850    0.00457   -4.05  5.1e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1029.75  on 752  degrees of freedom
Residual deviance:  923.04  on 747  degrees of freedom
AIC: 935

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p><code>glm()</code> uses Fisher scoring (iteratively reweighted least squares), which is a variant of Newton–Raphson. Below, we implement this from scratch.</p>
</section>
<section id="identification-and-scale" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="identification-and-scale"><span class="header-section-number">2.3</span> Identification and scale</h3>
<p>An important difference from OLS: probit coefficients are identified only up to scale. If we allowed <span class="math inline">\(\text{Var}(\varepsilon) = \sigma^2\)</span> instead of normalizing to 1, then <span class="math inline">\(P(Y = 1 \mid X) = \Phi(X'\beta/\sigma)\)</span> — only <span class="math inline">\(\beta/\sigma\)</span> is identified. The normalization <span class="math inline">\(\sigma = 1\)</span> pins down the scale, but it means <span class="math inline">\(\beta_j\)</span> does <strong>not</strong> have the same interpretation as in OLS. We return to this in the marginal effects section.</p>
</section>
</section>
<section id="writing-the-probit-likelihood-by-hand" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="writing-the-probit-likelihood-by-hand"><span class="header-section-number">3</span> Writing the probit likelihood by hand</h2>
<p>The probit log-likelihood is:</p>
<p><span id="eq-probit-loglik"><span class="math display">\[\ell_n(\beta) = \sum_{i=1}^n \left[ Y_i \log \Phi(X_i'\beta) + (1 - Y_i) \log(1 - \Phi(X_i'\beta)) \right] \tag{1}\]</span></span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> Mroz<span class="sc">$</span>lfp_bin</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc, <span class="at">data =</span> Mroz)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-likelihood</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>probit_loglik <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clamp to avoid log(0)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(y <span class="sc">*</span> <span class="fu">log</span>(Phi) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> y) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate at glm's estimate</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="fu">probit_loglik</span>(<span class="fu">coef</span>(probit))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -461.5</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(probit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' -461.5 (df=6)</code></pre>
</div>
</div>
<section id="profile-likelihood" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="profile-likelihood"><span class="header-section-number">3.1</span> Profile likelihood</h3>
<p>We can visualize the likelihood as a function of a single coefficient, holding the others at their MLE values:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>beta_hat <span class="ot">&lt;-</span> <span class="fu">coef</span>(probit)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># k5 coefficient</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>b_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_hat[j] <span class="sc">-</span> <span class="dv">1</span>, beta_hat[j] <span class="sc">+</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>ll_profile <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b_grid))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(b_grid)) {</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  beta_try <span class="ot">&lt;-</span> beta_hat</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  beta_try[j] <span class="ot">&lt;-</span> b_grid[i]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  ll_profile[i] <span class="ot">&lt;-</span> <span class="fu">probit_loglik</span>(beta_try)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>df_profile <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beta_k5 =</span> b_grid, <span class="at">loglik =</span> ll_profile)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_profile, <span class="fu">aes</span>(beta_k5, loglik)) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> beta_hat[j], <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Profile log-likelihood for β_k5"</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"MLE ="</span>, <span class="fu">round</span>(beta_hat[j], <span class="dv">3</span>)),</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(beta[k5]), <span class="at">y =</span> <span class="st">"Log-likelihood"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch07-probit_files/figure-html/profile-loglik-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-score-function" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="the-score-function"><span class="header-section-number">4</span> The score function</h2>
<p>Recall the <a href="./ch06-small-sample.html#def-score-information">score and Fisher information</a> from Chapter 6. The individual score contribution for the probit model is:</p>
<p><span id="eq-probit-score"><span class="math display">\[s_i(\beta) = \frac{\phi(X_i'\beta)}{\Phi(X_i'\beta)(1 - \Phi(X_i'\beta))} (Y_i - \Phi(X_i'\beta)) X_i \tag{2}\]</span></span></p>
<p>where <span class="math inline">\(\phi\)</span> is the standard normal pdf. The weight <span class="math inline">\(w_i = \phi/({\Phi(1 - \Phi)})\)</span> upweights observations near <span class="math inline">\(X'\beta = 0\)</span> (where the likelihood is most informative) and downweights observations deep in the tails.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Score function (returns a K-vector)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>probit_score <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  resid_w <span class="ot">&lt;-</span> w <span class="sc">*</span> (y <span class="sc">-</span> Phi)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> resid_w)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># At the MLE, the score should be zero</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">probit_score</span>(<span class="fu">coef</span>(probit))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.798e-04 7.338e-05 6.640e-04 6.994e-03 1.101e-04 7.178e-03</code></pre>
</div>
</div>
<p>All elements are numerically zero — confirming that <code>glm()</code> found the score root.</p>
<section id="comparing-estimating-equations" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="comparing-estimating-equations"><span class="header-section-number">4.1</span> Comparing estimating equations</h3>
<p>Setting the score to zero defines the MLE. Compare this to the OLS normal equation:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 54%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Estimating equation</th>
<th>Weights</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OLS</td>
<td><span class="math inline">\(\sum_i X_i(Y_i - X_i'\beta) = 0\)</span></td>
<td>Equal</td>
</tr>
<tr class="even">
<td>Probit MLE</td>
<td><span class="math inline">\(\sum_i w_i(Y_i - \Phi(X_i'\beta)) X_i = 0\)</span></td>
<td><span class="math inline">\(w_i = \phi/(\Phi(1-\Phi))\)</span></td>
</tr>
<tr class="odd">
<td>General</td>
<td><span class="math inline">\(\sum_i g_i(\theta) = 0\)</span></td>
<td><span class="math inline">\(\to\)</span> GMM</td>
</tr>
</tbody>
</table>
<p>Both OLS and probit MLE are <strong>method-of-moments estimators</strong> — they set sample moment conditions to zero. GMM (Chapter 13) is the general framework.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>The Probit Score Is a Moment Condition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Setting the probit score to zero, <span class="math inline">\(\sum w_i(Y_i - \Phi(X_i'\beta))X_i = 0\)</span>, is a method-of-moments estimating equation — just like OLS normal equations but with observation-specific weights <span class="math inline">\(w_i\)</span>. This connection to GMM (Chapter 11) unifies all the estimators in this course.</p>
</div>
</div>
</section>
</section>
<section id="newtonraphson-from-scratch" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="newtonraphson-from-scratch"><span class="header-section-number">5</span> Newton–Raphson from scratch</h2>
<p>The Hessian (second derivative of the log-likelihood) is:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hessian function (returns a K x K matrix)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>probit_hessian <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weight for the Hessian</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> lambda <span class="sc">*</span> (lambda <span class="sc">+</span> Xb)  <span class="co"># diagonal weights</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Negative Hessian contribution from each obs</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  w_hess <span class="ot">&lt;-</span> <span class="sc">-</span>(phi<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            ((y <span class="sc">-</span> Phi) <span class="sc">*</span> (<span class="sc">-</span>Xb <span class="sc">*</span> Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi) <span class="sc">-</span> phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> Phi)) <span class="sc">-</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>             phi<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (<span class="dv">1</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simpler: use the expected Hessian (Fisher scoring)</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  w_fisher <span class="ot">&lt;-</span> phi<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">t</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(w_fisher) <span class="sc">%*%</span> X</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Newton–Raphson iterates: <span class="math inline">\(\beta^{(t+1)} = \beta^{(t)} - [H_n(\beta^{(t)})]^{-1} S_n(\beta^{(t)})\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Newton-Raphson (using Fisher scoring: expected Hessian)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>newton_raphson_probit <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">tol =</span> <span class="fl">1e-8</span>, <span class="at">max_iter =</span> <span class="dv">50</span>) {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize with OLS</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">crossprod</span>(X)) <span class="sc">%*%</span> <span class="fu">crossprod</span>(X, y)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(beta)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max_iter) {</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Score</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> (w <span class="sc">*</span> (y <span class="sc">-</span> Phi)))</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected Hessian (Fisher scoring)</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> phi<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    H <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">t</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(W) <span class="sc">%*%</span> X</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    delta <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">solve</span>(H) <span class="sc">%*%</span> S</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">as.numeric</span>(delta)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(delta)) <span class="sc">&lt;</span> tol) {</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">coefficients =</span> beta, <span class="at">iterations =</span> iter,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>                  <span class="at">converged =</span> <span class="cn">TRUE</span>, <span class="at">hessian =</span> H))</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">coefficients =</span> beta, <span class="at">iterations =</span> max_iter, <span class="at">converged =</span> <span class="cn">FALSE</span>, <span class="at">hessian =</span> H)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>fit_nr <span class="ot">&lt;-</span> <span class="fu">newton_raphson_probit</span>(X, y)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>fit_nr<span class="sc">$</span>iterations</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare our Newton-Raphson to glm()</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">colnames</span>(X),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">NR =</span> <span class="fu">round</span>(fit_nr<span class="sc">$</span>coefficients, <span class="dv">6</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">glm =</span> <span class="fu">round</span>(<span class="fu">coef</span>(probit), <span class="dv">6</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> <span class="fu">round</span>(fit_nr<span class="sc">$</span>coefficients <span class="sc">-</span> <span class="fu">coef</span>(probit), <span class="dv">10</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable       NR      glm       diff
(Intercept) (Intercept)  2.28263  2.28263 -2.450e-06
k5                   k5 -0.87865 -0.87865  3.073e-07
k618               k618 -0.05185 -0.05185  5.738e-07
age                 age -0.03814 -0.03814  1.780e-08
wcyes             wcyes  0.63741  0.63741  3.525e-07
inc                 inc -0.01850 -0.01850  5.800e-08</code></pre>
</div>
</div>
<p>Our implementation matches <code>glm()</code> to many decimal places, converging in just a handful of iterations.</p>
<section id="visualizing-convergence" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="visualizing-convergence"><span class="header-section-number">5.1</span> Visualizing convergence</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Track convergence</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>beta_path <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="dv">20</span>, K)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">solve</span>(<span class="fu">crossprod</span>(X)) <span class="sc">%*%</span> <span class="fu">crossprod</span>(X, y))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>beta_path[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> beta</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> (w <span class="sc">*</span> (y <span class="sc">-</span> Phi)))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> phi<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  H <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">t</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(W) <span class="sc">%*%</span> X</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">solve</span>(H) <span class="sc">%*%</span> S</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">as.numeric</span>(delta)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  beta_path[iter, ] <span class="ot">&lt;-</span> beta</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(delta)) <span class="sc">&lt;</span> <span class="fl">1e-10</span>) <span class="cf">break</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance from MLE at each iteration</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>dist_to_mle <span class="ot">&lt;-</span> <span class="fu">apply</span>(beta_path, <span class="dv">1</span>, <span class="cf">function</span>(b) {</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(b))) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">sum</span>((b <span class="sc">-</span> <span class="fu">coef</span>(probit))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>dist_to_mle <span class="ot">&lt;-</span> dist_to_mle[<span class="sc">!</span><span class="fu">is.na</span>(dist_to_mle)]</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>df_conv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">iteration =</span> <span class="fu">seq_along</span>(dist_to_mle), <span class="at">distance =</span> dist_to_mle)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_conv, <span class="fu">aes</span>(iteration, distance)) <span class="sc">+</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Newton-Raphson convergence"</span>,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Distance to MLE on log scale --- quadratic convergence"</span>,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"||β(t) - β̂|| (log scale)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch07-probit_files/figure-html/convergence-path-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Newton–Raphson converges quadratically: the number of correct digits roughly doubles each iteration.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Newton-Raphson Exploits Concavity
</div>
</div>
<div class="callout-body-container callout-body">
<p>The probit log-likelihood is globally concave, guaranteeing that Newton-Raphson (or Fisher scoring) converges to the unique maximum from any starting point. Quadratic convergence means the number of correct digits roughly doubles each iteration.</p>
</div>
</div>
</section>
</section>
<section id="sec-marginal-effects" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-marginal-effects"><span class="header-section-number">6</span> Marginal effects</h2>
<p>In OLS, <span class="math inline">\(\partial E[Y \mid X] / \partial x_j = \beta_j\)</span> — the coefficient <strong>is</strong> the marginal effect. In probit:</p>
<p><span class="math display">\[\frac{\partial P(Y = 1 \mid X)}{\partial x_j} = \phi(X'\beta) \cdot \beta_j\]</span></p>
<p>The marginal effect depends on <span class="math inline">\(X\)</span> through <span class="math inline">\(\phi(X'\beta)\)</span>. Two standard summaries:</p>
<div id="def-marginal-effects" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 2 (Marginal Effects)</strong></span> In the probit model, <span class="math inline">\(\partial P(Y=1|X)/\partial x_j = \phi(X'\beta) \cdot \beta_j\)</span>. The <strong>marginal effect at the mean</strong> (MEM) evaluates at <span class="math inline">\(\bar{X}\)</span>; the <strong>average marginal effect</strong> (AME) averages over all observations. AME is comparable to the LPM coefficient.</p>
</div>
<ol type="1">
<li><strong>Marginal effect at the mean</strong> (MEM): evaluate at <span class="math inline">\(\bar{X}\)</span></li>
<li><strong>Average marginal effect</strong> (AME): average the marginal effect over all observations</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>Xb_hat <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> <span class="fu">coef</span>(probit))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal effect at the mean</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>phi_at_mean <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(<span class="fu">mean</span>(Xb_hat))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>mem <span class="ot">&lt;-</span> phi_at_mean <span class="sc">*</span> <span class="fu">coef</span>(probit)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Average marginal effect</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>phi_each <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb_hat)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>ame <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(<span class="fu">outer</span>(phi_each, <span class="fu">coef</span>(probit)))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to LPM coefficients</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(probit)),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">LPM =</span> <span class="fu">round</span>(<span class="fu">coef</span>(lpm_ols), <span class="dv">4</span>),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Probit =</span> <span class="fu">round</span>(<span class="fu">coef</span>(probit), <span class="dv">4</span>),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">MEM =</span> <span class="fu">round</span>(mem, <span class="dv">4</span>),</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">AME =</span> <span class="fu">round</span>(ame, <span class="dv">4</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable     LPM  Probit     MEM     AME
(Intercept) (Intercept)  1.2887  2.2826  0.8946  0.7986
k5                   k5 -0.3026 -0.8787 -0.3444 -0.3074
k618               k618 -0.0167 -0.0519 -0.0203 -0.0181
age                 age -0.0132 -0.0381 -0.0149 -0.0133
wcyes             wcyes  0.2206  0.6374  0.2498  0.2230
inc                 inc -0.0063 -0.0185 -0.0073 -0.0065</code></pre>
</div>
</div>
<p>The AME is directly comparable to the LPM coefficient: both estimate the average change in <span class="math inline">\(P(Y=1)\)</span> per unit change in <span class="math inline">\(X_j\)</span>. They are generally similar, with differences reflecting the curvature of <span class="math inline">\(\Phi\)</span>.</p>
<section id="where-marginal-effects-differ-most" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="where-marginal-effects-differ-most"><span class="header-section-number">6.1</span> Where marginal effects differ most</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal effect of age as a function of the index</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>xb_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>me_age <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(xb_grid) <span class="sc">*</span> <span class="fu">coef</span>(probit)[<span class="st">"age"</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>df_me <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">index =</span> xb_grid, <span class="at">me =</span> me_age)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_me, <span class="fu">aes</span>(index, me)) <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">coef</span>(lpm_ols)[<span class="st">"age"</span>], <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Marginal effect of age on P(lfp = 1)"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probit ME (black) vs. LPM constant effect (red dashed)"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"X'β (probit index)"</span>, <span class="at">y =</span> <span class="st">"∂P/∂age"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch07-probit_files/figure-html/marginal-effects-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The probit marginal effect is largest near <span class="math inline">\(X'\beta = 0\)</span> (where the CDF is steepest) and vanishes in the tails. The LPM assumes a constant effect everywhere.</p>
</section>
</section>
<section id="fisher-information-and-standard-errors" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="fisher-information-and-standard-errors"><span class="header-section-number">7</span> Fisher information and standard errors</h2>
<section id="model-based-standard-errors" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="model-based-standard-errors"><span class="header-section-number">7.1</span> Model-based standard errors</h3>
<p>Under correct specification, the information matrix equality holds:</p>
<p><span class="math display">\[\mathcal{I}(\beta) = E[s_i s_i'] = -E\left[\frac{\partial^2 \ell_i}{\partial \beta \partial \beta'}\right]\]</span></p>
<p>The asymptotic variance of <span class="math inline">\(\hat{\beta}\)</span> is <span class="math inline">\(\mathcal{I}(\beta)^{-1}/n\)</span>, estimated by inverting the negative Hessian:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model-based variance: inverse of negative Hessian</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>V_model <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="sc">-</span>fit_nr<span class="sc">$</span>hessian)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>se_model <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(V_model))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to glm's reported SEs</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">colnames</span>(X),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_manual =</span> <span class="fu">round</span>(se_model, <span class="dv">5</span>),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_glm =</span> <span class="fu">round</span>(<span class="fu">summary</span>(probit)<span class="sc">$</span>coefficients[, <span class="st">"Std. Error"</span>], <span class="dv">5</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable SE_manual  SE_glm
(Intercept) (Intercept)   0.36748 0.36748
k5                   k5   0.11331 0.11331
k618               k618   0.04055 0.04055
age                 age   0.00749 0.00749
wcyes             wcyes   0.11742 0.11742
inc                 inc   0.00457 0.00457</code></pre>
</div>
</div>
</section>
<section id="sandwich-standard-errors" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="sandwich-standard-errors"><span class="header-section-number">7.2</span> Sandwich standard errors</h3>
<p>If the probit model is misspecified (wrong link function), the information matrix equality fails and we need the sandwich:</p>
<p><span class="math display">\[V_{\text{sandwich}} = H^{-1} \left(\sum_i s_i s_i'\right) H^{-1}\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust SEs</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(probit)                                       <span class="co"># model-based</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
z test of coefficients:

            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.28263    0.36748    6.21  5.2e-10 ***
k5          -0.87865    0.11331   -7.75  8.9e-15 ***
k618        -0.05185    0.04055   -1.28      0.2    
age         -0.03814    0.00749   -5.09  3.5e-07 ***
wcyes        0.63741    0.11742    5.43  5.7e-08 ***
inc         -0.01850    0.00457   -4.05  5.1e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(probit, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(probit, <span class="at">type =</span> <span class="st">"HC1"</span>))  <span class="co"># sandwich</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
z test of coefficients:

            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.28263    0.37312    6.12  9.5e-10 ***
k5          -0.87865    0.11725   -7.49  6.7e-14 ***
k618        -0.05185    0.04359   -1.19  0.23425    
age         -0.03814    0.00755   -5.05  4.4e-07 ***
wcyes        0.63741    0.11764    5.42  6.0e-08 ***
inc         -0.01850    0.00493   -3.75  0.00018 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>se_classical <span class="ot">&lt;-</span> <span class="fu">summary</span>(probit)<span class="sc">$</span>coefficients[, <span class="st">"Std. Error"</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>se_robust <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcovHC</span>(probit, <span class="at">type =</span> <span class="st">"HC1"</span>)))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(probit)),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model_based =</span> <span class="fu">round</span>(se_classical, <span class="dv">4</span>),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sandwich =</span> <span class="fu">round</span>(se_robust, <span class="dv">4</span>),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ratio =</span> <span class="fu">round</span>(se_robust <span class="sc">/</span> se_classical, <span class="dv">3</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable Model_based Sandwich Ratio
(Intercept) (Intercept)      0.3675   0.3731 1.015
k5                   k5      0.1133   0.1172 1.035
k618               k618      0.0406   0.0436 1.075
age                 age      0.0075   0.0076 1.009
wcyes             wcyes      0.1174   0.1176 1.002
inc                 inc      0.0046   0.0049 1.079</code></pre>
</div>
</div>
<p>If model-based and sandwich SEs differ substantially, this signals possible misspecification of the link function. Here they are similar, which is reassuring.</p>
</section>
</section>
<section id="lpm-vs.-probit-applied-comparison" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="lpm-vs.-probit-applied-comparison"><span class="header-section-number">8</span> LPM vs.&nbsp;probit: applied comparison</h2>
<section id="fitted-probabilities" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="fitted-probabilities"><span class="header-section-number">8.1</span> Fitted probabilities</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p_probit <span class="ot">&lt;-</span> <span class="fu">predict</span>(probit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>df_compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpm =</span> p_hat_lpm,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">probit =</span> p_probit,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> Mroz<span class="sc">$</span>lfp_bin</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_compare, <span class="fu">aes</span>(lpm, probit)) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LPM vs. Probit fitted probabilities"</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Close agreement in the interior, diverge near 0 and 1"</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"P̂ (LPM)"</span>, <span class="at">y =</span> <span class="st">"P̂ (Probit)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch07-probit_files/figure-html/lpm-vs-probit-fitted-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary comparison</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"LPM"</span>, <span class="st">"Probit"</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">LogLik =</span> <span class="fu">c</span>(<span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">pmax</span>(<span class="fu">pmin</span>(p_hat_lpm, <span class="dv">1</span><span class="fl">-1e-10</span>), <span class="fl">1e-10</span>), <span class="at">log =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as.numeric</span>(<span class="fu">logLik</span>(probit))),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">AIC</span>(probit)),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Predictions_outside_01 =</span> <span class="fu">c</span>(<span class="fu">sum</span>(p_hat_lpm <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> p_hat_lpm <span class="sc">&gt;</span> <span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Model LogLik AIC Predictions_outside_01
1    LPM -462.6  NA                     11
2 Probit -461.5 935                      0</code></pre>
</div>
</div>
</section>
<section id="when-does-the-choice-matter" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="when-does-the-choice-matter"><span class="header-section-number">8.2</span> When does the choice matter?</h3>
<p>The LPM and probit give nearly identical results when predicted probabilities are far from 0 and 1. They diverge most when:</p>
<ol type="1">
<li>The outcome is rare (or nearly universal)</li>
<li>Predictions reach the boundaries</li>
<li>You need to interpret the functional form (e.g., for counterfactual predictions)</li>
</ol>
<p>For estimating average marginal effects, the LPM is a robust baseline that doesn’t require correct specification of the link function.</p>
</section>
</section>
<section id="logit-the-main-alternative" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="logit-the-main-alternative"><span class="header-section-number">9</span> Logit: the main alternative</h2>
<p>The logit model uses the logistic CDF <span class="math inline">\(\Lambda(z) = e^z/(1 + e^z)\)</span> instead of <span class="math inline">\(\Phi\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> Mroz, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Probit and logit fitted values are nearly identical</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">predict</span>(probit, <span class="at">type =</span> <span class="st">"response"</span>) <span class="sc">-</span> <span class="fu">predict</span>(logit, <span class="at">type =</span> <span class="st">"response"</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01162</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients differ by approximately a factor of 1.6</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(probit)),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Probit =</span> <span class="fu">round</span>(<span class="fu">coef</span>(probit), <span class="dv">4</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Logit =</span> <span class="fu">round</span>(<span class="fu">coef</span>(logit), <span class="dv">4</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ratio =</span> <span class="fu">round</span>(<span class="fu">coef</span>(logit) <span class="sc">/</span> <span class="fu">coef</span>(probit), <span class="dv">3</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable  Probit   Logit Ratio
(Intercept) (Intercept)  2.2826  3.7999 1.665
k5                   k5 -0.8787 -1.4631 1.665
k618               k618 -0.0519 -0.0876 1.689
age                 age -0.0381 -0.0637 1.669
wcyes             wcyes  0.6374  1.0623 1.667
inc                 inc -0.0185 -0.0308 1.663</code></pre>
</div>
</div>
<p>The ratio of logit to probit coefficients is approximately <span class="math inline">\(\pi/\sqrt{3} \approx 1.81\)</span>, because the logistic distribution has variance <span class="math inline">\(\pi^2/3\)</span> while the standard normal has variance 1. The fitted probabilities are nearly indistinguishable.</p>
</section>
<section id="simulation-verifying-asymptotic-normality" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="simulation-verifying-asymptotic-normality"><span class="header-section-number">10</span> Simulation: verifying asymptotic normality</h2>
<p>The MLE theory from Chapter 6 says <span class="math inline">\(\sqrt{n}(\hat{\beta} - \beta_0) \to N(0, \mathcal{I}^{-1})\)</span>. Let’s verify with a controlled simulation:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>beta_true <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.8</span>)  <span class="co"># intercept, x1, x2</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>K_sim <span class="ot">&lt;-</span> <span class="fu">length</span>(beta_true)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>b_sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, B, K_sim)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  X_sim <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, x1, x2)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  p_sim <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(X_sim <span class="sc">%*%</span> beta_true)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  y_sim <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_sim, <span class="dv">1</span>, p_sim)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_sim <span class="sc">~</span> x1 <span class="sc">+</span> x2, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  b_sim[b, ] <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus on x1 coefficient</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>j_sim <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">true =</span> beta_true[j_sim],</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_bhat =</span> <span class="fu">mean</span>(b_sim[, j_sim]),</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_bhat =</span> <span class="fu">sd</span>(b_sim[, j_sim]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>     true mean_bhat   sd_bhat 
 -0.50000  -0.50775   0.07339 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">b_hat =</span> b_sim[, j_sim])</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_sim, <span class="fu">aes</span>(b_hat)) <span class="sc">+</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="fu">mean</span>(b_sim[, j_sim]),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd =</span> <span class="fu">sd</span>(b_sim[, j_sim])),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> beta_true[j_sim], <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sampling distribution of probit MLE"</span>,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"n ="</span>, n_sim, <span class="st">"— centered on true β, approximately normal"</span>),</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[x1]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch07-probit_files/figure-html/asymptotic-sim-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The MLE is centered on the true value (unbiased in large samples) and approximately normal, as the theory predicts.</p>
</section>
<section id="prediction-and-classification" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="prediction-and-classification"><span class="header-section-number">11</span> Prediction and classification</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted probabilities</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>p_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(probit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Classify at threshold 0.5</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(p_pred <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">Predicted =</span> y_pred, <span class="at">Actual =</span> Mroz<span class="sc">$</span>lfp_bin)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Actual
Predicted   0   1
        0 166  83
        1 159 345</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Accuracy</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y_pred <span class="sc">==</span> Mroz<span class="sc">$</span>lfp_bin)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6786</code></pre>
</div>
</div>
<p>A simple 50% threshold gives reasonable classification. But the primary goal of probit in econometrics is estimating the effect of covariates on <span class="math inline">\(P(Y=1)\)</span>, not prediction.</p>
</section>
<section id="connecting-to-gmm" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="connecting-to-gmm"><span class="header-section-number">12</span> Connecting to GMM</h2>
<p>The probit score equation, the OLS normal equation, and the GLS estimating equation are all special cases of:</p>
<p><span class="math display">\[\frac{1}{n} \sum_{i=1}^n g(W_i, \theta) = 0\]</span></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Estimator</th>
<th>Moment condition <span class="math inline">\(g(W_i, \theta)\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OLS</td>
<td><span class="math inline">\(X_i(Y_i - X_i'\beta)\)</span></td>
</tr>
<tr class="even">
<td>WLS</td>
<td><span class="math inline">\(W_i^{1/2} X_i(Y_i - X_i'\beta)\)</span></td>
</tr>
<tr class="odd">
<td>Probit MLE</td>
<td><span class="math inline">\(w_i(Y_i - \Phi(X_i'\beta)) X_i\)</span></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All three are sample moment conditions that equal zero at the estimate</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> (y <span class="sc">-</span> X <span class="sc">%*%</span> <span class="fu">coef</span>(lpm_ols))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.976e-10</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Probit score</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">probit_score</span>(<span class="fu">coef</span>(probit))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.007178</code></pre>
</div>
</div>
<p>When there are more moment conditions than parameters, the <strong>generalized method of moments</strong> (Chapter 13) provides the efficient way to combine them.</p>
</section>
<section id="summary" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="summary"><span class="header-section-number">13</span> Summary</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 34%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Concept</th>
<th>Formula</th>
<th>R code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Linear probability model</td>
<td><span class="math inline">\(P(Y=1\mid X) = X'\beta\)</span></td>
<td><code>lm_robust(y ~ x, se_type = "HC2")</code></td>
</tr>
<tr class="even">
<td>Probit model</td>
<td><span class="math inline">\(P(Y=1\mid X) = \Phi(X'\beta)\)</span></td>
<td><code>glm(y ~ x, family = binomial(link = "probit"))</code></td>
</tr>
<tr class="odd">
<td>Log-likelihood</td>
<td><span class="math inline">\(\sum[Y\log\Phi + (1-Y)\log(1-\Phi)]\)</span></td>
<td><code>logLik(probit)</code></td>
</tr>
<tr class="even">
<td>Score</td>
<td><span class="math inline">\(\sum w_i(Y_i - \Phi(X_i'\beta))X_i = 0\)</span></td>
<td>manual (see above)</td>
</tr>
<tr class="odd">
<td>Newton–Raphson</td>
<td><span class="math inline">\(\beta^{(t+1)} = \beta^{(t)} - H^{-1}S\)</span></td>
<td><code>glm()</code> does this internally</td>
</tr>
<tr class="even">
<td>Average marginal effect</td>
<td><span class="math inline">\(\frac{1}{n}\sum \phi(X_i'\hat\beta)\hat\beta_j\)</span></td>
<td><code>mean(dnorm(Xb)) * coef(probit)</code></td>
</tr>
<tr class="odd">
<td>Model-based SEs</td>
<td><span class="math inline">\(\sqrt{[-H_n(\hat\beta)]^{-1}_{jj}}\)</span></td>
<td><code>summary(probit)</code></td>
</tr>
<tr class="even">
<td>Sandwich SEs</td>
<td><span class="math inline">\(\sqrt{[H^{-1}(\sum s_is_i')H^{-1}]_{jj}}\)</span></td>
<td><code>vcovHC(probit, type = "HC1")</code></td>
</tr>
<tr class="odd">
<td>Logit</td>
<td><span class="math inline">\(P(Y=1\mid X) = \Lambda(X'\beta)\)</span></td>
<td><code>family = binomial(link = "logit")</code></td>
</tr>
</tbody>
</table>
<p><strong>Key takeaway.</strong> The probit model is the natural extension of MLE to binary outcomes. The coefficients are not marginal effects (compute AME instead), the score equation is a moment condition just like OLS normal equations, and sandwich SEs protect against misspecification of the link function. The LPM remains a robust baseline for estimating average effects.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/UChicago-pol-methods\.github\.io\/EstimationI\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "7. Probit and MLE"</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Binary outcomes and maximum likelihood estimation"</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>Chapter 6 developed the likelihood for the normal linear model, where MLE turned out to be OLS. This chapter applies the same MLE toolkit to a genuinely nonlinear problem: modeling binary outcomes. We start with the linear probability model (LPM), motivate the probit link, write the probit likelihood and score by hand, implement Newton--Raphson, and compare everything to R's built-in <span class="in">`glm()`</span>. The running theme is that the score equation $\sum s_i(\beta) = 0$ is just another moment condition --- the same logic that gave us OLS, but now for a nonlinear model.</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>**Questions this chapter answers:**</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Why does the linear probability model predict outside $<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$, and how does probit fix this?</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>What is the probit model, and how does it arise from a latent variable representation?</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>How do we interpret probit coefficients — and why are marginal effects needed?</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>How does Newton-Raphson find the MLE, and why does it converge so fast?</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(carData)</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>We use the Mroz (1987) dataset: 753 married women, with labor force participation (<span class="in">`lfp`</span>) as the binary outcome.</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-setup</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Mroz)</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>Mroz<span class="sc">$</span>lfp_bin <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(Mroz<span class="sc">$</span>lfp <span class="sc">==</span> <span class="st">"yes"</span>)</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(Mroz<span class="sc">$</span>lfp_bin)</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>About 57% of women in the sample participate in the labor force.</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## The linear probability model</span></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>When $Y \in <span class="sc">\{</span>0,1<span class="sc">\}</span>$, the conditional expectation is a probability:</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>$$E<span class="co">[</span><span class="ot">Y \mid X</span><span class="co">]</span> = P(Y = 1 \mid X)$$</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>The best linear predictor (Chapter 2) still exists --- OLS estimates it by solving the usual normal equations. This is the **linear probability model** (LPM):</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lpm</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>lpm <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc, <span class="at">data =</span> Mroz, <span class="at">se_type =</span> <span class="st">"HC2"</span>)</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lpm)</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>Binary outcomes have built-in heteroskedasticity: $\text{Var}(Y \mid X) = p(X)(1 - p(X))$ depends on $X$ by construction, so we use HC2 standard errors throughout.</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictions outside $[0,1]$</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>The LPM is a linear function --- nothing stops it from predicting probabilities below 0 or above 1:</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lpm-predictions</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>lpm_ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc, <span class="at">data =</span> Mroz)</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>p_hat_lpm <span class="ot">&lt;-</span> <span class="fu">fitted</span>(lpm_ols)</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">min =</span> <span class="fu">min</span>(p_hat_lpm), <span class="at">max =</span> <span class="fu">max</span>(p_hat_lpm),</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">outside_01 =</span> <span class="fu">sum</span>(p_hat_lpm <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> p_hat_lpm <span class="sc">&gt;</span> <span class="dv">1</span>))</span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lpm-plot</span></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "LPM fitted values vs. age — dashed lines mark the [0, 1] bounds"</span></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>df_lpm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">fitted =</span> p_hat_lpm, <span class="at">age =</span> Mroz<span class="sc">$</span>age, <span class="at">y =</span> Mroz<span class="sc">$</span>lfp_bin)</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_lpm, <span class="fu">aes</span>(age, fitted)) <span class="sc">+</span></span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LPM fitted values vs. age"</span>,</span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Dashed lines mark 0 and 1 --- LPM can exceed these bounds"</span>,</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"P̂(lfp = 1)"</span>)</span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>This motivates models that constrain predictions to $<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$.</span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a><span class="fu">## LPM Predictions Outside [0, 1]</span></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>The linear probability model can predict probabilities below 0 or above 1 because it fits a line through binary data. While this doesn't affect the interpretation of coefficients as average marginal effects, it limits the model's use for prediction.</span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a><span class="fu">## The probit model</span></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a><span class="fu">### Latent variable representation</span></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a>Suppose there is an unobserved continuous variable:</span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a>$$Y_i^* = X_i'\beta + \varepsilon_i, \qquad \varepsilon_i \sim N(0, 1)$$</span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a>We observe $Y_i = \mathbf{1}<span class="sc">\{</span>Y_i^* &gt; 0<span class="sc">\}</span>$. Then:</span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a>$$P(Y_i = 1 \mid X_i) = P(\varepsilon_i &gt; -X_i'\beta) = \Phi(X_i'\beta)$$</span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a>where $\Phi$ is the standard normal CDF. This is the **probit model** --- a single-index model with link function $G = \Phi$.</span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a>::: {#def-probit}</span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a><span class="fu">## Probit Model</span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a>The probit model specifies $P(Y_i = 1 | X_i) = \Phi(X_i'\beta)$, where $\Phi$ is the standard normal CDF. It arises from a latent variable $Y_i^* = X_i'\beta + \varepsilon_i$ with $\varepsilon_i \sim N(0,1)$ and $Y_i = \mathbf{1}<span class="sc">\{</span>Y_i^* &gt; 0<span class="sc">\}</span>$.</span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting probit with `glm()`</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probit-fit</span></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a>probit <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc,</span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> Mroz, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(probit)</span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a><span class="in">`glm()`</span> uses Fisher scoring (iteratively reweighted least squares), which is a variant of Newton--Raphson. Below, we implement this from scratch.</span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Identification and scale</span></span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a>An important difference from OLS: probit coefficients are identified only up to scale. If we allowed $\text{Var}(\varepsilon) = \sigma^2$ instead of normalizing to 1, then $P(Y = 1 \mid X) = \Phi(X'\beta/\sigma)$ --- only $\beta/\sigma$ is identified. The normalization $\sigma = 1$ pins down the scale, but it means $\beta_j$ does **not** have the same interpretation as in OLS. We return to this in the marginal effects section.</span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a><span class="fu">## Writing the probit likelihood by hand</span></span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a>The probit log-likelihood is:</span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a>$$\ell_n(\beta) = \sum_{i=1}^n \left<span class="co">[</span><span class="ot"> Y_i \log \Phi(X_i'\beta) + (1 - Y_i) \log(1 - \Phi(X_i'\beta)) \right</span><span class="co">]</span>$$ {#eq-probit-loglik}</span>
<span id="cb53-140"><a href="#cb53-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-143"><a href="#cb53-143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-144"><a href="#cb53-144" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probit-loglik-manual</span></span>
<span id="cb53-145"><a href="#cb53-145" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> Mroz<span class="sc">$</span>lfp_bin</span>
<span id="cb53-146"><a href="#cb53-146" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc, <span class="at">data =</span> Mroz)</span>
<span id="cb53-147"><a href="#cb53-147" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb53-148"><a href="#cb53-148" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb53-149"><a href="#cb53-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-150"><a href="#cb53-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-likelihood</span></span>
<span id="cb53-151"><a href="#cb53-151" aria-hidden="true" tabindex="-1"></a>probit_loglik <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb53-152"><a href="#cb53-152" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb53-153"><a href="#cb53-153" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb53-154"><a href="#cb53-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clamp to avoid log(0)</span></span>
<span id="cb53-155"><a href="#cb53-155" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb53-156"><a href="#cb53-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(y <span class="sc">*</span> <span class="fu">log</span>(Phi) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> y) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-157"><a href="#cb53-157" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-158"><a href="#cb53-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-159"><a href="#cb53-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate at glm's estimate</span></span>
<span id="cb53-160"><a href="#cb53-160" aria-hidden="true" tabindex="-1"></a><span class="fu">probit_loglik</span>(<span class="fu">coef</span>(probit))</span>
<span id="cb53-161"><a href="#cb53-161" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(probit)</span>
<span id="cb53-162"><a href="#cb53-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-163"><a href="#cb53-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-164"><a href="#cb53-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Profile likelihood</span></span>
<span id="cb53-165"><a href="#cb53-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-166"><a href="#cb53-166" aria-hidden="true" tabindex="-1"></a>We can visualize the likelihood as a function of a single coefficient, holding the others at their MLE values:</span>
<span id="cb53-167"><a href="#cb53-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-170"><a href="#cb53-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-171"><a href="#cb53-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: profile-loglik</span></span>
<span id="cb53-172"><a href="#cb53-172" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-173"><a href="#cb53-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-174"><a href="#cb53-174" aria-hidden="true" tabindex="-1"></a>beta_hat <span class="ot">&lt;-</span> <span class="fu">coef</span>(probit)</span>
<span id="cb53-175"><a href="#cb53-175" aria-hidden="true" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># k5 coefficient</span></span>
<span id="cb53-176"><a href="#cb53-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-177"><a href="#cb53-177" aria-hidden="true" tabindex="-1"></a>b_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(beta_hat[j] <span class="sc">-</span> <span class="dv">1</span>, beta_hat[j] <span class="sc">+</span> <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb53-178"><a href="#cb53-178" aria-hidden="true" tabindex="-1"></a>ll_profile <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b_grid))</span>
<span id="cb53-179"><a href="#cb53-179" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(b_grid)) {</span>
<span id="cb53-180"><a href="#cb53-180" aria-hidden="true" tabindex="-1"></a>  beta_try <span class="ot">&lt;-</span> beta_hat</span>
<span id="cb53-181"><a href="#cb53-181" aria-hidden="true" tabindex="-1"></a>  beta_try[j] <span class="ot">&lt;-</span> b_grid[i]</span>
<span id="cb53-182"><a href="#cb53-182" aria-hidden="true" tabindex="-1"></a>  ll_profile[i] <span class="ot">&lt;-</span> <span class="fu">probit_loglik</span>(beta_try)</span>
<span id="cb53-183"><a href="#cb53-183" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-184"><a href="#cb53-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-185"><a href="#cb53-185" aria-hidden="true" tabindex="-1"></a>df_profile <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beta_k5 =</span> b_grid, <span class="at">loglik =</span> ll_profile)</span>
<span id="cb53-186"><a href="#cb53-186" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_profile, <span class="fu">aes</span>(beta_k5, loglik)) <span class="sc">+</span></span>
<span id="cb53-187"><a href="#cb53-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-188"><a href="#cb53-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> beta_hat[j], <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb53-189"><a href="#cb53-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Profile log-likelihood for β_k5"</span>,</span>
<span id="cb53-190"><a href="#cb53-190" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"MLE ="</span>, <span class="fu">round</span>(beta_hat[j], <span class="dv">3</span>)),</span>
<span id="cb53-191"><a href="#cb53-191" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(beta[k5]), <span class="at">y =</span> <span class="st">"Log-likelihood"</span>)</span>
<span id="cb53-192"><a href="#cb53-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-193"><a href="#cb53-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-194"><a href="#cb53-194" aria-hidden="true" tabindex="-1"></a><span class="fu">## The score function</span></span>
<span id="cb53-195"><a href="#cb53-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-196"><a href="#cb53-196" aria-hidden="true" tabindex="-1"></a>Recall the <span class="co">[</span><span class="ot">score and Fisher information</span><span class="co">](ch06-small-sample.qmd#def-score-information)</span> from Chapter 6. The individual score contribution for the probit model is:</span>
<span id="cb53-197"><a href="#cb53-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-198"><a href="#cb53-198" aria-hidden="true" tabindex="-1"></a>$$s_i(\beta) = \frac{\phi(X_i'\beta)}{\Phi(X_i'\beta)(1 - \Phi(X_i'\beta))} (Y_i - \Phi(X_i'\beta)) X_i$$ {#eq-probit-score}</span>
<span id="cb53-199"><a href="#cb53-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-200"><a href="#cb53-200" aria-hidden="true" tabindex="-1"></a>where $\phi$ is the standard normal pdf. The weight $w_i = \phi/({\Phi(1 - \Phi)})$ upweights observations near $X'\beta = 0$ (where the likelihood is most informative) and downweights observations deep in the tails.</span>
<span id="cb53-201"><a href="#cb53-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-204"><a href="#cb53-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-205"><a href="#cb53-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probit-score</span></span>
<span id="cb53-206"><a href="#cb53-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Score function (returns a K-vector)</span></span>
<span id="cb53-207"><a href="#cb53-207" aria-hidden="true" tabindex="-1"></a>probit_score <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb53-208"><a href="#cb53-208" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb53-209"><a href="#cb53-209" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb53-210"><a href="#cb53-210" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb53-211"><a href="#cb53-211" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb53-212"><a href="#cb53-212" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-213"><a href="#cb53-213" aria-hidden="true" tabindex="-1"></a>  resid_w <span class="ot">&lt;-</span> w <span class="sc">*</span> (y <span class="sc">-</span> Phi)</span>
<span id="cb53-214"><a href="#cb53-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> resid_w)</span>
<span id="cb53-215"><a href="#cb53-215" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-216"><a href="#cb53-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-217"><a href="#cb53-217" aria-hidden="true" tabindex="-1"></a><span class="co"># At the MLE, the score should be zero</span></span>
<span id="cb53-218"><a href="#cb53-218" aria-hidden="true" tabindex="-1"></a><span class="fu">probit_score</span>(<span class="fu">coef</span>(probit))</span>
<span id="cb53-219"><a href="#cb53-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-220"><a href="#cb53-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-221"><a href="#cb53-221" aria-hidden="true" tabindex="-1"></a>All elements are numerically zero --- confirming that <span class="in">`glm()`</span> found the score root.</span>
<span id="cb53-222"><a href="#cb53-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-223"><a href="#cb53-223" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing estimating equations</span></span>
<span id="cb53-224"><a href="#cb53-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-225"><a href="#cb53-225" aria-hidden="true" tabindex="-1"></a>Setting the score to zero defines the MLE. Compare this to the OLS normal equation:</span>
<span id="cb53-226"><a href="#cb53-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-227"><a href="#cb53-227" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Model <span class="pp">|</span> Estimating equation <span class="pp">|</span> Weights <span class="pp">|</span></span>
<span id="cb53-228"><a href="#cb53-228" aria-hidden="true" tabindex="-1"></a><span class="pp">|-------|-------------------|---------|</span></span>
<span id="cb53-229"><a href="#cb53-229" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> OLS <span class="pp">|</span> $\sum_i X_i(Y_i - X_i'\beta) = 0$ <span class="pp">|</span> Equal <span class="pp">|</span></span>
<span id="cb53-230"><a href="#cb53-230" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Probit MLE <span class="pp">|</span> $\sum_i w_i(Y_i - \Phi(X_i'\beta)) X_i = 0$ <span class="pp">|</span> $w_i = \phi/(\Phi(1-\Phi))$ <span class="pp">|</span></span>
<span id="cb53-231"><a href="#cb53-231" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> General <span class="pp">|</span> $\sum_i g_i(\theta) = 0$ <span class="pp">|</span> $\to$ GMM <span class="pp">|</span></span>
<span id="cb53-232"><a href="#cb53-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-233"><a href="#cb53-233" aria-hidden="true" tabindex="-1"></a>Both OLS and probit MLE are **method-of-moments estimators** --- they set sample moment conditions to zero. GMM (Chapter 13) is the general framework.</span>
<span id="cb53-234"><a href="#cb53-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-235"><a href="#cb53-235" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb53-236"><a href="#cb53-236" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Probit Score Is a Moment Condition</span></span>
<span id="cb53-237"><a href="#cb53-237" aria-hidden="true" tabindex="-1"></a>Setting the probit score to zero, $\sum w_i(Y_i - \Phi(X_i'\beta))X_i = 0$, is a method-of-moments estimating equation — just like OLS normal equations but with observation-specific weights $w_i$. This connection to GMM (Chapter 11) unifies all the estimators in this course.</span>
<span id="cb53-238"><a href="#cb53-238" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-239"><a href="#cb53-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-240"><a href="#cb53-240" aria-hidden="true" tabindex="-1"></a><span class="fu">## Newton--Raphson from scratch</span></span>
<span id="cb53-241"><a href="#cb53-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-242"><a href="#cb53-242" aria-hidden="true" tabindex="-1"></a>The Hessian (second derivative of the log-likelihood) is:</span>
<span id="cb53-243"><a href="#cb53-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-246"><a href="#cb53-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-247"><a href="#cb53-247" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probit-hessian</span></span>
<span id="cb53-248"><a href="#cb53-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Hessian function (returns a K x K matrix)</span></span>
<span id="cb53-249"><a href="#cb53-249" aria-hidden="true" tabindex="-1"></a>probit_hessian <span class="ot">&lt;-</span> <span class="cf">function</span>(beta) {</span>
<span id="cb53-250"><a href="#cb53-250" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb53-251"><a href="#cb53-251" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb53-252"><a href="#cb53-252" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb53-253"><a href="#cb53-253" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb53-254"><a href="#cb53-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-255"><a href="#cb53-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weight for the Hessian</span></span>
<span id="cb53-256"><a href="#cb53-256" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-257"><a href="#cb53-257" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> lambda <span class="sc">*</span> (lambda <span class="sc">+</span> Xb)  <span class="co"># diagonal weights</span></span>
<span id="cb53-258"><a href="#cb53-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Negative Hessian contribution from each obs</span></span>
<span id="cb53-259"><a href="#cb53-259" aria-hidden="true" tabindex="-1"></a>  w_hess <span class="ot">&lt;-</span> <span class="sc">-</span>(phi<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span></span>
<span id="cb53-260"><a href="#cb53-260" aria-hidden="true" tabindex="-1"></a>            ((y <span class="sc">-</span> Phi) <span class="sc">*</span> (<span class="sc">-</span>Xb <span class="sc">*</span> Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi) <span class="sc">-</span> phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> Phi)) <span class="sc">-</span></span>
<span id="cb53-261"><a href="#cb53-261" aria-hidden="true" tabindex="-1"></a>             phi<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (<span class="dv">1</span>)</span>
<span id="cb53-262"><a href="#cb53-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-263"><a href="#cb53-263" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simpler: use the expected Hessian (Fisher scoring)</span></span>
<span id="cb53-264"><a href="#cb53-264" aria-hidden="true" tabindex="-1"></a>  w_fisher <span class="ot">&lt;-</span> phi<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-265"><a href="#cb53-265" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">t</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(w_fisher) <span class="sc">%*%</span> X</span>
<span id="cb53-266"><a href="#cb53-266" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-267"><a href="#cb53-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-268"><a href="#cb53-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-269"><a href="#cb53-269" aria-hidden="true" tabindex="-1"></a>Newton--Raphson iterates: $\beta^{(t+1)} = \beta^{(t)} - <span class="co">[</span><span class="ot">H_n(\beta^{(t)})</span><span class="co">]</span>^{-1} S_n(\beta^{(t)})$.</span>
<span id="cb53-270"><a href="#cb53-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-273"><a href="#cb53-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-274"><a href="#cb53-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: newton-raphson</span></span>
<span id="cb53-275"><a href="#cb53-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Newton-Raphson (using Fisher scoring: expected Hessian)</span></span>
<span id="cb53-276"><a href="#cb53-276" aria-hidden="true" tabindex="-1"></a>newton_raphson_probit <span class="ot">&lt;-</span> <span class="cf">function</span>(X, y, <span class="at">tol =</span> <span class="fl">1e-8</span>, <span class="at">max_iter =</span> <span class="dv">50</span>) {</span>
<span id="cb53-277"><a href="#cb53-277" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb53-278"><a href="#cb53-278" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X)</span>
<span id="cb53-279"><a href="#cb53-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-280"><a href="#cb53-280" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize with OLS</span></span>
<span id="cb53-281"><a href="#cb53-281" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">crossprod</span>(X)) <span class="sc">%*%</span> <span class="fu">crossprod</span>(X, y)</span>
<span id="cb53-282"><a href="#cb53-282" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(beta)</span>
<span id="cb53-283"><a href="#cb53-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-284"><a href="#cb53-284" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max_iter) {</span>
<span id="cb53-285"><a href="#cb53-285" aria-hidden="true" tabindex="-1"></a>    Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb53-286"><a href="#cb53-286" aria-hidden="true" tabindex="-1"></a>    Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb53-287"><a href="#cb53-287" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb53-288"><a href="#cb53-288" aria-hidden="true" tabindex="-1"></a>    Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb53-289"><a href="#cb53-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-290"><a href="#cb53-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Score</span></span>
<span id="cb53-291"><a href="#cb53-291" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-292"><a href="#cb53-292" aria-hidden="true" tabindex="-1"></a>    S <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> (w <span class="sc">*</span> (y <span class="sc">-</span> Phi)))</span>
<span id="cb53-293"><a href="#cb53-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-294"><a href="#cb53-294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected Hessian (Fisher scoring)</span></span>
<span id="cb53-295"><a href="#cb53-295" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> phi<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-296"><a href="#cb53-296" aria-hidden="true" tabindex="-1"></a>    H <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">t</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(W) <span class="sc">%*%</span> X</span>
<span id="cb53-297"><a href="#cb53-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-298"><a href="#cb53-298" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update</span></span>
<span id="cb53-299"><a href="#cb53-299" aria-hidden="true" tabindex="-1"></a>    delta <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">solve</span>(H) <span class="sc">%*%</span> S</span>
<span id="cb53-300"><a href="#cb53-300" aria-hidden="true" tabindex="-1"></a>    beta <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">as.numeric</span>(delta)</span>
<span id="cb53-301"><a href="#cb53-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-302"><a href="#cb53-302" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(delta)) <span class="sc">&lt;</span> tol) {</span>
<span id="cb53-303"><a href="#cb53-303" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">coefficients =</span> beta, <span class="at">iterations =</span> iter,</span>
<span id="cb53-304"><a href="#cb53-304" aria-hidden="true" tabindex="-1"></a>                  <span class="at">converged =</span> <span class="cn">TRUE</span>, <span class="at">hessian =</span> H))</span>
<span id="cb53-305"><a href="#cb53-305" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb53-306"><a href="#cb53-306" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-307"><a href="#cb53-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">coefficients =</span> beta, <span class="at">iterations =</span> max_iter, <span class="at">converged =</span> <span class="cn">FALSE</span>, <span class="at">hessian =</span> H)</span>
<span id="cb53-308"><a href="#cb53-308" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-309"><a href="#cb53-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-310"><a href="#cb53-310" aria-hidden="true" tabindex="-1"></a>fit_nr <span class="ot">&lt;-</span> <span class="fu">newton_raphson_probit</span>(X, y)</span>
<span id="cb53-311"><a href="#cb53-311" aria-hidden="true" tabindex="-1"></a>fit_nr<span class="sc">$</span>iterations</span>
<span id="cb53-312"><a href="#cb53-312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-313"><a href="#cb53-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-316"><a href="#cb53-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-317"><a href="#cb53-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nr-comparison</span></span>
<span id="cb53-318"><a href="#cb53-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare our Newton-Raphson to glm()</span></span>
<span id="cb53-319"><a href="#cb53-319" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb53-320"><a href="#cb53-320" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">colnames</span>(X),</span>
<span id="cb53-321"><a href="#cb53-321" aria-hidden="true" tabindex="-1"></a>  <span class="at">NR =</span> <span class="fu">round</span>(fit_nr<span class="sc">$</span>coefficients, <span class="dv">6</span>),</span>
<span id="cb53-322"><a href="#cb53-322" aria-hidden="true" tabindex="-1"></a>  <span class="at">glm =</span> <span class="fu">round</span>(<span class="fu">coef</span>(probit), <span class="dv">6</span>),</span>
<span id="cb53-323"><a href="#cb53-323" aria-hidden="true" tabindex="-1"></a>  <span class="at">diff =</span> <span class="fu">round</span>(fit_nr<span class="sc">$</span>coefficients <span class="sc">-</span> <span class="fu">coef</span>(probit), <span class="dv">10</span>)</span>
<span id="cb53-324"><a href="#cb53-324" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-325"><a href="#cb53-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-326"><a href="#cb53-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-327"><a href="#cb53-327" aria-hidden="true" tabindex="-1"></a>Our implementation matches <span class="in">`glm()`</span> to many decimal places, converging in just a handful of iterations.</span>
<span id="cb53-328"><a href="#cb53-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-329"><a href="#cb53-329" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing convergence</span></span>
<span id="cb53-330"><a href="#cb53-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-333"><a href="#cb53-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-334"><a href="#cb53-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: convergence-path</span></span>
<span id="cb53-335"><a href="#cb53-335" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-336"><a href="#cb53-336" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-337"><a href="#cb53-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Track convergence</span></span>
<span id="cb53-338"><a href="#cb53-338" aria-hidden="true" tabindex="-1"></a>beta_path <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="dv">20</span>, K)</span>
<span id="cb53-339"><a href="#cb53-339" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">solve</span>(<span class="fu">crossprod</span>(X)) <span class="sc">%*%</span> <span class="fu">crossprod</span>(X, y))</span>
<span id="cb53-340"><a href="#cb53-340" aria-hidden="true" tabindex="-1"></a>beta_path[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> beta</span>
<span id="cb53-341"><a href="#cb53-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-342"><a href="#cb53-342" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (iter <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb53-343"><a href="#cb53-343" aria-hidden="true" tabindex="-1"></a>  Xb <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb53-344"><a href="#cb53-344" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Xb)</span>
<span id="cb53-345"><a href="#cb53-345" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb)</span>
<span id="cb53-346"><a href="#cb53-346" aria-hidden="true" tabindex="-1"></a>  Phi <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(Phi, <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1e-10</span>), <span class="fl">1e-10</span>)</span>
<span id="cb53-347"><a href="#cb53-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-348"><a href="#cb53-348" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> phi <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-349"><a href="#cb53-349" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> (w <span class="sc">*</span> (y <span class="sc">-</span> Phi)))</span>
<span id="cb53-350"><a href="#cb53-350" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> phi<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (Phi <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Phi))</span>
<span id="cb53-351"><a href="#cb53-351" aria-hidden="true" tabindex="-1"></a>  H <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">t</span>(X) <span class="sc">%*%</span> <span class="fu">diag</span>(W) <span class="sc">%*%</span> X</span>
<span id="cb53-352"><a href="#cb53-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-353"><a href="#cb53-353" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">solve</span>(H) <span class="sc">%*%</span> S</span>
<span id="cb53-354"><a href="#cb53-354" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">as.numeric</span>(delta)</span>
<span id="cb53-355"><a href="#cb53-355" aria-hidden="true" tabindex="-1"></a>  beta_path[iter, ] <span class="ot">&lt;-</span> beta</span>
<span id="cb53-356"><a href="#cb53-356" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(delta)) <span class="sc">&lt;</span> <span class="fl">1e-10</span>) <span class="cf">break</span></span>
<span id="cb53-357"><a href="#cb53-357" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-358"><a href="#cb53-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-359"><a href="#cb53-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance from MLE at each iteration</span></span>
<span id="cb53-360"><a href="#cb53-360" aria-hidden="true" tabindex="-1"></a>dist_to_mle <span class="ot">&lt;-</span> <span class="fu">apply</span>(beta_path, <span class="dv">1</span>, <span class="cf">function</span>(b) {</span>
<span id="cb53-361"><a href="#cb53-361" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(b))) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb53-362"><a href="#cb53-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">sum</span>((b <span class="sc">-</span> <span class="fu">coef</span>(probit))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb53-363"><a href="#cb53-363" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb53-364"><a href="#cb53-364" aria-hidden="true" tabindex="-1"></a>dist_to_mle <span class="ot">&lt;-</span> dist_to_mle[<span class="sc">!</span><span class="fu">is.na</span>(dist_to_mle)]</span>
<span id="cb53-365"><a href="#cb53-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-366"><a href="#cb53-366" aria-hidden="true" tabindex="-1"></a>df_conv <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">iteration =</span> <span class="fu">seq_along</span>(dist_to_mle), <span class="at">distance =</span> dist_to_mle)</span>
<span id="cb53-367"><a href="#cb53-367" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_conv, <span class="fu">aes</span>(iteration, distance)) <span class="sc">+</span></span>
<span id="cb53-368"><a href="#cb53-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-369"><a href="#cb53-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb53-370"><a href="#cb53-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb53-371"><a href="#cb53-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Newton-Raphson convergence"</span>,</span>
<span id="cb53-372"><a href="#cb53-372" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Distance to MLE on log scale --- quadratic convergence"</span>,</span>
<span id="cb53-373"><a href="#cb53-373" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"||β(t) - β̂|| (log scale)"</span>)</span>
<span id="cb53-374"><a href="#cb53-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-375"><a href="#cb53-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-376"><a href="#cb53-376" aria-hidden="true" tabindex="-1"></a>Newton--Raphson converges quadratically: the number of correct digits roughly doubles each iteration.</span>
<span id="cb53-377"><a href="#cb53-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-378"><a href="#cb53-378" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb53-379"><a href="#cb53-379" aria-hidden="true" tabindex="-1"></a><span class="fu">## Newton-Raphson Exploits Concavity</span></span>
<span id="cb53-380"><a href="#cb53-380" aria-hidden="true" tabindex="-1"></a>The probit log-likelihood is globally concave, guaranteeing that Newton-Raphson (or Fisher scoring) converges to the unique maximum from any starting point. Quadratic convergence means the number of correct digits roughly doubles each iteration.</span>
<span id="cb53-381"><a href="#cb53-381" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-382"><a href="#cb53-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-383"><a href="#cb53-383" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal effects {#sec-marginal-effects}</span></span>
<span id="cb53-384"><a href="#cb53-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-385"><a href="#cb53-385" aria-hidden="true" tabindex="-1"></a>In OLS, $\partial E<span class="co">[</span><span class="ot">Y \mid X</span><span class="co">]</span> / \partial x_j = \beta_j$ --- the coefficient **is** the marginal effect. In probit:</span>
<span id="cb53-386"><a href="#cb53-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-387"><a href="#cb53-387" aria-hidden="true" tabindex="-1"></a>$$\frac{\partial P(Y = 1 \mid X)}{\partial x_j} = \phi(X'\beta) \cdot \beta_j$$</span>
<span id="cb53-388"><a href="#cb53-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-389"><a href="#cb53-389" aria-hidden="true" tabindex="-1"></a>The marginal effect depends on $X$ through $\phi(X'\beta)$. Two standard summaries:</span>
<span id="cb53-390"><a href="#cb53-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-391"><a href="#cb53-391" aria-hidden="true" tabindex="-1"></a>::: {#def-marginal-effects}</span>
<span id="cb53-392"><a href="#cb53-392" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal Effects</span></span>
<span id="cb53-393"><a href="#cb53-393" aria-hidden="true" tabindex="-1"></a>In the probit model, $\partial P(Y=1|X)/\partial x_j = \phi(X'\beta) \cdot \beta_j$. The **marginal effect at the mean** (MEM) evaluates at $\bar{X}$; the **average marginal effect** (AME) averages over all observations. AME is comparable to the LPM coefficient.</span>
<span id="cb53-394"><a href="#cb53-394" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb53-395"><a href="#cb53-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-396"><a href="#cb53-396" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Marginal effect at the mean** (MEM): evaluate at $\bar{X}$</span>
<span id="cb53-397"><a href="#cb53-397" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Average marginal effect** (AME): average the marginal effect over all observations</span>
<span id="cb53-398"><a href="#cb53-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-401"><a href="#cb53-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-402"><a href="#cb53-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: marginal-effects</span></span>
<span id="cb53-403"><a href="#cb53-403" aria-hidden="true" tabindex="-1"></a>Xb_hat <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(X <span class="sc">%*%</span> <span class="fu">coef</span>(probit))</span>
<span id="cb53-404"><a href="#cb53-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-405"><a href="#cb53-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal effect at the mean</span></span>
<span id="cb53-406"><a href="#cb53-406" aria-hidden="true" tabindex="-1"></a>phi_at_mean <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(<span class="fu">mean</span>(Xb_hat))</span>
<span id="cb53-407"><a href="#cb53-407" aria-hidden="true" tabindex="-1"></a>mem <span class="ot">&lt;-</span> phi_at_mean <span class="sc">*</span> <span class="fu">coef</span>(probit)</span>
<span id="cb53-408"><a href="#cb53-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-409"><a href="#cb53-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Average marginal effect</span></span>
<span id="cb53-410"><a href="#cb53-410" aria-hidden="true" tabindex="-1"></a>phi_each <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(Xb_hat)</span>
<span id="cb53-411"><a href="#cb53-411" aria-hidden="true" tabindex="-1"></a>ame <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(<span class="fu">outer</span>(phi_each, <span class="fu">coef</span>(probit)))</span>
<span id="cb53-412"><a href="#cb53-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-413"><a href="#cb53-413" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to LPM coefficients</span></span>
<span id="cb53-414"><a href="#cb53-414" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb53-415"><a href="#cb53-415" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(probit)),</span>
<span id="cb53-416"><a href="#cb53-416" aria-hidden="true" tabindex="-1"></a>  <span class="at">LPM =</span> <span class="fu">round</span>(<span class="fu">coef</span>(lpm_ols), <span class="dv">4</span>),</span>
<span id="cb53-417"><a href="#cb53-417" aria-hidden="true" tabindex="-1"></a>  <span class="at">Probit =</span> <span class="fu">round</span>(<span class="fu">coef</span>(probit), <span class="dv">4</span>),</span>
<span id="cb53-418"><a href="#cb53-418" aria-hidden="true" tabindex="-1"></a>  <span class="at">MEM =</span> <span class="fu">round</span>(mem, <span class="dv">4</span>),</span>
<span id="cb53-419"><a href="#cb53-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">AME =</span> <span class="fu">round</span>(ame, <span class="dv">4</span>)</span>
<span id="cb53-420"><a href="#cb53-420" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-421"><a href="#cb53-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-422"><a href="#cb53-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-423"><a href="#cb53-423" aria-hidden="true" tabindex="-1"></a>The AME is directly comparable to the LPM coefficient: both estimate the average change in $P(Y=1)$ per unit change in $X_j$. They are generally similar, with differences reflecting the curvature of $\Phi$.</span>
<span id="cb53-424"><a href="#cb53-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-425"><a href="#cb53-425" aria-hidden="true" tabindex="-1"></a><span class="fu">### Where marginal effects differ most</span></span>
<span id="cb53-426"><a href="#cb53-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-429"><a href="#cb53-429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-430"><a href="#cb53-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: marginal-effects-plot</span></span>
<span id="cb53-431"><a href="#cb53-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-432"><a href="#cb53-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-433"><a href="#cb53-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal effect of age as a function of the index</span></span>
<span id="cb53-434"><a href="#cb53-434" aria-hidden="true" tabindex="-1"></a>xb_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">200</span>)</span>
<span id="cb53-435"><a href="#cb53-435" aria-hidden="true" tabindex="-1"></a>me_age <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(xb_grid) <span class="sc">*</span> <span class="fu">coef</span>(probit)[<span class="st">"age"</span>]</span>
<span id="cb53-436"><a href="#cb53-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-437"><a href="#cb53-437" aria-hidden="true" tabindex="-1"></a>df_me <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">index =</span> xb_grid, <span class="at">me =</span> me_age)</span>
<span id="cb53-438"><a href="#cb53-438" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_me, <span class="fu">aes</span>(index, me)) <span class="sc">+</span></span>
<span id="cb53-439"><a href="#cb53-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-440"><a href="#cb53-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">coef</span>(lpm_ols)[<span class="st">"age"</span>], <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb53-441"><a href="#cb53-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Marginal effect of age on P(lfp = 1)"</span>,</span>
<span id="cb53-442"><a href="#cb53-442" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probit ME (black) vs. LPM constant effect (red dashed)"</span>,</span>
<span id="cb53-443"><a href="#cb53-443" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"X'β (probit index)"</span>, <span class="at">y =</span> <span class="st">"∂P/∂age"</span>)</span>
<span id="cb53-444"><a href="#cb53-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-445"><a href="#cb53-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-446"><a href="#cb53-446" aria-hidden="true" tabindex="-1"></a>The probit marginal effect is largest near $X'\beta = 0$ (where the CDF is steepest) and vanishes in the tails. The LPM assumes a constant effect everywhere.</span>
<span id="cb53-447"><a href="#cb53-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-448"><a href="#cb53-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fisher information and standard errors</span></span>
<span id="cb53-449"><a href="#cb53-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-450"><a href="#cb53-450" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model-based standard errors</span></span>
<span id="cb53-451"><a href="#cb53-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-452"><a href="#cb53-452" aria-hidden="true" tabindex="-1"></a>Under correct specification, the information matrix equality holds:</span>
<span id="cb53-453"><a href="#cb53-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-454"><a href="#cb53-454" aria-hidden="true" tabindex="-1"></a>$$\mathcal{I}(\beta) = E<span class="co">[</span><span class="ot">s_i s_i'</span><span class="co">]</span> = -E\left<span class="co">[</span><span class="ot">\frac{\partial^2 \ell_i}{\partial \beta \partial \beta'}\right</span><span class="co">]</span>$$</span>
<span id="cb53-455"><a href="#cb53-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-456"><a href="#cb53-456" aria-hidden="true" tabindex="-1"></a>The asymptotic variance of $\hat{\beta}$ is $\mathcal{I}(\beta)^{-1}/n$, estimated by inverting the negative Hessian:</span>
<span id="cb53-457"><a href="#cb53-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-460"><a href="#cb53-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-461"><a href="#cb53-461" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model-se</span></span>
<span id="cb53-462"><a href="#cb53-462" aria-hidden="true" tabindex="-1"></a><span class="co"># Model-based variance: inverse of negative Hessian</span></span>
<span id="cb53-463"><a href="#cb53-463" aria-hidden="true" tabindex="-1"></a>V_model <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="sc">-</span>fit_nr<span class="sc">$</span>hessian)</span>
<span id="cb53-464"><a href="#cb53-464" aria-hidden="true" tabindex="-1"></a>se_model <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(V_model))</span>
<span id="cb53-465"><a href="#cb53-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-466"><a href="#cb53-466" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to glm's reported SEs</span></span>
<span id="cb53-467"><a href="#cb53-467" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb53-468"><a href="#cb53-468" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">colnames</span>(X),</span>
<span id="cb53-469"><a href="#cb53-469" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_manual =</span> <span class="fu">round</span>(se_model, <span class="dv">5</span>),</span>
<span id="cb53-470"><a href="#cb53-470" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_glm =</span> <span class="fu">round</span>(<span class="fu">summary</span>(probit)<span class="sc">$</span>coefficients[, <span class="st">"Std. Error"</span>], <span class="dv">5</span>)</span>
<span id="cb53-471"><a href="#cb53-471" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-472"><a href="#cb53-472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-473"><a href="#cb53-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-474"><a href="#cb53-474" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sandwich standard errors</span></span>
<span id="cb53-475"><a href="#cb53-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-476"><a href="#cb53-476" aria-hidden="true" tabindex="-1"></a>If the probit model is misspecified (wrong link function), the information matrix equality fails and we need the sandwich:</span>
<span id="cb53-477"><a href="#cb53-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-478"><a href="#cb53-478" aria-hidden="true" tabindex="-1"></a>$$V_{\text{sandwich}} = H^{-1} \left(\sum_i s_i s_i'\right) H^{-1}$$</span>
<span id="cb53-479"><a href="#cb53-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-482"><a href="#cb53-482" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-483"><a href="#cb53-483" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sandwich-probit</span></span>
<span id="cb53-484"><a href="#cb53-484" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust SEs</span></span>
<span id="cb53-485"><a href="#cb53-485" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(probit)                                       <span class="co"># model-based</span></span>
<span id="cb53-486"><a href="#cb53-486" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(probit, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(probit, <span class="at">type =</span> <span class="st">"HC1"</span>))  <span class="co"># sandwich</span></span>
<span id="cb53-487"><a href="#cb53-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-488"><a href="#cb53-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-491"><a href="#cb53-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-492"><a href="#cb53-492" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: se-comparison</span></span>
<span id="cb53-493"><a href="#cb53-493" aria-hidden="true" tabindex="-1"></a>se_classical <span class="ot">&lt;-</span> <span class="fu">summary</span>(probit)<span class="sc">$</span>coefficients[, <span class="st">"Std. Error"</span>]</span>
<span id="cb53-494"><a href="#cb53-494" aria-hidden="true" tabindex="-1"></a>se_robust <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcovHC</span>(probit, <span class="at">type =</span> <span class="st">"HC1"</span>)))</span>
<span id="cb53-495"><a href="#cb53-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-496"><a href="#cb53-496" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb53-497"><a href="#cb53-497" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(probit)),</span>
<span id="cb53-498"><a href="#cb53-498" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model_based =</span> <span class="fu">round</span>(se_classical, <span class="dv">4</span>),</span>
<span id="cb53-499"><a href="#cb53-499" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sandwich =</span> <span class="fu">round</span>(se_robust, <span class="dv">4</span>),</span>
<span id="cb53-500"><a href="#cb53-500" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ratio =</span> <span class="fu">round</span>(se_robust <span class="sc">/</span> se_classical, <span class="dv">3</span>)</span>
<span id="cb53-501"><a href="#cb53-501" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-502"><a href="#cb53-502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-503"><a href="#cb53-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-504"><a href="#cb53-504" aria-hidden="true" tabindex="-1"></a>If model-based and sandwich SEs differ substantially, this signals possible misspecification of the link function. Here they are similar, which is reassuring.</span>
<span id="cb53-505"><a href="#cb53-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-506"><a href="#cb53-506" aria-hidden="true" tabindex="-1"></a><span class="fu">## LPM vs. probit: applied comparison</span></span>
<span id="cb53-507"><a href="#cb53-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-508"><a href="#cb53-508" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitted probabilities</span></span>
<span id="cb53-509"><a href="#cb53-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-512"><a href="#cb53-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-513"><a href="#cb53-513" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lpm-vs-probit-fitted</span></span>
<span id="cb53-514"><a href="#cb53-514" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-515"><a href="#cb53-515" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb53-516"><a href="#cb53-516" aria-hidden="true" tabindex="-1"></a>p_probit <span class="ot">&lt;-</span> <span class="fu">predict</span>(probit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb53-517"><a href="#cb53-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-518"><a href="#cb53-518" aria-hidden="true" tabindex="-1"></a>df_compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb53-519"><a href="#cb53-519" aria-hidden="true" tabindex="-1"></a>  <span class="at">lpm =</span> p_hat_lpm,</span>
<span id="cb53-520"><a href="#cb53-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">probit =</span> p_probit,</span>
<span id="cb53-521"><a href="#cb53-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> Mroz<span class="sc">$</span>lfp_bin</span>
<span id="cb53-522"><a href="#cb53-522" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-523"><a href="#cb53-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-524"><a href="#cb53-524" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_compare, <span class="fu">aes</span>(lpm, probit)) <span class="sc">+</span></span>
<span id="cb53-525"><a href="#cb53-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb53-526"><a href="#cb53-526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb53-527"><a href="#cb53-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LPM vs. Probit fitted probabilities"</span>,</span>
<span id="cb53-528"><a href="#cb53-528" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Close agreement in the interior, diverge near 0 and 1"</span>,</span>
<span id="cb53-529"><a href="#cb53-529" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"P̂ (LPM)"</span>, <span class="at">y =</span> <span class="st">"P̂ (Probit)"</span>)</span>
<span id="cb53-530"><a href="#cb53-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-531"><a href="#cb53-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-534"><a href="#cb53-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-535"><a href="#cb53-535" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lpm-vs-probit-table</span></span>
<span id="cb53-536"><a href="#cb53-536" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary comparison</span></span>
<span id="cb53-537"><a href="#cb53-537" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb53-538"><a href="#cb53-538" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"LPM"</span>, <span class="st">"Probit"</span>),</span>
<span id="cb53-539"><a href="#cb53-539" aria-hidden="true" tabindex="-1"></a>  <span class="at">LogLik =</span> <span class="fu">c</span>(<span class="fu">sum</span>(<span class="fu">dbinom</span>(y, <span class="dv">1</span>, <span class="fu">pmax</span>(<span class="fu">pmin</span>(p_hat_lpm, <span class="dv">1</span><span class="fl">-1e-10</span>), <span class="fl">1e-10</span>), <span class="at">log =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb53-540"><a href="#cb53-540" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as.numeric</span>(<span class="fu">logLik</span>(probit))),</span>
<span id="cb53-541"><a href="#cb53-541" aria-hidden="true" tabindex="-1"></a>  <span class="at">AIC =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">AIC</span>(probit)),</span>
<span id="cb53-542"><a href="#cb53-542" aria-hidden="true" tabindex="-1"></a>  <span class="at">Predictions_outside_01 =</span> <span class="fu">c</span>(<span class="fu">sum</span>(p_hat_lpm <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> p_hat_lpm <span class="sc">&gt;</span> <span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb53-543"><a href="#cb53-543" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-544"><a href="#cb53-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-545"><a href="#cb53-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-546"><a href="#cb53-546" aria-hidden="true" tabindex="-1"></a><span class="fu">### When does the choice matter?</span></span>
<span id="cb53-547"><a href="#cb53-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-548"><a href="#cb53-548" aria-hidden="true" tabindex="-1"></a>The LPM and probit give nearly identical results when predicted probabilities are far from 0 and 1. They diverge most when:</span>
<span id="cb53-549"><a href="#cb53-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-550"><a href="#cb53-550" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>The outcome is rare (or nearly universal)</span>
<span id="cb53-551"><a href="#cb53-551" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Predictions reach the boundaries</span>
<span id="cb53-552"><a href="#cb53-552" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>You need to interpret the functional form (e.g., for counterfactual predictions)</span>
<span id="cb53-553"><a href="#cb53-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-554"><a href="#cb53-554" aria-hidden="true" tabindex="-1"></a>For estimating average marginal effects, the LPM is a robust baseline that doesn't require correct specification of the link function.</span>
<span id="cb53-555"><a href="#cb53-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-556"><a href="#cb53-556" aria-hidden="true" tabindex="-1"></a><span class="fu">## Logit: the main alternative</span></span>
<span id="cb53-557"><a href="#cb53-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-558"><a href="#cb53-558" aria-hidden="true" tabindex="-1"></a>The logit model uses the logistic CDF $\Lambda(z) = e^z/(1 + e^z)$ instead of $\Phi$:</span>
<span id="cb53-559"><a href="#cb53-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-562"><a href="#cb53-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-563"><a href="#cb53-563" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: logit-comparison</span></span>
<span id="cb53-564"><a href="#cb53-564" aria-hidden="true" tabindex="-1"></a>logit <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp_bin <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> inc,</span>
<span id="cb53-565"><a href="#cb53-565" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> Mroz, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb53-566"><a href="#cb53-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-567"><a href="#cb53-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Probit and logit fitted values are nearly identical</span></span>
<span id="cb53-568"><a href="#cb53-568" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">predict</span>(probit, <span class="at">type =</span> <span class="st">"response"</span>) <span class="sc">-</span> <span class="fu">predict</span>(logit, <span class="at">type =</span> <span class="st">"response"</span>)))</span>
<span id="cb53-569"><a href="#cb53-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-570"><a href="#cb53-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-573"><a href="#cb53-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-574"><a href="#cb53-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probit-logit-coefs</span></span>
<span id="cb53-575"><a href="#cb53-575" aria-hidden="true" tabindex="-1"></a><span class="co"># Coefficients differ by approximately a factor of 1.6</span></span>
<span id="cb53-576"><a href="#cb53-576" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb53-577"><a href="#cb53-577" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(probit)),</span>
<span id="cb53-578"><a href="#cb53-578" aria-hidden="true" tabindex="-1"></a>  <span class="at">Probit =</span> <span class="fu">round</span>(<span class="fu">coef</span>(probit), <span class="dv">4</span>),</span>
<span id="cb53-579"><a href="#cb53-579" aria-hidden="true" tabindex="-1"></a>  <span class="at">Logit =</span> <span class="fu">round</span>(<span class="fu">coef</span>(logit), <span class="dv">4</span>),</span>
<span id="cb53-580"><a href="#cb53-580" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ratio =</span> <span class="fu">round</span>(<span class="fu">coef</span>(logit) <span class="sc">/</span> <span class="fu">coef</span>(probit), <span class="dv">3</span>)</span>
<span id="cb53-581"><a href="#cb53-581" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-582"><a href="#cb53-582" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-583"><a href="#cb53-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-584"><a href="#cb53-584" aria-hidden="true" tabindex="-1"></a>The ratio of logit to probit coefficients is approximately $\pi/\sqrt{3} \approx 1.81$, because the logistic distribution has variance $\pi^2/3$ while the standard normal has variance 1. The fitted probabilities are nearly indistinguishable.</span>
<span id="cb53-585"><a href="#cb53-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-586"><a href="#cb53-586" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulation: verifying asymptotic normality</span></span>
<span id="cb53-587"><a href="#cb53-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-588"><a href="#cb53-588" aria-hidden="true" tabindex="-1"></a>The MLE theory from Chapter 6 says $\sqrt{n}(\hat{\beta} - \beta_0) \to N(0, \mathcal{I}^{-1})$. Let's verify with a controlled simulation:</span>
<span id="cb53-589"><a href="#cb53-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-592"><a href="#cb53-592" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-593"><a href="#cb53-593" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: asymptotic-sim</span></span>
<span id="cb53-594"><a href="#cb53-594" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-595"><a href="#cb53-595" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-596"><a href="#cb53-596" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb53-597"><a href="#cb53-597" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb53-598"><a href="#cb53-598" aria-hidden="true" tabindex="-1"></a>n_sim <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb53-599"><a href="#cb53-599" aria-hidden="true" tabindex="-1"></a>beta_true <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.8</span>)  <span class="co"># intercept, x1, x2</span></span>
<span id="cb53-600"><a href="#cb53-600" aria-hidden="true" tabindex="-1"></a>K_sim <span class="ot">&lt;-</span> <span class="fu">length</span>(beta_true)</span>
<span id="cb53-601"><a href="#cb53-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-602"><a href="#cb53-602" aria-hidden="true" tabindex="-1"></a>b_sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, B, K_sim)</span>
<span id="cb53-603"><a href="#cb53-603" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb53-604"><a href="#cb53-604" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb53-605"><a href="#cb53-605" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_sim)</span>
<span id="cb53-606"><a href="#cb53-606" aria-hidden="true" tabindex="-1"></a>  X_sim <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, x1, x2)</span>
<span id="cb53-607"><a href="#cb53-607" aria-hidden="true" tabindex="-1"></a>  p_sim <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(X_sim <span class="sc">%*%</span> beta_true)</span>
<span id="cb53-608"><a href="#cb53-608" aria-hidden="true" tabindex="-1"></a>  y_sim <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n_sim, <span class="dv">1</span>, p_sim)</span>
<span id="cb53-609"><a href="#cb53-609" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y_sim <span class="sc">~</span> x1 <span class="sc">+</span> x2, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb53-610"><a href="#cb53-610" aria-hidden="true" tabindex="-1"></a>  b_sim[b, ] <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)</span>
<span id="cb53-611"><a href="#cb53-611" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-612"><a href="#cb53-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-613"><a href="#cb53-613" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus on x1 coefficient</span></span>
<span id="cb53-614"><a href="#cb53-614" aria-hidden="true" tabindex="-1"></a>j_sim <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb53-615"><a href="#cb53-615" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">true =</span> beta_true[j_sim],</span>
<span id="cb53-616"><a href="#cb53-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_bhat =</span> <span class="fu">mean</span>(b_sim[, j_sim]),</span>
<span id="cb53-617"><a href="#cb53-617" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_bhat =</span> <span class="fu">sd</span>(b_sim[, j_sim]))</span>
<span id="cb53-618"><a href="#cb53-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-619"><a href="#cb53-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-622"><a href="#cb53-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-623"><a href="#cb53-623" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: asymptotic-sim-plot</span></span>
<span id="cb53-624"><a href="#cb53-624" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb53-625"><a href="#cb53-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb53-626"><a href="#cb53-626" aria-hidden="true" tabindex="-1"></a>df_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">b_hat =</span> b_sim[, j_sim])</span>
<span id="cb53-627"><a href="#cb53-627" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_sim, <span class="fu">aes</span>(b_hat)) <span class="sc">+</span></span>
<span id="cb53-628"><a href="#cb53-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb53-629"><a href="#cb53-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb53-630"><a href="#cb53-630" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="fu">mean</span>(b_sim[, j_sim]),</span>
<span id="cb53-631"><a href="#cb53-631" aria-hidden="true" tabindex="-1"></a>                            <span class="at">sd =</span> <span class="fu">sd</span>(b_sim[, j_sim])),</span>
<span id="cb53-632"><a href="#cb53-632" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-633"><a href="#cb53-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> beta_true[j_sim], <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb53-634"><a href="#cb53-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sampling distribution of probit MLE"</span>,</span>
<span id="cb53-635"><a href="#cb53-635" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"n ="</span>, n_sim, <span class="st">"— centered on true β, approximately normal"</span>),</span>
<span id="cb53-636"><a href="#cb53-636" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[x1]))</span>
<span id="cb53-637"><a href="#cb53-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-638"><a href="#cb53-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-639"><a href="#cb53-639" aria-hidden="true" tabindex="-1"></a>The MLE is centered on the true value (unbiased in large samples) and approximately normal, as the theory predicts.</span>
<span id="cb53-640"><a href="#cb53-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-641"><a href="#cb53-641" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prediction and classification</span></span>
<span id="cb53-642"><a href="#cb53-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-645"><a href="#cb53-645" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-646"><a href="#cb53-646" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: classification</span></span>
<span id="cb53-647"><a href="#cb53-647" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted probabilities</span></span>
<span id="cb53-648"><a href="#cb53-648" aria-hidden="true" tabindex="-1"></a>p_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(probit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb53-649"><a href="#cb53-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-650"><a href="#cb53-650" aria-hidden="true" tabindex="-1"></a><span class="co"># Classify at threshold 0.5</span></span>
<span id="cb53-651"><a href="#cb53-651" aria-hidden="true" tabindex="-1"></a>y_pred <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(p_pred <span class="sc">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb53-652"><a href="#cb53-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-653"><a href="#cb53-653" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb53-654"><a href="#cb53-654" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">Predicted =</span> y_pred, <span class="at">Actual =</span> Mroz<span class="sc">$</span>lfp_bin)</span>
<span id="cb53-655"><a href="#cb53-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-656"><a href="#cb53-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-659"><a href="#cb53-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-660"><a href="#cb53-660" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: classification-accuracy</span></span>
<span id="cb53-661"><a href="#cb53-661" aria-hidden="true" tabindex="-1"></a><span class="co"># Accuracy</span></span>
<span id="cb53-662"><a href="#cb53-662" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y_pred <span class="sc">==</span> Mroz<span class="sc">$</span>lfp_bin)</span>
<span id="cb53-663"><a href="#cb53-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-664"><a href="#cb53-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-665"><a href="#cb53-665" aria-hidden="true" tabindex="-1"></a>A simple 50% threshold gives reasonable classification. But the primary goal of probit in econometrics is estimating the effect of covariates on $P(Y=1)$, not prediction.</span>
<span id="cb53-666"><a href="#cb53-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-667"><a href="#cb53-667" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connecting to GMM</span></span>
<span id="cb53-668"><a href="#cb53-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-669"><a href="#cb53-669" aria-hidden="true" tabindex="-1"></a>The probit score equation, the OLS normal equation, and the GLS estimating equation are all special cases of:</span>
<span id="cb53-670"><a href="#cb53-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-671"><a href="#cb53-671" aria-hidden="true" tabindex="-1"></a>$$\frac{1}{n} \sum_{i=1}^n g(W_i, \theta) = 0$$</span>
<span id="cb53-672"><a href="#cb53-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-673"><a href="#cb53-673" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Estimator <span class="pp">|</span> Moment condition $g(W_i, \theta)$ <span class="pp">|</span></span>
<span id="cb53-674"><a href="#cb53-674" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------|----------------------------------|</span></span>
<span id="cb53-675"><a href="#cb53-675" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> OLS <span class="pp">|</span> $X_i(Y_i - X_i'\beta)$ <span class="pp">|</span></span>
<span id="cb53-676"><a href="#cb53-676" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> WLS <span class="pp">|</span> $W_i^{1/2} X_i(Y_i - X_i'\beta)$ <span class="pp">|</span></span>
<span id="cb53-677"><a href="#cb53-677" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Probit MLE <span class="pp">|</span> $w_i(Y_i - \Phi(X_i'\beta)) X_i$ <span class="pp">|</span></span>
<span id="cb53-678"><a href="#cb53-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-681"><a href="#cb53-681" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb53-682"><a href="#cb53-682" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: moment-conditions</span></span>
<span id="cb53-683"><a href="#cb53-683" aria-hidden="true" tabindex="-1"></a><span class="co"># All three are sample moment conditions that equal zero at the estimate</span></span>
<span id="cb53-684"><a href="#cb53-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-685"><a href="#cb53-685" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS</span></span>
<span id="cb53-686"><a href="#cb53-686" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">t</span>(X) <span class="sc">%*%</span> (y <span class="sc">-</span> X <span class="sc">%*%</span> <span class="fu">coef</span>(lpm_ols))))</span>
<span id="cb53-687"><a href="#cb53-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-688"><a href="#cb53-688" aria-hidden="true" tabindex="-1"></a><span class="co"># Probit score</span></span>
<span id="cb53-689"><a href="#cb53-689" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(<span class="fu">abs</span>(<span class="fu">probit_score</span>(<span class="fu">coef</span>(probit))))</span>
<span id="cb53-690"><a href="#cb53-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb53-691"><a href="#cb53-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-692"><a href="#cb53-692" aria-hidden="true" tabindex="-1"></a>When there are more moment conditions than parameters, the **generalized method of moments** (Chapter 13) provides the efficient way to combine them.</span>
<span id="cb53-693"><a href="#cb53-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-694"><a href="#cb53-694" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb53-695"><a href="#cb53-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-696"><a href="#cb53-696" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Concept <span class="pp">|</span> Formula <span class="pp">|</span> R code <span class="pp">|</span></span>
<span id="cb53-697"><a href="#cb53-697" aria-hidden="true" tabindex="-1"></a><span class="pp">|---------|---------|--------|</span></span>
<span id="cb53-698"><a href="#cb53-698" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Linear probability model <span class="pp">|</span> $P(Y=1\mid X) = X'\beta$ <span class="pp">|</span> <span class="in">`lm_robust(y ~ x, se_type = "HC2")`</span> <span class="pp">|</span></span>
<span id="cb53-699"><a href="#cb53-699" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Probit model <span class="pp">|</span> $P(Y=1\mid X) = \Phi(X'\beta)$ <span class="pp">|</span> <span class="in">`glm(y ~ x, family = binomial(link = "probit"))`</span> <span class="pp">|</span></span>
<span id="cb53-700"><a href="#cb53-700" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Log-likelihood <span class="pp">|</span> $\sum<span class="co">[</span><span class="ot">Y\log\Phi + (1-Y)\log(1-\Phi)</span><span class="co">]</span>$ <span class="pp">|</span> <span class="in">`logLik(probit)`</span> <span class="pp">|</span></span>
<span id="cb53-701"><a href="#cb53-701" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Score <span class="pp">|</span> $\sum w_i(Y_i - \Phi(X_i'\beta))X_i = 0$ <span class="pp">|</span> manual (see above) <span class="pp">|</span></span>
<span id="cb53-702"><a href="#cb53-702" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Newton--Raphson <span class="pp">|</span> $\beta^{(t+1)} = \beta^{(t)} - H^{-1}S$ <span class="pp">|</span> <span class="in">`glm()`</span> does this internally <span class="pp">|</span></span>
<span id="cb53-703"><a href="#cb53-703" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Average marginal effect <span class="pp">|</span> $\frac{1}{n}\sum \phi(X_i'\hat\beta)\hat\beta_j$ <span class="pp">|</span> <span class="in">`mean(dnorm(Xb)) * coef(probit)`</span> <span class="pp">|</span></span>
<span id="cb53-704"><a href="#cb53-704" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Model-based SEs <span class="pp">|</span> $\sqrt{<span class="co">[</span><span class="ot">-H_n(\hat\beta)</span><span class="co">]</span>^{-1}_{jj}}$ <span class="pp">|</span> <span class="in">`summary(probit)`</span> <span class="pp">|</span></span>
<span id="cb53-705"><a href="#cb53-705" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Sandwich SEs <span class="pp">|</span> $\sqrt{<span class="co">[</span><span class="ot">H^{-1}(\sum s_is_i')H^{-1}</span><span class="co">]</span>_{jj}}$ <span class="pp">|</span> <span class="in">`vcovHC(probit, type = "HC1")`</span> <span class="pp">|</span></span>
<span id="cb53-706"><a href="#cb53-706" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Logit <span class="pp">|</span> $P(Y=1\mid X) = \Lambda(X'\beta)$ <span class="pp">|</span> <span class="in">`family = binomial(link = "logit")`</span> <span class="pp">|</span></span>
<span id="cb53-707"><a href="#cb53-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-708"><a href="#cb53-708" aria-hidden="true" tabindex="-1"></a>**Key takeaway.** The probit model is the natural extension of MLE to binary outcomes. The coefficients are not marginal effects (compute AME instead), the score equation is a moment condition just like OLS normal equations, and sandwich SEs protect against misspecification of the link function. The LPM remains a robust baseline for estimating average effects.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>