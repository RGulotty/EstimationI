<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8. Asymptotics – Estimation I: Computational Companion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3bbbbd466991e281563892c5dce73c3d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
  MathJax = {
    tex: {
      macros: {
        E: "\\mathbb{E}",
        Var: "\\text{Var}",
        Cov: "\\text{Cov}",
        plim: "\\text{plim}",
        inprob: "\\xrightarrow{p}",
        indist: "\\xrightarrow{d}",
        bhat: "\\hat{\\boldsymbol{\\beta}}",
        N: "\\mathcal{N}",
        tr: "\\text{tr}",
        rank: "\\text{rank}",
        SE: "\\text{SE}",
        diag: "\\text{diag}"
      }
    }
  };
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Estimation I: Computational Companion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./ch01-review.html">
 <span class="dropdown-text">1. Probability and Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch02-cef-blp.html">
 <span class="dropdown-text">2. The CEF and Best Linear Predictor</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch03-ols.html">
 <span class="dropdown-text">3. Multivariate OLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch04-sensitivity.html">
 <span class="dropdown-text">4. Sensitivity and Leverage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch05-gls.html">
 <span class="dropdown-text">5. Efficiency and GLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch06-small-sample.html">
 <span class="dropdown-text">6. Small Sample Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch07-probit.html">
 <span class="dropdown-text">7. Probit and MLE</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch08-asymptotics.html">
 <span class="dropdown-text">8. Asymptotics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch09-testing.html">
 <span class="dropdown-text">9. Hypothesis Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch10-iv.html">
 <span class="dropdown-text">10. Instrumental Variables and 2SLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch11-gmm.html">
 <span class="dropdown-text">11. GMM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch12-panel.html">
 <span class="dropdown-text">12. Panel Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch13-fixed-effects.html">
 <span class="dropdown-text">13. Fixed Effects and Modern DiD</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/UChicago-pol-methods/EstimationI"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-consistency" id="toc-sec-consistency" class="nav-link active" data-scroll-target="#sec-consistency"><span class="header-section-number">1</span> Consistency: what more data buys you</a></li>
  <li><a href="#the-clt-and-why-standard-errors-work" id="toc-the-clt-and-why-standard-errors-work" class="nav-link" data-scroll-target="#the-clt-and-why-standard-errors-work"><span class="header-section-number">2</span> The CLT and why standard errors work</a></li>
  <li><a href="#sec-delta-method" id="toc-sec-delta-method" class="nav-link" data-scroll-target="#sec-delta-method"><span class="header-section-number">3</span> The delta method</a>
  <ul class="collapse">
  <li><a href="#applied-example-long-run-elasticity" id="toc-applied-example-long-run-elasticity" class="nav-link" data-scroll-target="#applied-example-long-run-elasticity"><span class="header-section-number">3.1</span> Applied example: long-run elasticity</a></li>
  <li><a href="#delta-method-by-hand" id="toc-delta-method-by-hand" class="nav-link" data-scroll-target="#delta-method-by-hand"><span class="header-section-number">3.2</span> Delta method by hand</a></li>
  </ul></li>
  <li><a href="#the-bootstrap" id="toc-the-bootstrap" class="nav-link" data-scroll-target="#the-bootstrap"><span class="header-section-number">4</span> The bootstrap</a>
  <ul class="collapse">
  <li><a href="#nonparametric-bootstrap-for-ols" id="toc-nonparametric-bootstrap-for-ols" class="nav-link" data-scroll-target="#nonparametric-bootstrap-for-ols"><span class="header-section-number">4.1</span> Nonparametric bootstrap for OLS</a></li>
  <li><a href="#visualizing-the-bootstrap-distribution" id="toc-visualizing-the-bootstrap-distribution" class="nav-link" data-scroll-target="#visualizing-the-bootstrap-distribution"><span class="header-section-number">4.2</span> Visualizing the bootstrap distribution</a></li>
  <li><a href="#using-the-boot-package" id="toc-using-the-boot-package" class="nav-link" data-scroll-target="#using-the-boot-package"><span class="header-section-number">4.3</span> Using the <code>boot</code> package</a></li>
  </ul></li>
  <li><a href="#delta-method-vs.-bootstrap-a-direct-comparison" id="toc-delta-method-vs.-bootstrap-a-direct-comparison" class="nav-link" data-scroll-target="#delta-method-vs.-bootstrap-a-direct-comparison"><span class="header-section-number">5</span> Delta method vs.&nbsp;bootstrap: a direct comparison</a></li>
  <li><a href="#when-does-each-approach-work" id="toc-when-does-each-approach-work" class="nav-link" data-scroll-target="#when-does-each-approach-work"><span class="header-section-number">6</span> When does each approach work?</a>
  <ul class="collapse">
  <li><a href="#coverage-simulation" id="toc-coverage-simulation" class="nav-link" data-scroll-target="#coverage-simulation"><span class="header-section-number">6.1</span> Coverage simulation</a></li>
  <li><a href="#when-the-bootstrap-breaks-down" id="toc-when-the-bootstrap-breaks-down" class="nav-link" data-scroll-target="#when-the-bootstrap-breaks-down"><span class="header-section-number">6.2</span> When the bootstrap breaks down</a></li>
  </ul></li>
  <li><a href="#applied-workflow-prestige-data" id="toc-applied-workflow-prestige-data" class="nav-link" data-scroll-target="#applied-workflow-prestige-data"><span class="header-section-number">7</span> Applied workflow: Prestige data</a>
  <ul class="collapse">
  <li><a href="#standard-errors-three-ways" id="toc-standard-errors-three-ways" class="nav-link" data-scroll-target="#standard-errors-three-ways"><span class="header-section-number">7.1</span> Standard errors: three ways</a></li>
  <li><a href="#confidence-intervals-three-ways" id="toc-confidence-intervals-three-ways" class="nav-link" data-scroll-target="#confidence-intervals-three-ways"><span class="header-section-number">7.2</span> Confidence intervals: three ways</a></li>
  <li><a href="#nonlinear-function-income-to-education-ratio" id="toc-nonlinear-function-income-to-education-ratio" class="nav-link" data-scroll-target="#nonlinear-function-income-to-education-ratio"><span class="header-section-number">7.3</span> Nonlinear function: income-to-education ratio</a></li>
  <li><a href="#wald-test-with-robust-and-bootstrap-covariance" id="toc-wald-test-with-robust-and-bootstrap-covariance" class="nav-link" data-scroll-target="#wald-test-with-robust-and-bootstrap-covariance"><span class="header-section-number">7.4</span> Wald test with robust and bootstrap covariance</a></li>
  </ul></li>
  <li><a href="#the-asymptotic-toolkit-in-one-picture" id="toc-the-asymptotic-toolkit-in-one-picture" class="nav-link" data-scroll-target="#the-asymptotic-toolkit-in-one-picture"><span class="header-section-number">8</span> The asymptotic toolkit in one picture</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">8. Asymptotics</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Large-sample theory, the delta method, and the bootstrap</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Chapters 5–7 used sandwich standard errors and asymptotic normality without fully justifying them. This chapter provides the justification — and then immediately asks: can we do better? The <strong>bootstrap</strong> offers a simulation-based alternative that avoids distributional assumptions and derivative calculations entirely. We develop both approaches side by side so you can see when they agree, when they diverge, and which to trust.</p>
<p>The chapter is organized around three practical questions:</p>
<ol type="1">
<li><strong>Why are my standard errors approximately right?</strong> (CLT, sandwich)</li>
<li><strong>How do I get SEs for nonlinear functions of parameters?</strong> (Delta method vs.&nbsp;bootstrap)</li>
<li><strong>How do I know my sample is large enough?</strong> (Coverage simulations, bootstrap diagnostics)</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(carData)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="sec-consistency" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="sec-consistency"><span class="header-section-number">1</span> Consistency: what more data buys you</h2>
<p>An estimator is <strong>consistent</strong> if it converges to the truth as the sample grows. Formally, <span class="math inline">\(\hat{\theta}_n \overset{p}{\to} \theta\)</span> means <span class="math inline">\(P(|\hat{\theta}_n - \theta| &gt; \varepsilon) \to 0\)</span> for all <span class="math inline">\(\varepsilon &gt; 0\)</span>.</p>
<p>Consistency is a stronger guarantee than unbiasedness. The “first observation” estimator <span class="math inline">\(\hat{\mu} = X_1\)</span> is unbiased but useless — its variance never shrinks. The sample mean is both unbiased and consistent.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>df_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">1000</span>)) {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  xbar <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, <span class="fu">mean</span>(<span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">24</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">430</span>))))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(B, <span class="at">mean =</span> <span class="dv">24</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">430</span>))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  df_list[[<span class="fu">length</span>(df_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="fu">c</span>(xbar, x1),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimator =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Sample mean"</span>, <span class="st">"First observation"</span>), <span class="at">each =</span> B),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>df_consist <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df_list)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_consist, <span class="fu">aes</span>(estimate, <span class="at">fill =</span> estimator)) <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">24</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> n, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">labeller =</span> label_both) <span class="sc">+</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Consistent vs. merely unbiased"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Both are unbiased, but only the sample mean concentrates on μ"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Estimate of μ = 24"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/consistency-motivation-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p><strong>OLS is consistent</strong> for the projection coefficient <span class="math inline">\(\beta\)</span> whenever <span class="math inline">\(E[X_i e_i] = 0\)</span>. The proof is short: OLS is a continuous function of sample moments (<span class="math inline">\(\hat{Q}_{XX}^{-1} \hat{Q}_{XY}\)</span>), the WLLN says sample moments converge to population moments, and the continuous mapping theorem (CMT) says continuous functions preserve convergence. When <span class="math inline">\(E[Xe] \neq 0\)</span> — endogeneity — OLS is inconsistent regardless of sample size. This motivates the <a href="./ch10-iv.html#sec-iv-estimator">IV estimator</a>.</p>
<div id="thm-clt-ols" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (OLS Consistency)</strong></span> If <span class="math inline">\(\mathbb{E}[X_i e_i] = 0\)</span> and <span class="math inline">\(Q_{XX} = \mathbb{E}[X_i X_i']\)</span> is positive definite, then <span class="math inline">\(\hat\beta_{OLS} \xrightarrow{p} \beta\)</span>. OLS is a continuous function of sample moments; the WLLN and continuous mapping theorem deliver consistency.</p>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Consistency Requires <span class="math inline">\(\mathbb{E}[Xe] = 0\)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<p>OLS is consistent if and only if regressors are uncorrelated with errors. When <span class="math inline">\(\mathbb{E}[Xe] \neq 0\)</span> — from omitted variables, measurement error, or simultaneity — OLS converges to the wrong value no matter how large the sample. This is the fundamental motivation for IV estimation (Chapter 10).</p>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-normal, skewed errors: OLS is still consistent</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sim_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">rexp</span>(n) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># skewed, mean 0</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))[<span class="st">"x"</span>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>df_ols <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">b =</span> <span class="fu">replicate</span>(B, <span class="fu">sim_ols</span>(<span class="dv">20</span>)),   <span class="at">n =</span> <span class="st">"n = 20"</span>),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">b =</span> <span class="fu">replicate</span>(B, <span class="fu">sim_ols</span>(<span class="dv">200</span>)),  <span class="at">n =</span> <span class="st">"n = 200"</span>),</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">b =</span> <span class="fu">replicate</span>(B, <span class="fu">sim_ols</span>(<span class="dv">2000</span>)), <span class="at">n =</span> <span class="st">"n = 2000"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_ols, <span class="fu">aes</span>(b)) <span class="sc">+</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> n, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OLS is consistent even with non-normal errors"</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Errors ~ Exp(1) - 1 (skewed). True β = 3 (blue). Distribution concentrates as n grows."</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/ols-consistency-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-clt-and-why-standard-errors-work" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="the-clt-and-why-standard-errors-work"><span class="header-section-number">2</span> The CLT and why standard errors work</h2>
<p>The <strong>central limit theorem</strong> says that standardized sample means converge to a normal distribution, regardless of the underlying data distribution:</p>
<p><span id="eq-clt"><span class="math display">\[\sqrt{n}(\bar{X}_n - \mu) \overset{d}{\to} N(0, \sigma^2) \tag{1}\]</span></span></p>
<p>Applied to OLS, this gives:</p>
<p><span id="eq-clt-ols"><span class="math display">\[\sqrt{n}(\hat{\beta} - \beta) \overset{d}{\to} N\!\left(0,\; Q_{XX}^{-1}\, \Omega\, Q_{XX}^{-1}\right) \tag{2}\]</span></span></p>
<div id="thm-clt" class="theorem">
<p><span class="theorem-title"><strong>Theorem 2 (Lindeberg-Levy CLT)</strong></span> If <span class="math inline">\(X_1, \ldots, X_n\)</span> are iid with mean <span class="math inline">\(\mu\)</span> and variance <span class="math inline">\(\sigma^2 &lt; \infty\)</span>, then <span class="math inline">\(\sqrt{n}(\bar{X}_n - \mu) \xrightarrow{d} N(0, \sigma^2)\)</span>. Applied to OLS: <span class="math inline">\(\sqrt{n}(\hat\beta - \beta) \xrightarrow{d} N(0, Q_{XX}^{-1}\Omega Q_{XX}^{-1})\)</span>.</p>
</div>
<p>where <span class="math inline">\(\Omega = E[X_i X_i' e_i^2]\)</span>. This is the <a href="./ch05-gls.html#def-sandwich">sandwich variance estimator</a>, now justified by asymptotic theory. The convergence rate depends on the shape of the data — symmetric data need <span class="math inline">\(n \approx 30\)</span>, skewed data may need <span class="math inline">\(n \geq 100\)</span>, and heavy-tailed data may need much more.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># How fast does the CLT kick in? Depends on the error distribution.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>sim_tstat <span class="ot">&lt;-</span> <span class="cf">function</span>(n, rdist_e) {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(B, {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    e <span class="ot">&lt;-</span> <span class="fu">rdist_e</span>(n)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y <span class="sc">~</span> x, <span class="at">se_type =</span> <span class="st">"HC2"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">coef</span>(fit)[<span class="st">"x"</span>] <span class="sc">-</span> <span class="dv">3</span>) <span class="sc">/</span> fit<span class="sc">$</span>std.error[<span class="st">"x"</span>]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>df_clt <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">30</span>,  <span class="cf">function</span>(n) <span class="fu">rnorm</span>(n)),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 30"</span>,  <span class="at">errors =</span> <span class="st">"Normal"</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">30</span>,  <span class="cf">function</span>(n) <span class="fu">rexp</span>(n) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 30"</span>,  <span class="at">errors =</span> <span class="st">"Exponential (skewed)"</span>),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">30</span>,  <span class="cf">function</span>(n) (<span class="fu">rt</span>(n, <span class="at">df =</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">3</span>))),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 30"</span>,  <span class="at">errors =</span> <span class="st">"t(3) (heavy-tailed)"</span>),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">200</span>, <span class="cf">function</span>(n) <span class="fu">rnorm</span>(n)),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 200"</span>, <span class="at">errors =</span> <span class="st">"Normal"</span>),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">200</span>, <span class="cf">function</span>(n) <span class="fu">rexp</span>(n) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 200"</span>, <span class="at">errors =</span> <span class="st">"Exponential (skewed)"</span>),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">200</span>, <span class="cf">function</span>(n) (<span class="fu">rt</span>(n, <span class="at">df =</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">3</span>))),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 200"</span>, <span class="at">errors =</span> <span class="st">"t(3) (heavy-tailed)"</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_clt, <span class="fu">aes</span>(t)) <span class="sc">+</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(errors <span class="sc">~</span> n) <span class="sc">+</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"How fast does the CLT kick in?"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red = N(0,1). Normal errors: fast. Skewed: OK by n=200. Heavy tails: slowest."</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"t-statistic (HC2)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/clt-convergence-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>How fast does the CLT kick in? Depends on the error distribution.</figcaption>
</figure>
</div>
</div>
</div>
<p>With normal errors, the CLT approximation is excellent even at <span class="math inline">\(n = 30\)</span>. With skewed errors (Exponential), it improves by <span class="math inline">\(n = 200\)</span>. With heavy-tailed errors (<span class="math inline">\(t_3\)</span>), it remains imperfect even at <span class="math inline">\(n = 200\)</span>. This is why alternatives like the bootstrap matter.</p>
</section>
<section id="sec-delta-method" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-delta-method"><span class="header-section-number">3</span> The delta method</h2>
<p>Often we care about a <strong>nonlinear function</strong> of the estimated parameters, not <span class="math inline">\(\hat{\beta}\)</span> itself. The delta method uses a first-order Taylor expansion:</p>
<p><span id="eq-delta-method"><span class="math display">\[\sqrt{n}(h(\hat{\theta}) - h(\theta)) \overset{d}{\to} N(0, \; \nabla h' \, V \, \nabla h) \tag{3}\]</span></span></p>
<div id="thm-delta-method" class="theorem">
<p><span class="theorem-title"><strong>Theorem 3 (Delta Method)</strong></span> If <span class="math inline">\(\sqrt{n}(\hat\theta - \theta) \xrightarrow{d} N(0, V)\)</span> and <span class="math inline">\(h\)</span> is continuously differentiable with <span class="math inline">\(\nabla h(\theta) \neq 0\)</span>, then <span class="math inline">\(\sqrt{n}(h(\hat\theta) - h(\theta)) \xrightarrow{d} N(0, \nabla h' V \nabla h)\)</span>.</p>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Delta Method Fails at Boundaries
</div>
</div>
<div class="callout-body-container callout-body">
<p>The delta method relies on a first-order Taylor expansion. It fails when <span class="math inline">\(\nabla h(\theta) = 0\)</span> (e.g., testing <span class="math inline">\(h(\theta) = \theta^2\)</span> at <span class="math inline">\(\theta = 0\)</span>) or when the function is not differentiable. In such cases, the bootstrap (or higher-order expansions) is more reliable.</p>
</div>
</div>
<p>In practice: compute the gradient <span class="math inline">\(\nabla h\)</span>, sandwich it around the covariance matrix, take the square root. R’s <code>car::deltaMethod()</code> does this automatically.</p>
<section id="applied-example-long-run-elasticity" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="applied-example-long-run-elasticity"><span class="header-section-number">3.1</span> Applied example: long-run elasticity</h3>
<p>A model with a lagged dependent variable:</p>
<p><span class="math display">\[y_t = \beta_0 + \beta_1 x_t + \gamma y_{t-1} + \varepsilon_t\]</span></p>
<p>The short-run effect of <span class="math inline">\(x\)</span> is <span class="math inline">\(\beta_1\)</span>. The long-run effect (after the dynamics play out) is:</p>
<p><span class="math display">\[\theta = \frac{\beta_1}{1 - \gamma}\]</span></p>
<p>This is a ratio of regression coefficients — the delta method gives its standard error.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="dv">1</span>; beta1 <span class="ot">&lt;-</span> <span class="fl">0.5</span>; gamma_true <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  y[t] <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> x[t] <span class="sc">+</span> gamma_true <span class="sc">*</span> y[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>dta <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y[<span class="sc">-</span><span class="dv">1</span>], <span class="at">x =</span> x[<span class="sc">-</span><span class="dv">1</span>], <span class="at">y_lag =</span> y[<span class="sc">-</span>n])</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>fit_dyn <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> y_lag, <span class="at">data =</span> dta)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Delta method (car package)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">deltaMethod</span>(fit_dyn, <span class="st">"x / (1 - y_lag)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate    SE 2.5 % 97.5 %
x/(1 - y_lag)    1.332 0.177 0.985   1.68</code></pre>
</div>
</div>
<p>The true long-run effect is <span class="math inline">\(0.5/(1 - 0.7) = 1.67\)</span>.</p>
</section>
<section id="delta-method-by-hand" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="delta-method-by-hand"><span class="header-section-number">3.2</span> Delta method by hand</h3>
<p>Under the hood, <code>deltaMethod()</code> computes the gradient vector and applies <span class="math inline">\(\text{SE} = \sqrt{\nabla h' \hat{V} \nabla h}\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_dyn)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Gradient of h(beta) = beta1 / (1 - gamma) w.r.t. (intercept, x, y_lag)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>grad <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>          <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b[<span class="st">"y_lag"</span>]),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>          b[<span class="st">"x"</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b[<span class="st">"y_lag"</span>])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>se_delta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sqrt</span>(<span class="fu">t</span>(grad) <span class="sc">%*%</span> <span class="fu">vcov</span>(fit_dyn) <span class="sc">%*%</span> grad))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>lr_hat <span class="ot">&lt;-</span> b[<span class="st">"x"</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b[<span class="st">"y_lag"</span>])</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">estimate =</span> lr_hat, <span class="at">se =</span> se_delta,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_lo =</span> lr_hat <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_delta, <span class="at">ci_hi =</span> lr_hat <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_delta)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>estimate.x         se    ci_lo.x    ci_hi.x 
    1.3318     0.1768     0.9853     1.6783 </code></pre>
</div>
</div>
<p>The delta method requires computing derivatives. For simple functions this is fine; for complicated transformations it becomes tedious. The bootstrap avoids derivatives entirely.</p>
</section>
</section>
<section id="the-bootstrap" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="the-bootstrap"><span class="header-section-number">4</span> The bootstrap</h2>
<p>The <strong>bootstrap</strong> (Efron, 1979) replaces analytical derivations with simulation. The idea: if the sample is a good stand-in for the population, then resampling from the sample mimics sampling from the population. The variation across resamples estimates sampling variability.</p>
<section id="nonparametric-bootstrap-for-ols" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="nonparametric-bootstrap-for-ols"><span class="header-section-number">4.1</span> Nonparametric bootstrap for OLS</h3>
<p>The <strong>pairs bootstrap</strong> resamples rows <span class="math inline">\((Y_i, X_i)\)</span> with replacement, re-estimates OLS on each resample, and uses the distribution of <span class="math inline">\(\hat{\beta}^*\)</span> across resamples to estimate the sampling distribution:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Prestige)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> Prestige)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap by hand</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Prestige)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>boot_coefs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, B, <span class="fu">length</span>(<span class="fu">coef</span>(mod)))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  boot_coefs[b, ] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> Prestige[idx, ]))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(boot_coefs) <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">coef</span>(mod))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare bootstrap SEs to classical and sandwich SEs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>se_classical <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mod)))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>se_hc2 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>)))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>se_boot <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_coefs, <span class="dv">2</span>, sd)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(mod)),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Classical =</span> <span class="fu">round</span>(se_classical, <span class="dv">4</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">HC2 =</span> <span class="fu">round</span>(se_hc2, <span class="dv">4</span>),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Bootstrap =</span> <span class="fu">round</span>(se_boot, <span class="dv">4</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable Classical    HC2 Bootstrap
(Intercept) (Intercept)    3.2391 3.2167    3.2067
income           income    0.0003 0.0004    0.0004
education     education    0.3887 0.4469    0.4759
women             women    0.0304 0.0355    0.0369</code></pre>
</div>
</div>
<p>The bootstrap SEs are close to the sandwich (HC2) SEs — both account for heteroskedasticity without assuming a specific form. The classical SEs assume homoskedasticity, which may be wrong.</p>
</section>
<section id="visualizing-the-bootstrap-distribution" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="visualizing-the-bootstrap-distribution"><span class="header-section-number">4.2</span> Visualizing the bootstrap distribution</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_boot <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">income =</span> boot_coefs[, <span class="st">"income"</span>],</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">education =</span> boot_coefs[, <span class="st">"education"</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_boot, <span class="fu">aes</span>(income)) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">coef</span>(mod)[<span class="st">"income"</span>], <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="fu">coef</span>(mod)[<span class="st">"income"</span>], <span class="at">sd =</span> se_hc2[<span class="st">"income"</span>]),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap distribution of income coefficient"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Blue = point estimate, Red = normal approximation (sandwich SE)"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[income]<span class="sc">^</span><span class="st">"*"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/bootstrap-distribution-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="using-the-boot-package" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="using-the-boot-package"><span class="header-section-number">4.3</span> Using the <code>boot</code> package</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The boot package standardizes this workflow</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>boot_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indices) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> data[indices, ]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(<span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> d))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>boot_out <span class="ot">&lt;-</span> <span class="fu">boot</span>(Prestige, boot_fn, <span class="at">R =</span> <span class="dv">5000</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>boot_out</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = Prestige, statistic = boot_fn, R = 5000)


Bootstrap Statistics :
     original     bias    std. error
t1* -6.794334  0.0571783   3.2173023
t2*  0.001314  0.0001055   0.0004326
t3*  4.186637 -0.0831645   0.4685039
t4* -0.008905  0.0055652   0.0366501</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap confidence intervals for education coefficient</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_out, <span class="at">index =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"norm"</span>, <span class="st">"perc"</span>, <span class="st">"bca"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 5000 bootstrap replicates

CALL : 
boot.ci(boot.out = boot_out, type = c("norm", "perc", "bca"), 
    index = 3)

Intervals : 
Level      Normal             Percentile            BCa          
95%   ( 3.352,  5.188 )   ( 3.043,  4.935 )   ( 3.261,  5.020 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
<p>The <code>boot.ci</code> function provides three types of intervals:</p>
<ul>
<li><strong>Normal</strong>: <span class="math inline">\(\hat{\theta} \pm z_{0.025} \cdot \text{SE}_{\text{boot}}\)</span> (same logic as asymptotic, just uses bootstrap SE)</li>
<li><strong>Percentile</strong>: the 2.5th and 97.5th percentiles of <span class="math inline">\(\hat{\theta}^*\)</span> (no normal assumption)</li>
<li><strong>BCa</strong> (bias-corrected, accelerated): adjusts for bias and skewness in the bootstrap distribution (generally preferred)</li>
</ul>
</section>
</section>
<section id="delta-method-vs.-bootstrap-a-direct-comparison" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="delta-method-vs.-bootstrap-a-direct-comparison"><span class="header-section-number">5</span> Delta method vs.&nbsp;bootstrap: a direct comparison</h2>
<p>For the long-run elasticity <span class="math inline">\(\theta = \beta_1/(1 - \gamma)\)</span>, we can compare three approaches:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap the long-run effect</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>boot_lr <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dta), <span class="fu">nrow</span>(dta), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  b_star <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> y_lag, <span class="at">data =</span> dta[idx, ]))</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  b_star[<span class="st">"x"</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b_star[<span class="st">"y_lag"</span>])</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Delta method (from above)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(fit_dyn, <span class="st">"x / (1 - y_lag)"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Delta method"</span>, <span class="st">"Bootstrap"</span>),</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">c</span>(dm<span class="sc">$</span>Estimate, <span class="fu">mean</span>(boot_lr)),</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE =</span> <span class="fu">c</span>(dm<span class="sc">$</span>SE, <span class="fu">sd</span>(boot_lr)),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lo =</span> <span class="fu">c</span>(dm<span class="sc">$</span><span class="st">`</span><span class="at">2.5 %</span><span class="st">`</span>, <span class="fu">quantile</span>(boot_lr, <span class="fl">0.025</span>)),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_hi =</span> <span class="fu">c</span>(dm<span class="sc">$</span><span class="st">`</span><span class="at">97.5 %</span><span class="st">`</span>, <span class="fu">quantile</span>(boot_lr, <span class="fl">0.975</span>))</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Method Estimate     SE  CI_lo CI_hi
     Delta method    1.332 0.1768 0.9853 1.678
2.5%    Bootstrap    1.350 0.1881 1.0229 1.756</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_lr <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lr =</span> boot_lr)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_lr, <span class="fu">aes</span>(lr)) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">60</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> dm<span class="sc">$</span>Estimate, <span class="at">sd =</span> dm<span class="sc">$</span>SE),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.5</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.7</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap vs. delta method for long-run elasticity"</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red = normal approximation (delta method). Dashed = true value 1.67."</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[x] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">hat</span>(gamma))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/delta-vs-bootstrap-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When the bootstrap distribution is close to normal, the two approaches agree. When it is skewed (common for ratios, especially when the denominator can be near zero), the bootstrap percentile interval is more reliable.</p>
</section>
<section id="when-does-each-approach-work" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="when-does-each-approach-work"><span class="header-section-number">6</span> When does each approach work?</h2>
<section id="coverage-simulation" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="coverage-simulation"><span class="header-section-number">6.1</span> Coverage simulation</h3>
<p>The acid test for any inference method: does a nominal 95% interval actually contain the true parameter 95% of the time?</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>n_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">200</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>B_boot <span class="ot">&lt;-</span> <span class="dv">200</span>  <span class="co"># bootstrap replicates per simulation</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> n_vals) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  cover_analytic <span class="ot">&lt;-</span> cover_sandwich <span class="ot">&lt;-</span> cover_boot <span class="ot">&lt;-</span> <span class="fu">logical</span>(B)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    sigma_i <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fu">abs</span>(x)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    e <span class="ot">&lt;-</span> <span class="fu">rt</span>(n, <span class="at">df =</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">3</span>) <span class="sc">*</span> sigma_i  <span class="co"># heavy-tailed + heteroskedastic</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analytic (classical)</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    ci_a <span class="ot">&lt;-</span> <span class="fu">confint</span>(fit)[<span class="st">"x"</span>, ]</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    cover_analytic[b] <span class="ot">&lt;-</span> ci_a[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="dv">3</span> <span class="sc">&lt;</span> ci_a[<span class="dv">2</span>]</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sandwich (HC2)</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    fit_r <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat, <span class="at">se_type =</span> <span class="st">"HC2"</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    ci_s <span class="ot">&lt;-</span> <span class="fu">c</span>(fit_r<span class="sc">$</span>conf.low[<span class="st">"x"</span>], fit_r<span class="sc">$</span>conf.high[<span class="st">"x"</span>])</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    cover_sandwich[b] <span class="ot">&lt;-</span> ci_s[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="dv">3</span> <span class="sc">&lt;</span> ci_s[<span class="dv">2</span>]</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap (percentile)</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    boot_b <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B_boot, {</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat[idx, ]))[<span class="st">"x"</span>]</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    ci_boot <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_b, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    cover_boot[b] <span class="ot">&lt;-</span> ci_boot[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="dv">3</span> <span class="sc">&lt;</span> ci_boot[<span class="dv">2</span>]</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  results[[<span class="fu">length</span>(results) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n,</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">Classical =</span> <span class="fu">mean</span>(cover_analytic),</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">HC2 =</span> <span class="fu">mean</span>(cover_sandwich),</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">Bootstrap =</span> <span class="fu">mean</span>(cover_boot)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(rbind, results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    n Classical   HC2 Bootstrap
1  20     0.862 0.914     0.892
2  50     0.838 0.958     0.932
3 200     0.776 0.928     0.906</code></pre>
</div>
</div>
<p>Key patterns:</p>
<ul>
<li><strong>Classical SEs</strong> undercover when errors are heteroskedastic (they assume homoskedasticity)</li>
<li><strong>HC2 sandwich SEs</strong> do well once <span class="math inline">\(n\)</span> is moderate, but can undercover with very small <span class="math inline">\(n\)</span> and heavy tails</li>
<li><strong>Bootstrap</strong> tends to be robust across scenarios, especially with small <span class="math inline">\(n\)</span></li>
</ul>
</section>
<section id="when-the-bootstrap-breaks-down" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="when-the-bootstrap-breaks-down"><span class="header-section-number">6.2</span> When the bootstrap breaks down</h3>
<p>The bootstrap is not a panacea. It fails or becomes unreliable when:</p>
<ol type="1">
<li><strong>The data are not iid</strong> (time series, clustered data) — you need a block bootstrap or cluster bootstrap instead</li>
<li><strong>The estimator is not smooth</strong> (e.g., the maximum of the data) — the bootstrap distribution can be inconsistent</li>
<li><strong>The sample is very small</strong> (<span class="math inline">\(n &lt; 20\)</span>) — there aren’t enough distinct resamples to represent the population</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap fails for the sample maximum (non-smooth estimator)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>true_max <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># support of Uniform[0,1]</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>boot_max <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  x_star <span class="ot">&lt;-</span> <span class="fu">sample</span>(x, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(x_star)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>df_max <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">max_star =</span> boot_max)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_max, <span class="fu">aes</span>(max_star)) <span class="sc">+</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_max, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap failure: sample maximum of Uniform[0,1]"</span>,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"The bootstrap cannot exceed the sample max, so it cannot cover the true max = 1."</span>,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">max</span>(X<span class="sc">^</span><span class="st">"*"</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/bootstrap-failure-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The bootstrap distribution of the sample maximum is bounded by the observed maximum — it can never reach the true parameter boundary. For smooth functions of sample means (like regression coefficients), this pathology does not arise.</p>
</section>
</section>
<section id="applied-workflow-prestige-data" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="applied-workflow-prestige-data"><span class="header-section-number">7</span> Applied workflow: Prestige data</h2>
<p>Let’s put everything together on a real example, comparing all approaches.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> Prestige)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="standard-errors-three-ways" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="standard-errors-three-ways"><span class="header-section-number">7.1</span> Standard errors: three ways</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Classical (assumes homoskedasticity + normality)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>se_class <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mod)))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Sandwich (asymptotic, no distributional assumptions)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>se_hc2 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>)))</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Bootstrap</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>boot_out <span class="ot">&lt;-</span> <span class="fu">boot</span>(Prestige,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(d, i) <span class="fu">coef</span>(<span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> d[i, ])),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">R =</span> <span class="dv">5000</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>se_boot <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_out<span class="sc">$</span>t, <span class="dv">2</span>, sd)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(mod)),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">round</span>(<span class="fu">coef</span>(mod), <span class="dv">4</span>),</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_classical =</span> <span class="fu">round</span>(se_class, <span class="dv">4</span>),</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_HC2 =</span> <span class="fu">round</span>(se_hc2, <span class="dv">4</span>),</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_bootstrap =</span> <span class="fu">round</span>(se_boot, <span class="dv">4</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Variable Estimate SE_classical SE_HC2 SE_bootstrap
(Intercept) (Intercept)  -6.7943       3.2391 3.2167       3.1653
income           income   0.0013       0.0003 0.0004       0.0004
education     education   4.1866       0.3887 0.4469       0.4724
women             women  -0.0089       0.0304 0.0355       0.0372</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals-three-ways" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="confidence-intervals-three-ways"><span class="header-section-number">7.2</span> Confidence intervals: three ways</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus on the education coefficient (index 3)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>ci_class <span class="ot">&lt;-</span> <span class="fu">confint</span>(mod)[<span class="st">"education"</span>, ]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>ci_hc2 <span class="ot">&lt;-</span> <span class="fu">coefci</span>(mod, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>))[<span class="st">"education"</span>, ]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>ci_boot <span class="ot">&lt;-</span> <span class="fu">boot.ci</span>(boot_out, <span class="at">index =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"perc"</span>)<span class="sc">$</span>percent[<span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Classical"</span>, <span class="st">"HC2 sandwich"</span>, <span class="st">"Bootstrap percentile"</span>),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Lower =</span> <span class="fu">round</span>(<span class="fu">c</span>(ci_class[<span class="dv">1</span>], ci_hc2[<span class="dv">1</span>], ci_boot[<span class="dv">1</span>]), <span class="dv">3</span>),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Upper =</span> <span class="fu">round</span>(<span class="fu">c</span>(ci_class[<span class="dv">2</span>], ci_hc2[<span class="dv">2</span>], ci_boot[<span class="dv">2</span>]), <span class="dv">3</span>),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Width =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">diff</span>(ci_class), <span class="fu">diff</span>(ci_hc2), <span class="fu">diff</span>(ci_boot)), <span class="dv">3</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Method Lower Upper Width
1            Classical 3.415 4.958 1.543
2         HC2 sandwich 3.300 5.073 1.774
3 Bootstrap percentile 3.025 4.881 1.856</code></pre>
</div>
</div>
</section>
<section id="nonlinear-function-income-to-education-ratio" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="nonlinear-function-income-to-education-ratio"><span class="header-section-number">7.3</span> Nonlinear function: income-to-education ratio</h3>
<p>Suppose we want to compare the magnitude of the income and education effects. The ratio <span class="math inline">\(\theta = \beta_{\text{income}} / \beta_{\text{education}}\)</span> tells us how many prestige points a unit of income buys relative to a year of education.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Delta method</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>dm_ratio <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(mod, <span class="st">"income / education"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>dm_ratio</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Estimate       SE    2.5 % 97.5 %
income/education 3.14e-04 8.87e-05 1.40e-04      0</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>boot_ratio <span class="ot">&lt;-</span> boot_out<span class="sc">$</span>t[, <span class="dv">2</span>] <span class="sc">/</span> boot_out<span class="sc">$</span>t[, <span class="dv">3</span>]  <span class="co"># income / education</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">delta_method_se =</span> dm_ratio<span class="sc">$</span>SE,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap_se =</span> <span class="fu">sd</span>(boot_ratio))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>delta_method_se    bootstrap_se 
      8.866e-05       1.747e-04 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_ratio <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ratio =</span> boot_ratio)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_ratio, <span class="fu">aes</span>(ratio)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> dm_ratio<span class="sc">$</span>Estimate, <span class="at">sd =</span> dm_ratio<span class="sc">$</span>SE),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> dm_ratio<span class="sc">$</span>Estimate, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap vs. delta method for β_income / β_education"</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red = normal approximation (delta method). Bootstrap is slightly skewed."</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[income] <span class="sc">/</span> <span class="fu">hat</span>(beta)[education]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch08-asymptotics_files/figure-html/prestige-ratio-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="wald-test-with-robust-and-bootstrap-covariance" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="wald-test-with-robust-and-bootstrap-covariance"><span class="header-section-number">7.4</span> Wald test with robust and bootstrap covariance</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Classical F-test</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="fu">c</span>(<span class="st">"education = 0"</span>, <span class="st">"women = 0"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
education = 0
women = 0

Model 1: restricted model
Model 2: prestige ~ income + education + women

  Res.Df   RSS Df Sum of Sq    F Pr(&gt;F)    
1    100 14616                             
2     98  6034  2      8583 69.7 &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust Wald test (sandwich)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="fu">c</span>(<span class="st">"education = 0"</span>, <span class="st">"women = 0"</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>), <span class="at">test =</span> <span class="st">"Chisq"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
education = 0
women = 0

Model 1: restricted model
Model 2: prestige ~ income + education + women

Note: Coefficient covariance matrix supplied.

  Res.Df Df Chisq Pr(&gt;Chisq)    
1    100                        
2     98  2   118     &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
</section>
<section id="the-asymptotic-toolkit-in-one-picture" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="the-asymptotic-toolkit-in-one-picture"><span class="header-section-number">8</span> The asymptotic toolkit in one picture</h2>
<p>Every estimator in this course follows the same pattern:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>Tool</th>
<th>What it does</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1. Consistency</td>
<td>WLLN + CMT</td>
<td>Sample moments → population moments; <span class="math inline">\(\hat{\theta} \overset{p}{\to} \theta\)</span></td>
</tr>
<tr class="even">
<td>2. Asymptotic normality</td>
<td>CLT + Slutsky</td>
<td><span class="math inline">\(\sqrt{n}(\hat{\theta} - \theta) \overset{d}{\to} N(0, V)\)</span></td>
</tr>
<tr class="odd">
<td>3. Variance estimation</td>
<td>Sandwich</td>
<td><span class="math inline">\(\hat{V} \overset{p}{\to} V\)</span> (robust to misspecification)</td>
</tr>
<tr class="even">
<td>4. Nonlinear functions</td>
<td>Delta method or bootstrap</td>
<td>SEs for <span class="math inline">\(h(\hat{\theta})\)</span></td>
</tr>
</tbody>
</table>
<p>This applies identically to OLS, probit MLE (Chapter 7), IV (Chapter 10), and GMM (Chapter 11) — only the moment condition changes:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Estimator</th>
<th>Moment condition</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OLS</td>
<td><span class="math inline">\(E[X_i(Y_i - X_i'\beta)] = 0\)</span></td>
</tr>
<tr class="even">
<td>Probit MLE</td>
<td><span class="math inline">\(E[s_i(\beta)] = 0\)</span> (score)</td>
</tr>
<tr class="odd">
<td>IV</td>
<td><span class="math inline">\(E[Z_i(Y_i - X_i'\beta)] = 0\)</span></td>
</tr>
<tr class="even">
<td>GMM</td>
<td><span class="math inline">\(E[g(W_i, \theta)] = 0\)</span> (general)</td>
</tr>
</tbody>
</table>
</section>
<section id="summary" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="summary"><span class="header-section-number">9</span> Summary</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 28%">
<col style="width: 26%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>How it works</th>
<th>Advantages</th>
<th>Limitations</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Classical SE</td>
<td>Assumes <span class="math inline">\(e \sim N(0, \sigma^2)\)</span></td>
<td>Exact under normality</td>
<td>Wrong under heteroskedasticity</td>
</tr>
<tr class="even">
<td>Sandwich (HC2)</td>
<td>Estimates <span class="math inline">\(E[X_i X_i' e_i^2]\)</span></td>
<td>No distributional assumptions</td>
<td>Needs moderate <span class="math inline">\(n\)</span></td>
</tr>
<tr class="odd">
<td>Delta method</td>
<td>Taylor expansion of <span class="math inline">\(h(\hat{\beta})\)</span></td>
<td>Fast, analytical</td>
<td>Requires derivatives; assumes normality of <span class="math inline">\(h(\hat{\beta})\)</span></td>
</tr>
<tr class="even">
<td>Bootstrap</td>
<td>Resample rows, re-estimate</td>
<td>No derivatives; captures skewness</td>
<td>Needs iid; slow; fails for non-smooth estimators</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<colgroup>
<col style="width: 42%">
<col style="width: 57%">
</colgroup>
<thead>
<tr class="header">
<th>Task</th>
<th>R code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sandwich SEs</td>
<td><code>vcovHC(mod, type = "HC2")</code> or <code>lm_robust(..., se_type = "HC2")</code></td>
</tr>
<tr class="even">
<td>Delta method</td>
<td><code>car::deltaMethod(mod, "expression")</code></td>
</tr>
<tr class="odd">
<td>Bootstrap SEs</td>
<td><code>boot(data, statistic, R = 5000)</code></td>
</tr>
<tr class="even">
<td>Bootstrap CIs</td>
<td><code>boot.ci(boot_out, type = "perc")</code> or <code>type = "bca"</code></td>
</tr>
<tr class="odd">
<td>Robust Wald test</td>
<td><code>linearHypothesis(mod, ..., vcov = vcovHC, test = "Chisq")</code></td>
</tr>
</tbody>
</table>
<p><strong>Key takeaways.</strong></p>
<ul>
<li>The CLT justifies using normal-based inference for OLS, probit, IV, and GMM — but convergence speed depends on the error distribution. Heavy tails and small samples require caution.</li>
<li>The sandwich SE and the bootstrap SE are both robust to heteroskedasticity. They usually agree for linear models with moderate <span class="math inline">\(n\)</span>.</li>
<li>The delta method and the bootstrap both handle nonlinear functions. Use the delta method when you can compute derivatives easily; use the bootstrap when the function is complicated or the normal approximation is suspect.</li>
<li>When in doubt about whether <span class="math inline">\(n\)</span> is “large enough,” compare all three approaches. If they disagree substantially, trust the bootstrap percentile or BCa interval.</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/UChicago-pol-methods\.github\.io\/EstimationI\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "8. Asymptotics"</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Large-sample theory, the delta method, and the bootstrap"</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>Chapters 5--7 used sandwich standard errors and asymptotic normality without fully justifying them. This chapter provides the justification --- and then immediately asks: can we do better? The **bootstrap** offers a simulation-based alternative that avoids distributional assumptions and derivative calculations entirely. We develop both approaches side by side so you can see when they agree, when they diverge, and which to trust.</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>The chapter is organized around three practical questions:</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Why are my standard errors approximately right?** (CLT, sandwich)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**How do I get SEs for nonlinear functions of parameters?** (Delta method vs. bootstrap)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**How do I know my sample is large enough?** (Coverage simulations, bootstrap diagnostics)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(carData)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Consistency: what more data buys you {#sec-consistency}</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>An estimator is **consistent** if it converges to the truth as the sample grows. Formally, $\hat{\theta}_n \overset{p}{\to} \theta$ means $P(|\hat{\theta}_n - \theta| &gt; \varepsilon) \to 0$ for all $\varepsilon &gt; 0$.</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>Consistency is a stronger guarantee than unbiasedness. The "first observation" estimator $\hat{\mu} = X_1$ is unbiased but useless --- its variance never shrinks. The sample mean is both unbiased and consistent.</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: consistency-motivation</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>df_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">1000</span>)) {</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>  xbar <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, <span class="fu">mean</span>(<span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">24</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">430</span>))))</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(B, <span class="at">mean =</span> <span class="dv">24</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">430</span>))</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>  df_list[[<span class="fu">length</span>(df_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="fu">c</span>(xbar, x1),</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimator =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Sample mean"</span>, <span class="st">"First observation"</span>), <span class="at">each =</span> B),</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>df_consist <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df_list)</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_consist, <span class="fu">aes</span>(estimate, <span class="at">fill =</span> estimator)) <span class="sc">+</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">24</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> n, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">labeller =</span> label_both) <span class="sc">+</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Consistent vs. merely unbiased"</span>,</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Both are unbiased, but only the sample mean concentrates on μ"</span>,</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Estimate of μ = 24"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>)</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>**OLS is consistent** for the projection coefficient $\beta$ whenever $E<span class="co">[</span><span class="ot">X_i e_i</span><span class="co">]</span> = 0$. The proof is short: OLS is a continuous function of sample moments ($\hat{Q}_{XX}^{-1} \hat{Q}_{XY}$), the WLLN says sample moments converge to population moments, and the continuous mapping theorem (CMT) says continuous functions preserve convergence. When $E<span class="co">[</span><span class="ot">Xe</span><span class="co">]</span> \neq 0$ --- endogeneity --- OLS is inconsistent regardless of sample size. This motivates the <span class="co">[</span><span class="ot">IV estimator</span><span class="co">](ch10-iv.qmd#sec-iv-estimator)</span>.</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>::: {#thm-clt-ols}</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## OLS Consistency</span></span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>If $\mathbb{E}<span class="co">[</span><span class="ot">X_i e_i</span><span class="co">]</span> = 0$ and $Q_{XX} = \mathbb{E}<span class="co">[</span><span class="ot">X_i X_i'</span><span class="co">]</span>$ is positive definite, then $\hat\beta_{OLS} \xrightarrow{p} \beta$. OLS is a continuous function of sample moments; the WLLN and continuous mapping theorem deliver consistency.</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Consistency Requires $\mathbb{E}[Xe] = 0$</span></span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>OLS is consistent if and only if regressors are uncorrelated with errors. When $\mathbb{E}<span class="co">[</span><span class="ot">Xe</span><span class="co">]</span> \neq 0$ — from omitted variables, measurement error, or simultaneity — OLS converges to the wrong value no matter how large the sample. This is the fundamental motivation for IV estimation (Chapter 10).</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ols-consistency</span></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-normal, skewed errors: OLS is still consistent</span></span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a>sim_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(n) {</span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> <span class="fu">rexp</span>(n) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># skewed, mean 0</span></span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))[<span class="st">"x"</span>]</span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a>df_ols <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">b =</span> <span class="fu">replicate</span>(B, <span class="fu">sim_ols</span>(<span class="dv">20</span>)),   <span class="at">n =</span> <span class="st">"n = 20"</span>),</span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">b =</span> <span class="fu">replicate</span>(B, <span class="fu">sim_ols</span>(<span class="dv">200</span>)),  <span class="at">n =</span> <span class="st">"n = 200"</span>),</span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">b =</span> <span class="fu">replicate</span>(B, <span class="fu">sim_ols</span>(<span class="dv">2000</span>)), <span class="at">n =</span> <span class="st">"n = 2000"</span>)</span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_ols, <span class="fu">aes</span>(b)) <span class="sc">+</span></span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> n, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"OLS is consistent even with non-normal errors"</span>,</span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Errors ~ Exp(1) - 1 (skewed). True β = 3 (blue). Distribution concentrates as n grows."</span>,</span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)))</span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## The CLT and why standard errors work</span></span>
<span id="cb37-112"><a href="#cb37-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-113"><a href="#cb37-113" aria-hidden="true" tabindex="-1"></a>The **central limit theorem** says that standardized sample means converge to a normal distribution, regardless of the underlying data distribution:</span>
<span id="cb37-114"><a href="#cb37-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-115"><a href="#cb37-115" aria-hidden="true" tabindex="-1"></a>$$\sqrt{n}(\bar{X}_n - \mu) \overset{d}{\to} N(0, \sigma^2)$$ {#eq-clt}</span>
<span id="cb37-116"><a href="#cb37-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-117"><a href="#cb37-117" aria-hidden="true" tabindex="-1"></a>Applied to OLS, this gives:</span>
<span id="cb37-118"><a href="#cb37-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-119"><a href="#cb37-119" aria-hidden="true" tabindex="-1"></a>$$\sqrt{n}(\hat{\beta} - \beta) \overset{d}{\to} N<span class="sc">\!</span>\left(0,\; Q_{XX}^{-1}\, \Omega\, Q_{XX}^{-1}\right)$$ {#eq-clt-ols}</span>
<span id="cb37-120"><a href="#cb37-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-121"><a href="#cb37-121" aria-hidden="true" tabindex="-1"></a>::: {#thm-clt}</span>
<span id="cb37-122"><a href="#cb37-122" aria-hidden="true" tabindex="-1"></a><span class="fu">## Lindeberg-Levy CLT</span></span>
<span id="cb37-123"><a href="#cb37-123" aria-hidden="true" tabindex="-1"></a>If $X_1, \ldots, X_n$ are iid with mean $\mu$ and variance $\sigma^2 &lt; \infty$, then $\sqrt{n}(\bar{X}_n - \mu) \xrightarrow{d} N(0, \sigma^2)$. Applied to OLS: $\sqrt{n}(\hat\beta - \beta) \xrightarrow{d} N(0, Q_{XX}^{-1}\Omega Q_{XX}^{-1})$.</span>
<span id="cb37-124"><a href="#cb37-124" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb37-125"><a href="#cb37-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-126"><a href="#cb37-126" aria-hidden="true" tabindex="-1"></a>where $\Omega = E<span class="co">[</span><span class="ot">X_i X_i' e_i^2</span><span class="co">]</span>$. This is the <span class="co">[</span><span class="ot">sandwich variance estimator</span><span class="co">](ch05-gls.qmd#def-sandwich)</span>, now justified by asymptotic theory. The convergence rate depends on the shape of the data --- symmetric data need $n \approx 30$, skewed data may need $n \geq 100$, and heavy-tailed data may need much more.</span>
<span id="cb37-127"><a href="#cb37-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-130"><a href="#cb37-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-131"><a href="#cb37-131" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: clt-convergence</span></span>
<span id="cb37-132"><a href="#cb37-132" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "How fast does the CLT kick in? Depends on the error distribution."</span></span>
<span id="cb37-133"><a href="#cb37-133" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb37-134"><a href="#cb37-134" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb37-135"><a href="#cb37-135" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-136"><a href="#cb37-136" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb37-137"><a href="#cb37-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-138"><a href="#cb37-138" aria-hidden="true" tabindex="-1"></a><span class="co"># How fast does the CLT kick in? Depends on the error distribution.</span></span>
<span id="cb37-139"><a href="#cb37-139" aria-hidden="true" tabindex="-1"></a>sim_tstat <span class="ot">&lt;-</span> <span class="cf">function</span>(n, rdist_e) {</span>
<span id="cb37-140"><a href="#cb37-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(B, {</span>
<span id="cb37-141"><a href="#cb37-141" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb37-142"><a href="#cb37-142" aria-hidden="true" tabindex="-1"></a>    e <span class="ot">&lt;-</span> <span class="fu">rdist_e</span>(n)</span>
<span id="cb37-143"><a href="#cb37-143" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb37-144"><a href="#cb37-144" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y <span class="sc">~</span> x, <span class="at">se_type =</span> <span class="st">"HC2"</span>)</span>
<span id="cb37-145"><a href="#cb37-145" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">coef</span>(fit)[<span class="st">"x"</span>] <span class="sc">-</span> <span class="dv">3</span>) <span class="sc">/</span> fit<span class="sc">$</span>std.error[<span class="st">"x"</span>]</span>
<span id="cb37-146"><a href="#cb37-146" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb37-147"><a href="#cb37-147" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-148"><a href="#cb37-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-149"><a href="#cb37-149" aria-hidden="true" tabindex="-1"></a>df_clt <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb37-150"><a href="#cb37-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">30</span>,  <span class="cf">function</span>(n) <span class="fu">rnorm</span>(n)),</span>
<span id="cb37-151"><a href="#cb37-151" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 30"</span>,  <span class="at">errors =</span> <span class="st">"Normal"</span>),</span>
<span id="cb37-152"><a href="#cb37-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">30</span>,  <span class="cf">function</span>(n) <span class="fu">rexp</span>(n) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb37-153"><a href="#cb37-153" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 30"</span>,  <span class="at">errors =</span> <span class="st">"Exponential (skewed)"</span>),</span>
<span id="cb37-154"><a href="#cb37-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">30</span>,  <span class="cf">function</span>(n) (<span class="fu">rt</span>(n, <span class="at">df =</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">3</span>))),</span>
<span id="cb37-155"><a href="#cb37-155" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 30"</span>,  <span class="at">errors =</span> <span class="st">"t(3) (heavy-tailed)"</span>),</span>
<span id="cb37-156"><a href="#cb37-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">200</span>, <span class="cf">function</span>(n) <span class="fu">rnorm</span>(n)),</span>
<span id="cb37-157"><a href="#cb37-157" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 200"</span>, <span class="at">errors =</span> <span class="st">"Normal"</span>),</span>
<span id="cb37-158"><a href="#cb37-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">200</span>, <span class="cf">function</span>(n) <span class="fu">rexp</span>(n) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb37-159"><a href="#cb37-159" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 200"</span>, <span class="at">errors =</span> <span class="st">"Exponential (skewed)"</span>),</span>
<span id="cb37-160"><a href="#cb37-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">sim_tstat</span>(<span class="dv">200</span>, <span class="cf">function</span>(n) (<span class="fu">rt</span>(n, <span class="at">df =</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">3</span>))),</span>
<span id="cb37-161"><a href="#cb37-161" aria-hidden="true" tabindex="-1"></a>             <span class="at">n =</span> <span class="st">"n = 200"</span>, <span class="at">errors =</span> <span class="st">"t(3) (heavy-tailed)"</span>)</span>
<span id="cb37-162"><a href="#cb37-162" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-163"><a href="#cb37-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-164"><a href="#cb37-164" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_clt, <span class="fu">aes</span>(t)) <span class="sc">+</span></span>
<span id="cb37-165"><a href="#cb37-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-166"><a href="#cb37-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb37-167"><a href="#cb37-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(errors <span class="sc">~</span> n) <span class="sc">+</span></span>
<span id="cb37-168"><a href="#cb37-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb37-169"><a href="#cb37-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"How fast does the CLT kick in?"</span>,</span>
<span id="cb37-170"><a href="#cb37-170" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red = N(0,1). Normal errors: fast. Skewed: OK by n=200. Heavy tails: slowest."</span>,</span>
<span id="cb37-171"><a href="#cb37-171" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"t-statistic (HC2)"</span>)</span>
<span id="cb37-172"><a href="#cb37-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-173"><a href="#cb37-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-174"><a href="#cb37-174" aria-hidden="true" tabindex="-1"></a>With normal errors, the CLT approximation is excellent even at $n = 30$. With skewed errors (Exponential), it improves by $n = 200$. With heavy-tailed errors ($t_3$), it remains imperfect even at $n = 200$. This is why alternatives like the bootstrap matter.</span>
<span id="cb37-175"><a href="#cb37-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-176"><a href="#cb37-176" aria-hidden="true" tabindex="-1"></a><span class="fu">## The delta method {#sec-delta-method}</span></span>
<span id="cb37-177"><a href="#cb37-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-178"><a href="#cb37-178" aria-hidden="true" tabindex="-1"></a>Often we care about a **nonlinear function** of the estimated parameters, not $\hat{\beta}$ itself. The delta method uses a first-order Taylor expansion:</span>
<span id="cb37-179"><a href="#cb37-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-180"><a href="#cb37-180" aria-hidden="true" tabindex="-1"></a>$$\sqrt{n}(h(\hat{\theta}) - h(\theta)) \overset{d}{\to} N(0, \; \nabla h' \, V \, \nabla h)$$ {#eq-delta-method}</span>
<span id="cb37-181"><a href="#cb37-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-182"><a href="#cb37-182" aria-hidden="true" tabindex="-1"></a>::: {#thm-delta-method}</span>
<span id="cb37-183"><a href="#cb37-183" aria-hidden="true" tabindex="-1"></a><span class="fu">## Delta Method</span></span>
<span id="cb37-184"><a href="#cb37-184" aria-hidden="true" tabindex="-1"></a>If $\sqrt{n}(\hat\theta - \theta) \xrightarrow{d} N(0, V)$ and $h$ is continuously differentiable with $\nabla h(\theta) \neq 0$, then $\sqrt{n}(h(\hat\theta) - h(\theta)) \xrightarrow{d} N(0, \nabla h' V \nabla h)$.</span>
<span id="cb37-185"><a href="#cb37-185" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb37-186"><a href="#cb37-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-187"><a href="#cb37-187" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb37-188"><a href="#cb37-188" aria-hidden="true" tabindex="-1"></a><span class="fu">## Delta Method Fails at Boundaries</span></span>
<span id="cb37-189"><a href="#cb37-189" aria-hidden="true" tabindex="-1"></a>The delta method relies on a first-order Taylor expansion. It fails when $\nabla h(\theta) = 0$ (e.g., testing $h(\theta) = \theta^2$ at $\theta = 0$) or when the function is not differentiable. In such cases, the bootstrap (or higher-order expansions) is more reliable.</span>
<span id="cb37-190"><a href="#cb37-190" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb37-191"><a href="#cb37-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-192"><a href="#cb37-192" aria-hidden="true" tabindex="-1"></a>In practice: compute the gradient $\nabla h$, sandwich it around the covariance matrix, take the square root. R's <span class="in">`car::deltaMethod()`</span> does this automatically.</span>
<span id="cb37-193"><a href="#cb37-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-194"><a href="#cb37-194" aria-hidden="true" tabindex="-1"></a><span class="fu">### Applied example: long-run elasticity</span></span>
<span id="cb37-195"><a href="#cb37-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-196"><a href="#cb37-196" aria-hidden="true" tabindex="-1"></a>A model with a lagged dependent variable:</span>
<span id="cb37-197"><a href="#cb37-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-198"><a href="#cb37-198" aria-hidden="true" tabindex="-1"></a>$$y_t = \beta_0 + \beta_1 x_t + \gamma y_{t-1} + \varepsilon_t$$</span>
<span id="cb37-199"><a href="#cb37-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-200"><a href="#cb37-200" aria-hidden="true" tabindex="-1"></a>The short-run effect of $x$ is $\beta_1$. The long-run effect (after the dynamics play out) is:</span>
<span id="cb37-201"><a href="#cb37-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-202"><a href="#cb37-202" aria-hidden="true" tabindex="-1"></a>$$\theta = \frac{\beta_1}{1 - \gamma}$$</span>
<span id="cb37-203"><a href="#cb37-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-204"><a href="#cb37-204" aria-hidden="true" tabindex="-1"></a>This is a ratio of regression coefficients --- the delta method gives its standard error.</span>
<span id="cb37-205"><a href="#cb37-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-208"><a href="#cb37-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-209"><a href="#cb37-209" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delta-applied</span></span>
<span id="cb37-210"><a href="#cb37-210" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-211"><a href="#cb37-211" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb37-212"><a href="#cb37-212" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="dv">1</span>; beta1 <span class="ot">&lt;-</span> <span class="fl">0.5</span>; gamma_true <span class="ot">&lt;-</span> <span class="fl">0.7</span></span>
<span id="cb37-213"><a href="#cb37-213" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb37-214"><a href="#cb37-214" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb37-215"><a href="#cb37-215" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-216"><a href="#cb37-216" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb37-217"><a href="#cb37-217" aria-hidden="true" tabindex="-1"></a>  y[t] <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> x[t] <span class="sc">+</span> gamma_true <span class="sc">*</span> y[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb37-218"><a href="#cb37-218" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-219"><a href="#cb37-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-220"><a href="#cb37-220" aria-hidden="true" tabindex="-1"></a>dta <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y[<span class="sc">-</span><span class="dv">1</span>], <span class="at">x =</span> x[<span class="sc">-</span><span class="dv">1</span>], <span class="at">y_lag =</span> y[<span class="sc">-</span>n])</span>
<span id="cb37-221"><a href="#cb37-221" aria-hidden="true" tabindex="-1"></a>fit_dyn <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> y_lag, <span class="at">data =</span> dta)</span>
<span id="cb37-222"><a href="#cb37-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-223"><a href="#cb37-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Delta method (car package)</span></span>
<span id="cb37-224"><a href="#cb37-224" aria-hidden="true" tabindex="-1"></a><span class="fu">deltaMethod</span>(fit_dyn, <span class="st">"x / (1 - y_lag)"</span>)</span>
<span id="cb37-225"><a href="#cb37-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-226"><a href="#cb37-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-227"><a href="#cb37-227" aria-hidden="true" tabindex="-1"></a>The true long-run effect is $0.5/(1 - 0.7) = 1.67$.</span>
<span id="cb37-228"><a href="#cb37-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-229"><a href="#cb37-229" aria-hidden="true" tabindex="-1"></a><span class="fu">### Delta method by hand</span></span>
<span id="cb37-230"><a href="#cb37-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-231"><a href="#cb37-231" aria-hidden="true" tabindex="-1"></a>Under the hood, <span class="in">`deltaMethod()`</span> computes the gradient vector and applies $\text{SE} = \sqrt{\nabla h' \hat{V} \nabla h}$:</span>
<span id="cb37-232"><a href="#cb37-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-235"><a href="#cb37-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-236"><a href="#cb37-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delta-by-hand</span></span>
<span id="cb37-237"><a href="#cb37-237" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_dyn)</span>
<span id="cb37-238"><a href="#cb37-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-239"><a href="#cb37-239" aria-hidden="true" tabindex="-1"></a><span class="co"># Gradient of h(beta) = beta1 / (1 - gamma) w.r.t. (intercept, x, y_lag)</span></span>
<span id="cb37-240"><a href="#cb37-240" aria-hidden="true" tabindex="-1"></a>grad <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,</span>
<span id="cb37-241"><a href="#cb37-241" aria-hidden="true" tabindex="-1"></a>          <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b[<span class="st">"y_lag"</span>]),</span>
<span id="cb37-242"><a href="#cb37-242" aria-hidden="true" tabindex="-1"></a>          b[<span class="st">"x"</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b[<span class="st">"y_lag"</span>])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb37-243"><a href="#cb37-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-244"><a href="#cb37-244" aria-hidden="true" tabindex="-1"></a>se_delta <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sqrt</span>(<span class="fu">t</span>(grad) <span class="sc">%*%</span> <span class="fu">vcov</span>(fit_dyn) <span class="sc">%*%</span> grad))</span>
<span id="cb37-245"><a href="#cb37-245" aria-hidden="true" tabindex="-1"></a>lr_hat <span class="ot">&lt;-</span> b[<span class="st">"x"</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b[<span class="st">"y_lag"</span>])</span>
<span id="cb37-246"><a href="#cb37-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-247"><a href="#cb37-247" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">estimate =</span> lr_hat, <span class="at">se =</span> se_delta,</span>
<span id="cb37-248"><a href="#cb37-248" aria-hidden="true" tabindex="-1"></a>  <span class="at">ci_lo =</span> lr_hat <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_delta, <span class="at">ci_hi =</span> lr_hat <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_delta)</span>
<span id="cb37-249"><a href="#cb37-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-250"><a href="#cb37-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-251"><a href="#cb37-251" aria-hidden="true" tabindex="-1"></a>The delta method requires computing derivatives. For simple functions this is fine; for complicated transformations it becomes tedious. The bootstrap avoids derivatives entirely.</span>
<span id="cb37-252"><a href="#cb37-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-253"><a href="#cb37-253" aria-hidden="true" tabindex="-1"></a><span class="fu">## The bootstrap</span></span>
<span id="cb37-254"><a href="#cb37-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-255"><a href="#cb37-255" aria-hidden="true" tabindex="-1"></a>The **bootstrap** (Efron, 1979) replaces analytical derivations with simulation. The idea: if the sample is a good stand-in for the population, then resampling from the sample mimics sampling from the population. The variation across resamples estimates sampling variability.</span>
<span id="cb37-256"><a href="#cb37-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-257"><a href="#cb37-257" aria-hidden="true" tabindex="-1"></a><span class="fu">### Nonparametric bootstrap for OLS</span></span>
<span id="cb37-258"><a href="#cb37-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-259"><a href="#cb37-259" aria-hidden="true" tabindex="-1"></a>The **pairs bootstrap** resamples rows $(Y_i, X_i)$ with replacement, re-estimates OLS on each resample, and uses the distribution of $\hat{\beta}^*$ across resamples to estimate the sampling distribution:</span>
<span id="cb37-260"><a href="#cb37-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-263"><a href="#cb37-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-264"><a href="#cb37-264" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bootstrap-ols</span></span>
<span id="cb37-265"><a href="#cb37-265" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Prestige)</span>
<span id="cb37-266"><a href="#cb37-266" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> Prestige)</span>
<span id="cb37-267"><a href="#cb37-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-268"><a href="#cb37-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap by hand</span></span>
<span id="cb37-269"><a href="#cb37-269" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-270"><a href="#cb37-270" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb37-271"><a href="#cb37-271" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Prestige)</span>
<span id="cb37-272"><a href="#cb37-272" aria-hidden="true" tabindex="-1"></a>boot_coefs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, B, <span class="fu">length</span>(<span class="fu">coef</span>(mod)))</span>
<span id="cb37-273"><a href="#cb37-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-274"><a href="#cb37-274" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb37-275"><a href="#cb37-275" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-276"><a href="#cb37-276" aria-hidden="true" tabindex="-1"></a>  boot_coefs[b, ] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women,</span>
<span id="cb37-277"><a href="#cb37-277" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> Prestige[idx, ]))</span>
<span id="cb37-278"><a href="#cb37-278" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-279"><a href="#cb37-279" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(boot_coefs) <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">coef</span>(mod))</span>
<span id="cb37-280"><a href="#cb37-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-281"><a href="#cb37-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-284"><a href="#cb37-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-285"><a href="#cb37-285" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bootstrap-vs-analytical</span></span>
<span id="cb37-286"><a href="#cb37-286" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare bootstrap SEs to classical and sandwich SEs</span></span>
<span id="cb37-287"><a href="#cb37-287" aria-hidden="true" tabindex="-1"></a>se_classical <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mod)))</span>
<span id="cb37-288"><a href="#cb37-288" aria-hidden="true" tabindex="-1"></a>se_hc2 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>)))</span>
<span id="cb37-289"><a href="#cb37-289" aria-hidden="true" tabindex="-1"></a>se_boot <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_coefs, <span class="dv">2</span>, sd)</span>
<span id="cb37-290"><a href="#cb37-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-291"><a href="#cb37-291" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb37-292"><a href="#cb37-292" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(mod)),</span>
<span id="cb37-293"><a href="#cb37-293" aria-hidden="true" tabindex="-1"></a>  <span class="at">Classical =</span> <span class="fu">round</span>(se_classical, <span class="dv">4</span>),</span>
<span id="cb37-294"><a href="#cb37-294" aria-hidden="true" tabindex="-1"></a>  <span class="at">HC2 =</span> <span class="fu">round</span>(se_hc2, <span class="dv">4</span>),</span>
<span id="cb37-295"><a href="#cb37-295" aria-hidden="true" tabindex="-1"></a>  <span class="at">Bootstrap =</span> <span class="fu">round</span>(se_boot, <span class="dv">4</span>)</span>
<span id="cb37-296"><a href="#cb37-296" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-297"><a href="#cb37-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-298"><a href="#cb37-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-299"><a href="#cb37-299" aria-hidden="true" tabindex="-1"></a>The bootstrap SEs are close to the sandwich (HC2) SEs --- both account for heteroskedasticity without assuming a specific form. The classical SEs assume homoskedasticity, which may be wrong.</span>
<span id="cb37-300"><a href="#cb37-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-301"><a href="#cb37-301" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing the bootstrap distribution</span></span>
<span id="cb37-302"><a href="#cb37-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-305"><a href="#cb37-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-306"><a href="#cb37-306" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bootstrap-distribution</span></span>
<span id="cb37-307"><a href="#cb37-307" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb37-308"><a href="#cb37-308" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb37-309"><a href="#cb37-309" aria-hidden="true" tabindex="-1"></a>df_boot <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-310"><a href="#cb37-310" aria-hidden="true" tabindex="-1"></a>  <span class="at">income =</span> boot_coefs[, <span class="st">"income"</span>],</span>
<span id="cb37-311"><a href="#cb37-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">education =</span> boot_coefs[, <span class="st">"education"</span>]</span>
<span id="cb37-312"><a href="#cb37-312" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-313"><a href="#cb37-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-314"><a href="#cb37-314" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_boot, <span class="fu">aes</span>(income)) <span class="sc">+</span></span>
<span id="cb37-315"><a href="#cb37-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-316"><a href="#cb37-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">coef</span>(mod)[<span class="st">"income"</span>], <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-317"><a href="#cb37-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb37-318"><a href="#cb37-318" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="fu">coef</span>(mod)[<span class="st">"income"</span>], <span class="at">sd =</span> se_hc2[<span class="st">"income"</span>]),</span>
<span id="cb37-319"><a href="#cb37-319" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb37-320"><a href="#cb37-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap distribution of income coefficient"</span>,</span>
<span id="cb37-321"><a href="#cb37-321" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Blue = point estimate, Red = normal approximation (sandwich SE)"</span>,</span>
<span id="cb37-322"><a href="#cb37-322" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[income]<span class="sc">^</span><span class="st">"*"</span>))</span>
<span id="cb37-323"><a href="#cb37-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-324"><a href="#cb37-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-325"><a href="#cb37-325" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using the `boot` package</span></span>
<span id="cb37-326"><a href="#cb37-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-329"><a href="#cb37-329" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-330"><a href="#cb37-330" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: boot-package</span></span>
<span id="cb37-331"><a href="#cb37-331" aria-hidden="true" tabindex="-1"></a><span class="co"># The boot package standardizes this workflow</span></span>
<span id="cb37-332"><a href="#cb37-332" aria-hidden="true" tabindex="-1"></a>boot_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indices) {</span>
<span id="cb37-333"><a href="#cb37-333" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> data[indices, ]</span>
<span id="cb37-334"><a href="#cb37-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>(<span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> d))</span>
<span id="cb37-335"><a href="#cb37-335" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-336"><a href="#cb37-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-337"><a href="#cb37-337" aria-hidden="true" tabindex="-1"></a>boot_out <span class="ot">&lt;-</span> <span class="fu">boot</span>(Prestige, boot_fn, <span class="at">R =</span> <span class="dv">5000</span>)</span>
<span id="cb37-338"><a href="#cb37-338" aria-hidden="true" tabindex="-1"></a>boot_out</span>
<span id="cb37-339"><a href="#cb37-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-340"><a href="#cb37-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-343"><a href="#cb37-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-344"><a href="#cb37-344" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: boot-ci</span></span>
<span id="cb37-345"><a href="#cb37-345" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap confidence intervals for education coefficient</span></span>
<span id="cb37-346"><a href="#cb37-346" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(boot_out, <span class="at">index =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"norm"</span>, <span class="st">"perc"</span>, <span class="st">"bca"</span>))</span>
<span id="cb37-347"><a href="#cb37-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-348"><a href="#cb37-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-349"><a href="#cb37-349" aria-hidden="true" tabindex="-1"></a>The <span class="in">`boot.ci`</span> function provides three types of intervals:</span>
<span id="cb37-350"><a href="#cb37-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-351"><a href="#cb37-351" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Normal**: $\hat{\theta} \pm z_{0.025} \cdot \text{SE}_{\text{boot}}$ (same logic as asymptotic, just uses bootstrap SE)</span>
<span id="cb37-352"><a href="#cb37-352" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Percentile**: the 2.5th and 97.5th percentiles of $\hat{\theta}^*$ (no normal assumption)</span>
<span id="cb37-353"><a href="#cb37-353" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**BCa** (bias-corrected, accelerated): adjusts for bias and skewness in the bootstrap distribution (generally preferred)</span>
<span id="cb37-354"><a href="#cb37-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-355"><a href="#cb37-355" aria-hidden="true" tabindex="-1"></a><span class="fu">## Delta method vs. bootstrap: a direct comparison</span></span>
<span id="cb37-356"><a href="#cb37-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-357"><a href="#cb37-357" aria-hidden="true" tabindex="-1"></a>For the long-run elasticity $\theta = \beta_1/(1 - \gamma)$, we can compare three approaches:</span>
<span id="cb37-358"><a href="#cb37-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-361"><a href="#cb37-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-362"><a href="#cb37-362" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delta-vs-bootstrap</span></span>
<span id="cb37-363"><a href="#cb37-363" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-364"><a href="#cb37-364" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb37-365"><a href="#cb37-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-366"><a href="#cb37-366" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap the long-run effect</span></span>
<span id="cb37-367"><a href="#cb37-367" aria-hidden="true" tabindex="-1"></a>boot_lr <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb37-368"><a href="#cb37-368" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dta), <span class="fu">nrow</span>(dta), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-369"><a href="#cb37-369" aria-hidden="true" tabindex="-1"></a>  b_star <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> y_lag, <span class="at">data =</span> dta[idx, ]))</span>
<span id="cb37-370"><a href="#cb37-370" aria-hidden="true" tabindex="-1"></a>  b_star[<span class="st">"x"</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> b_star[<span class="st">"y_lag"</span>])</span>
<span id="cb37-371"><a href="#cb37-371" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-372"><a href="#cb37-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-373"><a href="#cb37-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Delta method (from above)</span></span>
<span id="cb37-374"><a href="#cb37-374" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(fit_dyn, <span class="st">"x / (1 - y_lag)"</span>)</span>
<span id="cb37-375"><a href="#cb37-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-376"><a href="#cb37-376" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb37-377"><a href="#cb37-377" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Delta method"</span>, <span class="st">"Bootstrap"</span>),</span>
<span id="cb37-378"><a href="#cb37-378" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">c</span>(dm<span class="sc">$</span>Estimate, <span class="fu">mean</span>(boot_lr)),</span>
<span id="cb37-379"><a href="#cb37-379" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE =</span> <span class="fu">c</span>(dm<span class="sc">$</span>SE, <span class="fu">sd</span>(boot_lr)),</span>
<span id="cb37-380"><a href="#cb37-380" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lo =</span> <span class="fu">c</span>(dm<span class="sc">$</span><span class="st">`</span><span class="at">2.5 %</span><span class="st">`</span>, <span class="fu">quantile</span>(boot_lr, <span class="fl">0.025</span>)),</span>
<span id="cb37-381"><a href="#cb37-381" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_hi =</span> <span class="fu">c</span>(dm<span class="sc">$</span><span class="st">`</span><span class="at">97.5 %</span><span class="st">`</span>, <span class="fu">quantile</span>(boot_lr, <span class="fl">0.975</span>))</span>
<span id="cb37-382"><a href="#cb37-382" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-383"><a href="#cb37-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-384"><a href="#cb37-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-387"><a href="#cb37-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-388"><a href="#cb37-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delta-vs-bootstrap-plot</span></span>
<span id="cb37-389"><a href="#cb37-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb37-390"><a href="#cb37-390" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb37-391"><a href="#cb37-391" aria-hidden="true" tabindex="-1"></a>df_lr <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">lr =</span> boot_lr)</span>
<span id="cb37-392"><a href="#cb37-392" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_lr, <span class="fu">aes</span>(lr)) <span class="sc">+</span></span>
<span id="cb37-393"><a href="#cb37-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">60</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-394"><a href="#cb37-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb37-395"><a href="#cb37-395" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> dm<span class="sc">$</span>Estimate, <span class="at">sd =</span> dm<span class="sc">$</span>SE),</span>
<span id="cb37-396"><a href="#cb37-396" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-397"><a href="#cb37-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.5</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.7</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb37-398"><a href="#cb37-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap vs. delta method for long-run elasticity"</span>,</span>
<span id="cb37-399"><a href="#cb37-399" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red = normal approximation (delta method). Dashed = true value 1.67."</span>,</span>
<span id="cb37-400"><a href="#cb37-400" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[x] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">hat</span>(gamma))))</span>
<span id="cb37-401"><a href="#cb37-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-402"><a href="#cb37-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-403"><a href="#cb37-403" aria-hidden="true" tabindex="-1"></a>When the bootstrap distribution is close to normal, the two approaches agree. When it is skewed (common for ratios, especially when the denominator can be near zero), the bootstrap percentile interval is more reliable.</span>
<span id="cb37-404"><a href="#cb37-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-405"><a href="#cb37-405" aria-hidden="true" tabindex="-1"></a><span class="fu">## When does each approach work?</span></span>
<span id="cb37-406"><a href="#cb37-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-407"><a href="#cb37-407" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coverage simulation</span></span>
<span id="cb37-408"><a href="#cb37-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-409"><a href="#cb37-409" aria-hidden="true" tabindex="-1"></a>The acid test for any inference method: does a nominal 95% interval actually contain the true parameter 95% of the time?</span>
<span id="cb37-410"><a href="#cb37-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-413"><a href="#cb37-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-414"><a href="#cb37-414" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: coverage-comparison</span></span>
<span id="cb37-415"><a href="#cb37-415" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-416"><a href="#cb37-416" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb37-417"><a href="#cb37-417" aria-hidden="true" tabindex="-1"></a>n_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">200</span>)</span>
<span id="cb37-418"><a href="#cb37-418" aria-hidden="true" tabindex="-1"></a>B_boot <span class="ot">&lt;-</span> <span class="dv">200</span>  <span class="co"># bootstrap replicates per simulation</span></span>
<span id="cb37-419"><a href="#cb37-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-420"><a href="#cb37-420" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb37-421"><a href="#cb37-421" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> n_vals) {</span>
<span id="cb37-422"><a href="#cb37-422" aria-hidden="true" tabindex="-1"></a>  cover_analytic <span class="ot">&lt;-</span> cover_sandwich <span class="ot">&lt;-</span> cover_boot <span class="ot">&lt;-</span> <span class="fu">logical</span>(B)</span>
<span id="cb37-423"><a href="#cb37-423" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B) {</span>
<span id="cb37-424"><a href="#cb37-424" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb37-425"><a href="#cb37-425" aria-hidden="true" tabindex="-1"></a>    sigma_i <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">+</span> <span class="fu">abs</span>(x)</span>
<span id="cb37-426"><a href="#cb37-426" aria-hidden="true" tabindex="-1"></a>    e <span class="ot">&lt;-</span> <span class="fu">rt</span>(n, <span class="at">df =</span> <span class="dv">3</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">3</span>) <span class="sc">*</span> sigma_i  <span class="co"># heavy-tailed + heteroskedastic</span></span>
<span id="cb37-427"><a href="#cb37-427" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> x <span class="sc">+</span> e</span>
<span id="cb37-428"><a href="#cb37-428" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x)</span>
<span id="cb37-429"><a href="#cb37-429" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat)</span>
<span id="cb37-430"><a href="#cb37-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-431"><a href="#cb37-431" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analytic (classical)</span></span>
<span id="cb37-432"><a href="#cb37-432" aria-hidden="true" tabindex="-1"></a>    ci_a <span class="ot">&lt;-</span> <span class="fu">confint</span>(fit)[<span class="st">"x"</span>, ]</span>
<span id="cb37-433"><a href="#cb37-433" aria-hidden="true" tabindex="-1"></a>    cover_analytic[b] <span class="ot">&lt;-</span> ci_a[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="dv">3</span> <span class="sc">&lt;</span> ci_a[<span class="dv">2</span>]</span>
<span id="cb37-434"><a href="#cb37-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-435"><a href="#cb37-435" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sandwich (HC2)</span></span>
<span id="cb37-436"><a href="#cb37-436" aria-hidden="true" tabindex="-1"></a>    fit_r <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat, <span class="at">se_type =</span> <span class="st">"HC2"</span>)</span>
<span id="cb37-437"><a href="#cb37-437" aria-hidden="true" tabindex="-1"></a>    ci_s <span class="ot">&lt;-</span> <span class="fu">c</span>(fit_r<span class="sc">$</span>conf.low[<span class="st">"x"</span>], fit_r<span class="sc">$</span>conf.high[<span class="st">"x"</span>])</span>
<span id="cb37-438"><a href="#cb37-438" aria-hidden="true" tabindex="-1"></a>    cover_sandwich[b] <span class="ot">&lt;-</span> ci_s[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="dv">3</span> <span class="sc">&lt;</span> ci_s[<span class="dv">2</span>]</span>
<span id="cb37-439"><a href="#cb37-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-440"><a href="#cb37-440" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap (percentile)</span></span>
<span id="cb37-441"><a href="#cb37-441" aria-hidden="true" tabindex="-1"></a>    boot_b <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B_boot, {</span>
<span id="cb37-442"><a href="#cb37-442" aria-hidden="true" tabindex="-1"></a>      idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-443"><a href="#cb37-443" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coef</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> dat[idx, ]))[<span class="st">"x"</span>]</span>
<span id="cb37-444"><a href="#cb37-444" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-445"><a href="#cb37-445" aria-hidden="true" tabindex="-1"></a>    ci_boot <span class="ot">&lt;-</span> <span class="fu">quantile</span>(boot_b, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb37-446"><a href="#cb37-446" aria-hidden="true" tabindex="-1"></a>    cover_boot[b] <span class="ot">&lt;-</span> ci_boot[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="dv">3</span> <span class="sc">&lt;</span> ci_boot[<span class="dv">2</span>]</span>
<span id="cb37-447"><a href="#cb37-447" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-448"><a href="#cb37-448" aria-hidden="true" tabindex="-1"></a>  results[[<span class="fu">length</span>(results) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-449"><a href="#cb37-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n,</span>
<span id="cb37-450"><a href="#cb37-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">Classical =</span> <span class="fu">mean</span>(cover_analytic),</span>
<span id="cb37-451"><a href="#cb37-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">HC2 =</span> <span class="fu">mean</span>(cover_sandwich),</span>
<span id="cb37-452"><a href="#cb37-452" aria-hidden="true" tabindex="-1"></a>    <span class="at">Bootstrap =</span> <span class="fu">mean</span>(cover_boot)</span>
<span id="cb37-453"><a href="#cb37-453" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-454"><a href="#cb37-454" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-455"><a href="#cb37-455" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(rbind, results)</span>
<span id="cb37-456"><a href="#cb37-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-457"><a href="#cb37-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-458"><a href="#cb37-458" aria-hidden="true" tabindex="-1"></a>Key patterns:</span>
<span id="cb37-459"><a href="#cb37-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-460"><a href="#cb37-460" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Classical SEs** undercover when errors are heteroskedastic (they assume homoskedasticity)</span>
<span id="cb37-461"><a href="#cb37-461" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**HC2 sandwich SEs** do well once $n$ is moderate, but can undercover with very small $n$ and heavy tails</span>
<span id="cb37-462"><a href="#cb37-462" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Bootstrap** tends to be robust across scenarios, especially with small $n$</span>
<span id="cb37-463"><a href="#cb37-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-464"><a href="#cb37-464" aria-hidden="true" tabindex="-1"></a><span class="fu">### When the bootstrap breaks down</span></span>
<span id="cb37-465"><a href="#cb37-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-466"><a href="#cb37-466" aria-hidden="true" tabindex="-1"></a>The bootstrap is not a panacea. It fails or becomes unreliable when:</span>
<span id="cb37-467"><a href="#cb37-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-468"><a href="#cb37-468" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**The data are not iid** (time series, clustered data) --- you need a block bootstrap or cluster bootstrap instead</span>
<span id="cb37-469"><a href="#cb37-469" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**The estimator is not smooth** (e.g., the maximum of the data) --- the bootstrap distribution can be inconsistent</span>
<span id="cb37-470"><a href="#cb37-470" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**The sample is very small** ($n &lt; 20$) --- there aren't enough distinct resamples to represent the population</span>
<span id="cb37-471"><a href="#cb37-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-474"><a href="#cb37-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-475"><a href="#cb37-475" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bootstrap-failure</span></span>
<span id="cb37-476"><a href="#cb37-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb37-477"><a href="#cb37-477" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb37-478"><a href="#cb37-478" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap fails for the sample maximum (non-smooth estimator)</span></span>
<span id="cb37-479"><a href="#cb37-479" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-480"><a href="#cb37-480" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb37-481"><a href="#cb37-481" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb37-482"><a href="#cb37-482" aria-hidden="true" tabindex="-1"></a>true_max <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># support of Uniform[0,1]</span></span>
<span id="cb37-483"><a href="#cb37-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-484"><a href="#cb37-484" aria-hidden="true" tabindex="-1"></a>boot_max <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb37-485"><a href="#cb37-485" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">runif</span>(n)</span>
<span id="cb37-486"><a href="#cb37-486" aria-hidden="true" tabindex="-1"></a>  x_star <span class="ot">&lt;-</span> <span class="fu">sample</span>(x, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-487"><a href="#cb37-487" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(x_star)</span>
<span id="cb37-488"><a href="#cb37-488" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-489"><a href="#cb37-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-490"><a href="#cb37-490" aria-hidden="true" tabindex="-1"></a>df_max <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">max_star =</span> boot_max)</span>
<span id="cb37-491"><a href="#cb37-491" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_max, <span class="fu">aes</span>(max_star)) <span class="sc">+</span></span>
<span id="cb37-492"><a href="#cb37-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-493"><a href="#cb37-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_max, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb37-494"><a href="#cb37-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap failure: sample maximum of Uniform[0,1]"</span>,</span>
<span id="cb37-495"><a href="#cb37-495" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"The bootstrap cannot exceed the sample max, so it cannot cover the true max = 1."</span>,</span>
<span id="cb37-496"><a href="#cb37-496" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">max</span>(X<span class="sc">^</span><span class="st">"*"</span>)))</span>
<span id="cb37-497"><a href="#cb37-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-498"><a href="#cb37-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-499"><a href="#cb37-499" aria-hidden="true" tabindex="-1"></a>The bootstrap distribution of the sample maximum is bounded by the observed maximum --- it can never reach the true parameter boundary. For smooth functions of sample means (like regression coefficients), this pathology does not arise.</span>
<span id="cb37-500"><a href="#cb37-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-501"><a href="#cb37-501" aria-hidden="true" tabindex="-1"></a><span class="fu">## Applied workflow: Prestige data</span></span>
<span id="cb37-502"><a href="#cb37-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-503"><a href="#cb37-503" aria-hidden="true" tabindex="-1"></a>Let's put everything together on a real example, comparing all approaches.</span>
<span id="cb37-504"><a href="#cb37-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-507"><a href="#cb37-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-508"><a href="#cb37-508" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prestige-full</span></span>
<span id="cb37-509"><a href="#cb37-509" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> Prestige)</span>
<span id="cb37-510"><a href="#cb37-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-511"><a href="#cb37-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-512"><a href="#cb37-512" aria-hidden="true" tabindex="-1"></a><span class="fu">### Standard errors: three ways</span></span>
<span id="cb37-513"><a href="#cb37-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-516"><a href="#cb37-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-517"><a href="#cb37-517" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prestige-se-comparison</span></span>
<span id="cb37-518"><a href="#cb37-518" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Classical (assumes homoskedasticity + normality)</span></span>
<span id="cb37-519"><a href="#cb37-519" aria-hidden="true" tabindex="-1"></a>se_class <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(mod)))</span>
<span id="cb37-520"><a href="#cb37-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-521"><a href="#cb37-521" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Sandwich (asymptotic, no distributional assumptions)</span></span>
<span id="cb37-522"><a href="#cb37-522" aria-hidden="true" tabindex="-1"></a>se_hc2 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>)))</span>
<span id="cb37-523"><a href="#cb37-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-524"><a href="#cb37-524" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Bootstrap</span></span>
<span id="cb37-525"><a href="#cb37-525" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-526"><a href="#cb37-526" aria-hidden="true" tabindex="-1"></a>boot_out <span class="ot">&lt;-</span> <span class="fu">boot</span>(Prestige,</span>
<span id="cb37-527"><a href="#cb37-527" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(d, i) <span class="fu">coef</span>(<span class="fu">lm</span>(prestige <span class="sc">~</span> income <span class="sc">+</span> education <span class="sc">+</span> women, <span class="at">data =</span> d[i, ])),</span>
<span id="cb37-528"><a href="#cb37-528" aria-hidden="true" tabindex="-1"></a>                  <span class="at">R =</span> <span class="dv">5000</span>)</span>
<span id="cb37-529"><a href="#cb37-529" aria-hidden="true" tabindex="-1"></a>se_boot <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_out<span class="sc">$</span>t, <span class="dv">2</span>, sd)</span>
<span id="cb37-530"><a href="#cb37-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-531"><a href="#cb37-531" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb37-532"><a href="#cb37-532" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(mod)),</span>
<span id="cb37-533"><a href="#cb37-533" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">round</span>(<span class="fu">coef</span>(mod), <span class="dv">4</span>),</span>
<span id="cb37-534"><a href="#cb37-534" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_classical =</span> <span class="fu">round</span>(se_class, <span class="dv">4</span>),</span>
<span id="cb37-535"><a href="#cb37-535" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_HC2 =</span> <span class="fu">round</span>(se_hc2, <span class="dv">4</span>),</span>
<span id="cb37-536"><a href="#cb37-536" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE_bootstrap =</span> <span class="fu">round</span>(se_boot, <span class="dv">4</span>)</span>
<span id="cb37-537"><a href="#cb37-537" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-538"><a href="#cb37-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-539"><a href="#cb37-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-540"><a href="#cb37-540" aria-hidden="true" tabindex="-1"></a><span class="fu">### Confidence intervals: three ways</span></span>
<span id="cb37-541"><a href="#cb37-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-544"><a href="#cb37-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-545"><a href="#cb37-545" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prestige-ci-comparison</span></span>
<span id="cb37-546"><a href="#cb37-546" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus on the education coefficient (index 3)</span></span>
<span id="cb37-547"><a href="#cb37-547" aria-hidden="true" tabindex="-1"></a>ci_class <span class="ot">&lt;-</span> <span class="fu">confint</span>(mod)[<span class="st">"education"</span>, ]</span>
<span id="cb37-548"><a href="#cb37-548" aria-hidden="true" tabindex="-1"></a>ci_hc2 <span class="ot">&lt;-</span> <span class="fu">coefci</span>(mod, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>))[<span class="st">"education"</span>, ]</span>
<span id="cb37-549"><a href="#cb37-549" aria-hidden="true" tabindex="-1"></a>ci_boot <span class="ot">&lt;-</span> <span class="fu">boot.ci</span>(boot_out, <span class="at">index =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"perc"</span>)<span class="sc">$</span>percent[<span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb37-550"><a href="#cb37-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-551"><a href="#cb37-551" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb37-552"><a href="#cb37-552" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Classical"</span>, <span class="st">"HC2 sandwich"</span>, <span class="st">"Bootstrap percentile"</span>),</span>
<span id="cb37-553"><a href="#cb37-553" aria-hidden="true" tabindex="-1"></a>  <span class="at">Lower =</span> <span class="fu">round</span>(<span class="fu">c</span>(ci_class[<span class="dv">1</span>], ci_hc2[<span class="dv">1</span>], ci_boot[<span class="dv">1</span>]), <span class="dv">3</span>),</span>
<span id="cb37-554"><a href="#cb37-554" aria-hidden="true" tabindex="-1"></a>  <span class="at">Upper =</span> <span class="fu">round</span>(<span class="fu">c</span>(ci_class[<span class="dv">2</span>], ci_hc2[<span class="dv">2</span>], ci_boot[<span class="dv">2</span>]), <span class="dv">3</span>),</span>
<span id="cb37-555"><a href="#cb37-555" aria-hidden="true" tabindex="-1"></a>  <span class="at">Width =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">diff</span>(ci_class), <span class="fu">diff</span>(ci_hc2), <span class="fu">diff</span>(ci_boot)), <span class="dv">3</span>)</span>
<span id="cb37-556"><a href="#cb37-556" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-557"><a href="#cb37-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-558"><a href="#cb37-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-559"><a href="#cb37-559" aria-hidden="true" tabindex="-1"></a><span class="fu">### Nonlinear function: income-to-education ratio</span></span>
<span id="cb37-560"><a href="#cb37-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-561"><a href="#cb37-561" aria-hidden="true" tabindex="-1"></a>Suppose we want to compare the magnitude of the income and education effects. The ratio $\theta = \beta_{\text{income}} / \beta_{\text{education}}$ tells us how many prestige points a unit of income buys relative to a year of education.</span>
<span id="cb37-562"><a href="#cb37-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-565"><a href="#cb37-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-566"><a href="#cb37-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prestige-ratio</span></span>
<span id="cb37-567"><a href="#cb37-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Delta method</span></span>
<span id="cb37-568"><a href="#cb37-568" aria-hidden="true" tabindex="-1"></a>dm_ratio <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(mod, <span class="st">"income / education"</span>)</span>
<span id="cb37-569"><a href="#cb37-569" aria-hidden="true" tabindex="-1"></a>dm_ratio</span>
<span id="cb37-570"><a href="#cb37-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-571"><a href="#cb37-571" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap</span></span>
<span id="cb37-572"><a href="#cb37-572" aria-hidden="true" tabindex="-1"></a>boot_ratio <span class="ot">&lt;-</span> boot_out<span class="sc">$</span>t[, <span class="dv">2</span>] <span class="sc">/</span> boot_out<span class="sc">$</span>t[, <span class="dv">3</span>]  <span class="co"># income / education</span></span>
<span id="cb37-573"><a href="#cb37-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-574"><a href="#cb37-574" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">delta_method_se =</span> dm_ratio<span class="sc">$</span>SE,</span>
<span id="cb37-575"><a href="#cb37-575" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap_se =</span> <span class="fu">sd</span>(boot_ratio))</span>
<span id="cb37-576"><a href="#cb37-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-577"><a href="#cb37-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-580"><a href="#cb37-580" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-581"><a href="#cb37-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prestige-ratio-plot</span></span>
<span id="cb37-582"><a href="#cb37-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb37-583"><a href="#cb37-583" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb37-584"><a href="#cb37-584" aria-hidden="true" tabindex="-1"></a>df_ratio <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ratio =</span> boot_ratio)</span>
<span id="cb37-585"><a href="#cb37-585" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_ratio, <span class="fu">aes</span>(ratio)) <span class="sc">+</span></span>
<span id="cb37-586"><a href="#cb37-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">50</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-587"><a href="#cb37-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb37-588"><a href="#cb37-588" aria-hidden="true" tabindex="-1"></a>                <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> dm_ratio<span class="sc">$</span>Estimate, <span class="at">sd =</span> dm_ratio<span class="sc">$</span>SE),</span>
<span id="cb37-589"><a href="#cb37-589" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-590"><a href="#cb37-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> dm_ratio<span class="sc">$</span>Estimate, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb37-591"><a href="#cb37-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bootstrap vs. delta method for β_income / β_education"</span>,</span>
<span id="cb37-592"><a href="#cb37-592" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red = normal approximation (delta method). Bootstrap is slightly skewed."</span>,</span>
<span id="cb37-593"><a href="#cb37-593" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(beta)[income] <span class="sc">/</span> <span class="fu">hat</span>(beta)[education]))</span>
<span id="cb37-594"><a href="#cb37-594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-595"><a href="#cb37-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-596"><a href="#cb37-596" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wald test with robust and bootstrap covariance</span></span>
<span id="cb37-597"><a href="#cb37-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-600"><a href="#cb37-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb37-601"><a href="#cb37-601" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prestige-wald</span></span>
<span id="cb37-602"><a href="#cb37-602" aria-hidden="true" tabindex="-1"></a><span class="co"># Classical F-test</span></span>
<span id="cb37-603"><a href="#cb37-603" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="fu">c</span>(<span class="st">"education = 0"</span>, <span class="st">"women = 0"</span>))</span>
<span id="cb37-604"><a href="#cb37-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-605"><a href="#cb37-605" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust Wald test (sandwich)</span></span>
<span id="cb37-606"><a href="#cb37-606" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="fu">c</span>(<span class="st">"education = 0"</span>, <span class="st">"women = 0"</span>),</span>
<span id="cb37-607"><a href="#cb37-607" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC2"</span>), <span class="at">test =</span> <span class="st">"Chisq"</span>)</span>
<span id="cb37-608"><a href="#cb37-608" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-609"><a href="#cb37-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-610"><a href="#cb37-610" aria-hidden="true" tabindex="-1"></a><span class="fu">## The asymptotic toolkit in one picture</span></span>
<span id="cb37-611"><a href="#cb37-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-612"><a href="#cb37-612" aria-hidden="true" tabindex="-1"></a>Every estimator in this course follows the same pattern:</span>
<span id="cb37-613"><a href="#cb37-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-614"><a href="#cb37-614" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Step <span class="pp">|</span> Tool <span class="pp">|</span> What it does <span class="pp">|</span></span>
<span id="cb37-615"><a href="#cb37-615" aria-hidden="true" tabindex="-1"></a><span class="pp">|------|------|-------------|</span></span>
<span id="cb37-616"><a href="#cb37-616" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 1. Consistency <span class="pp">|</span> WLLN + CMT <span class="pp">|</span> Sample moments → population moments; $\hat{\theta} \overset{p}{\to} \theta$ <span class="pp">|</span></span>
<span id="cb37-617"><a href="#cb37-617" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 2. Asymptotic normality <span class="pp">|</span> CLT + Slutsky <span class="pp">|</span> $\sqrt{n}(\hat{\theta} - \theta) \overset{d}{\to} N(0, V)$ <span class="pp">|</span></span>
<span id="cb37-618"><a href="#cb37-618" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 3. Variance estimation <span class="pp">|</span> Sandwich <span class="pp">|</span> $\hat{V} \overset{p}{\to} V$ (robust to misspecification) <span class="pp">|</span></span>
<span id="cb37-619"><a href="#cb37-619" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 4. Nonlinear functions <span class="pp">|</span> Delta method or bootstrap <span class="pp">|</span> SEs for $h(\hat{\theta})$ <span class="pp">|</span></span>
<span id="cb37-620"><a href="#cb37-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-621"><a href="#cb37-621" aria-hidden="true" tabindex="-1"></a>This applies identically to OLS, probit MLE (Chapter 7), IV (Chapter 10), and GMM (Chapter 11) --- only the moment condition changes:</span>
<span id="cb37-622"><a href="#cb37-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-623"><a href="#cb37-623" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Estimator <span class="pp">|</span> Moment condition <span class="pp">|</span></span>
<span id="cb37-624"><a href="#cb37-624" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------|-----------------|</span></span>
<span id="cb37-625"><a href="#cb37-625" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> OLS <span class="pp">|</span> $E<span class="co">[</span><span class="ot">X_i(Y_i - X_i'\beta)</span><span class="co">]</span> = 0$ <span class="pp">|</span></span>
<span id="cb37-626"><a href="#cb37-626" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Probit MLE <span class="pp">|</span> $E<span class="co">[</span><span class="ot">s_i(\beta)</span><span class="co">]</span> = 0$ (score) <span class="pp">|</span></span>
<span id="cb37-627"><a href="#cb37-627" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> IV <span class="pp">|</span> $E<span class="co">[</span><span class="ot">Z_i(Y_i - X_i'\beta)</span><span class="co">]</span> = 0$ <span class="pp">|</span></span>
<span id="cb37-628"><a href="#cb37-628" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GMM <span class="pp">|</span> $E<span class="co">[</span><span class="ot">g(W_i, \theta)</span><span class="co">]</span> = 0$ (general) <span class="pp">|</span></span>
<span id="cb37-629"><a href="#cb37-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-630"><a href="#cb37-630" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb37-631"><a href="#cb37-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-632"><a href="#cb37-632" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Method <span class="pp">|</span> How it works <span class="pp">|</span> Advantages <span class="pp">|</span> Limitations <span class="pp">|</span></span>
<span id="cb37-633"><a href="#cb37-633" aria-hidden="true" tabindex="-1"></a><span class="pp">|--------|-------------|------------|-------------|</span></span>
<span id="cb37-634"><a href="#cb37-634" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Classical SE <span class="pp">|</span> Assumes $e \sim N(0, \sigma^2)$ <span class="pp">|</span> Exact under normality <span class="pp">|</span> Wrong under heteroskedasticity <span class="pp">|</span></span>
<span id="cb37-635"><a href="#cb37-635" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Sandwich (HC2) <span class="pp">|</span> Estimates $E<span class="co">[</span><span class="ot">X_i X_i' e_i^2</span><span class="co">]</span>$ <span class="pp">|</span> No distributional assumptions <span class="pp">|</span> Needs moderate $n$ <span class="pp">|</span></span>
<span id="cb37-636"><a href="#cb37-636" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Delta method <span class="pp">|</span> Taylor expansion of $h(\hat{\beta})$ <span class="pp">|</span> Fast, analytical <span class="pp">|</span> Requires derivatives; assumes normality of $h(\hat{\beta})$ <span class="pp">|</span></span>
<span id="cb37-637"><a href="#cb37-637" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Bootstrap <span class="pp">|</span> Resample rows, re-estimate <span class="pp">|</span> No derivatives; captures skewness <span class="pp">|</span> Needs iid; slow; fails for non-smooth estimators <span class="pp">|</span></span>
<span id="cb37-638"><a href="#cb37-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-639"><a href="#cb37-639" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Task <span class="pp">|</span> R code <span class="pp">|</span></span>
<span id="cb37-640"><a href="#cb37-640" aria-hidden="true" tabindex="-1"></a><span class="pp">|------|--------|</span></span>
<span id="cb37-641"><a href="#cb37-641" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Sandwich SEs <span class="pp">|</span> <span class="in">`vcovHC(mod, type = "HC2")`</span> or <span class="in">`lm_robust(..., se_type = "HC2")`</span> <span class="pp">|</span></span>
<span id="cb37-642"><a href="#cb37-642" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Delta method <span class="pp">|</span> <span class="in">`car::deltaMethod(mod, "expression")`</span> <span class="pp">|</span></span>
<span id="cb37-643"><a href="#cb37-643" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Bootstrap SEs <span class="pp">|</span> <span class="in">`boot(data, statistic, R = 5000)`</span> <span class="pp">|</span></span>
<span id="cb37-644"><a href="#cb37-644" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Bootstrap CIs <span class="pp">|</span> <span class="in">`boot.ci(boot_out, type = "perc")`</span> or <span class="in">`type = "bca"`</span> <span class="pp">|</span></span>
<span id="cb37-645"><a href="#cb37-645" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Robust Wald test <span class="pp">|</span> <span class="in">`linearHypothesis(mod, ..., vcov = vcovHC, test = "Chisq")`</span> <span class="pp">|</span></span>
<span id="cb37-646"><a href="#cb37-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-647"><a href="#cb37-647" aria-hidden="true" tabindex="-1"></a>**Key takeaways.**</span>
<span id="cb37-648"><a href="#cb37-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-649"><a href="#cb37-649" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The CLT justifies using normal-based inference for OLS, probit, IV, and GMM --- but convergence speed depends on the error distribution. Heavy tails and small samples require caution.</span>
<span id="cb37-650"><a href="#cb37-650" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The sandwich SE and the bootstrap SE are both robust to heteroskedasticity. They usually agree for linear models with moderate $n$.</span>
<span id="cb37-651"><a href="#cb37-651" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The delta method and the bootstrap both handle nonlinear functions. Use the delta method when you can compute derivatives easily; use the bootstrap when the function is complicated or the normal approximation is suspect.</span>
<span id="cb37-652"><a href="#cb37-652" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>When in doubt about whether $n$ is "large enough," compare all three approaches. If they disagree substantially, trust the bootstrap percentile or BCa interval.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>