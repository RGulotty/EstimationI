<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13. Fixed Effects and Modern DiD – Estimation I: Computational Companion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3bbbbd466991e281563892c5dce73c3d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
  MathJax = {
    tex: {
      macros: {
        E: "\\mathbb{E}",
        Var: "\\text{Var}",
        Cov: "\\text{Cov}",
        plim: "\\text{plim}",
        inprob: "\\xrightarrow{p}",
        indist: "\\xrightarrow{d}",
        bhat: "\\hat{\\boldsymbol{\\beta}}",
        N: "\\mathcal{N}",
        tr: "\\text{tr}",
        rank: "\\text{rank}",
        SE: "\\text{SE}",
        diag: "\\text{diag}"
      }
    }
  };
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Estimation I: Computational Companion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./ch01-review.html">
 <span class="dropdown-text">1. Probability and Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch02-cef-blp.html">
 <span class="dropdown-text">2. The CEF and Best Linear Predictor</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch03-ols.html">
 <span class="dropdown-text">3. Multivariate OLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch04-sensitivity.html">
 <span class="dropdown-text">4. Sensitivity and Leverage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch05-gls.html">
 <span class="dropdown-text">5. Efficiency and GLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch06-small-sample.html">
 <span class="dropdown-text">6. Small Sample Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch07-probit.html">
 <span class="dropdown-text">7. Probit and MLE</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch08-asymptotics.html">
 <span class="dropdown-text">8. Asymptotics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch09-testing.html">
 <span class="dropdown-text">9. Hypothesis Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch10-iv.html">
 <span class="dropdown-text">10. Instrumental Variables and 2SLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch11-gmm.html">
 <span class="dropdown-text">11. GMM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch12-panel.html">
 <span class="dropdown-text">12. Panel Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch13-fixed-effects.html">
 <span class="dropdown-text">13. Fixed Effects and Modern DiD</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/UChicago-pol-methods/EstimationI"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#random-effects-as-gls" id="toc-random-effects-as-gls" class="nav-link active" data-scroll-target="#random-effects-as-gls"><span class="header-section-number">1</span> Random effects as GLS</a>
  <ul class="collapse">
  <li><a href="#variance-components" id="toc-variance-components" class="nav-link" data-scroll-target="#variance-components"><span class="header-section-number">1.1</span> Variance components</a></li>
  <li><a href="#partial-pooling-re-as-a-weighted-average" id="toc-partial-pooling-re-as-a-weighted-average" class="nav-link" data-scroll-target="#partial-pooling-re-as-a-weighted-average"><span class="header-section-number">1.2</span> Partial pooling: RE as a weighted average</a></li>
  </ul></li>
  <li><a href="#the-hausman-test" id="toc-the-hausman-test" class="nav-link" data-scroll-target="#the-hausman-test"><span class="header-section-number">2</span> The Hausman test</a></li>
  <li><a href="#sec-mundlak" id="toc-sec-mundlak" class="nav-link" data-scroll-target="#sec-mundlak"><span class="header-section-number">3</span> Correlated random effects (Mundlak)</a>
  <ul class="collapse">
  <li><a href="#the-mundlak-test-hausman-test" id="toc-the-mundlak-test-hausman-test" class="nav-link" data-scroll-target="#the-mundlak-test-hausman-test"><span class="header-section-number">3.1</span> The Mundlak test = Hausman test</a></li>
  <li><a href="#cre-identifies-effects-of-time-invariant-variables" id="toc-cre-identifies-effects-of-time-invariant-variables" class="nav-link" data-scroll-target="#cre-identifies-effects-of-time-invariant-variables"><span class="header-section-number">3.2</span> CRE identifies effects of time-invariant variables</a></li>
  </ul></li>
  <li><a href="#sec-twfe-bias" id="toc-sec-twfe-bias" class="nav-link" data-scroll-target="#sec-twfe-bias"><span class="header-section-number">4</span> The problem with TWFE under staggered treatment</a>
  <ul class="collapse">
  <li><a href="#simulation-twfe-bias" id="toc-simulation-twfe-bias" class="nav-link" data-scroll-target="#simulation-twfe-bias"><span class="header-section-number">4.1</span> Simulation: TWFE bias</a></li>
  </ul></li>
  <li><a href="#callawaysantanna-group-time-atts" id="toc-callawaysantanna-group-time-atts" class="nav-link" data-scroll-target="#callawaysantanna-group-time-atts"><span class="header-section-number">5</span> Callaway–Sant’Anna: group-time ATTs</a>
  <ul class="collapse">
  <li><a href="#estimating-group-time-atts" id="toc-estimating-group-time-atts" class="nav-link" data-scroll-target="#estimating-group-time-atts"><span class="header-section-number">5.1</span> Estimating group-time ATTs</a></li>
  <li><a href="#aggregation-event-study" id="toc-aggregation-event-study" class="nav-link" data-scroll-target="#aggregation-event-study"><span class="header-section-number">5.2</span> Aggregation: event study</a></li>
  <li><a href="#simple-aggregation-overall-att" id="toc-simple-aggregation-overall-att" class="nav-link" data-scroll-target="#simple-aggregation-overall-att"><span class="header-section-number">5.3</span> Simple aggregation: overall ATT</a></li>
  <li><a href="#group-specific-effects" id="toc-group-specific-effects" class="nav-link" data-scroll-target="#group-specific-effects"><span class="header-section-number">5.4</span> Group-specific effects</a></li>
  <li><a href="#with-covariates" id="toc-with-covariates" class="nav-link" data-scroll-target="#with-covariates"><span class="header-section-number">5.5</span> With covariates</a></li>
  </ul></li>
  <li><a href="#counterfactual-estimators-with-fect" id="toc-counterfactual-estimators-with-fect" class="nav-link" data-scroll-target="#counterfactual-estimators-with-fect"><span class="header-section-number">6</span> Counterfactual estimators with fect</a>
  <ul class="collapse">
  <li><a href="#two-way-fe-counterfactual" id="toc-two-way-fe-counterfactual" class="nav-link" data-scroll-target="#two-way-fe-counterfactual"><span class="header-section-number">6.1</span> Two-way FE counterfactual</a></li>
  <li><a href="#event-study-gap-plot" id="toc-event-study-gap-plot" class="nav-link" data-scroll-target="#event-study-gap-plot"><span class="header-section-number">6.2</span> Event study (gap) plot</a></li>
  <li><a href="#interactive-fixed-effects-ife" id="toc-interactive-fixed-effects-ife" class="nav-link" data-scroll-target="#interactive-fixed-effects-ife"><span class="header-section-number">6.3</span> Interactive fixed effects (IFE)</a></li>
  <li><a href="#matrix-completion" id="toc-matrix-completion" class="nav-link" data-scroll-target="#matrix-completion"><span class="header-section-number">6.4</span> Matrix completion</a></li>
  <li><a href="#comparing-methods" id="toc-comparing-methods" class="nav-link" data-scroll-target="#comparing-methods"><span class="header-section-number">6.5</span> Comparing methods</a></li>
  <li><a href="#placebo-test-for-pre-trends" id="toc-placebo-test-for-pre-trends" class="nav-link" data-scroll-target="#placebo-test-for-pre-trends"><span class="header-section-number">6.6</span> Placebo test for pre-trends</a></li>
  <li><a href="#equivalence-test" id="toc-equivalence-test" class="nav-link" data-scroll-target="#equivalence-test"><span class="header-section-number">6.7</span> Equivalence test</a></li>
  </ul></li>
  <li><a href="#matrix-completion-for-panel-data-conceptual" id="toc-matrix-completion-for-panel-data-conceptual" class="nav-link" data-scroll-target="#matrix-completion-for-panel-data-conceptual"><span class="header-section-number">7</span> Matrix completion for panel data (conceptual)</a></li>
  <li><a href="#when-to-use-which-method" id="toc-when-to-use-which-method" class="nav-link" data-scroll-target="#when-to-use-which-method"><span class="header-section-number">8</span> When to use which method</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">13. Fixed Effects and Modern DiD</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Random effects, Hausman test, CRE, dynamic panels, and new DiD methods</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This chapter covers the fixed vs.&nbsp;random effects choice, correlated random effects (Mundlak), dynamic panel GMM, and modern difference-in-differences methods that address the problems with two-way fixed effects under staggered treatment adoption. We use <code>plm</code> for panel estimation, <code>did</code> for Callaway–Sant’Anna group-time ATTs, and <code>fect</code> for counterfactual imputation estimators.</p>
<p><strong>Questions this chapter answers:</strong></p>
<ol type="1">
<li>When should you use fixed effects vs.&nbsp;random effects, and what does the Hausman test tell you?</li>
<li>How does the TWFE estimator fail under staggered treatment with heterogeneous effects?</li>
<li>What modern alternatives (Callaway-Sant’Anna, fect, matrix completion) fix the negative weighting problem?</li>
</ol>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plm)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(did)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fect)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="random-effects-as-gls" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="random-effects-as-gls"><span class="header-section-number">1</span> Random effects as GLS</h2>
<p>In Chapter 12 we estimated fixed effects by demeaning within each unit. The <strong>random effects</strong> (RE) estimator instead treats <span class="math inline">\(\alpha_i\)</span> as part of a composite error <span class="math inline">\(\nu_{it} = \alpha_i + \varepsilon_{it}\)</span> and applies GLS to exploit the known correlation structure:</p>
<p><span id="eq-re-variance"><span class="math display">\[\text{Var}(\nu_i) = \sigma_\varepsilon^2 I_T + \sigma_\alpha^2 \iota\iota' = \Omega \tag{1}\]</span></span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Produc"</span>, <span class="at">package =</span> <span class="st">"plm"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">pdata.frame</span>(Produc, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"year"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed effects</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>fe_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Random effects (GLS with error components)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>re_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare slope coefficients</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>coef_comp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(fe_fit)),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">FE =</span> <span class="fu">round</span>(<span class="fu">coef</span>(fe_fit), <span class="dv">4</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">RE =</span> <span class="fu">round</span>(<span class="fu">coef</span>(re_fit)[<span class="sc">-</span><span class="dv">1</span>], <span class="dv">4</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(coef_comp) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>coef_comp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Variable      FE      RE
1 log(pcap) -0.0261  0.0044
2   log(pc)  0.2920  0.3105
3  log(emp)  0.7682  0.7297
4     unemp -0.0053 -0.0062</code></pre>
</div>
</div>
<p>RE is more efficient than FE when the random effects assumption (<span class="math inline">\(\alpha_i \perp X_{it}\)</span>) holds, because it uses both within-unit and between-unit variation. But if <span class="math inline">\(\alpha_i\)</span> is correlated with the regressors, RE is inconsistent.</p>
<section id="variance-components" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="variance-components"><span class="header-section-number">1.1</span> Variance components</h3>
<p>The RE estimator decomposes total variance into unit-level (<span class="math inline">\(\sigma_\alpha^2\)</span>) and idiosyncratic (<span class="math inline">\(\sigma_\varepsilon^2\)</span>) components:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variance components from plm</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ercomp <span class="ot">&lt;-</span> <span class="fu">ercomp</span>(re_fit)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"sigma_alpha (unit):"</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(ercomp<span class="sc">$</span>sigma2[<span class="st">"id"</span>]), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sigma_alpha (unit): 0.0827 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"sigma_eps (idios):"</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(ercomp<span class="sc">$</span>sigma2[<span class="st">"idios"</span>]), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sigma_eps (idios): 0.0381 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"theta (shrinkage):"</span>, <span class="fu">round</span>(ercomp<span class="sc">$</span>theta, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>theta (shrinkage): 0.8888 </code></pre>
</div>
</div>
<p>The shrinkage parameter <span class="math inline">\(\theta\)</span> controls how much RE pulls toward the within estimator versus the between estimator. When <span class="math inline">\(\theta\)</span> is close to 1, RE is close to FE; when <span class="math inline">\(\theta\)</span> is close to 0, RE is close to pooled OLS.</p>
</section>
<section id="partial-pooling-re-as-a-weighted-average" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="partial-pooling-re-as-a-weighted-average"><span class="header-section-number">1.2</span> Partial pooling: RE as a weighted average</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Between estimator</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>be_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"between"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Between: "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(be_fit)[<span class="st">"log(pcap)"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Between:  0.1794 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Within:  "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fe_fit)[<span class="st">"log(pcap)"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Within:   -0.0261 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"RE:      "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(re_fit)[<span class="st">"log(pcap)"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>RE:       0.0044 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(RE is between the within and between estimates)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>(RE is between the within and between estimates)</code></pre>
</div>
</div>
</section>
</section>
<section id="the-hausman-test" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="the-hausman-test"><span class="header-section-number">2</span> The Hausman test</h2>
<p>The Hausman test compares FE (consistent under both <span class="math inline">\(H_0\)</span> and <span class="math inline">\(H_1\)</span>) with RE (efficient under <span class="math inline">\(H_0\)</span> but inconsistent under <span class="math inline">\(H_1\)</span>):</p>
<p><span id="eq-hausman"><span class="math display">\[H = (\hat\beta_{FE} - \hat\beta_{RE})' [\text{Var}(\hat\beta_{FE}) - \text{Var}(\hat\beta_{RE})]^{-1} (\hat\beta_{FE} - \hat\beta_{RE}) \xrightarrow{d} \chi^2_K \tag{2}\]</span></span></p>
<div id="thm-hausman" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (Hausman Test)</strong></span> The Hausman statistic <span class="math inline">\(H = (\hat\beta_{FE} - \hat\beta_{RE})'[\text{Var}(\hat\beta_{FE}) - \text{Var}(\hat\beta_{RE})]^{-1}(\hat\beta_{FE} - \hat\beta_{RE}) \xrightarrow{d} \chi^2_K\)</span> tests whether FE and RE estimates differ systematically. Rejection means <span class="math inline">\(\alpha_i\)</span> is correlated with <span class="math inline">\(X_{it}\)</span>, favoring FE.</p>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">phtest</span>(fe_fit, re_fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Hausman Test

data:  log(gsp) ~ log(pcap) + log(pc) + log(emp) + unemp
chisq = 9.5254, df = 4, p-value = 0.04923
alternative hypothesis: one model is inconsistent</code></pre>
</div>
</div>
<p>A small p-value rejects the RE assumption—state fixed effects are correlated with the regressors, so FE is preferred.</p>
<p><strong>Caveat:</strong> Using the Hausman test to <em>choose</em> between FE and RE creates a pretest estimator with distorted coverage. The research design should determine the estimator; report the Hausman test as a diagnostic. The Hausman test can also be viewed as a <a href="./ch11-gmm.html#sec-j-test">GMM overidentification test</a>.</p>
</section>
<section id="sec-mundlak" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-mundlak"><span class="header-section-number">3</span> Correlated random effects (Mundlak)</h2>
<p>Mundlak (1978) proposed a middle ground: include the group means <span class="math inline">\(\bar{x}_i\)</span> as additional regressors in the RE model. This “soaks up” the correlation between <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(x_{it}\)</span>:</p>
<p><span class="math display">\[\alpha_i = \delta_0 + \bar{x}_i' \delta + \zeta_i, \quad \mathbb{E}[\zeta_i \mid x_{it}, z_i] = 0\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add group means of time-varying regressors</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>lpcap_bar <span class="ot">&lt;-</span> <span class="fu">Between</span>(<span class="fu">log</span>(pdata<span class="sc">$</span>pcap))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>lpc_bar   <span class="ot">&lt;-</span> <span class="fu">Between</span>(<span class="fu">log</span>(pdata<span class="sc">$</span>pc))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>lemp_bar  <span class="ot">&lt;-</span> <span class="fu">Between</span>(<span class="fu">log</span>(pdata<span class="sc">$</span>emp))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>unemp_bar <span class="ot">&lt;-</span> <span class="fu">Between</span>(pdata<span class="sc">$</span>unemp)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># CRE = RE + group means</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>cre_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                 lpcap_bar <span class="sc">+</span> lpc_bar <span class="sc">+</span> lemp_bar <span class="sc">+</span> unemp_bar,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># CRE slopes = FE slopes (by FWL)</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"CRE slopes: "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_fit)[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CRE slopes:  -0.0261 0.292 0.7682 -0.0053 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"FE slopes:  "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fe_fit), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>FE slopes:   -0.0261 0.292 0.7682 -0.0053 </code></pre>
</div>
</div>
<p>The CRE slopes on time-varying regressors match FE exactly. This follows from the <a href="./ch04-sensitivity.html#thm-fwl">FWL theorem</a>: partialing out <span class="math inline">\(\bar{x}_i\)</span> from <span class="math inline">\(x_{it}\)</span> gives the within-demeaned data.</p>
<div id="thm-mundlak" class="theorem">
<p><span class="theorem-title"><strong>Theorem 2 (Correlated Random Effects (Mundlak))</strong></span> Adding group means <span class="math inline">\(\bar{x}_i\)</span> to the RE model gives CRE: <span class="math inline">\(y_{it} = x_{it}'\beta + \bar{x}_i'\delta + \alpha_i + \varepsilon_{it}\)</span>. The slope <span class="math inline">\(\hat\beta_{CRE}\)</span> equals <span class="math inline">\(\hat\beta_{FE}\)</span> by FWL. Testing <span class="math inline">\(\delta = 0\)</span> is equivalent to the Hausman test but works with robust SEs and allows estimation of time-invariant variable effects.</p>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>CRE = FE + Time-Invariant Variables
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Mundlak/CRE approach gives identical slope coefficients to FE while also allowing estimation of effects of time-invariant regressors (region, sex, ethnicity). It also provides a robust version of the Hausman test through an F-test on the group means.</p>
</div>
</div>
<section id="the-mundlak-test-hausman-test" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="the-mundlak-test-hausman-test"><span class="header-section-number">3.1</span> The Mundlak test = Hausman test</h3>
<p>Testing <span class="math inline">\(H_0: \delta = 0\)</span> (the group means have no additional explanatory power) is equivalent to the Hausman test:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># F-test on the group means</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: carData</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(cre_fit,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"lpcap_bar = 0"</span>, <span class="st">"lpc_bar = 0"</span>, <span class="st">"lemp_bar = 0"</span>, <span class="st">"unemp_bar = 0"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
lpcap_bar = 0
lpc_bar = 0
lemp_bar = 0
unemp_bar = 0

Model 1: restricted model
Model 2: log(gsp) ~ log(pcap) + log(pc) + log(emp) + unemp + lpcap_bar + 
    lpc_bar + lemp_bar + unemp_bar

  Res.Df Df  Chisq Pr(&gt;Chisq)  
1    811                       
2    807  4 9.7181    0.04545 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="cre-identifies-effects-of-time-invariant-variables" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="cre-identifies-effects-of-time-invariant-variables"><span class="header-section-number">3.2</span> CRE identifies effects of time-invariant variables</h3>
<p>A key advantage of CRE over FE: it can estimate effects of time-invariant regressors. FE sweeps them out along with <span class="math inline">\(\alpha_i\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a time-invariant variable: region</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>region_ne <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>region_s  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"3"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>region_w  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"4"</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>cre_region <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                    lpcap_bar <span class="sc">+</span> lpc_bar <span class="sc">+</span> lemp_bar <span class="sc">+</span> unemp_bar <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>                    region_ne <span class="sc">+</span> region_s <span class="sc">+</span> region_w,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Region coefficients (relative to North Central)</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Region effects (CRE):</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Region effects (CRE):</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Northeast:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_region)[<span class="st">"region_ne"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Northeast: 0.1225 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  South:    "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_region)[<span class="st">"region_s"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  South:     -0.0089 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  West:     "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_region)[<span class="st">"region_w"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  West:      -0.102 </code></pre>
</div>
</div>
</section>
</section>
<section id="sec-twfe-bias" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sec-twfe-bias"><span class="header-section-number">4</span> The problem with TWFE under staggered treatment</h2>
<p>Standard two-way fixed effects (TWFE) with staggered treatment can produce severely biased estimates when treatment effects are heterogeneous. TWFE implicitly compares newly-treated units to already-treated units, creating negative weights on some group-time ATTs.</p>
<div id="thm-twfe-bias" class="theorem">
<p><span class="theorem-title"><strong>Theorem 3 (TWFE Bias Under Staggered Treatment)</strong></span> With staggered adoption and heterogeneous treatment effects, TWFE assigns negative weights to some group-time ATTs — using already-treated units as controls for newly-treated units. The resulting estimate can be far from any meaningful causal parameter, including the wrong sign.</p>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>TWFE Can Produce Negative Weights
</div>
</div>
<div class="callout-body-container callout-body">
<p>Under staggered treatment with dynamic or heterogeneous effects, TWFE regression assigns negative weights to some group-time treatment effects. This means the TWFE coefficient is not a convex average of individual treatment effects — it can even have the wrong sign. Use Callaway-Sant’Anna, Sun-Abraham, or fect instead.</p>
</div>
</div>
<section id="simulation-twfe-bias" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="simulation-twfe-bias"><span class="header-section-number">4.1</span> Simulation: TWFE bias</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span>; T_max <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Staggered adoption: 3 cohorts + never-treated</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>cohorts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>)  <span class="co"># treatment start times</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>sim_panel <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign to cohort (25% each)</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(cohorts, <span class="dv">0</span>), <span class="dv">1</span>)  <span class="co"># 0 = never treated</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  alpha_i <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    treated <span class="ot">&lt;-</span> (g <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (t <span class="sc">&gt;=</span> g)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment effect grows with exposure AND varies by cohort</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    te <span class="ot">&lt;-</span> <span class="cf">if</span> (treated) <span class="fl">1.0</span> <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> (t <span class="sc">-</span> g) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (g <span class="sc">==</span> <span class="dv">4</span>) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> alpha_i <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> t <span class="sc">+</span> te <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    sim_panel <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sim_panel,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">id =</span> i, <span class="at">time =</span> t, <span class="at">y =</span> y,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">treat =</span> <span class="fu">as.integer</span>(treated),</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cohort =</span> g,</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">first_treat =</span> <span class="fu">ifelse</span>(g <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, g)))</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co"># TWFE regression</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>twfe <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> treat <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data =</span> sim_panel)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TWFE estimate:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(twfe)[<span class="st">"treat"</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>TWFE estimate: 1.417 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># True average ATT among treated observations</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>true_att <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_panel<span class="sc">$</span>y[sim_panel<span class="sc">$</span>treat <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="dv">2</span> <span class="sc">+</span> <span class="fu">ave</span>(<span class="fu">rnorm</span>(N), <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T_max)) <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> sim_panel<span class="sc">$</span>time[sim_panel<span class="sc">$</span>treat <span class="sc">==</span> <span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in split.default(x, g): data length is not a multiple of split variable</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in split.default(seq_along(x), f, drop = drop, ...): data length is not
a multiple of split variable</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in 2 + ave(rnorm(N), rep(1:N, each = T_max)) + 0.2 *
sim_panel$time[sim_panel$treat == : longer object length is not a multiple of
shorter object length</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(The true ATT varies by cohort and exposure time -- TWFE averages with potentially negative weights)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>(The true ATT varies by cohort and exposure time -- TWFE averages with potentially negative weights)</code></pre>
</div>
</div>
</section>
</section>
<section id="callawaysantanna-group-time-atts" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="callawaysantanna-group-time-atts"><span class="header-section-number">5</span> Callaway–Sant’Anna: group-time ATTs</h2>
<p>The <code>did</code> package (Callaway &amp; Sant’Anna, 2021) avoids the TWFE problem by estimating separate ATTs for each group-time pair, then aggregating. The <code>mpdta</code> dataset tracks teen employment across 500 U.S. counties, with staggered minimum wage increases.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mpdta)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Counties:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(mpdta<span class="sc">$</span>countyreal)),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Years:"</span>, <span class="fu">paste</span>(<span class="fu">range</span>(mpdta<span class="sc">$</span>year), <span class="at">collapse =</span> <span class="st">"-"</span>),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Treatment cohorts:"</span>, <span class="fu">paste</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(mpdta<span class="sc">$</span>first.treat[mpdta<span class="sc">$</span>first.treat <span class="sc">&gt;</span> <span class="dv">0</span>])),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Counties: 500  Years: 2003-2007  Treatment cohorts: 2004, 2006, 2007 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mpdta)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    year countyreal     lpop     lemp first.treat treat
866 2003       8001 5.896761 8.461469        2007     1
841 2004       8001 5.896761 8.336870        2007     1
842 2005       8001 5.896761 8.340217        2007     1
819 2006       8001 5.896761 8.378161        2007     1
827 2007       8001 5.896761 8.487352        2007     1
937 2003       8019 2.232377 4.997212        2007     1</code></pre>
</div>
</div>
<section id="estimating-group-time-atts" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="estimating-group-time-atts"><span class="header-section-number">5.1</span> Estimating group-time ATTs</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate all group-time ATTs</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>cs_out <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">yname =</span> <span class="st">"lemp"</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gname =</span> <span class="st">"first.treat"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">idname =</span> <span class="st">"countyreal"</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">xformla =</span> <span class="sc">~</span><span class="dv">1</span>,              <span class="co"># unconditional</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mpdta,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">control_group =</span> <span class="st">"nevertreated"</span>,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">est_method =</span> <span class="st">"dr"</span>          <span class="co"># doubly robust (default)</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_out)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
att_gt(yname = "lemp", tname = "year", idname = "countyreal", 
    gname = "first.treat", xformla = ~1, data = mpdta, control_group = "nevertreated", 
    est_method = "dr")

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 

Group-Time Average Treatment Effects:
 Group Time ATT(g,t) Std. Error [95% Simult.  Conf. Band]  
  2004 2004  -0.0105     0.0237       -0.0747      0.0537  
  2004 2005  -0.0704     0.0313       -0.1553      0.0145  
  2004 2006  -0.1373     0.0362       -0.2354     -0.0391 *
  2004 2007  -0.1008     0.0379       -0.2036      0.0020  
  2006 2004   0.0065     0.0235       -0.0571      0.0702  
  2006 2005  -0.0028     0.0193       -0.0552      0.0497  
  2006 2006  -0.0046     0.0167       -0.0499      0.0407  
  2006 2007  -0.0412     0.0195       -0.0940      0.0116  
  2007 2004   0.0305     0.0144       -0.0084      0.0695  
  2007 2005  -0.0027     0.0165       -0.0474      0.0419  
  2007 2006  -0.0311     0.0181       -0.0801      0.0179  
  2007 2007  -0.0261     0.0161       -0.0698      0.0177  
---
Signif. codes: `*' confidence band does not cover 0

P-value for pre-test of parallel trends assumption:  0.16812
Control Group:  Never Treated,  Anticipation Periods:  0
Estimation Method:  Doubly Robust</code></pre>
</div>
</div>
<p>Each row is an ATT(g, t): the average treatment effect for group <span class="math inline">\(g\)</span> (defined by when they were first treated) at time <span class="math inline">\(t\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(cs_out, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/cs-attgt-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="aggregation-event-study" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="aggregation-event-study"><span class="header-section-number">5.2</span> Aggregation: event study</h3>
<p>The many group-time ATTs can be aggregated into an event study (dynamic effects by exposure time):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>cs_dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_out, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_dyn)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
aggte(MP = cs_out, type = "dynamic")

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 


Overall summary of ATT's based on event-study/dynamic aggregation:  
     ATT    Std. Error     [ 95%  Conf. Int.]  
 -0.0772        0.0221    -0.1206     -0.0338 *


Dynamic Effects:
 Event time Estimate Std. Error [95% Simult.  Conf. Band]  
         -3   0.0305     0.0150       -0.0069      0.0679  
         -2  -0.0006     0.0138       -0.0350      0.0338  
         -1  -0.0245     0.0132       -0.0574      0.0085  
          0  -0.0199     0.0115       -0.0486      0.0088  
          1  -0.0510     0.0170       -0.0934     -0.0085 *
          2  -0.1373     0.0375       -0.2310     -0.0435 *
          3  -0.1008     0.0345       -0.1871     -0.0145 *
---
Signif. codes: `*' confidence band does not cover 0

Control Group:  Never Treated,  Anticipation Periods:  0
Estimation Method:  Doubly Robust</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(cs_dyn, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/cs-event-plot-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Callaway-Sant’Anna event study: pre-treatment estimates near zero support parallel trends</figcaption>
</figure>
</div>
</div>
</div>
<p>Pre-treatment estimates near zero support the parallel trends assumption. Post-treatment estimates show the dynamic treatment effect.</p>
</section>
<section id="simple-aggregation-overall-att" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="simple-aggregation-overall-att"><span class="header-section-number">5.3</span> Simple aggregation: overall ATT</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>cs_simple <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_out, <span class="at">type =</span> <span class="st">"simple"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_simple)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
aggte(MP = cs_out, type = "simple")

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 


   ATT    Std. Error     [ 95%  Conf. Int.]  
 -0.04        0.0118    -0.0632     -0.0167 *


---
Signif. codes: `*' confidence band does not cover 0

Control Group:  Never Treated,  Anticipation Periods:  0
Estimation Method:  Doubly Robust</code></pre>
</div>
</div>
</section>
<section id="group-specific-effects" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="group-specific-effects"><span class="header-section-number">5.4</span> Group-specific effects</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>cs_group <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_out, <span class="at">type =</span> <span class="st">"group"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_group)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
aggte(MP = cs_out, type = "group")

Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. &lt;https://doi.org/10.1016/j.jeconom.2020.12.001&gt;, &lt;https://arxiv.org/abs/1803.09015&gt; 


Overall summary of ATT's based on group/cohort aggregation:  
    ATT    Std. Error     [ 95%  Conf. Int.]  
 -0.031        0.0127    -0.0559     -0.0062 *


Group Effects:
 Group Estimate Std. Error [95% Simult.  Conf. Band]  
  2004  -0.0797     0.0299       -0.1447     -0.0148 *
  2006  -0.0229     0.0164       -0.0586      0.0128  
  2007  -0.0261     0.0167       -0.0623      0.0101  
---
Signif. codes: `*' confidence band does not cover 0

Control Group:  Never Treated,  Anticipation Periods:  0
Estimation Method:  Doubly Robust</code></pre>
</div>
</div>
<p>Different cohorts may experience different effects—early adopters vs.&nbsp;late adopters of the minimum wage increase.</p>
</section>
<section id="with-covariates" class="level3" data-number="5.5">
<h3 data-number="5.5" class="anchored" data-anchor-id="with-covariates"><span class="header-section-number">5.5</span> With covariates</h3>
<p>Parallel trends can be conditioned on covariates. Here we control for log population:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>cs_cov <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">yname =</span> <span class="st">"lemp"</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">gname =</span> <span class="st">"first.treat"</span>,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">idname =</span> <span class="st">"countyreal"</span>,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xformla =</span> <span class="sc">~</span>lpop,           <span class="co"># conditional on log population</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mpdta,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">control_group =</span> <span class="st">"nevertreated"</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>cs_cov_dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_cov, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(cs_cov_dyn, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/cs-covariates-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="counterfactual-estimators-with-fect" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="counterfactual-estimators-with-fect"><span class="header-section-number">6</span> Counterfactual estimators with fect</h2>
<p>The <code>fect</code> package (Liu, Wang &amp; Xu, 2024) takes a different approach: it imputes counterfactual outcomes for treated observations by fitting a model on untreated observations only, then computes treatment effects as the difference between observed and imputed outcomes.</p>
<p>The <code>simdata</code> dataset has 200 units over 35 periods with treatment that can switch on and off:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(fect)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Units:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(simdata<span class="sc">$</span>id)),</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Periods:"</span>, <span class="fu">paste</span>(<span class="fu">range</span>(simdata<span class="sc">$</span>time), <span class="at">collapse =</span> <span class="st">"-"</span>),</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Treated obs:"</span>, <span class="fu">sum</span>(simdata<span class="sc">$</span>D), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: 200  Periods: 1-35  Treated obs: 1503 </code></pre>
</div>
</div>
<section id="two-way-fe-counterfactual" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="two-way-fe-counterfactual"><span class="header-section-number">6.1</span> Two-way FE counterfactual</h3>
<p>The simplest <code>fect</code> estimator uses two-way fixed effects to impute counterfactuals:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>out_fe <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"fe"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ATT estimate:"</span>, <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>ATT estimate: 5.121 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SE:          "</span>, <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SE:           0.3 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:      ["</span>, <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>], <span class="dv">3</span>), <span class="st">","</span>,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>], <span class="dv">3</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>95% CI:      [ 4.532 , 5.709 ]</code></pre>
</div>
</div>
</section>
<section id="event-study-gap-plot" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="event-study-gap-plot"><span class="header-section-number">6.2</span> Event study (gap) plot</h3>
<p>The default plot shows period-by-period ATTs relative to treatment onset:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_fe, <span class="at">main =</span> <span class="st">"FE counterfactual: ATT by periods since treatment"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/fect-fe-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interactive-fixed-effects-ife" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="interactive-fixed-effects-ife"><span class="header-section-number">6.3</span> Interactive fixed effects (IFE)</h3>
<p>When parallel trends may not hold, interactive fixed effects allow for unit-specific responses to common latent factors:</p>
<p><span class="math display">\[Y_{it}(0) = \alpha_i + \xi_t + f_t' \lambda_i + X_{it}'\beta + \varepsilon_{it}\]</span></p>
<p>The number of factors <span class="math inline">\(r\)</span> is selected by cross-validation:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>out_ife <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"ife"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">CV =</span> <span class="cn">TRUE</span>, <span class="at">r =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Cross-validating ...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Criterion: Mean Squared Prediction Error</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interactive fixed effects model...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>r = 0; sigma2 = 6.35460; IC = 2.21891; PC = 6.08178; MSPE = 6.89894</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>r = 1; sigma2 = 4.52698; IC = 2.24325; PC = 5.26760; MSPE = 5.05627</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>r = 2; sigma2 = 3.89603; IC = 2.45349; PC = 5.33953; MSPE = 4.62321</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>*</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>r = 3; sigma2 = 3.79056; IC = 2.78325; PC = 5.98062; MSPE = 4.96778</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>r = 4; sigma2 = 3.67967; IC = 3.10762; PC = 6.56967; MSPE = 5.65206</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>r = 5; sigma2 = 3.57625; IC = 3.43005; PC = 7.12886; MSPE = 6.07420</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 r* = 2</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IFE ATT:"</span>, <span class="fu">round</span>(out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">3</span>),</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">" (selected r ="</span>, out_ife<span class="sc">$</span>r.cv, <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>IFE ATT: 3.073  (selected r = 2 )</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_ife, <span class="at">main =</span> <span class="st">"IFE counterfactual: ATT by periods since treatment"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/fect-ife-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="matrix-completion" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="matrix-completion"><span class="header-section-number">6.4</span> Matrix completion</h3>
<p>Matrix completion treats the <span class="math inline">\(N \times T\)</span> matrix of untreated potential outcomes as approximately low-rank and uses nuclear norm regularization to impute missing entries—no need to specify the number of factors:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>out_mc <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"mc"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">CV =</span> <span class="cn">TRUE</span>,</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Cross-validating ...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Criterion: Mean Squared Prediction Error</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Matrix completion method...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>lambda.norm = 1.00000; MSPE = 7.10032; MSPTATT = 0.28561; MSE = 5.80999</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>lambda.norm = 0.42170; MSPE = 5.52641; MSPTATT = 0.12218; MSE = 4.15356</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>lambda.norm = 0.17783; MSPE = 5.25167; MSPTATT = 0.04007; MSE = 1.57548</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>*</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>lambda.norm = 0.07499; MSPE = 5.47297; MSPTATT = 0.00815; MSE = 0.28590</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>lambda.norm = 0.03162; MSPE = 5.76475; MSPTATT = 0.00170; MSE = 0.05133</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>lambda.norm = 0.01334; MSPE = 6.68770; MSPTATT = 0.00034; MSE = 0.00914</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
 lambda.norm* = 0.177827941003892</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MC ATT:"</span>, <span class="fu">round</span>(out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>MC ATT: 4.262 </code></pre>
</div>
</div>
</section>
<section id="comparing-methods" class="level3" data-number="6.5">
<h3 data-number="6.5" class="anchored" data-anchor-id="comparing-methods"><span class="header-section-number">6.5</span> Comparing methods</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>methods_comp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"FE"</span>, <span class="st">"IFE"</span>, <span class="st">"MC"</span>),</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATT =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>]), <span class="dv">3</span>),</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>]), <span class="dv">3</span>),</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lower =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>]), <span class="dv">3</span>),</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_upper =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>]), <span class="dv">3</span>)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>methods_comp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Method   ATT    SE CI_lower CI_upper
1     FE 5.121 0.300    4.532    5.709
2    IFE 3.073 0.282    2.521    3.626
3     MC 4.262 0.327    3.622    4.902</code></pre>
</div>
</div>
</section>
<section id="placebo-test-for-pre-trends" class="level3" data-number="6.6">
<h3 data-number="6.6" class="anchored" data-anchor-id="placebo-test-for-pre-trends"><span class="header-section-number">6.6</span> Placebo test for pre-trends</h3>
<p>The placebo test checks whether there are “treatment effects” in the pre-treatment period—evidence against parallel trends:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>out_placebo <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">method =</span> <span class="st">"fe"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">placeboTest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">placebo.period =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>),</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_placebo, <span class="at">main =</span> <span class="st">"Placebo test: pre-treatment effects should be zero"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/fect-placebo-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="equivalence-test" class="level3" data-number="6.7">
<h3 data-number="6.7" class="anchored" data-anchor-id="equivalence-test"><span class="header-section-number">6.7</span> Equivalence test</h3>
<p>The equivalence test provides a more formal assessment: are pre-treatment ATTs close enough to zero?</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_fe, <span class="at">type =</span> <span class="st">"equiv"</span>,</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Equivalence test for pre-treatment periods"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.
ℹ The deprecated feature was likely used in the fect package.
  Please report the issue at &lt;https://github.com/xuyiqing/fect/issues&gt;.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch13-fixed-effects_files/figure-html/fect-equiv-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="matrix-completion-for-panel-data-conceptual" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="matrix-completion-for-panel-data-conceptual"><span class="header-section-number">7</span> Matrix completion for panel data (conceptual)</h2>
<p>Athey, Bayati, Doudchenko, Imbens &amp; Khosravi (2021) formalize the connection between DID, synthetic control, and matrix completion. The key insight is that all three are special cases of the same framework, differing in what structure they impose on the matrix of untreated potential outcomes <span class="math inline">\(Y(0)\)</span>:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 52%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Assumption on <span class="math inline">\(Y(0)\)</span></th>
<th>Best when</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DID</td>
<td>Additive: <span class="math inline">\(Y_{it}(0) = \alpha_i + \xi_t\)</span> (rank 1)</td>
<td>Strong parallel trends</td>
</tr>
<tr class="even">
<td>Synthetic control</td>
<td>Hard rank constraint on columns</td>
<td>Few treated units, many controls</td>
</tr>
<tr class="odd">
<td>Matrix completion</td>
<td>Soft low-rank via nuclear norm penalty</td>
<td>General (robust across settings)</td>
</tr>
</tbody>
</table>
<p>The <code>MCPanel</code> package (available from GitHub: <code>susanathey/MCPanel</code>) implements nuclear norm minimized matrix completion. The idea is to find a low-rank matrix <span class="math inline">\(L\)</span> plus unit and time effects that best approximate the observed (untreated) entries:</p>
<p><span class="math display">\[\min_{L, \gamma, \delta} \frac{1}{|\mathcal{O}|} \sum_{(i,t) \in \mathcal{O}} (Y_{it} - L_{it} - \gamma_i - \delta_t)^2 + \lambda \|L\|_*\]</span></p>
<p>where <span class="math inline">\(\|L\|_*\)</span> is the nuclear norm (sum of singular values) and <span class="math inline">\(\lambda\)</span> is chosen by cross-validation. When <span class="math inline">\(\lambda\)</span> is very large, <span class="math inline">\(L \to 0\)</span> and the method reduces to DID. When <span class="math inline">\(\lambda\)</span> is small, it approximates interactive fixed effects.</p>
<p>We can demonstrate the idea with a simple simulation:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>N_mc <span class="ot">&lt;-</span> <span class="dv">30</span>; T_mc <span class="ot">&lt;-</span> <span class="dv">20</span>; R_true <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Low-rank structure</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N_mc <span class="sc">*</span> R_true), N_mc, R_true)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(T_mc <span class="sc">*</span> R_true), T_mc, R_true)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>L_true <span class="ot">&lt;-</span> A <span class="sc">%*%</span> <span class="fu">t</span>(B)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Unit and time effects</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N_mc, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(T_mc, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> L_true <span class="sc">+</span> <span class="fu">outer</span>(gamma, <span class="fu">rep</span>(<span class="dv">1</span>, T_mc)) <span class="sc">+</span> <span class="fu">outer</span>(<span class="fu">rep</span>(<span class="dv">1</span>, N_mc), delta) <span class="sc">+</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N_mc <span class="sc">*</span> T_mc, <span class="at">sd =</span> <span class="fl">0.3</span>), N_mc, T_mc)</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment: units 1-10 treated from period 15 onward</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>tau_true <span class="ot">&lt;-</span> <span class="fl">2.0</span>  <span class="co"># constant treatment effect</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>Y_obs <span class="ot">&lt;-</span> Y0</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="ot">&lt;-</span> Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="sc">+</span> tau_true</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a><span class="co"># What DID would estimate</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>did_control_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">11</span><span class="sc">:</span>N_mc, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>])</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>did_control_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">11</span><span class="sc">:</span>N_mc, <span class="dv">15</span><span class="sc">:</span>T_mc])</span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>did_treat_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>])</span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>did_treat_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc])</span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>did_att <span class="ot">&lt;-</span> (did_treat_post <span class="sc">-</span> did_treat_pre) <span class="sc">-</span> (did_control_post <span class="sc">-</span> did_control_pre)</span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a><span class="co"># SVD-based imputation (simplified matrix completion)</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Use control rows + pre-treatment treated rows to impute</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, N_mc, T_mc)</span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a>mask[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># missing = treated</span></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute using low-rank SVD of observed entries</span></span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>Y_masked <span class="ot">&lt;-</span> Y_obs <span class="sc">*</span> mask</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>Y_masked[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple imputation: use SVD on complete rows to predict treated post</span></span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>Y_control <span class="ot">&lt;-</span> Y_obs[<span class="dv">11</span><span class="sc">:</span>N_mc, ]</span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>svd_control <span class="ot">&lt;-</span> <span class="fu">svd</span>(Y_control)</span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Project treated pre-period onto control space</span></span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a>Y_treat_pre <span class="ot">&lt;-</span> Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>]</span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Use first R_true factors</span></span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>V_pre <span class="ot">&lt;-</span> svd_control<span class="sc">$</span>v[<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>, <span class="dv">1</span><span class="sc">:</span>R_true]</span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a>V_post <span class="ot">&lt;-</span> svd_control<span class="sc">$</span>v[<span class="dv">15</span><span class="sc">:</span>T_mc, <span class="dv">1</span><span class="sc">:</span>R_true]</span>
<span id="cb105-44"><a href="#cb105-44" aria-hidden="true" tabindex="-1"></a>U_hat <span class="ot">&lt;-</span> Y_treat_pre <span class="sc">%*%</span> V_pre <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(V_pre) <span class="sc">%*%</span> V_pre)</span>
<span id="cb105-45"><a href="#cb105-45" aria-hidden="true" tabindex="-1"></a>Y0_hat_post <span class="ot">&lt;-</span> U_hat <span class="sc">%*%</span> <span class="fu">t</span>(V_post)</span>
<span id="cb105-46"><a href="#cb105-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-47"><a href="#cb105-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust for level (add mean)</span></span>
<span id="cb105-48"><a href="#cb105-48" aria-hidden="true" tabindex="-1"></a>mc_att <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="sc">-</span> Y0_hat_post) <span class="sc">-</span></span>
<span id="cb105-49"><a href="#cb105-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>] <span class="sc">-</span> U_hat <span class="sc">%*%</span> <span class="fu">t</span>(V_pre))</span>
<span id="cb105-50"><a href="#cb105-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-51"><a href="#cb105-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATT:     "</span>, tau_true, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>True ATT:      2 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DID estimate: "</span>, <span class="fu">round</span>(did_att, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>DID estimate:  1.914 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MC estimate:  "</span>, <span class="fu">round</span>(mc_att, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>MC estimate:   1.733 </code></pre>
</div>
</div>
<p>When the data have a low-rank structure that violates simple parallel trends, matrix completion can outperform DID by exploiting the factor structure.</p>
</section>
<section id="when-to-use-which-method" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="when-to-use-which-method"><span class="header-section-number">8</span> When to use which method</h2>
<p>The landscape of DiD and panel methods has expanded. Here is a practical guide:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Modern DiD / Panel Method Guide:
==================================

STANDARD PANEL (no staggered treatment):
  - alpha_i correlated with X?
    Yes --&gt; Fixed Effects or CRE (Mundlak)
    No  --&gt; Random Effects (rare in observational data)
  - Lagged dependent variable?
    Yes --&gt; Arellano-Bond or System GMM (see Ch. 12)

STAGGERED DiD (treatment adopted at different times):
  - Homogeneous treatment effects?
    Yes --&gt; Standard TWFE is fine
    No  --&gt; Use modern methods:
      * Callaway-Sant'Anna (did package):
        - Group-time ATTs, flexible aggregation
        - Supports covariates, doubly robust estimation
        - Requires staggered adoption (no treatment reversal)
      * fect package:
        - FE, IFE, or matrix completion counterfactuals
        - Handles treatment reversal
        - Built-in placebo and equivalence tests
        - Also wraps other methods (CS, Sun-Abraham, etc.)
      * MCPanel:
        - Matrix completion (nuclear norm)
        - Unifies DID, synthetic control, and IFE
        - Best when outcome matrix is approximately low-rank

DIAGNOSTICS:
  - Always check pre-trends (event study / placebo test)
  - For GMM: Sargan/J-test + AR(2) test
  - For RE: Hausman test (as diagnostic, not decision rule)
  - For CRE: F-test on group means = robust Hausman test</code></pre>
</div>
</div>
</section>
<section id="summary" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="summary"><span class="header-section-number">9</span> Summary</h2>
<ul>
<li><strong>Random effects</strong> assumes <span class="math inline">\(\alpha_i \perp X_{it}\)</span> and applies GLS with the composite error structure. It is more efficient than FE when valid, but inconsistent when violated.</li>
<li><strong>The Hausman test</strong> compares FE and RE; use it as a diagnostic, not a model-selection tool.</li>
<li><strong>Correlated random effects (Mundlak)</strong> nests both FE and RE: it recovers FE slopes while also estimating effects of time-invariant variables. The Mundlak test (<span class="math inline">\(\delta = 0\)</span>) equals the Hausman test but works with robust SEs.</li>
<li><strong>TWFE fails under staggered treatment</strong> with heterogeneous effects due to negative weighting.</li>
<li><strong>Callaway–Sant’Anna</strong> (<code>did</code> package) estimates group-time ATTs and aggregates them into event studies, group-specific effects, or an overall ATT—avoiding the negative weighting problem.</li>
<li><strong>fect</strong> provides counterfactual imputation estimators: FE, interactive fixed effects, and matrix completion. It handles treatment reversal and includes built-in diagnostics.</li>
<li><strong>Matrix completion</strong> (Athey et al.) unifies DID and synthetic control as special cases of nuclear norm minimization, providing a flexible middle ground.</li>
<li>All panel estimators connect to the <strong>GMM framework</strong>: FE uses within-group moments, RE adds between-group moments, CRE augments RE to nest FE, and dynamic panels use lagged instruments.</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/UChicago-pol-methods\.github\.io\/EstimationI\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb112" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "13. Fixed Effects and Modern DiD"</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Random effects, Hausman test, CRE, dynamic panels, and new DiD methods"</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>This chapter covers the fixed vs. random effects choice, correlated random effects (Mundlak), dynamic panel GMM, and modern difference-in-differences methods that address the problems with two-way fixed effects under staggered treatment adoption. We use <span class="in">`plm`</span> for panel estimation, <span class="in">`did`</span> for Callaway--Sant'Anna group-time ATTs, and <span class="in">`fect`</span> for counterfactual imputation estimators.</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>**Questions this chapter answers:**</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>When should you use fixed effects vs. random effects, and what does the Hausman test tell you?</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>How does the TWFE estimator fail under staggered treatment with heterogeneous effects?</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>What modern alternatives (Callaway-Sant'Anna, fect, matrix completion) fix the negative weighting problem?</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plm)</span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(did)</span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fect)</span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random effects as GLS</span></span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>In Chapter 12 we estimated fixed effects by demeaning within each unit. The **random effects** (RE) estimator instead treats $\alpha_i$ as part of a composite error $\nu_{it} = \alpha_i + \varepsilon_{it}$ and applies GLS to exploit the known correlation structure:</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>$$\text{Var}(\nu_i) = \sigma_\varepsilon^2 I_T + \sigma_\alpha^2 \iota\iota' = \Omega$$ {#eq-re-variance}</span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: produc-setup</span></span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"Produc"</span>, <span class="at">package =</span> <span class="st">"plm"</span>)</span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">pdata.frame</span>(Produc, <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"year"</span>))</span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: re-estimation</span></span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed effects</span></span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a>fe_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp,</span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"within"</span>)</span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Random effects (GLS with error components)</span></span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a>re_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp,</span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare slope coefficients</span></span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>coef_comp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(<span class="fu">coef</span>(fe_fit)),</span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">FE =</span> <span class="fu">round</span>(<span class="fu">coef</span>(fe_fit), <span class="dv">4</span>),</span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">RE =</span> <span class="fu">round</span>(<span class="fu">coef</span>(re_fit)[<span class="sc">-</span><span class="dv">1</span>], <span class="dv">4</span>)</span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(coef_comp) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>coef_comp</span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>RE is more efficient than FE when the random effects assumption ($\alpha_i \perp X_{it}$) holds, because it uses both within-unit and between-unit variation. But if $\alpha_i$ is correlated with the regressors, RE is inconsistent.</span>
<span id="cb112-65"><a href="#cb112-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-66"><a href="#cb112-66" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variance components</span></span>
<span id="cb112-67"><a href="#cb112-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-68"><a href="#cb112-68" aria-hidden="true" tabindex="-1"></a>The RE estimator decomposes total variance into unit-level ($\sigma_\alpha^2$) and idiosyncratic ($\sigma_\varepsilon^2$) components:</span>
<span id="cb112-69"><a href="#cb112-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-72"><a href="#cb112-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-73"><a href="#cb112-73" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: variance-components</span></span>
<span id="cb112-74"><a href="#cb112-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variance components from plm</span></span>
<span id="cb112-75"><a href="#cb112-75" aria-hidden="true" tabindex="-1"></a>ercomp <span class="ot">&lt;-</span> <span class="fu">ercomp</span>(re_fit)</span>
<span id="cb112-76"><a href="#cb112-76" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"sigma_alpha (unit):"</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(ercomp<span class="sc">$</span>sigma2[<span class="st">"id"</span>]), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-77"><a href="#cb112-77" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"sigma_eps (idios):"</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(ercomp<span class="sc">$</span>sigma2[<span class="st">"idios"</span>]), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-78"><a href="#cb112-78" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"theta (shrinkage):"</span>, <span class="fu">round</span>(ercomp<span class="sc">$</span>theta, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-79"><a href="#cb112-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-80"><a href="#cb112-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-81"><a href="#cb112-81" aria-hidden="true" tabindex="-1"></a>The shrinkage parameter $\theta$ controls how much RE pulls toward the within estimator versus the between estimator. When $\theta$ is close to 1, RE is close to FE; when $\theta$ is close to 0, RE is close to pooled OLS.</span>
<span id="cb112-82"><a href="#cb112-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-83"><a href="#cb112-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Partial pooling: RE as a weighted average</span></span>
<span id="cb112-84"><a href="#cb112-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-87"><a href="#cb112-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-88"><a href="#cb112-88" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: partial-pooling</span></span>
<span id="cb112-89"><a href="#cb112-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Between estimator</span></span>
<span id="cb112-90"><a href="#cb112-90" aria-hidden="true" tabindex="-1"></a>be_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp,</span>
<span id="cb112-91"><a href="#cb112-91" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"between"</span>)</span>
<span id="cb112-92"><a href="#cb112-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-93"><a href="#cb112-93" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Between: "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(be_fit)[<span class="st">"log(pcap)"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-94"><a href="#cb112-94" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Within:  "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fe_fit)[<span class="st">"log(pcap)"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-95"><a href="#cb112-95" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"RE:      "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(re_fit)[<span class="st">"log(pcap)"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-96"><a href="#cb112-96" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(RE is between the within and between estimates)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-97"><a href="#cb112-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-98"><a href="#cb112-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-99"><a href="#cb112-99" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Hausman test</span></span>
<span id="cb112-100"><a href="#cb112-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-101"><a href="#cb112-101" aria-hidden="true" tabindex="-1"></a>The Hausman test compares FE (consistent under both $H_0$ and $H_1$) with RE (efficient under $H_0$ but inconsistent under $H_1$):</span>
<span id="cb112-102"><a href="#cb112-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-103"><a href="#cb112-103" aria-hidden="true" tabindex="-1"></a>$$H = (\hat\beta_{FE} - \hat\beta_{RE})' <span class="co">[</span><span class="ot">\text{Var}(\hat\beta_{FE}) - \text{Var}(\hat\beta_{RE})</span><span class="co">]</span>^{-1} (\hat\beta_{FE} - \hat\beta_{RE}) \xrightarrow{d} \chi^2_K$$ {#eq-hausman}</span>
<span id="cb112-104"><a href="#cb112-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-105"><a href="#cb112-105" aria-hidden="true" tabindex="-1"></a>::: {#thm-hausman}</span>
<span id="cb112-106"><a href="#cb112-106" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hausman Test</span></span>
<span id="cb112-107"><a href="#cb112-107" aria-hidden="true" tabindex="-1"></a>The Hausman statistic $H = (\hat\beta_{FE} - \hat\beta_{RE})'<span class="co">[</span><span class="ot">\text{Var}(\hat\beta_{FE}) - \text{Var}(\hat\beta_{RE})</span><span class="co">]</span>^{-1}(\hat\beta_{FE} - \hat\beta_{RE}) \xrightarrow{d} \chi^2_K$ tests whether FE and RE estimates differ systematically. Rejection means $\alpha_i$ is correlated with $X_{it}$, favoring FE.</span>
<span id="cb112-108"><a href="#cb112-108" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb112-109"><a href="#cb112-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-112"><a href="#cb112-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-113"><a href="#cb112-113" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: hausman-test</span></span>
<span id="cb112-114"><a href="#cb112-114" aria-hidden="true" tabindex="-1"></a><span class="fu">phtest</span>(fe_fit, re_fit)</span>
<span id="cb112-115"><a href="#cb112-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-116"><a href="#cb112-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-117"><a href="#cb112-117" aria-hidden="true" tabindex="-1"></a>A small p-value rejects the RE assumption---state fixed effects are correlated with the regressors, so FE is preferred.</span>
<span id="cb112-118"><a href="#cb112-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-119"><a href="#cb112-119" aria-hidden="true" tabindex="-1"></a>**Caveat:** Using the Hausman test to *choose* between FE and RE creates a pretest estimator with distorted coverage. The research design should determine the estimator; report the Hausman test as a diagnostic. The Hausman test can also be viewed as a <span class="co">[</span><span class="ot">GMM overidentification test</span><span class="co">](ch11-gmm.qmd#sec-j-test)</span>.</span>
<span id="cb112-120"><a href="#cb112-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-121"><a href="#cb112-121" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correlated random effects (Mundlak) {#sec-mundlak}</span></span>
<span id="cb112-122"><a href="#cb112-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-123"><a href="#cb112-123" aria-hidden="true" tabindex="-1"></a>Mundlak (1978) proposed a middle ground: include the group means $\bar{x}_i$ as additional regressors in the RE model. This "soaks up" the correlation between $\alpha_i$ and $x_{it}$:</span>
<span id="cb112-124"><a href="#cb112-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-125"><a href="#cb112-125" aria-hidden="true" tabindex="-1"></a>$$\alpha_i = \delta_0 + \bar{x}_i' \delta + \zeta_i, \quad \mathbb{E}[\zeta_i \mid x_{it}, z_i] = 0$$</span>
<span id="cb112-126"><a href="#cb112-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-129"><a href="#cb112-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-130"><a href="#cb112-130" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cre-mundlak</span></span>
<span id="cb112-131"><a href="#cb112-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Add group means of time-varying regressors</span></span>
<span id="cb112-132"><a href="#cb112-132" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>lpcap_bar <span class="ot">&lt;-</span> <span class="fu">Between</span>(<span class="fu">log</span>(pdata<span class="sc">$</span>pcap))</span>
<span id="cb112-133"><a href="#cb112-133" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>lpc_bar   <span class="ot">&lt;-</span> <span class="fu">Between</span>(<span class="fu">log</span>(pdata<span class="sc">$</span>pc))</span>
<span id="cb112-134"><a href="#cb112-134" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>lemp_bar  <span class="ot">&lt;-</span> <span class="fu">Between</span>(<span class="fu">log</span>(pdata<span class="sc">$</span>emp))</span>
<span id="cb112-135"><a href="#cb112-135" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>unemp_bar <span class="ot">&lt;-</span> <span class="fu">Between</span>(pdata<span class="sc">$</span>unemp)</span>
<span id="cb112-136"><a href="#cb112-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-137"><a href="#cb112-137" aria-hidden="true" tabindex="-1"></a><span class="co"># CRE = RE + group means</span></span>
<span id="cb112-138"><a href="#cb112-138" aria-hidden="true" tabindex="-1"></a>cre_fit <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp <span class="sc">+</span></span>
<span id="cb112-139"><a href="#cb112-139" aria-hidden="true" tabindex="-1"></a>                 lpcap_bar <span class="sc">+</span> lpc_bar <span class="sc">+</span> lemp_bar <span class="sc">+</span> unemp_bar,</span>
<span id="cb112-140"><a href="#cb112-140" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb112-141"><a href="#cb112-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-142"><a href="#cb112-142" aria-hidden="true" tabindex="-1"></a><span class="co"># CRE slopes = FE slopes (by FWL)</span></span>
<span id="cb112-143"><a href="#cb112-143" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"CRE slopes: "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_fit)[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-144"><a href="#cb112-144" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"FE slopes:  "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(fe_fit), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-145"><a href="#cb112-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-146"><a href="#cb112-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-147"><a href="#cb112-147" aria-hidden="true" tabindex="-1"></a>The CRE slopes on time-varying regressors match FE exactly. This follows from the <span class="co">[</span><span class="ot">FWL theorem</span><span class="co">](ch04-sensitivity.qmd#thm-fwl)</span>: partialing out $\bar{x}_i$ from $x_{it}$ gives the within-demeaned data.</span>
<span id="cb112-148"><a href="#cb112-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-149"><a href="#cb112-149" aria-hidden="true" tabindex="-1"></a>::: {#thm-mundlak}</span>
<span id="cb112-150"><a href="#cb112-150" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correlated Random Effects (Mundlak)</span></span>
<span id="cb112-151"><a href="#cb112-151" aria-hidden="true" tabindex="-1"></a>Adding group means $\bar{x}_i$ to the RE model gives CRE: $y_{it} = x_{it}'\beta + \bar{x}_i'\delta + \alpha_i + \varepsilon_{it}$. The slope $\hat\beta_{CRE}$ equals $\hat\beta_{FE}$ by FWL. Testing $\delta = 0$ is equivalent to the Hausman test but works with robust SEs and allows estimation of time-invariant variable effects.</span>
<span id="cb112-152"><a href="#cb112-152" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb112-153"><a href="#cb112-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-154"><a href="#cb112-154" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb112-155"><a href="#cb112-155" aria-hidden="true" tabindex="-1"></a><span class="fu">## CRE = FE + Time-Invariant Variables</span></span>
<span id="cb112-156"><a href="#cb112-156" aria-hidden="true" tabindex="-1"></a>The Mundlak/CRE approach gives identical slope coefficients to FE while also allowing estimation of effects of time-invariant regressors (region, sex, ethnicity). It also provides a robust version of the Hausman test through an F-test on the group means.</span>
<span id="cb112-157"><a href="#cb112-157" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb112-158"><a href="#cb112-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-159"><a href="#cb112-159" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Mundlak test = Hausman test</span></span>
<span id="cb112-160"><a href="#cb112-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-161"><a href="#cb112-161" aria-hidden="true" tabindex="-1"></a>Testing $H_0: \delta = 0$ (the group means have no additional explanatory power) is equivalent to the Hausman test:</span>
<span id="cb112-162"><a href="#cb112-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-165"><a href="#cb112-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-166"><a href="#cb112-166" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mundlak-test</span></span>
<span id="cb112-167"><a href="#cb112-167" aria-hidden="true" tabindex="-1"></a><span class="co"># F-test on the group means</span></span>
<span id="cb112-168"><a href="#cb112-168" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb112-169"><a href="#cb112-169" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(cre_fit,</span>
<span id="cb112-170"><a href="#cb112-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"lpcap_bar = 0"</span>, <span class="st">"lpc_bar = 0"</span>, <span class="st">"lemp_bar = 0"</span>, <span class="st">"unemp_bar = 0"</span>))</span>
<span id="cb112-171"><a href="#cb112-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-172"><a href="#cb112-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-173"><a href="#cb112-173" aria-hidden="true" tabindex="-1"></a><span class="fu">### CRE identifies effects of time-invariant variables</span></span>
<span id="cb112-174"><a href="#cb112-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-175"><a href="#cb112-175" aria-hidden="true" tabindex="-1"></a>A key advantage of CRE over FE: it can estimate effects of time-invariant regressors. FE sweeps them out along with $\alpha_i$.</span>
<span id="cb112-176"><a href="#cb112-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-179"><a href="#cb112-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-180"><a href="#cb112-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cre-time-invariant</span></span>
<span id="cb112-181"><a href="#cb112-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a time-invariant variable: region</span></span>
<span id="cb112-182"><a href="#cb112-182" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>region_ne <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb112-183"><a href="#cb112-183" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>region_s  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"3"</span>)</span>
<span id="cb112-184"><a href="#cb112-184" aria-hidden="true" tabindex="-1"></a>pdata<span class="sc">$</span>region_w  <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"4"</span>)</span>
<span id="cb112-185"><a href="#cb112-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-186"><a href="#cb112-186" aria-hidden="true" tabindex="-1"></a>cre_region <span class="ot">&lt;-</span> <span class="fu">plm</span>(<span class="fu">log</span>(gsp) <span class="sc">~</span> <span class="fu">log</span>(pcap) <span class="sc">+</span> <span class="fu">log</span>(pc) <span class="sc">+</span> <span class="fu">log</span>(emp) <span class="sc">+</span> unemp <span class="sc">+</span></span>
<span id="cb112-187"><a href="#cb112-187" aria-hidden="true" tabindex="-1"></a>                    lpcap_bar <span class="sc">+</span> lpc_bar <span class="sc">+</span> lemp_bar <span class="sc">+</span> unemp_bar <span class="sc">+</span></span>
<span id="cb112-188"><a href="#cb112-188" aria-hidden="true" tabindex="-1"></a>                    region_ne <span class="sc">+</span> region_s <span class="sc">+</span> region_w,</span>
<span id="cb112-189"><a href="#cb112-189" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> pdata, <span class="at">model =</span> <span class="st">"random"</span>)</span>
<span id="cb112-190"><a href="#cb112-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-191"><a href="#cb112-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Region coefficients (relative to North Central)</span></span>
<span id="cb112-192"><a href="#cb112-192" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Region effects (CRE):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-193"><a href="#cb112-193" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Northeast:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_region)[<span class="st">"region_ne"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-194"><a href="#cb112-194" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  South:    "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_region)[<span class="st">"region_s"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-195"><a href="#cb112-195" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  West:     "</span>, <span class="fu">round</span>(<span class="fu">coef</span>(cre_region)[<span class="st">"region_w"</span>], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-196"><a href="#cb112-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-197"><a href="#cb112-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-198"><a href="#cb112-198" aria-hidden="true" tabindex="-1"></a><span class="fu">## The problem with TWFE under staggered treatment {#sec-twfe-bias}</span></span>
<span id="cb112-199"><a href="#cb112-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-200"><a href="#cb112-200" aria-hidden="true" tabindex="-1"></a>Standard two-way fixed effects (TWFE) with staggered treatment can produce severely biased estimates when treatment effects are heterogeneous. TWFE implicitly compares newly-treated units to already-treated units, creating negative weights on some group-time ATTs.</span>
<span id="cb112-201"><a href="#cb112-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-202"><a href="#cb112-202" aria-hidden="true" tabindex="-1"></a>::: {#thm-twfe-bias}</span>
<span id="cb112-203"><a href="#cb112-203" aria-hidden="true" tabindex="-1"></a><span class="fu">## TWFE Bias Under Staggered Treatment</span></span>
<span id="cb112-204"><a href="#cb112-204" aria-hidden="true" tabindex="-1"></a>With staggered adoption and heterogeneous treatment effects, TWFE assigns negative weights to some group-time ATTs — using already-treated units as controls for newly-treated units. The resulting estimate can be far from any meaningful causal parameter, including the wrong sign.</span>
<span id="cb112-205"><a href="#cb112-205" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb112-206"><a href="#cb112-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-207"><a href="#cb112-207" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb112-208"><a href="#cb112-208" aria-hidden="true" tabindex="-1"></a><span class="fu">## TWFE Can Produce Negative Weights</span></span>
<span id="cb112-209"><a href="#cb112-209" aria-hidden="true" tabindex="-1"></a>Under staggered treatment with dynamic or heterogeneous effects, TWFE regression assigns negative weights to some group-time treatment effects. This means the TWFE coefficient is not a convex average of individual treatment effects — it can even have the wrong sign. Use Callaway-Sant'Anna, Sun-Abraham, or fect instead.</span>
<span id="cb112-210"><a href="#cb112-210" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb112-211"><a href="#cb112-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-212"><a href="#cb112-212" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulation: TWFE bias</span></span>
<span id="cb112-213"><a href="#cb112-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-216"><a href="#cb112-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-217"><a href="#cb112-217" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: twfe-bias-sim</span></span>
<span id="cb112-218"><a href="#cb112-218" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb112-219"><a href="#cb112-219" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span>; T_max <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb112-220"><a href="#cb112-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-221"><a href="#cb112-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Staggered adoption: 3 cohorts + never-treated</span></span>
<span id="cb112-222"><a href="#cb112-222" aria-hidden="true" tabindex="-1"></a>cohorts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>)  <span class="co"># treatment start times</span></span>
<span id="cb112-223"><a href="#cb112-223" aria-hidden="true" tabindex="-1"></a>sim_panel <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb112-224"><a href="#cb112-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-225"><a href="#cb112-225" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb112-226"><a href="#cb112-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign to cohort (25% each)</span></span>
<span id="cb112-227"><a href="#cb112-227" aria-hidden="true" tabindex="-1"></a>  g <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(cohorts, <span class="dv">0</span>), <span class="dv">1</span>)  <span class="co"># 0 = never treated</span></span>
<span id="cb112-228"><a href="#cb112-228" aria-hidden="true" tabindex="-1"></a>  alpha_i <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb112-229"><a href="#cb112-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-230"><a href="#cb112-230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_max) {</span>
<span id="cb112-231"><a href="#cb112-231" aria-hidden="true" tabindex="-1"></a>    treated <span class="ot">&lt;-</span> (g <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (t <span class="sc">&gt;=</span> g)</span>
<span id="cb112-232"><a href="#cb112-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treatment effect grows with exposure AND varies by cohort</span></span>
<span id="cb112-233"><a href="#cb112-233" aria-hidden="true" tabindex="-1"></a>    te <span class="ot">&lt;-</span> <span class="cf">if</span> (treated) <span class="fl">1.0</span> <span class="sc">+</span> <span class="fl">0.3</span> <span class="sc">*</span> (t <span class="sc">-</span> g) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> (g <span class="sc">==</span> <span class="dv">4</span>) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb112-234"><a href="#cb112-234" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> alpha_i <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> t <span class="sc">+</span> te <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb112-235"><a href="#cb112-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-236"><a href="#cb112-236" aria-hidden="true" tabindex="-1"></a>    sim_panel <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sim_panel,</span>
<span id="cb112-237"><a href="#cb112-237" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">id =</span> i, <span class="at">time =</span> t, <span class="at">y =</span> y,</span>
<span id="cb112-238"><a href="#cb112-238" aria-hidden="true" tabindex="-1"></a>                 <span class="at">treat =</span> <span class="fu">as.integer</span>(treated),</span>
<span id="cb112-239"><a href="#cb112-239" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cohort =</span> g,</span>
<span id="cb112-240"><a href="#cb112-240" aria-hidden="true" tabindex="-1"></a>                 <span class="at">first_treat =</span> <span class="fu">ifelse</span>(g <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, g)))</span>
<span id="cb112-241"><a href="#cb112-241" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-242"><a href="#cb112-242" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb112-243"><a href="#cb112-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-244"><a href="#cb112-244" aria-hidden="true" tabindex="-1"></a><span class="co"># TWFE regression</span></span>
<span id="cb112-245"><a href="#cb112-245" aria-hidden="true" tabindex="-1"></a>twfe <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> treat <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data =</span> sim_panel)</span>
<span id="cb112-246"><a href="#cb112-246" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"TWFE estimate:"</span>, <span class="fu">round</span>(<span class="fu">coef</span>(twfe)[<span class="st">"treat"</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-247"><a href="#cb112-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-248"><a href="#cb112-248" aria-hidden="true" tabindex="-1"></a><span class="co"># True average ATT among treated observations</span></span>
<span id="cb112-249"><a href="#cb112-249" aria-hidden="true" tabindex="-1"></a>true_att <span class="ot">&lt;-</span> <span class="fu">mean</span>(sim_panel<span class="sc">$</span>y[sim_panel<span class="sc">$</span>treat <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span></span>
<span id="cb112-250"><a href="#cb112-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="dv">2</span> <span class="sc">+</span> <span class="fu">ave</span>(<span class="fu">rnorm</span>(N), <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> T_max)) <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> sim_panel<span class="sc">$</span>time[sim_panel<span class="sc">$</span>treat <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb112-251"><a href="#cb112-251" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"(The true ATT varies by cohort and exposure time -- TWFE averages with potentially negative weights)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-252"><a href="#cb112-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-253"><a href="#cb112-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-254"><a href="#cb112-254" aria-hidden="true" tabindex="-1"></a><span class="fu">## Callaway--Sant'Anna: group-time ATTs</span></span>
<span id="cb112-255"><a href="#cb112-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-256"><a href="#cb112-256" aria-hidden="true" tabindex="-1"></a>The <span class="in">`did`</span> package (Callaway &amp; Sant'Anna, 2021) avoids the TWFE problem by estimating separate ATTs for each group-time pair, then aggregating. The <span class="in">`mpdta`</span> dataset tracks teen employment across 500 U.S. counties, with staggered minimum wage increases.</span>
<span id="cb112-257"><a href="#cb112-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-260"><a href="#cb112-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-261"><a href="#cb112-261" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mpdta-setup</span></span>
<span id="cb112-262"><a href="#cb112-262" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mpdta)</span>
<span id="cb112-263"><a href="#cb112-263" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Counties:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(mpdta<span class="sc">$</span>countyreal)),</span>
<span id="cb112-264"><a href="#cb112-264" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Years:"</span>, <span class="fu">paste</span>(<span class="fu">range</span>(mpdta<span class="sc">$</span>year), <span class="at">collapse =</span> <span class="st">"-"</span>),</span>
<span id="cb112-265"><a href="#cb112-265" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Treatment cohorts:"</span>, <span class="fu">paste</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(mpdta<span class="sc">$</span>first.treat[mpdta<span class="sc">$</span>first.treat <span class="sc">&gt;</span> <span class="dv">0</span>])),</span>
<span id="cb112-266"><a href="#cb112-266" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-267"><a href="#cb112-267" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mpdta)</span>
<span id="cb112-268"><a href="#cb112-268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-269"><a href="#cb112-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-270"><a href="#cb112-270" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimating group-time ATTs</span></span>
<span id="cb112-271"><a href="#cb112-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-274"><a href="#cb112-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-275"><a href="#cb112-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-attgt</span></span>
<span id="cb112-276"><a href="#cb112-276" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate all group-time ATTs</span></span>
<span id="cb112-277"><a href="#cb112-277" aria-hidden="true" tabindex="-1"></a>cs_out <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(</span>
<span id="cb112-278"><a href="#cb112-278" aria-hidden="true" tabindex="-1"></a>  <span class="at">yname =</span> <span class="st">"lemp"</span>,</span>
<span id="cb112-279"><a href="#cb112-279" aria-hidden="true" tabindex="-1"></a>  <span class="at">gname =</span> <span class="st">"first.treat"</span>,</span>
<span id="cb112-280"><a href="#cb112-280" aria-hidden="true" tabindex="-1"></a>  <span class="at">idname =</span> <span class="st">"countyreal"</span>,</span>
<span id="cb112-281"><a href="#cb112-281" aria-hidden="true" tabindex="-1"></a>  <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb112-282"><a href="#cb112-282" aria-hidden="true" tabindex="-1"></a>  <span class="at">xformla =</span> <span class="sc">~</span><span class="dv">1</span>,              <span class="co"># unconditional</span></span>
<span id="cb112-283"><a href="#cb112-283" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mpdta,</span>
<span id="cb112-284"><a href="#cb112-284" aria-hidden="true" tabindex="-1"></a>  <span class="at">control_group =</span> <span class="st">"nevertreated"</span>,</span>
<span id="cb112-285"><a href="#cb112-285" aria-hidden="true" tabindex="-1"></a>  <span class="at">est_method =</span> <span class="st">"dr"</span>          <span class="co"># doubly robust (default)</span></span>
<span id="cb112-286"><a href="#cb112-286" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-287"><a href="#cb112-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-288"><a href="#cb112-288" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_out)</span>
<span id="cb112-289"><a href="#cb112-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-290"><a href="#cb112-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-291"><a href="#cb112-291" aria-hidden="true" tabindex="-1"></a>Each row is an ATT(g, t): the average treatment effect for group $g$ (defined by when they were first treated) at time $t$.</span>
<span id="cb112-292"><a href="#cb112-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-295"><a href="#cb112-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-296"><a href="#cb112-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-attgt-plot</span></span>
<span id="cb112-297"><a href="#cb112-297" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(cs_out, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>))</span>
<span id="cb112-298"><a href="#cb112-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-299"><a href="#cb112-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-300"><a href="#cb112-300" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aggregation: event study</span></span>
<span id="cb112-301"><a href="#cb112-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-302"><a href="#cb112-302" aria-hidden="true" tabindex="-1"></a>The many group-time ATTs can be aggregated into an event study (dynamic effects by exposure time):</span>
<span id="cb112-303"><a href="#cb112-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-306"><a href="#cb112-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-307"><a href="#cb112-307" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-event-study</span></span>
<span id="cb112-308"><a href="#cb112-308" aria-hidden="true" tabindex="-1"></a>cs_dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_out, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb112-309"><a href="#cb112-309" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_dyn)</span>
<span id="cb112-310"><a href="#cb112-310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-311"><a href="#cb112-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-314"><a href="#cb112-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-315"><a href="#cb112-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-event-plot</span></span>
<span id="cb112-316"><a href="#cb112-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Callaway-Sant'Anna event study: pre-treatment estimates near zero support parallel trends"</span></span>
<span id="cb112-317"><a href="#cb112-317" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(cs_dyn, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>))</span>
<span id="cb112-318"><a href="#cb112-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-319"><a href="#cb112-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-320"><a href="#cb112-320" aria-hidden="true" tabindex="-1"></a>Pre-treatment estimates near zero support the parallel trends assumption. Post-treatment estimates show the dynamic treatment effect.</span>
<span id="cb112-321"><a href="#cb112-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-322"><a href="#cb112-322" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple aggregation: overall ATT</span></span>
<span id="cb112-323"><a href="#cb112-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-326"><a href="#cb112-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-327"><a href="#cb112-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-simple</span></span>
<span id="cb112-328"><a href="#cb112-328" aria-hidden="true" tabindex="-1"></a>cs_simple <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_out, <span class="at">type =</span> <span class="st">"simple"</span>)</span>
<span id="cb112-329"><a href="#cb112-329" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_simple)</span>
<span id="cb112-330"><a href="#cb112-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-331"><a href="#cb112-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-332"><a href="#cb112-332" aria-hidden="true" tabindex="-1"></a><span class="fu">### Group-specific effects</span></span>
<span id="cb112-333"><a href="#cb112-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-336"><a href="#cb112-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-337"><a href="#cb112-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-group</span></span>
<span id="cb112-338"><a href="#cb112-338" aria-hidden="true" tabindex="-1"></a>cs_group <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_out, <span class="at">type =</span> <span class="st">"group"</span>)</span>
<span id="cb112-339"><a href="#cb112-339" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cs_group)</span>
<span id="cb112-340"><a href="#cb112-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-341"><a href="#cb112-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-342"><a href="#cb112-342" aria-hidden="true" tabindex="-1"></a>Different cohorts may experience different effects---early adopters vs. late adopters of the minimum wage increase.</span>
<span id="cb112-343"><a href="#cb112-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-344"><a href="#cb112-344" aria-hidden="true" tabindex="-1"></a><span class="fu">### With covariates</span></span>
<span id="cb112-345"><a href="#cb112-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-346"><a href="#cb112-346" aria-hidden="true" tabindex="-1"></a>Parallel trends can be conditioned on covariates. Here we control for log population:</span>
<span id="cb112-347"><a href="#cb112-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-350"><a href="#cb112-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-351"><a href="#cb112-351" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cs-covariates</span></span>
<span id="cb112-352"><a href="#cb112-352" aria-hidden="true" tabindex="-1"></a>cs_cov <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(</span>
<span id="cb112-353"><a href="#cb112-353" aria-hidden="true" tabindex="-1"></a>  <span class="at">yname =</span> <span class="st">"lemp"</span>,</span>
<span id="cb112-354"><a href="#cb112-354" aria-hidden="true" tabindex="-1"></a>  <span class="at">gname =</span> <span class="st">"first.treat"</span>,</span>
<span id="cb112-355"><a href="#cb112-355" aria-hidden="true" tabindex="-1"></a>  <span class="at">idname =</span> <span class="st">"countyreal"</span>,</span>
<span id="cb112-356"><a href="#cb112-356" aria-hidden="true" tabindex="-1"></a>  <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb112-357"><a href="#cb112-357" aria-hidden="true" tabindex="-1"></a>  <span class="at">xformla =</span> <span class="sc">~</span>lpop,           <span class="co"># conditional on log population</span></span>
<span id="cb112-358"><a href="#cb112-358" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mpdta,</span>
<span id="cb112-359"><a href="#cb112-359" aria-hidden="true" tabindex="-1"></a>  <span class="at">control_group =</span> <span class="st">"nevertreated"</span></span>
<span id="cb112-360"><a href="#cb112-360" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-361"><a href="#cb112-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-362"><a href="#cb112-362" aria-hidden="true" tabindex="-1"></a>cs_cov_dyn <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs_cov, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb112-363"><a href="#cb112-363" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdid</span>(cs_cov_dyn, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.3</span>))</span>
<span id="cb112-364"><a href="#cb112-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-365"><a href="#cb112-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-366"><a href="#cb112-366" aria-hidden="true" tabindex="-1"></a><span class="fu">## Counterfactual estimators with fect</span></span>
<span id="cb112-367"><a href="#cb112-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-368"><a href="#cb112-368" aria-hidden="true" tabindex="-1"></a>The <span class="in">`fect`</span> package (Liu, Wang &amp; Xu, 2024) takes a different approach: it imputes counterfactual outcomes for treated observations by fitting a model on untreated observations only, then computes treatment effects as the difference between observed and imputed outcomes.</span>
<span id="cb112-369"><a href="#cb112-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-370"><a href="#cb112-370" aria-hidden="true" tabindex="-1"></a>The <span class="in">`simdata`</span> dataset has 200 units over 35 periods with treatment that can switch on and off:</span>
<span id="cb112-371"><a href="#cb112-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-374"><a href="#cb112-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-375"><a href="#cb112-375" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-data</span></span>
<span id="cb112-376"><a href="#cb112-376" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(fect)</span>
<span id="cb112-377"><a href="#cb112-377" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Units:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(simdata<span class="sc">$</span>id)),</span>
<span id="cb112-378"><a href="#cb112-378" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Periods:"</span>, <span class="fu">paste</span>(<span class="fu">range</span>(simdata<span class="sc">$</span>time), <span class="at">collapse =</span> <span class="st">"-"</span>),</span>
<span id="cb112-379"><a href="#cb112-379" aria-hidden="true" tabindex="-1"></a>    <span class="st">" Treated obs:"</span>, <span class="fu">sum</span>(simdata<span class="sc">$</span>D), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-380"><a href="#cb112-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-381"><a href="#cb112-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-382"><a href="#cb112-382" aria-hidden="true" tabindex="-1"></a><span class="fu">### Two-way FE counterfactual</span></span>
<span id="cb112-383"><a href="#cb112-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-384"><a href="#cb112-384" aria-hidden="true" tabindex="-1"></a>The simplest <span class="in">`fect`</span> estimator uses two-way fixed effects to impute counterfactuals:</span>
<span id="cb112-385"><a href="#cb112-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-388"><a href="#cb112-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-389"><a href="#cb112-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-fe</span></span>
<span id="cb112-390"><a href="#cb112-390" aria-hidden="true" tabindex="-1"></a>out_fe <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb112-391"><a href="#cb112-391" aria-hidden="true" tabindex="-1"></a>               <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb112-392"><a href="#cb112-392" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"fe"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb112-393"><a href="#cb112-393" aria-hidden="true" tabindex="-1"></a>               <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb112-394"><a href="#cb112-394" aria-hidden="true" tabindex="-1"></a>               <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span>
<span id="cb112-395"><a href="#cb112-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-396"><a href="#cb112-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-399"><a href="#cb112-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-400"><a href="#cb112-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-fe-summary</span></span>
<span id="cb112-401"><a href="#cb112-401" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"ATT estimate:"</span>, <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-402"><a href="#cb112-402" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SE:          "</span>, <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-403"><a href="#cb112-403" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95% CI:      ["</span>, <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>], <span class="dv">3</span>), <span class="st">","</span>,</span>
<span id="cb112-404"><a href="#cb112-404" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>], <span class="dv">3</span>), <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-405"><a href="#cb112-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-406"><a href="#cb112-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-407"><a href="#cb112-407" aria-hidden="true" tabindex="-1"></a><span class="fu">### Event study (gap) plot</span></span>
<span id="cb112-408"><a href="#cb112-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-409"><a href="#cb112-409" aria-hidden="true" tabindex="-1"></a>The default plot shows period-by-period ATTs relative to treatment onset:</span>
<span id="cb112-410"><a href="#cb112-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-413"><a href="#cb112-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-414"><a href="#cb112-414" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-fe-plot</span></span>
<span id="cb112-415"><a href="#cb112-415" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_fe, <span class="at">main =</span> <span class="st">"FE counterfactual: ATT by periods since treatment"</span>)</span>
<span id="cb112-416"><a href="#cb112-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-417"><a href="#cb112-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-418"><a href="#cb112-418" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interactive fixed effects (IFE)</span></span>
<span id="cb112-419"><a href="#cb112-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-420"><a href="#cb112-420" aria-hidden="true" tabindex="-1"></a>When parallel trends may not hold, interactive fixed effects allow for unit-specific responses to common latent factors:</span>
<span id="cb112-421"><a href="#cb112-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-422"><a href="#cb112-422" aria-hidden="true" tabindex="-1"></a>$$Y_{it}(0) = \alpha_i + \xi_t + f_t' \lambda_i + X_{it}'\beta + \varepsilon_{it}$$</span>
<span id="cb112-423"><a href="#cb112-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-424"><a href="#cb112-424" aria-hidden="true" tabindex="-1"></a>The number of factors $r$ is selected by cross-validation:</span>
<span id="cb112-425"><a href="#cb112-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-428"><a href="#cb112-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-429"><a href="#cb112-429" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-ife</span></span>
<span id="cb112-430"><a href="#cb112-430" aria-hidden="true" tabindex="-1"></a>out_ife <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb112-431"><a href="#cb112-431" aria-hidden="true" tabindex="-1"></a>                <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb112-432"><a href="#cb112-432" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"ife"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb112-433"><a href="#cb112-433" aria-hidden="true" tabindex="-1"></a>                <span class="at">CV =</span> <span class="cn">TRUE</span>, <span class="at">r =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb112-434"><a href="#cb112-434" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb112-435"><a href="#cb112-435" aria-hidden="true" tabindex="-1"></a>                <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span>
<span id="cb112-436"><a href="#cb112-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-437"><a href="#cb112-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-440"><a href="#cb112-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-441"><a href="#cb112-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-ife-summary</span></span>
<span id="cb112-442"><a href="#cb112-442" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"IFE ATT:"</span>, <span class="fu">round</span>(out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">3</span>),</span>
<span id="cb112-443"><a href="#cb112-443" aria-hidden="true" tabindex="-1"></a>    <span class="st">" (selected r ="</span>, out_ife<span class="sc">$</span>r.cv, <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-444"><a href="#cb112-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-445"><a href="#cb112-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-448"><a href="#cb112-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-449"><a href="#cb112-449" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-ife-plot</span></span>
<span id="cb112-450"><a href="#cb112-450" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_ife, <span class="at">main =</span> <span class="st">"IFE counterfactual: ATT by periods since treatment"</span>)</span>
<span id="cb112-451"><a href="#cb112-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-452"><a href="#cb112-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-453"><a href="#cb112-453" aria-hidden="true" tabindex="-1"></a><span class="fu">### Matrix completion</span></span>
<span id="cb112-454"><a href="#cb112-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-455"><a href="#cb112-455" aria-hidden="true" tabindex="-1"></a>Matrix completion treats the $N \times T$ matrix of untreated potential outcomes as approximately low-rank and uses nuclear norm regularization to impute missing entries---no need to specify the number of factors:</span>
<span id="cb112-456"><a href="#cb112-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-459"><a href="#cb112-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-460"><a href="#cb112-460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-mc</span></span>
<span id="cb112-461"><a href="#cb112-461" aria-hidden="true" tabindex="-1"></a>out_mc <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb112-462"><a href="#cb112-462" aria-hidden="true" tabindex="-1"></a>               <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb112-463"><a href="#cb112-463" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"mc"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb112-464"><a href="#cb112-464" aria-hidden="true" tabindex="-1"></a>               <span class="at">CV =</span> <span class="cn">TRUE</span>,</span>
<span id="cb112-465"><a href="#cb112-465" aria-hidden="true" tabindex="-1"></a>               <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb112-466"><a href="#cb112-466" aria-hidden="true" tabindex="-1"></a>               <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span>
<span id="cb112-467"><a href="#cb112-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-468"><a href="#cb112-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-471"><a href="#cb112-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-472"><a href="#cb112-472" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-mc-summary</span></span>
<span id="cb112-473"><a href="#cb112-473" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MC ATT:"</span>, <span class="fu">round</span>(out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-474"><a href="#cb112-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-475"><a href="#cb112-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-476"><a href="#cb112-476" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing methods</span></span>
<span id="cb112-477"><a href="#cb112-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-480"><a href="#cb112-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-481"><a href="#cb112-481" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-comparison</span></span>
<span id="cb112-482"><a href="#cb112-482" aria-hidden="true" tabindex="-1"></a>methods_comp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb112-483"><a href="#cb112-483" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"FE"</span>, <span class="st">"IFE"</span>, <span class="st">"MC"</span>),</span>
<span id="cb112-484"><a href="#cb112-484" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATT =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">1</span>]), <span class="dv">3</span>),</span>
<span id="cb112-485"><a href="#cb112-485" aria-hidden="true" tabindex="-1"></a>  <span class="at">SE =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">2</span>]), <span class="dv">3</span>),</span>
<span id="cb112-486"><a href="#cb112-486" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_lower =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">3</span>]), <span class="dv">3</span>),</span>
<span id="cb112-487"><a href="#cb112-487" aria-hidden="true" tabindex="-1"></a>  <span class="at">CI_upper =</span> <span class="fu">round</span>(<span class="fu">c</span>(out_fe<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>], out_ife<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>], out_mc<span class="sc">$</span>est.avg[<span class="dv">1</span>, <span class="dv">4</span>]), <span class="dv">3</span>)</span>
<span id="cb112-488"><a href="#cb112-488" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-489"><a href="#cb112-489" aria-hidden="true" tabindex="-1"></a>methods_comp</span>
<span id="cb112-490"><a href="#cb112-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-491"><a href="#cb112-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-492"><a href="#cb112-492" aria-hidden="true" tabindex="-1"></a><span class="fu">### Placebo test for pre-trends</span></span>
<span id="cb112-493"><a href="#cb112-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-494"><a href="#cb112-494" aria-hidden="true" tabindex="-1"></a>The placebo test checks whether there are "treatment effects" in the pre-treatment period---evidence against parallel trends:</span>
<span id="cb112-495"><a href="#cb112-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-498"><a href="#cb112-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-499"><a href="#cb112-499" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-placebo</span></span>
<span id="cb112-500"><a href="#cb112-500" aria-hidden="true" tabindex="-1"></a>out_placebo <span class="ot">&lt;-</span> <span class="fu">fect</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> simdata,</span>
<span id="cb112-501"><a href="#cb112-501" aria-hidden="true" tabindex="-1"></a>                    <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb112-502"><a href="#cb112-502" aria-hidden="true" tabindex="-1"></a>                    <span class="at">method =</span> <span class="st">"fe"</span>, <span class="at">force =</span> <span class="st">"two-way"</span>,</span>
<span id="cb112-503"><a href="#cb112-503" aria-hidden="true" tabindex="-1"></a>                    <span class="at">placeboTest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb112-504"><a href="#cb112-504" aria-hidden="true" tabindex="-1"></a>                    <span class="at">placebo.period =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>),</span>
<span id="cb112-505"><a href="#cb112-505" aria-hidden="true" tabindex="-1"></a>                    <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">nboots =</span> <span class="dv">200</span>,</span>
<span id="cb112-506"><a href="#cb112-506" aria-hidden="true" tabindex="-1"></a>                    <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span>
<span id="cb112-507"><a href="#cb112-507" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_placebo, <span class="at">main =</span> <span class="st">"Placebo test: pre-treatment effects should be zero"</span>)</span>
<span id="cb112-508"><a href="#cb112-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-509"><a href="#cb112-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-510"><a href="#cb112-510" aria-hidden="true" tabindex="-1"></a><span class="fu">### Equivalence test</span></span>
<span id="cb112-511"><a href="#cb112-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-512"><a href="#cb112-512" aria-hidden="true" tabindex="-1"></a>The equivalence test provides a more formal assessment: are pre-treatment ATTs close enough to zero?</span>
<span id="cb112-513"><a href="#cb112-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-516"><a href="#cb112-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-517"><a href="#cb112-517" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fect-equiv</span></span>
<span id="cb112-518"><a href="#cb112-518" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out_fe, <span class="at">type =</span> <span class="st">"equiv"</span>,</span>
<span id="cb112-519"><a href="#cb112-519" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Equivalence test for pre-treatment periods"</span>)</span>
<span id="cb112-520"><a href="#cb112-520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-521"><a href="#cb112-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-522"><a href="#cb112-522" aria-hidden="true" tabindex="-1"></a><span class="fu">## Matrix completion for panel data (conceptual)</span></span>
<span id="cb112-523"><a href="#cb112-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-524"><a href="#cb112-524" aria-hidden="true" tabindex="-1"></a>Athey, Bayati, Doudchenko, Imbens &amp; Khosravi (2021) formalize the connection between DID, synthetic control, and matrix completion. The key insight is that all three are special cases of the same framework, differing in what structure they impose on the matrix of untreated potential outcomes $Y(0)$:</span>
<span id="cb112-525"><a href="#cb112-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-526"><a href="#cb112-526" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Method <span class="pp">|</span> Assumption on $Y(0)$ <span class="pp">|</span> Best when <span class="pp">|</span></span>
<span id="cb112-527"><a href="#cb112-527" aria-hidden="true" tabindex="-1"></a><span class="pp">|--------|---------------------|-----------|</span></span>
<span id="cb112-528"><a href="#cb112-528" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> DID <span class="pp">|</span> Additive: $Y_{it}(0) = \alpha_i + \xi_t$ (rank 1) <span class="pp">|</span> Strong parallel trends <span class="pp">|</span></span>
<span id="cb112-529"><a href="#cb112-529" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Synthetic control <span class="pp">|</span> Hard rank constraint on columns <span class="pp">|</span> Few treated units, many controls <span class="pp">|</span></span>
<span id="cb112-530"><a href="#cb112-530" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Matrix completion <span class="pp">|</span> Soft low-rank via nuclear norm penalty <span class="pp">|</span> General (robust across settings) <span class="pp">|</span></span>
<span id="cb112-531"><a href="#cb112-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-532"><a href="#cb112-532" aria-hidden="true" tabindex="-1"></a>The <span class="in">`MCPanel`</span> package (available from GitHub: <span class="in">`susanathey/MCPanel`</span>) implements nuclear norm minimized matrix completion. The idea is to find a low-rank matrix $L$ plus unit and time effects that best approximate the observed (untreated) entries:</span>
<span id="cb112-533"><a href="#cb112-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-534"><a href="#cb112-534" aria-hidden="true" tabindex="-1"></a>$$\min_{L, \gamma, \delta} \frac{1}{|\mathcal{O}|} \sum_{(i,t) \in \mathcal{O}} (Y_{it} - L_{it} - \gamma_i - \delta_t)^2 + \lambda <span class="sc">\|</span>L<span class="sc">\|</span>_*$$</span>
<span id="cb112-535"><a href="#cb112-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-536"><a href="#cb112-536" aria-hidden="true" tabindex="-1"></a>where $<span class="sc">\|</span>L<span class="sc">\|</span>_*$ is the nuclear norm (sum of singular values) and $\lambda$ is chosen by cross-validation. When $\lambda$ is very large, $L \to 0$ and the method reduces to DID. When $\lambda$ is small, it approximates interactive fixed effects.</span>
<span id="cb112-537"><a href="#cb112-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-538"><a href="#cb112-538" aria-hidden="true" tabindex="-1"></a>We can demonstrate the idea with a simple simulation:</span>
<span id="cb112-539"><a href="#cb112-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-542"><a href="#cb112-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-543"><a href="#cb112-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mc-concept</span></span>
<span id="cb112-544"><a href="#cb112-544" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb112-545"><a href="#cb112-545" aria-hidden="true" tabindex="-1"></a>N_mc <span class="ot">&lt;-</span> <span class="dv">30</span>; T_mc <span class="ot">&lt;-</span> <span class="dv">20</span>; R_true <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb112-546"><a href="#cb112-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-547"><a href="#cb112-547" aria-hidden="true" tabindex="-1"></a><span class="co"># Low-rank structure</span></span>
<span id="cb112-548"><a href="#cb112-548" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N_mc <span class="sc">*</span> R_true), N_mc, R_true)</span>
<span id="cb112-549"><a href="#cb112-549" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(T_mc <span class="sc">*</span> R_true), T_mc, R_true)</span>
<span id="cb112-550"><a href="#cb112-550" aria-hidden="true" tabindex="-1"></a>L_true <span class="ot">&lt;-</span> A <span class="sc">%*%</span> <span class="fu">t</span>(B)</span>
<span id="cb112-551"><a href="#cb112-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-552"><a href="#cb112-552" aria-hidden="true" tabindex="-1"></a><span class="co"># Unit and time effects</span></span>
<span id="cb112-553"><a href="#cb112-553" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N_mc, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb112-554"><a href="#cb112-554" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(T_mc, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb112-555"><a href="#cb112-555" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> L_true <span class="sc">+</span> <span class="fu">outer</span>(gamma, <span class="fu">rep</span>(<span class="dv">1</span>, T_mc)) <span class="sc">+</span> <span class="fu">outer</span>(<span class="fu">rep</span>(<span class="dv">1</span>, N_mc), delta) <span class="sc">+</span></span>
<span id="cb112-556"><a href="#cb112-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N_mc <span class="sc">*</span> T_mc, <span class="at">sd =</span> <span class="fl">0.3</span>), N_mc, T_mc)</span>
<span id="cb112-557"><a href="#cb112-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-558"><a href="#cb112-558" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment: units 1-10 treated from period 15 onward</span></span>
<span id="cb112-559"><a href="#cb112-559" aria-hidden="true" tabindex="-1"></a>tau_true <span class="ot">&lt;-</span> <span class="fl">2.0</span>  <span class="co"># constant treatment effect</span></span>
<span id="cb112-560"><a href="#cb112-560" aria-hidden="true" tabindex="-1"></a>Y_obs <span class="ot">&lt;-</span> Y0</span>
<span id="cb112-561"><a href="#cb112-561" aria-hidden="true" tabindex="-1"></a>Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="ot">&lt;-</span> Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="sc">+</span> tau_true</span>
<span id="cb112-562"><a href="#cb112-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-563"><a href="#cb112-563" aria-hidden="true" tabindex="-1"></a><span class="co"># What DID would estimate</span></span>
<span id="cb112-564"><a href="#cb112-564" aria-hidden="true" tabindex="-1"></a>did_control_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">11</span><span class="sc">:</span>N_mc, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>])</span>
<span id="cb112-565"><a href="#cb112-565" aria-hidden="true" tabindex="-1"></a>did_control_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">11</span><span class="sc">:</span>N_mc, <span class="dv">15</span><span class="sc">:</span>T_mc])</span>
<span id="cb112-566"><a href="#cb112-566" aria-hidden="true" tabindex="-1"></a>did_treat_pre <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>])</span>
<span id="cb112-567"><a href="#cb112-567" aria-hidden="true" tabindex="-1"></a>did_treat_post <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc])</span>
<span id="cb112-568"><a href="#cb112-568" aria-hidden="true" tabindex="-1"></a>did_att <span class="ot">&lt;-</span> (did_treat_post <span class="sc">-</span> did_treat_pre) <span class="sc">-</span> (did_control_post <span class="sc">-</span> did_control_pre)</span>
<span id="cb112-569"><a href="#cb112-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-570"><a href="#cb112-570" aria-hidden="true" tabindex="-1"></a><span class="co"># SVD-based imputation (simplified matrix completion)</span></span>
<span id="cb112-571"><a href="#cb112-571" aria-hidden="true" tabindex="-1"></a><span class="co"># Use control rows + pre-treatment treated rows to impute</span></span>
<span id="cb112-572"><a href="#cb112-572" aria-hidden="true" tabindex="-1"></a>mask <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>, N_mc, T_mc)</span>
<span id="cb112-573"><a href="#cb112-573" aria-hidden="true" tabindex="-1"></a>mask[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># missing = treated</span></span>
<span id="cb112-574"><a href="#cb112-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-575"><a href="#cb112-575" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute using low-rank SVD of observed entries</span></span>
<span id="cb112-576"><a href="#cb112-576" aria-hidden="true" tabindex="-1"></a>Y_masked <span class="ot">&lt;-</span> Y_obs <span class="sc">*</span> mask</span>
<span id="cb112-577"><a href="#cb112-577" aria-hidden="true" tabindex="-1"></a>Y_masked[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb112-578"><a href="#cb112-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-579"><a href="#cb112-579" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple imputation: use SVD on complete rows to predict treated post</span></span>
<span id="cb112-580"><a href="#cb112-580" aria-hidden="true" tabindex="-1"></a>Y_control <span class="ot">&lt;-</span> Y_obs[<span class="dv">11</span><span class="sc">:</span>N_mc, ]</span>
<span id="cb112-581"><a href="#cb112-581" aria-hidden="true" tabindex="-1"></a>svd_control <span class="ot">&lt;-</span> <span class="fu">svd</span>(Y_control)</span>
<span id="cb112-582"><a href="#cb112-582" aria-hidden="true" tabindex="-1"></a><span class="co"># Project treated pre-period onto control space</span></span>
<span id="cb112-583"><a href="#cb112-583" aria-hidden="true" tabindex="-1"></a>Y_treat_pre <span class="ot">&lt;-</span> Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>]</span>
<span id="cb112-584"><a href="#cb112-584" aria-hidden="true" tabindex="-1"></a><span class="co"># Use first R_true factors</span></span>
<span id="cb112-585"><a href="#cb112-585" aria-hidden="true" tabindex="-1"></a>V_pre <span class="ot">&lt;-</span> svd_control<span class="sc">$</span>v[<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>, <span class="dv">1</span><span class="sc">:</span>R_true]</span>
<span id="cb112-586"><a href="#cb112-586" aria-hidden="true" tabindex="-1"></a>V_post <span class="ot">&lt;-</span> svd_control<span class="sc">$</span>v[<span class="dv">15</span><span class="sc">:</span>T_mc, <span class="dv">1</span><span class="sc">:</span>R_true]</span>
<span id="cb112-587"><a href="#cb112-587" aria-hidden="true" tabindex="-1"></a>U_hat <span class="ot">&lt;-</span> Y_treat_pre <span class="sc">%*%</span> V_pre <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(V_pre) <span class="sc">%*%</span> V_pre)</span>
<span id="cb112-588"><a href="#cb112-588" aria-hidden="true" tabindex="-1"></a>Y0_hat_post <span class="ot">&lt;-</span> U_hat <span class="sc">%*%</span> <span class="fu">t</span>(V_post)</span>
<span id="cb112-589"><a href="#cb112-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-590"><a href="#cb112-590" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust for level (add mean)</span></span>
<span id="cb112-591"><a href="#cb112-591" aria-hidden="true" tabindex="-1"></a>mc_att <span class="ot">&lt;-</span> <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">15</span><span class="sc">:</span>T_mc] <span class="sc">-</span> Y0_hat_post) <span class="sc">-</span></span>
<span id="cb112-592"><a href="#cb112-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(Y_obs[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>] <span class="sc">-</span> U_hat <span class="sc">%*%</span> <span class="fu">t</span>(V_pre))</span>
<span id="cb112-593"><a href="#cb112-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-594"><a href="#cb112-594" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"True ATT:     "</span>, tau_true, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-595"><a href="#cb112-595" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DID estimate: "</span>, <span class="fu">round</span>(did_att, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-596"><a href="#cb112-596" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MC estimate:  "</span>, <span class="fu">round</span>(mc_att, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb112-597"><a href="#cb112-597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-598"><a href="#cb112-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-599"><a href="#cb112-599" aria-hidden="true" tabindex="-1"></a>When the data have a low-rank structure that violates simple parallel trends, matrix completion can outperform DID by exploiting the factor structure.</span>
<span id="cb112-600"><a href="#cb112-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-601"><a href="#cb112-601" aria-hidden="true" tabindex="-1"></a><span class="fu">## When to use which method</span></span>
<span id="cb112-602"><a href="#cb112-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-603"><a href="#cb112-603" aria-hidden="true" tabindex="-1"></a>The landscape of DiD and panel methods has expanded. Here is a practical guide:</span>
<span id="cb112-604"><a href="#cb112-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-607"><a href="#cb112-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb112-608"><a href="#cb112-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: method-guide</span></span>
<span id="cb112-609"><a href="#cb112-609" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb112-610"><a href="#cb112-610" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb112-611"><a href="#cb112-611" aria-hidden="true" tabindex="-1"></a><span class="st">Modern DiD / Panel Method Guide:</span></span>
<span id="cb112-612"><a href="#cb112-612" aria-hidden="true" tabindex="-1"></a><span class="st">==================================</span></span>
<span id="cb112-613"><a href="#cb112-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-614"><a href="#cb112-614" aria-hidden="true" tabindex="-1"></a><span class="st">STANDARD PANEL (no staggered treatment):</span></span>
<span id="cb112-615"><a href="#cb112-615" aria-hidden="true" tabindex="-1"></a><span class="st">  - alpha_i correlated with X?</span></span>
<span id="cb112-616"><a href="#cb112-616" aria-hidden="true" tabindex="-1"></a><span class="st">    Yes --&gt; Fixed Effects or CRE (Mundlak)</span></span>
<span id="cb112-617"><a href="#cb112-617" aria-hidden="true" tabindex="-1"></a><span class="st">    No  --&gt; Random Effects (rare in observational data)</span></span>
<span id="cb112-618"><a href="#cb112-618" aria-hidden="true" tabindex="-1"></a><span class="st">  - Lagged dependent variable?</span></span>
<span id="cb112-619"><a href="#cb112-619" aria-hidden="true" tabindex="-1"></a><span class="st">    Yes --&gt; Arellano-Bond or System GMM (see Ch. 12)</span></span>
<span id="cb112-620"><a href="#cb112-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-621"><a href="#cb112-621" aria-hidden="true" tabindex="-1"></a><span class="st">STAGGERED DiD (treatment adopted at different times):</span></span>
<span id="cb112-622"><a href="#cb112-622" aria-hidden="true" tabindex="-1"></a><span class="st">  - Homogeneous treatment effects?</span></span>
<span id="cb112-623"><a href="#cb112-623" aria-hidden="true" tabindex="-1"></a><span class="st">    Yes --&gt; Standard TWFE is fine</span></span>
<span id="cb112-624"><a href="#cb112-624" aria-hidden="true" tabindex="-1"></a><span class="st">    No  --&gt; Use modern methods:</span></span>
<span id="cb112-625"><a href="#cb112-625" aria-hidden="true" tabindex="-1"></a><span class="st">      * Callaway-Sant'Anna (did package):</span></span>
<span id="cb112-626"><a href="#cb112-626" aria-hidden="true" tabindex="-1"></a><span class="st">        - Group-time ATTs, flexible aggregation</span></span>
<span id="cb112-627"><a href="#cb112-627" aria-hidden="true" tabindex="-1"></a><span class="st">        - Supports covariates, doubly robust estimation</span></span>
<span id="cb112-628"><a href="#cb112-628" aria-hidden="true" tabindex="-1"></a><span class="st">        - Requires staggered adoption (no treatment reversal)</span></span>
<span id="cb112-629"><a href="#cb112-629" aria-hidden="true" tabindex="-1"></a><span class="st">      * fect package:</span></span>
<span id="cb112-630"><a href="#cb112-630" aria-hidden="true" tabindex="-1"></a><span class="st">        - FE, IFE, or matrix completion counterfactuals</span></span>
<span id="cb112-631"><a href="#cb112-631" aria-hidden="true" tabindex="-1"></a><span class="st">        - Handles treatment reversal</span></span>
<span id="cb112-632"><a href="#cb112-632" aria-hidden="true" tabindex="-1"></a><span class="st">        - Built-in placebo and equivalence tests</span></span>
<span id="cb112-633"><a href="#cb112-633" aria-hidden="true" tabindex="-1"></a><span class="st">        - Also wraps other methods (CS, Sun-Abraham, etc.)</span></span>
<span id="cb112-634"><a href="#cb112-634" aria-hidden="true" tabindex="-1"></a><span class="st">      * MCPanel:</span></span>
<span id="cb112-635"><a href="#cb112-635" aria-hidden="true" tabindex="-1"></a><span class="st">        - Matrix completion (nuclear norm)</span></span>
<span id="cb112-636"><a href="#cb112-636" aria-hidden="true" tabindex="-1"></a><span class="st">        - Unifies DID, synthetic control, and IFE</span></span>
<span id="cb112-637"><a href="#cb112-637" aria-hidden="true" tabindex="-1"></a><span class="st">        - Best when outcome matrix is approximately low-rank</span></span>
<span id="cb112-638"><a href="#cb112-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-639"><a href="#cb112-639" aria-hidden="true" tabindex="-1"></a><span class="st">DIAGNOSTICS:</span></span>
<span id="cb112-640"><a href="#cb112-640" aria-hidden="true" tabindex="-1"></a><span class="st">  - Always check pre-trends (event study / placebo test)</span></span>
<span id="cb112-641"><a href="#cb112-641" aria-hidden="true" tabindex="-1"></a><span class="st">  - For GMM: Sargan/J-test + AR(2) test</span></span>
<span id="cb112-642"><a href="#cb112-642" aria-hidden="true" tabindex="-1"></a><span class="st">  - For RE: Hausman test (as diagnostic, not decision rule)</span></span>
<span id="cb112-643"><a href="#cb112-643" aria-hidden="true" tabindex="-1"></a><span class="st">  - For CRE: F-test on group means = robust Hausman test</span></span>
<span id="cb112-644"><a href="#cb112-644" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb112-645"><a href="#cb112-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb112-646"><a href="#cb112-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-647"><a href="#cb112-647" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb112-648"><a href="#cb112-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-649"><a href="#cb112-649" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Random effects** assumes $\alpha_i \perp X_{it}$ and applies GLS with the composite error structure. It is more efficient than FE when valid, but inconsistent when violated.</span>
<span id="cb112-650"><a href="#cb112-650" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The Hausman test** compares FE and RE; use it as a diagnostic, not a model-selection tool.</span>
<span id="cb112-651"><a href="#cb112-651" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Correlated random effects (Mundlak)** nests both FE and RE: it recovers FE slopes while also estimating effects of time-invariant variables. The Mundlak test ($\delta = 0$) equals the Hausman test but works with robust SEs.</span>
<span id="cb112-652"><a href="#cb112-652" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**TWFE fails under staggered treatment** with heterogeneous effects due to negative weighting.</span>
<span id="cb112-653"><a href="#cb112-653" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Callaway--Sant'Anna** (<span class="in">`did`</span> package) estimates group-time ATTs and aggregates them into event studies, group-specific effects, or an overall ATT---avoiding the negative weighting problem.</span>
<span id="cb112-654"><a href="#cb112-654" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**fect** provides counterfactual imputation estimators: FE, interactive fixed effects, and matrix completion. It handles treatment reversal and includes built-in diagnostics.</span>
<span id="cb112-655"><a href="#cb112-655" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Matrix completion** (Athey et al.) unifies DID and synthetic control as special cases of nuclear norm minimization, providing a flexible middle ground.</span>
<span id="cb112-656"><a href="#cb112-656" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>All panel estimators connect to the **GMM framework**: FE uses within-group moments, RE adds between-group moments, CRE augments RE to nest FE, and dynamic panels use lagged instruments.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>