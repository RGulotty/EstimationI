<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9. Hypothesis Testing – Estimation I: Computational Companion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-3bbbbd466991e281563892c5dce73c3d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
  MathJax = {
    tex: {
      macros: {
        E: "\\mathbb{E}",
        Var: "\\text{Var}",
        Cov: "\\text{Cov}",
        plim: "\\text{plim}",
        inprob: "\\xrightarrow{p}",
        indist: "\\xrightarrow{d}",
        bhat: "\\hat{\\boldsymbol{\\beta}}",
        N: "\\mathcal{N}",
        tr: "\\text{tr}",
        rank: "\\text{rank}",
        SE: "\\text{SE}",
        diag: "\\text{diag}"
      }
    }
  };
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Estimation I: Computational Companion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-chapters" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Chapters</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-chapters">    
        <li>
    <a class="dropdown-item" href="./ch01-review.html">
 <span class="dropdown-text">1. Probability and Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch02-cef-blp.html">
 <span class="dropdown-text">2. The CEF and Best Linear Predictor</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch03-ols.html">
 <span class="dropdown-text">3. Multivariate OLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch04-sensitivity.html">
 <span class="dropdown-text">4. Sensitivity and Leverage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch05-gls.html">
 <span class="dropdown-text">5. Efficiency and GLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch06-small-sample.html">
 <span class="dropdown-text">6. Small Sample Inference</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch07-probit.html">
 <span class="dropdown-text">7. Probit and MLE</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch08-asymptotics.html">
 <span class="dropdown-text">8. Asymptotics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch09-testing.html">
 <span class="dropdown-text">9. Hypothesis Testing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch10-iv.html">
 <span class="dropdown-text">10. Instrumental Variables and 2SLS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch11-gmm.html">
 <span class="dropdown-text">11. GMM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch12-panel.html">
 <span class="dropdown-text">12. Panel Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ch13-fixed-effects.html">
 <span class="dropdown-text">13. Fixed Effects and Modern DiD</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/UChicago-pol-methods/EstimationI"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#testing-a-single-coefficient" id="toc-testing-a-single-coefficient" class="nav-link active" data-scroll-target="#testing-a-single-coefficient"><span class="header-section-number">1</span> Testing a single coefficient</a>
  <ul class="collapse">
  <li><a href="#testing-against-a-non-zero-value" id="toc-testing-against-a-non-zero-value" class="nav-link" data-scroll-target="#testing-against-a-non-zero-value"><span class="header-section-number">1.1</span> Testing against a non-zero value</a></li>
  </ul></li>
  <li><a href="#testing-multiple-restrictions-the-f-test" id="toc-testing-multiple-restrictions-the-f-test" class="nav-link" data-scroll-target="#testing-multiple-restrictions-the-f-test"><span class="header-section-number">2</span> Testing multiple restrictions: the F-test</a>
  <ul class="collapse">
  <li><a href="#by-hand-comparing-two-regressions" id="toc-by-hand-comparing-two-regressions" class="nav-link" data-scroll-target="#by-hand-comparing-two-regressions"><span class="header-section-number">2.1</span> By hand: comparing two regressions</a></li>
  <li><a href="#the-easy-way-anova-and-linearhypothesis" id="toc-the-easy-way-anova-and-linearhypothesis" class="nav-link" data-scroll-target="#the-easy-way-anova-and-linearhypothesis"><span class="header-section-number">2.2</span> The easy way: <code>anova()</code> and <code>linearHypothesis()</code></a></li>
  <li><a href="#equality-constraints" id="toc-equality-constraints" class="nav-link" data-scroll-target="#equality-constraints"><span class="header-section-number">2.3</span> Equality constraints</a></li>
  </ul></li>
  <li><a href="#the-test-trinity-wald-score-and-f" id="toc-the-test-trinity-wald-score-and-f" class="nav-link" data-scroll-target="#the-test-trinity-wald-score-and-f"><span class="header-section-number">3</span> The test trinity: Wald, Score, and F</a>
  <ul class="collapse">
  <li><a href="#when-do-they-diverge" id="toc-when-do-they-diverge" class="nav-link" data-scroll-target="#when-do-they-diverge"><span class="header-section-number">3.1</span> When do they diverge?</a></li>
  </ul></li>
  <li><a href="#confidence-regions-and-test-inversion" id="toc-confidence-regions-and-test-inversion" class="nav-link" data-scroll-target="#confidence-regions-and-test-inversion"><span class="header-section-number">4</span> Confidence regions and test inversion</a>
  <ul class="collapse">
  <li><a href="#confidence-ellipses-for-two-coefficients" id="toc-confidence-ellipses-for-two-coefficients" class="nav-link" data-scroll-target="#confidence-ellipses-for-two-coefficients"><span class="header-section-number">4.1</span> Confidence ellipses for two coefficients</a></li>
  <li><a href="#test-inversion-for-a-nonlinear-parameter-fiellers-method" id="toc-test-inversion-for-a-nonlinear-parameter-fiellers-method" class="nav-link" data-scroll-target="#test-inversion-for-a-nonlinear-parameter-fiellers-method"><span class="header-section-number">4.2</span> Test inversion for a nonlinear parameter: Fieller’s method</a></li>
  <li><a href="#when-fieller-and-the-delta-method-disagree" id="toc-when-fieller-and-the-delta-method-disagree" class="nav-link" data-scroll-target="#when-fieller-and-the-delta-method-disagree"><span class="header-section-number">4.3</span> When Fieller and the delta method disagree</a></li>
  </ul></li>
  <li><a href="#sec-multiple-testing" id="toc-sec-multiple-testing" class="nav-link" data-scroll-target="#sec-multiple-testing"><span class="header-section-number">5</span> Multiple testing</a>
  <ul class="collapse">
  <li><a href="#simulation-false-discoveries-under-the-null" id="toc-simulation-false-discoveries-under-the-null" class="nav-link" data-scroll-target="#simulation-false-discoveries-under-the-null"><span class="header-section-number">5.1</span> Simulation: false discoveries under the null</a></li>
  <li><a href="#corrections-bonferroni-and-holm" id="toc-corrections-bonferroni-and-holm" class="nav-link" data-scroll-target="#corrections-bonferroni-and-holm"><span class="header-section-number">5.2</span> Corrections: Bonferroni and Holm</a></li>
  <li><a href="#when-to-worry-about-multiple-testing" id="toc-when-to-worry-about-multiple-testing" class="nav-link" data-scroll-target="#when-to-worry-about-multiple-testing"><span class="header-section-number">5.3</span> When to worry about multiple testing</a></li>
  </ul></li>
  <li><a href="#power-can-you-detect-the-effect" id="toc-power-can-you-detect-the-effect" class="nav-link" data-scroll-target="#power-can-you-detect-the-effect"><span class="header-section-number">6</span> Power: can you detect the effect?</a>
  <ul class="collapse">
  <li><a href="#power-curves" id="toc-power-curves" class="nav-link" data-scroll-target="#power-curves"><span class="header-section-number">6.1</span> Power curves</a></li>
  <li><a href="#simulation-observing-power" id="toc-simulation-observing-power" class="nav-link" data-scroll-target="#simulation-observing-power"><span class="header-section-number">6.2</span> Simulation: observing power</a></li>
  <li><a href="#controls-boost-power" id="toc-controls-boost-power" class="nav-link" data-scroll-target="#controls-boost-power"><span class="header-section-number">6.3</span> Controls boost power</a></li>
  <li><a href="#joint-tests-have-less-power" id="toc-joint-tests-have-less-power" class="nav-link" data-scroll-target="#joint-tests-have-less-power"><span class="header-section-number">6.4</span> Joint tests have less power</a></li>
  </ul></li>
  <li><a href="#statistical-vs.-economic-significance" id="toc-statistical-vs.-economic-significance" class="nav-link" data-scroll-target="#statistical-vs.-economic-significance"><span class="header-section-number">7</span> Statistical vs.&nbsp;economic significance</a></li>
  <li><a href="#applied-workflow-the-salary-example" id="toc-applied-workflow-the-salary-example" class="nav-link" data-scroll-target="#applied-workflow-the-salary-example"><span class="header-section-number">8</span> Applied workflow: the salary example</a>
  <ul class="collapse">
  <li><a href="#step-1-fit-and-inspect" id="toc-step-1-fit-and-inspect" class="nav-link" data-scroll-target="#step-1-fit-and-inspect"><span class="header-section-number">8.1</span> Step 1: Fit and inspect</a></li>
  <li><a href="#step-2-key-hypotheses" id="toc-step-2-key-hypotheses" class="nav-link" data-scroll-target="#step-2-key-hypotheses"><span class="header-section-number">8.2</span> Step 2: Key hypotheses</a></li>
  <li><a href="#step-3-confidence-intervals" id="toc-step-3-confidence-intervals" class="nav-link" data-scroll-target="#step-3-confidence-intervals"><span class="header-section-number">8.3</span> Step 3: Confidence intervals</a></li>
  <li><a href="#step-4-multiple-testing-adjustment" id="toc-step-4-multiple-testing-adjustment" class="nav-link" data-scroll-target="#step-4-multiple-testing-adjustment"><span class="header-section-number">8.4</span> Step 4: Multiple testing adjustment</a></li>
  <li><a href="#step-5-power-assessment-for-the-gender-gap" id="toc-step-5-power-assessment-for-the-gender-gap" class="nav-link" data-scroll-target="#step-5-power-assessment-for-the-gender-gap"><span class="header-section-number">8.5</span> Step 5: Power assessment for the gender gap</a></li>
  </ul></li>
  <li><a href="#practical-advice-after-hansen" id="toc-practical-advice-after-hansen" class="nav-link" data-scroll-target="#practical-advice-after-hansen"><span class="header-section-number">9</span> Practical advice (after Hansen)</a></li>
  <li><a href="#connection-to-gmm" id="toc-connection-to-gmm" class="nav-link" data-scroll-target="#connection-to-gmm"><span class="header-section-number">10</span> Connection to GMM</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">9. Hypothesis Testing</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">The F-test, the test trinity, multiple testing, and power</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Chapter 8 gave us sandwich standard errors and bootstrap confidence intervals. This chapter puts them to work: we test hypotheses, build confidence regions, guard against false discoveries, and ask whether our sample is large enough to detect effects we care about.</p>
<p>The emphasis is on <em>doing</em> — running tests in R, interpreting the output correctly, and avoiding common pitfalls. We organize around applied questions:</p>
<ol type="1">
<li><strong>How do I test whether a coefficient is zero?</strong> (t-tests, robust Wald)</li>
<li><strong>How do I test multiple restrictions at once?</strong> (F-test, joint Wald)</li>
<li><strong>When do different tests disagree?</strong> (Wald, Score, F)</li>
<li><strong>How do I get confidence sets for nonlinear parameters?</strong> (test inversion, Fieller)</li>
<li><strong>What if I test many hypotheses?</strong> (Bonferroni, Holm)</li>
<li><strong>How large a sample do I need?</strong> (power analysis)</li>
</ol>
<p>We use the <code>Salaries</code> dataset from <code>carData</code> throughout: salaries of 397 U.S. professors, with rank, discipline, years since PhD, years of service, and sex.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(carData)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Salaries)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="testing-a-single-coefficient" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="testing-a-single-coefficient"><span class="header-section-number">1</span> Testing a single coefficient</h2>
<p>We start with a wage equation and ask: controlling for rank, discipline, and experience, does sex predict salary?</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> rank <span class="sc">+</span> discipline <span class="sc">+</span> yrs.since.phd <span class="sc">+</span> yrs.service <span class="sc">+</span> sex,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> Salaries)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = salary ~ rank + discipline + yrs.since.phd + yrs.service + 
    sex, data = Salaries)

Residuals:
   Min     1Q Median     3Q    Max 
-65248 -13211  -1775  10384  99592 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      65955       4589   14.37  &lt; 2e-16 ***
rankAssocProf    12908       4145    3.11    0.002 ** 
rankProf         45066       4238   10.63  &lt; 2e-16 ***
disciplineB      14418       2343    6.15  1.9e-09 ***
yrs.since.phd      535        241    2.22    0.027 *  
yrs.service       -490        212   -2.31    0.021 *  
sexMale           4784       3859    1.24    0.216    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 22500 on 390 degrees of freedom
Multiple R-squared:  0.455, Adjusted R-squared:  0.446 
F-statistic: 54.2 on 6 and 390 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
<p>The <code>summary()</code> output gives t-statistics and p-values, but these assume homoskedasticity. The robust version uses sandwich standard errors:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(mod, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
t test of coefficients:

              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      65955       2896   22.78  &lt; 2e-16 ***
rankAssocProf    12908       2206    5.85  1.0e-08 ***
rankProf         45066       3285   13.72  &lt; 2e-16 ***
disciplineB      14418       2316    6.22  1.2e-09 ***
yrs.since.phd      535        312    1.71    0.088 .  
yrs.service       -490        307   -1.60    0.111    
sexMale           4784       2396    2.00    0.047 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>These are the same tests, built from the same Wald statistic <span class="math inline">\(W = (\hat{\beta}_j / \widehat{\text{se}}_j)^2\)</span>. The only difference is the denominator. When the two disagree, trust the robust version — it doesn’t assume <span class="math inline">\(\text{Var}(e_i \mid X_i)\)</span> is constant.</p>
<p>You can also use <code>linearHypothesis()</code> for the same test, which makes the Wald structure explicit:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="st">"sexMale = 0"</span>, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
sexMale = 0

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df    F Pr(&gt;F)  
1    391                 
2    390  1 3.99  0.047 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>This tests <span class="math inline">\(H_0: \beta_{\text{Male}} = 0\)</span> against <span class="math inline">\(H_1: \beta_{\text{Male}} \neq 0\)</span> using the robust covariance matrix. The Chisq column is the Wald statistic; divide by 1 (one restriction) and you get the squared t-statistic.</p>
<section id="testing-against-a-non-zero-value" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="testing-against-a-non-zero-value"><span class="header-section-number">1.1</span> Testing against a non-zero value</h3>
<p>Suppose theory predicts a gender gap of $5,000. The null is <span class="math inline">\(H_0: \beta_{\text{Male}} = 5000\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="st">"sexMale = 5000"</span>, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
sexMale = 5000

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df    F Pr(&gt;F)
1    391               
2    390  1 0.01   0.93</code></pre>
</div>
</div>
<p>The test is not significant if the confidence interval from Chapter 8 already contains $5,000. Test and CI carry exactly the same information — they are duals.</p>
</section>
</section>
<section id="testing-multiple-restrictions-the-f-test" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="testing-multiple-restrictions-the-f-test"><span class="header-section-number">2</span> Testing multiple restrictions: the F-test</h2>
<p>Individual t-tests tell you about one coefficient at a time. But sometimes you need a <em>joint</em> test. Does rank matter at all? That means testing two coefficients simultaneously (since rank is a three-level factor with two dummies):</p>
<p><span class="math display">\[H_0: \beta_{\text{AssocProf}} = \beta_{\text{Prof}} = 0\]</span></p>
<section id="by-hand-comparing-two-regressions" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="by-hand-comparing-two-regressions"><span class="header-section-number">2.1</span> By hand: comparing two regressions</h3>
<p>The F-test compares the fit of an <strong>unrestricted</strong> model to a <strong>restricted</strong> model that imposes <span class="math inline">\(H_0\)</span>:</p>
<p><span class="math display">\[F = \frac{(\text{SSE}_R - \text{SSE}_U) / q}{\text{SSE}_U / (n - k)}\]</span></p>
<p>where <span class="math inline">\(q\)</span> is the number of restrictions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Unrestricted model (full)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mod_U <span class="ot">&lt;-</span> mod</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Restricted model: drop rank</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>mod_R <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> discipline <span class="sc">+</span> yrs.since.phd <span class="sc">+</span> yrs.service <span class="sc">+</span> sex,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> Salaries)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Manual F-stat</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>SSE_U <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">resid</span>(mod_U)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>SSE_R <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">resid</span>(mod_R)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">2</span>                              <span class="co"># two restrictions</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nobs</span>(mod_U)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">coef</span>(mod_U))</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>F_stat <span class="ot">&lt;-</span> ((SSE_R <span class="sc">-</span> SSE_U) <span class="sc">/</span> q) <span class="sc">/</span> (SSE_U <span class="sc">/</span> (n <span class="sc">-</span> k))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>p_val  <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pf</span>(F_stat, q, n <span class="sc">-</span> k)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"F ="</span>, <span class="fu">round</span>(F_stat, <span class="dv">2</span>), <span class="st">"  df1 ="</span>, q, <span class="st">"  df2 ="</span>, n <span class="sc">-</span> k,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"  p ="</span>, <span class="fu">format.pval</span>(p_val), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>F = 68.41   df1 = 2   df2 = 390   p = &lt;2e-16 </code></pre>
</div>
</div>
</section>
<section id="the-easy-way-anova-and-linearhypothesis" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="the-easy-way-anova-and-linearhypothesis"><span class="header-section-number">2.2</span> The easy way: <code>anova()</code> and <code>linearHypothesis()</code></h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Nested model comparison</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(mod_R, mod_U)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: salary ~ discipline + yrs.since.phd + yrs.service + sex
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex
  Res.Df      RSS Df Sum of Sq    F Pr(&gt;F)    
1    392 2.68e+11                             
2    390 1.98e+11  2  6.95e+10 68.4 &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Same test via linearHypothesis (with robust SEs)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="fu">c</span>(<span class="st">"rankAssocProf = 0"</span>, <span class="st">"rankProf = 0"</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
rankAssocProf = 0
rankProf = 0

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df   F Pr(&gt;F)    
1    392                  
2    390  2 109 &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Note that <code>anova()</code> uses the classical (homoskedastic) F-test, while <code>linearHypothesis()</code> with a robust <code>vcov.</code> gives the heteroskedasticity-robust Wald test. In this example they agree; with strongly heteroskedastic data they might not.</p>
</section>
<section id="equality-constraints" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="equality-constraints"><span class="header-section-number">2.3</span> Equality constraints</h3>
<p>Does the return to years since PhD equal the return to years of service? This is <span class="math inline">\(H_0: \beta_{\text{yrs.phd}} = \beta_{\text{yrs.service}}\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="st">"yrs.since.phd = yrs.service"</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
yrs.since.phd - yrs.service = 0

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df    F Pr(&gt;F)  
1    391                 
2    390  1 2.92  0.088 .
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>This works because <code>linearHypothesis()</code> can test <em>any</em> linear restriction <span class="math inline">\(\mathbf{R}\boldsymbol{\beta} = \mathbf{r}\)</span>. Under the hood it constructs the restriction matrix <span class="math inline">\(\mathbf{R}\)</span> and computes: <span id="eq-wald"><span class="math display">\[W = (\mathbf{R}\hat{\boldsymbol{\beta}} - \mathbf{r})' [\mathbf{R}\hat{\mathbf{V}}\mathbf{R}']^{-1} (\mathbf{R}\hat{\boldsymbol{\beta}} - \mathbf{r}) \;\xrightarrow{d}\; \chi^2_q \tag{1}\]</span></span></p>
<div id="thm-wald" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (Wald Statistic)</strong></span> For testing <span class="math inline">\(H_0: R\beta = r\)</span>, the Wald statistic is <span class="math inline">\(W = (R\hat\beta - r)'[R\hat{V}R']^{-1}(R\hat\beta - r) \xrightarrow{d} \chi^2_q\)</span> under <span class="math inline">\(H_0\)</span>, where <span class="math inline">\(q\)</span> is the number of restrictions. With robust <span class="math inline">\(\hat{V}\)</span>, the test is valid under heteroskedasticity.</p>
</div>
</section>
</section>
<section id="the-test-trinity-wald-score-and-f" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="the-test-trinity-wald-score-and-f"><span class="header-section-number">3</span> The test trinity: Wald, Score, and F</h2>
<p>Three classical approaches test the same null <span class="math inline">\(H_0: \mathbf{R}\boldsymbol{\beta} = \mathbf{r}\)</span>:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 50%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>Test</th>
<th>Estimates from</th>
<th>Measures</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Wald</strong></td>
<td>Unrestricted model</td>
<td>How far <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> is from <span class="math inline">\(H_0\)</span></td>
</tr>
<tr class="even">
<td><strong>Score (LM)</strong></td>
<td>Restricted model</td>
<td>Whether the objective function wants to move away from <span class="math inline">\(H_0\)</span></td>
</tr>
<tr class="odd">
<td><strong>F / LR</strong></td>
<td>Both models</td>
<td>How much the fit worsens when we impose <span class="math inline">\(H_0\)</span></td>
</tr>
</tbody>
</table>
<p>For linear restrictions in a normal linear model, they are <strong>monotone transformations of each other</strong> and always give the same accept/reject decision. Let’s verify:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Test: rank doesn't matter (q = 2 restrictions)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Wald (homoskedastic, for comparability)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">linearHypothesis</span>(mod_U, <span class="fu">c</span>(<span class="st">"rankAssocProf = 0"</span>, <span class="st">"rankProf = 0"</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>W_stat <span class="ot">&lt;-</span> W<span class="sc">$</span>F[<span class="dv">2</span>] <span class="sc">*</span> q  <span class="co"># linearHypothesis reports F; multiply by q for chi-sq scale</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="do">## F from anova</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>Ftest <span class="ot">&lt;-</span> <span class="fu">anova</span>(mod_R, mod_U)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Score test (LM): use restricted residuals</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="do">## S = n * (1 - SSE_U / SSE_R) under homoskedasticity</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> n <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> SSE_U <span class="sc">/</span> SSE_R)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Wald statistic (chi-sq scale):"</span>, <span class="fu">round</span>(W_stat, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Wald statistic (chi-sq scale): 136.8 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"F statistic (x q):           "</span>, <span class="fu">round</span>(Ftest<span class="sc">$</span>F[<span class="dv">2</span>] <span class="sc">*</span> q, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>F statistic (x q):            136.8 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Score statistic:             "</span>, <span class="fu">round</span>(S, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score statistic:              103.1 </code></pre>
</div>
</div>
<p>The three numbers are close but not identical — they use different variance estimates (unrestricted <span class="math inline">\(s^2\)</span>, restricted <span class="math inline">\(\tilde{\sigma}^2\)</span>, or pooled). Asymptotically they converge. Under normality, we have the <a href="./ch06-small-sample.html#thm-exact-distributions">exact distributions</a> that make the F-test slightly more conservative in finite samples, which is why <code>anova()</code> uses <span class="math inline">\(F_{q, n-k}\)</span> critical values instead of <span class="math inline">\(\chi^2_q / q\)</span>.</p>
<section id="when-do-they-diverge" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="when-do-they-diverge"><span class="header-section-number">3.1</span> When do they diverge?</h3>
<p>For <strong>non-normal</strong> models, the trinity can disagree because the three test statistics are no longer monotone transformations of each other. Here is an example using a joint test in the probit model from Chapter 7:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Mroz)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>probit <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> lwg <span class="sc">+</span> inc,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>), <span class="at">data =</span> Mroz)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Test H0: k5 = 0, k618 = 0 (joint, q = 2)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>probit_r <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp <span class="sc">~</span> age <span class="sc">+</span> wc <span class="sc">+</span> lwg <span class="sc">+</span> inc,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>), <span class="at">data =</span> Mroz)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Wald</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>W_probit <span class="ot">&lt;-</span> <span class="fu">linearHypothesis</span>(probit, <span class="fu">c</span>(<span class="st">"k5 = 0"</span>, <span class="st">"k618 = 0"</span>))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="do">## LR</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>LR <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(<span class="fu">logLik</span>(probit_r) <span class="sc">-</span> <span class="fu">logLik</span>(probit))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Score (Rao)</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>S_probit <span class="ot">&lt;-</span> <span class="fu">anova</span>(probit_r, probit, <span class="at">test =</span> <span class="st">"Rao"</span>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Wald chi-sq: "</span>, <span class="fu">round</span>(W_probit<span class="sc">$</span>Chisq[<span class="dv">2</span>], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Wald chi-sq:  58.45 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"LR chi-sq:   "</span>, <span class="fu">round</span>(LR, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>LR chi-sq:    65.77 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Score chi-sq:"</span>, <span class="fu">round</span>(S_probit<span class="sc">$</span>Rao[<span class="dv">2</span>], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score chi-sq: 65.03 </code></pre>
</div>
</div>
<p>The three statistics differ noticeably: the Wald statistic (58.5) is substantially smaller than the LR (65.8) and Score (65.0). All three reject decisively here, but in borderline cases they could lead to different conclusions. The LR test tends to be the most reliable in nonlinear models because it directly measures the change in the log-likelihood.</p>
</section>
</section>
<section id="confidence-regions-and-test-inversion" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="confidence-regions-and-test-inversion"><span class="header-section-number">4</span> Confidence regions and test inversion</h2>
<p>A 95% confidence interval is the set of values <span class="math inline">\(\theta_0\)</span> that would <em>not be rejected</em> at the 5% level:</p>
<p><span class="math display">\[\hat{C} = \{\theta_0 : |T(\theta_0)| \leq 1.96\}\]</span></p>
<p>This is <strong>test inversion</strong>. For a single linear coefficient, test inversion gives the familiar <span class="math inline">\(\hat{\beta} \pm 1.96 \cdot \widehat{\text{se}}\)</span>. But for <em>nonlinear</em> functions of parameters, test inversion is more reliable than the delta method.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Test Inversion Gives Confidence Sets
</div>
</div>
<div class="callout-body-container callout-body">
<p>A 95% confidence set is exactly the set of parameter values not rejected at the 5% level. For linear parameters, this gives the familiar <span class="math inline">\(\hat\beta \pm 1.96 \cdot \text{SE}\)</span>. For nonlinear functions, Fieller’s method (test inversion over a grid) is more reliable than the delta method.</p>
</div>
</div>
<section id="confidence-ellipses-for-two-coefficients" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="confidence-ellipses-for-two-coefficients"><span class="header-section-number">4.1</span> Confidence ellipses for two coefficients</h3>
<p>For two parameters tested jointly, the confidence region is an <strong>ellipse</strong> — the set of <span class="math inline">\((\beta_1, \beta_2)\)</span> values consistent with the Wald test:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Joint confidence region for the two experience variables</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">confidenceEllipse</span>(mod, <span class="at">which.coef =</span> <span class="fu">c</span>(<span class="st">"yrs.since.phd"</span>, <span class="st">"yrs.service"</span>),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">main =</span> <span class="st">"95% joint confidence region"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlab =</span> <span class="st">"Coefficient on yrs.since.phd"</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylab =</span> <span class="st">"Coefficient on yrs.service"</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">"steelblue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"gray50"</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"gray50"</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Add the 45-degree line for equality</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"coral"</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"95% joint region"</span>, <span class="st">"equality line"</span>),</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">lwd =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">1.5</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch09-testing_files/figure-html/confidence-ellipse-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The dashed lines at zero show the individual null values. The coral line shows where the two coefficients are equal. If the ellipse crosses a line, the corresponding null cannot be rejected.</p>
</section>
<section id="test-inversion-for-a-nonlinear-parameter-fiellers-method" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="test-inversion-for-a-nonlinear-parameter-fiellers-method"><span class="header-section-number">4.2</span> Test inversion for a nonlinear parameter: Fieller’s method</h3>
<p>Suppose we want a confidence interval for the <strong>ratio</strong> <span class="math inline">\(\theta = \beta_{\text{Prof}} / \beta_{\text{AssocProf}}\)</span> — how many times larger is the full professor salary premium than the associate professor premium? The delta method (Chapter 8) gives a quick CI, but it can be unreliable when the denominator is imprecisely estimated.</p>
<p><strong>Fieller’s trick</strong>: rewrite <span class="math inline">\(\theta = \beta_1 / \beta_2\)</span> as the linear restriction <span class="math inline">\(\beta_1 - \theta \beta_2 = 0\)</span>, then <em>invert</em> the Wald test over a grid of <span class="math inline">\(\theta\)</span> values:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Delta method CI for comparison</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(mod, <span class="st">"rankProf / rankAssocProf"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>dm_ci <span class="ot">&lt;-</span> <span class="fu">c</span>(dm<span class="sc">$</span>Estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> dm<span class="sc">$</span>SE, dm<span class="sc">$</span>Estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> dm<span class="sc">$</span>SE)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Grid search: invert the Wald test</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>theta_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>idx_prof <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"rankProf"</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>idx_assoc <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"rankAssocProf"</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>in_CI <span class="ot">&lt;-</span> <span class="fu">sapply</span>(theta_grid, <span class="cf">function</span>(th) {</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  r_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_prof] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_assoc] <span class="ot">&lt;-</span> <span class="sc">-</span>th</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> (<span class="fu">sum</span>(r_vec <span class="sc">*</span> b))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  den <span class="ot">&lt;-</span> <span class="fu">t</span>(r_vec) <span class="sc">%*%</span> V <span class="sc">%*%</span> r_vec</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  num <span class="sc">/</span> den <span class="sc">&lt;=</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>fieller_ci <span class="ot">&lt;-</span> <span class="fu">range</span>(theta_grid[in_CI])</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Point estimate:  "</span>, <span class="fu">round</span>(dm<span class="sc">$</span>Estimate, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Point estimate:   3.491 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Delta method CI: "</span>, <span class="fu">round</span>(dm_ci, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Delta method CI:  2.602 4.381 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fieller CI:      "</span>, <span class="fu">round</span>(fieller_ci, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fieller CI:       2.81 4.79 </code></pre>
</div>
</div>
<p>Here the two CIs are similar because the denominator (<span class="math inline">\(\beta_{\text{AssocProf}}\)</span>) is precisely estimated. The ratio tells us that the full professor premium is about 3.5 times the associate professor premium.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the Wald statistic over theta</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>wald_vals <span class="ot">&lt;-</span> <span class="fu">sapply</span>(theta_grid, <span class="cf">function</span>(th) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  r_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_prof] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_assoc] <span class="ot">&lt;-</span> <span class="sc">-</span>th</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> (<span class="fu">sum</span>(r_vec <span class="sc">*</span> b))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  den <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">t</span>(r_vec) <span class="sc">%*%</span> V <span class="sc">%*%</span> r_vec)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  num <span class="sc">/</span> den</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>df_fieller <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">theta =</span> theta_grid, <span class="at">W =</span> wald_vals)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_fieller, <span class="fu">aes</span>(theta, W)) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">6.5</span>, <span class="at">y =</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">label =</span> <span class="st">"95% critical value"</span>,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Test inversion: Wald statistic as a function of θ₀"</span>,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"The Fieller CI is the set of θ₀ values below the dashed line"</span>,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta[<span class="dv">0</span>] <span class="sc">==</span> beta[Prof] <span class="sc">/</span> beta[AssocProf]),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Wald statistic"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch09-testing_files/figure-html/fieller-plot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="when-fieller-and-the-delta-method-disagree" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="when-fieller-and-the-delta-method-disagree"><span class="header-section-number">4.3</span> When Fieller and the delta method disagree</h3>
<p>The real value of Fieller’s method appears when the <strong>denominator is imprecise</strong>. Consider <span class="math inline">\(\theta = \beta_{\text{yrs.phd}} / \beta_{\text{yrs.service}}\)</span> — the ratio of the two experience coefficients. Both are individually insignificant:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Experience coefficients are imprecise</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"yrs.since.phd: estimate ="</span>, <span class="fu">round</span>(b[<span class="st">"yrs.since.phd"</span>]),</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"  SE ="</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(V[<span class="st">"yrs.since.phd"</span>, <span class="st">"yrs.since.phd"</span>])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>yrs.since.phd: estimate = 535   SE = 312 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"yrs.service:   estimate ="</span>, <span class="fu">round</span>(b[<span class="st">"yrs.service"</span>]),</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"  SE ="</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(V[<span class="st">"yrs.service"</span>, <span class="st">"yrs.service"</span>])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>yrs.service:   estimate = -490   SE = 307 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Delta method gives a finite CI</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>dm2 <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(mod, <span class="st">"yrs.since.phd / yrs.service"</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Delta method CI:"</span>, <span class="fu">round</span>(<span class="fu">c</span>(dm2<span class="sc">$</span>Estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> dm2<span class="sc">$</span>SE,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                                  dm2<span class="sc">$</span>Estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> dm2<span class="sc">$</span>SE), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Delta method CI: -1.75 -0.43 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fieller: check a wide grid</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>theta_wide <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">50</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>idx_phd <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"yrs.since.phd"</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>idx_svc <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"yrs.service"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>in_CI2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(theta_wide, <span class="cf">function</span>(th) {</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  r_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_phd] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_svc] <span class="ot">&lt;-</span> <span class="sc">-</span>th</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> (<span class="fu">sum</span>(r_vec <span class="sc">*</span> b))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  den <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">t</span>(r_vec) <span class="sc">%*%</span> V <span class="sc">%*%</span> r_vec)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  num <span class="sc">/</span> den <span class="sc">&lt;=</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Check if CI covers entire grid (unbounded)</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(in_CI2)) {</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Fieller CI: (-∞, +∞)  [unbounded!]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">any</span>(in_CI2)) {</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Fieller CI:"</span>, <span class="fu">range</span>(theta_wide[in_CI2]), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fieller CI: (-∞, +∞)  [unbounded!]</code></pre>
</div>
</div>
<p>The delta method reports a finite CI of width ~1.3, but the Fieller CI is <strong>unbounded</strong> — the entire real line. This is the correct answer: since <span class="math inline">\(\beta_{\text{yrs.service}}\)</span> is not significantly different from zero, the ratio could be anything. The delta method’s finite interval is overconfident.</p>
</section>
</section>
<section id="sec-multiple-testing" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="sec-multiple-testing"><span class="header-section-number">5</span> Multiple testing</h2>
<p>When you look at many coefficients, some will be “significant” by chance.</p>
<section id="simulation-false-discoveries-under-the-null" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="simulation-false-discoveries-under-the-null"><span class="header-section-number">5.1</span> Simulation: false discoveries under the null</h3>
<p>To make this concrete: generate 20 pure-noise regressors, test each at 5%, and count how many reject:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">303</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>k_noise <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>X_noise <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> k_noise), <span class="at">nrow =</span> n)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X_noise) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, <span class="dv">1</span><span class="sc">:</span>k_noise)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>dat_noise <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Y, X_noise)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>mod_noise <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> ., <span class="at">data =</span> dat_noise)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>pvals <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod_noise)<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]  <span class="co"># drop intercept</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of regressors with p &lt; 0.05:"</span>, <span class="fu">sum</span>(pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>), <span class="st">"out of"</span>, k_noise, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of regressors with p &lt; 0.05: 1 out of 20 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Significant variables:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(pvals[pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>]), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Significant variables: X12 </code></pre>
</div>
</div>
<p>Under the global null, we <em>expect</em> <span class="math inline">\(20 \times 0.05 = 1\)</span> false rejection on average. Repeat this many times to see the problem clearly:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>k_noise <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>false_rejections <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> k_noise), <span class="at">nrow =</span> n)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  pv <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X))<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(pv <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"P(at least one false rejection):"</span>, <span class="fu">mean</span>(false_rejections <span class="sc">&gt;=</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>P(at least one false rejection): 0.6204 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Expected:"</span>, <span class="fu">round</span>(<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.05</span>)<span class="sc">^</span>k_noise, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expected: 0.642 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">rejections =</span> false_rejections), <span class="fu">aes</span>(rejections)) <span class="sc">+</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"False rejections when all 20 nulls are true"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"P(≥1 false rejection) = "</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">round</span>(<span class="fu">mean</span>(false_rejections <span class="sc">&gt;=</span> <span class="dv">1</span>), <span class="dv">3</span>)),</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Number of rejections at α = 0.05"</span>,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Frequency"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch09-testing_files/figure-html/fwer-simulation-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>With 20 tests at 5%, you have about a 64% chance of at least one false rejection. This is the <strong>familywise error rate (FWER)</strong> problem.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Multiple Testing Inflates the Familywise Error Rate
</div>
</div>
<div class="callout-body-container callout-body">
<p>With <span class="math inline">\(k\)</span> independent tests at level <span class="math inline">\(\alpha\)</span>, the probability of at least one false rejection is <span class="math inline">\(1 - (1 - \alpha)^k\)</span>. With 20 tests at 5%, this exceeds 60%. Use Holm’s correction (uniformly more powerful than Bonferroni) to control the FWER.</p>
</div>
</div>
</section>
<section id="corrections-bonferroni-and-holm" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="corrections-bonferroni-and-holm"><span class="header-section-number">5.2</span> Corrections: Bonferroni and Holm</h3>
<p>The <strong>Bonferroni correction</strong> rejects the <span class="math inline">\(j\)</span>th hypothesis only if <span class="math inline">\(p_j &lt; \alpha / k\)</span>. It controls the FWER for any dependence structure:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Back to our salary model</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>pvals_salary <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod)<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>corrections <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw =</span> <span class="fu">round</span>(pvals_salary, <span class="dv">4</span>),</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bonferroni =</span> <span class="fu">round</span>(<span class="fu">p.adjust</span>(pvals_salary, <span class="at">method =</span> <span class="st">"bonferroni"</span>), <span class="dv">4</span>),</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">holm =</span> <span class="fu">round</span>(<span class="fu">p.adjust</span>(pvals_salary, <span class="at">method =</span> <span class="st">"holm"</span>), <span class="dv">4</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>corrections</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 raw bonferroni   holm
rankAssocProf 0.0020     0.0119 0.0079
rankProf      0.0000     0.0000 0.0000
disciplineB   0.0000     0.0000 0.0000
yrs.since.phd 0.0270     0.1619 0.0643
yrs.service   0.0214     0.1286 0.0643
sexMale       0.2158     1.0000 0.2158</code></pre>
</div>
</div>
<p><strong>Holm’s method</strong> is uniformly more powerful than Bonferroni while still controlling the FWER. It works by ordering the p-values from smallest to largest and comparing the <span class="math inline">\(j\)</span>th smallest to <span class="math inline">\(\alpha / (k - j + 1)\)</span>. Use Holm whenever you would use Bonferroni.</p>
</section>
<section id="when-to-worry-about-multiple-testing" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="when-to-worry-about-multiple-testing"><span class="header-section-number">5.3</span> When to worry about multiple testing</h3>
<p>Multiple testing corrections matter when you:</p>
<ul>
<li>Examine many coefficients and report the “most significant”</li>
<li>Try many specifications and present the one that “works”</li>
<li>Test across subgroups (by age, gender, region, …)</li>
<li>Use stepwise selection procedures</li>
</ul>
<p>They matter <em>less</em> when you have a small number of pre-specified hypotheses motivated by theory.</p>
</section>
</section>
<section id="power-can-you-detect-the-effect" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="power-can-you-detect-the-effect"><span class="header-section-number">6</span> Power: can you detect the effect?</h2>
<p>A test’s <strong>power</strong> is the probability it rejects when <span class="math inline">\(H_0\)</span> is false:</p>
<p><span class="math display">\[\text{Power}(\theta) = P[\text{Reject } H_0 \mid \theta \neq \theta_0]\]</span></p>
<p>Power depends on four things: the true effect size, the standard error, the significance level, and the sample size. In OLS, for a two-sided test of <span class="math inline">\(H_0: \beta = 0\)</span>:</p>
<p><span class="math display">\[\delta = \frac{|\beta|}{\text{se}(\hat{\beta})} \approx \frac{|\beta| \cdot \text{sd}(X) \cdot \sqrt{n}}{\sigma_e}\]</span></p>
<p>Power <span class="math inline">\(\approx \Phi(\delta - z_{\alpha/2}) + \Phi(-\delta - z_{\alpha/2})\)</span>, where <span class="math inline">\(\delta\)</span> is the signal-to-noise ratio.</p>
<div id="thm-power" class="theorem">
<p><span class="theorem-title"><strong>Theorem 2 (Power of a Two-Sided Test)</strong></span> For testing <span class="math inline">\(H_0: \beta = 0\)</span> at level <span class="math inline">\(\alpha\)</span>, the power against alternative <span class="math inline">\(\beta \neq 0\)</span> is approximately <span class="math inline">\(\Phi(\delta - z_{\alpha/2}) + \Phi(-\delta - z_{\alpha/2})\)</span>, where <span class="math inline">\(\delta = |\beta|/\text{SE}(\hat\beta)\)</span> is the signal-to-noise ratio.</p>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Power for a two-sided t-test in OLS</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>power_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(effect, sigma_e, sd_x, n, <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> sigma_e <span class="sc">/</span> (sd_x <span class="sc">*</span> <span class="fu">sqrt</span>(n))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">abs</span>(effect) <span class="sc">/</span> se</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pnorm</span>(delta <span class="sc">-</span> z) <span class="sc">+</span> <span class="fu">pnorm</span>(<span class="sc">-</span>delta <span class="sc">-</span> z)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="power-curves" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="power-curves"><span class="header-section-number">6.1</span> Power curves</h3>
<p>How does power vary with sample size and effect size?</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>n_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">20</span>, <span class="dv">500</span>, <span class="at">by =</span> <span class="dv">5</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>effects <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.20</span>, <span class="fl">0.40</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>df_power <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(effects, <span class="cf">function</span>(eff) {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n_seq,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">sapply</span>(n_seq, <span class="cf">function</span>(nn) <span class="fu">power_ols</span>(eff, <span class="at">sigma_e =</span> <span class="dv">1</span>, <span class="at">sd_x =</span> <span class="dv">1</span>, nn)),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect =</span> <span class="fu">paste0</span>(<span class="st">"β = "</span>, eff)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power, <span class="fu">aes</span>(n, power, <span class="at">color =</span> effect)) <span class="sc">+</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.80</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">480</span>, <span class="at">y =</span> <span class="fl">0.82</span>, <span class="at">label =</span> <span class="st">"80% power"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.05</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">480</span>, <span class="at">y =</span> <span class="fl">0.07</span>, <span class="at">label =</span> <span class="st">"α = 0.05"</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power curves for a two-sided OLS t-test"</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"σ_e = 1, sd(X) = 1"</span>,</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Sample size (n)"</span>, <span class="at">y =</span> <span class="st">"Power"</span>, <span class="at">color =</span> <span class="st">"True effect"</span>) <span class="sc">+</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ch09-testing_files/figure-html/power-curves-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Power curves for a two-sided OLS t-test</figcaption>
</figure>
</div>
</div>
</div>
<p>Small effects require enormous samples. With <span class="math inline">\(\beta = 0.10\)</span> and <span class="math inline">\(\sigma_e / \text{sd}(X) = 1\)</span>, you need roughly <span class="math inline">\(n = 800\)</span> for 80% power.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>The 80% Power Rule of Thumb
</div>
</div>
<div class="callout-body-container callout-body">
<p>A study should have at least 80% power to detect the smallest effect of scientific interest. This requires <span class="math inline">\(n \approx 16\sigma_e^2 / (\beta^2 \cdot \text{Var}(X))\)</span> for a two-sided 5% test. Adding relevant controls reduces <span class="math inline">\(\sigma_e\)</span> and boosts power for free.</p>
</div>
</div>
</section>
<section id="simulation-observing-power" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="simulation-observing-power"><span class="header-section-number">6.2</span> Simulation: observing power</h3>
<p>Let’s verify the formula with a Monte Carlo simulation:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>true_beta <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>sigma_e <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>n_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>sim_power <span class="ot">&lt;-</span> <span class="cf">function</span>(n, B) {</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  rejections <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> true_beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> sigma_e)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    pval <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    pval <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(rejections)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> n_vals,</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">simulated =</span> <span class="fu">sapply</span>(n_vals, sim_power, <span class="at">B =</span> B),</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> <span class="fu">sapply</span>(n_vals, <span class="cf">function</span>(nn) <span class="fu">power_ols</span>(true_beta, sigma_e, <span class="dv">1</span>, nn))</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    n simulated formula
1  20    0.2290  0.2687
2  50    0.5575  0.5641
3 100    0.8250  0.8508
4 200    0.9880  0.9888</code></pre>
</div>
</div>
<p>The simulated power matches the formula closely.</p>
</section>
<section id="controls-boost-power" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="controls-boost-power"><span class="header-section-number">6.3</span> Controls boost power</h3>
<p>Adding a relevant control variable reduces <span class="math inline">\(\sigma_e\)</span> without reducing <span class="math inline">\(\text{sd}(X)\)</span>, giving a free power boost:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>beta_x <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>beta_z <span class="ot">&lt;-</span> <span class="fl">1.0</span>  <span class="co"># strong control</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Without control</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>power_no_ctrl <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">replicate</span>(B, {</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n); z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> beta_x <span class="sc">*</span> x <span class="sc">+</span> beta_z <span class="sc">*</span> z <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="do">## With control</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>power_with_ctrl <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">replicate</span>(B, {</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n); z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> beta_x <span class="sc">*</span> x <span class="sc">+</span> beta_z <span class="sc">*</span> z <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Power without control:"</span>, <span class="fu">round</span>(power_no_ctrl, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Power without control: 0.294 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Power with control:   "</span>, <span class="fu">round</span>(power_with_ctrl, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Power with control:    0.5 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Residual SD without z:"</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(beta_z<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Residual SD without z: 1.41 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Residual SD with z:   "</span>, <span class="fu">round</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Residual SD with z:    1 </code></pre>
</div>
</div>
<p>The control cuts the residual standard deviation roughly in half, dramatically increasing power. This is why pre-treatment covariates help in experiments even though they are unnecessary for unbiasedness.</p>
</section>
<section id="joint-tests-have-less-power" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="joint-tests-have-less-power"><span class="header-section-number">6.4</span> Joint tests have less power</h3>
<p>Testing more restrictions simultaneously dilutes power. Fix the total non-centrality parameter and compare:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>lambda_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>df_joint <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="cf">function</span>(q) {</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> lambda_seq,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(<span class="fu">qchisq</span>(<span class="fl">0.95</span>, q), q, <span class="at">ncp =</span> lambda_seq),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="fu">paste0</span>(<span class="st">"q = "</span>, q)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_joint, <span class="fu">aes</span>(lambda, power, <span class="at">color =</span> q)) <span class="sc">+</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.80</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power vs. non-centrality for joint tests"</span>,</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"More restrictions require a larger signal to achieve the same power"</span>,</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"Non-centrality parameter "</span>, lambda)),</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Power"</span>, <span class="at">color =</span> <span class="st">"Restrictions"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch09-testing_files/figure-html/joint-test-power-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A single-coefficient t-test is more powerful than a joint F-test that lumps in other restrictions. Test exactly what you care about.</p>
</section>
</section>
<section id="statistical-vs.-economic-significance" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="statistical-vs.-economic-significance"><span class="header-section-number">7</span> Statistical vs.&nbsp;economic significance</h2>
<p>With a large enough sample, <em>any</em> nonzero coefficient becomes statistically significant. This is test consistency: <span class="math inline">\(P[\text{Reject}] \to 1\)</span> whenever <span class="math inline">\(\beta \neq 0\)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">77</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>true_beta <span class="ot">&lt;-</span> <span class="fl">0.01</span>   <span class="co"># tiny effect</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>n_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">1000</span>, <span class="dv">5000</span>, <span class="dv">20000</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>rejection_rate <span class="ot">&lt;-</span> <span class="fu">sapply</span>(n_vals, <span class="cf">function</span>(nn) {</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">replicate</span>(B, {</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nn)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> true_beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(nn)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>df_consist <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">n =</span> n_vals, <span class="at">rejection_rate =</span> rejection_rate)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_consist, <span class="fu">aes</span>(n, rejection_rate)) <span class="sc">+</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.05</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Test consistency: even β = 0.01 gets rejected eventually"</span>,</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"With enough data, statistical significance is guaranteed for any nonzero effect"</span>,</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Sample size (log scale)"</span>, <span class="at">y =</span> <span class="st">"Rejection rate at α = 0.05"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="ch09-testing_files/figure-html/stat-vs-econ-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>A <span class="math inline">\(p\)</span>-value tells you whether the data are inconsistent with <span class="math inline">\(H_0\)</span>. It tells you nothing about whether the effect is large enough to matter. Always report the <strong>magnitude</strong> alongside the significance.</p>
</section>
<section id="applied-workflow-the-salary-example" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="applied-workflow-the-salary-example"><span class="header-section-number">8</span> Applied workflow: the salary example</h2>
<p>Let’s bring everything together with a thorough analysis of the professor salary data.</p>
<section id="step-1-fit-and-inspect" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="step-1-fit-and-inspect"><span class="header-section-number">8.1</span> Step 1: Fit and inspect</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>mod_full <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> rank <span class="sc">+</span> discipline <span class="sc">+</span> yrs.since.phd <span class="sc">+</span> yrs.service <span class="sc">+</span> sex,</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> Salaries)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(mod_full, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
t test of coefficients:

              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      65955       2896   22.78  &lt; 2e-16 ***
rankAssocProf    12908       2206    5.85  1.0e-08 ***
rankProf         45066       3285   13.72  &lt; 2e-16 ***
disciplineB      14418       2316    6.22  1.2e-09 ***
yrs.since.phd      535        312    1.71    0.088 .  
yrs.service       -490        307   -1.60    0.111    
sexMale           4784       2396    2.00    0.047 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="step-2-key-hypotheses" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="step-2-key-hypotheses"><span class="header-section-number">8.2</span> Step 2: Key hypotheses</h3>
<p><strong>Does rank matter?</strong> (joint test, <span class="math inline">\(q = 2\)</span>)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod_full, <span class="fu">c</span>(<span class="st">"rankAssocProf = 0"</span>, <span class="st">"rankProf = 0"</span>),</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
rankAssocProf = 0
rankProf = 0

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df   F Pr(&gt;F)    
1    392                  
2    390  2 109 &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p><strong>Does discipline matter?</strong> (single restriction)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod_full, <span class="st">"disciplineB = 0"</span>,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
disciplineB = 0

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df    F  Pr(&gt;F)    
1    391                    
2    390  1 38.7 1.2e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p><strong>Are the two experience measures interchangeable?</strong> (<span class="math inline">\(\beta_{\text{phd}} = \beta_{\text{svc}}\)</span>)</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod_full, <span class="st">"yrs.since.phd = yrs.service"</span>,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear hypothesis test:
yrs.since.phd - yrs.service = 0

Model 1: restricted model
Model 2: salary ~ rank + discipline + yrs.since.phd + yrs.service + sex

Note: Coefficient covariance matrix supplied.

  Res.Df Df    F Pr(&gt;F)  
1    391                 
2    390  1 2.92  0.088 .
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="step-3-confidence-intervals" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="step-3-confidence-intervals"><span class="header-section-number">8.3</span> Step 3: Confidence intervals</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Robust CIs</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>ci_robust <span class="ot">&lt;-</span> <span class="fu">coefci</span>(mod_full, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>ci_robust</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 2.5 %  97.5 %
(Intercept)   60261.83 71648.6
rankAssocProf  8571.09 17244.1
rankProf      38607.31 51524.7
disciplineB    9863.61 18971.6
yrs.since.phd   -79.26  1149.4
yrs.service   -1092.74   113.7
sexMale          72.96  9494.0</code></pre>
</div>
</div>
</section>
<section id="step-4-multiple-testing-adjustment" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="step-4-multiple-testing-adjustment"><span class="header-section-number">8.4</span> Step 4: Multiple testing adjustment</h3>
<p>If we’re testing all six regressors simultaneously:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>pvals_all <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(mod_full, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw_p =</span> <span class="fu">round</span>(pvals_all, <span class="dv">4</span>),</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">holm_p =</span> <span class="fu">round</span>(<span class="fu">p.adjust</span>(pvals_all, <span class="at">method =</span> <span class="st">"holm"</span>), <span class="dv">4</span>),</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">significant_raw =</span> <span class="fu">ifelse</span>(pvals_all <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>),</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">significant_holm =</span> <span class="fu">ifelse</span>(<span class="fu">p.adjust</span>(pvals_all, <span class="at">method =</span> <span class="st">"holm"</span>) <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>               raw_p holm_p significant_raw significant_holm
rankAssocProf 0.0000 0.0000               *                *
rankProf      0.0000 0.0000               *                *
disciplineB   0.0000 0.0000               *                *
yrs.since.phd 0.0876 0.1752                                 
yrs.service   0.1114 0.1752                                 
sexMale       0.0466 0.1397               *                 </code></pre>
</div>
</div>
</section>
<section id="step-5-power-assessment-for-the-gender-gap" class="level3" data-number="8.5">
<h3 data-number="8.5" class="anchored" data-anchor-id="step-5-power-assessment-for-the-gender-gap"><span class="header-section-number">8.5</span> Step 5: Power assessment for the gender gap</h3>
<p>Suppose the “true” gender gap is $5,000 (about 5% of mean salary). Could we detect it?</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>sigma_e <span class="ot">&lt;-</span> <span class="fu">sigma</span>(mod_full)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>sd_sex <span class="ot">&lt;-</span> <span class="fu">sd</span>(<span class="fu">as.numeric</span>(Salaries<span class="sc">$</span>sex <span class="sc">==</span> <span class="st">"Male"</span>))</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Salaries)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>power_sex <span class="ot">&lt;-</span> <span class="fu">power_ols</span>(<span class="at">effect =</span> <span class="dv">5000</span>, <span class="at">sigma_e =</span> sigma_e,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sd_x =</span> sd_sex, <span class="at">n =</span> n, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated power to detect a $5,000 gender gap:"</span>, <span class="fu">round</span>(power_sex, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated power to detect a $5,000 gender gap: 0.261 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="do">## What sample size for 80% power?</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>n_needed <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">5000</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>pow_curve <span class="ot">&lt;-</span> <span class="fu">sapply</span>(n_needed, <span class="cf">function</span>(nn)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">power_ols</span>(<span class="dv">5000</span>, sigma_e, sd_sex, nn, <span class="fl">0.05</span>))</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>n80 <span class="ot">&lt;-</span> n_needed[<span class="fu">which</span>(pow_curve <span class="sc">&gt;=</span> <span class="fl">0.80</span>)[<span class="dv">1</span>]]</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size for 80% power:"</span>, n80, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size for 80% power: 1800 </code></pre>
</div>
</div>
</section>
</section>
<section id="practical-advice-after-hansen" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="practical-advice-after-hansen"><span class="header-section-number">9</span> Practical advice (after Hansen)</h2>
<p>A checklist for reporting regression results:</p>
<ol type="1">
<li><p><strong>Report standard errors, not just t-ratios.</strong> Standard errors convey precision; t-statistics reduce everything to a binary yes/no.</p></li>
<li><p><strong>Report p-values, not asterisks.</strong> The difference between <span class="math inline">\(p = 0.049\)</span> and <span class="math inline">\(p = 0.051\)</span> is not meaningful. Stars obscure this.</p></li>
<li><p><strong>Focus on substantive hypotheses.</strong> Don’t mechanically test every coefficient against zero. Test things that answer a scientific question.</p></li>
<li><p><strong>“Fail to reject” <span class="math inline">\(\neq\)</span> “accept.”</strong> Low power can explain non-rejection. Always ask: could we have detected a meaningful effect?</p></li>
<li><p><strong>Statistical significance <span class="math inline">\(\neq\)</span> economic significance.</strong> A tiny but significant coefficient may be policy-irrelevant. A large but insignificant coefficient may reflect low power.</p></li>
<li><p><strong>Use robust inference by default.</strong> There is rarely a good reason to report classical SEs when <span class="math inline">\(n\)</span> is not tiny. Use HC1/HC2 or the bootstrap.</p></li>
<li><p><strong>Account for multiple testing.</strong> If you report the “most significant” result from many tests, apply Holm or Bonferroni corrections.</p></li>
</ol>
</section>
<section id="connection-to-gmm" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="connection-to-gmm"><span class="header-section-number">10</span> Connection to GMM</h2>
<p>The Wald test has a natural GMM interpretation. In GMM, testing <span class="math inline">\(H_0: \mathbf{R}\boldsymbol{\beta} = \mathbf{r}\)</span> is equivalent to testing whether the restricted moment conditions <span class="math inline">\(E[\mathbf{Z}'(Y - \mathbf{X}\boldsymbol{\beta})] = \mathbf{0}\)</span> with <span class="math inline">\(\mathbf{R}\boldsymbol{\beta} = \mathbf{r}\)</span> are compatible with the data. The J-test of overidentifying restrictions, which we’ll meet in Chapter 11, generalizes the F-test to the setting where there are more moment conditions than parameters.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 37%">
<col style="width: 62%">
</colgroup>
<thead>
<tr class="header">
<th>OLS test</th>
<th>GMM counterpart</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>F-test (restricted vs.&nbsp;unrestricted)</td>
<td>Distance test (restricted vs.&nbsp;unrestricted GMM)</td>
</tr>
<tr class="even">
<td>Wald test</td>
<td>Wald test (same formula, different <span class="math inline">\(\hat{\mathbf{V}}\)</span>)</td>
</tr>
<tr class="odd">
<td>Score / LM test</td>
<td>Score test from restricted GMM</td>
</tr>
<tr class="even">
<td>Overall F-statistic</td>
<td>J-test of overidentifying restrictions</td>
</tr>
</tbody>
</table>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/UChicago-pol-methods\.github\.io\/EstimationI\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb87" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "9. Hypothesis Testing"</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "The F-test, the test trinity, multiple testing, and power"</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>Chapter 8 gave us sandwich standard errors and bootstrap confidence intervals. This chapter puts them to work: we test hypotheses, build confidence regions, guard against false discoveries, and ask whether our sample is large enough to detect effects we care about.</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>The emphasis is on *doing* --- running tests in R, interpreting the output correctly, and avoiding common pitfalls. We organize around applied questions:</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**How do I test whether a coefficient is zero?** (t-tests, robust Wald)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**How do I test multiple restrictions at once?** (F-test, joint Wald)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**When do different tests disagree?** (Wald, Score, F)</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**How do I get confidence sets for nonlinear parameters?** (test inversion, Fieller)</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**What if I test many hypotheses?** (Bonferroni, Holm)</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**How large a sample do I need?** (power analysis)</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>We use the <span class="in">`Salaries`</span> dataset from <span class="in">`carData`</span> throughout: salaries of 397 U.S. professors, with rank, discipline, years since PhD, years of service, and sex.</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(carData)</span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits =</span> <span class="dv">4</span>)</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Salaries)</span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a><span class="fu">## Testing a single coefficient</span></span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>We start with a wage equation and ask: controlling for rank, discipline, and experience, does sex predict salary?</span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: base-model</span></span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> rank <span class="sc">+</span> discipline <span class="sc">+</span> yrs.since.phd <span class="sc">+</span> yrs.service <span class="sc">+</span> sex,</span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> Salaries)</span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod)</span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-47"><a href="#cb87-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-48"><a href="#cb87-48" aria-hidden="true" tabindex="-1"></a>The <span class="in">`summary()`</span> output gives t-statistics and p-values, but these assume homoskedasticity. The robust version uses sandwich standard errors:</span>
<span id="cb87-49"><a href="#cb87-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-52"><a href="#cb87-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-53"><a href="#cb87-53" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: robust-t</span></span>
<span id="cb87-54"><a href="#cb87-54" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(mod, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-55"><a href="#cb87-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-56"><a href="#cb87-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-57"><a href="#cb87-57" aria-hidden="true" tabindex="-1"></a>These are the same tests, built from the same Wald statistic $W = (\hat{\beta}_j / \widehat{\text{se}}_j)^2$. The only difference is the denominator. When the two disagree, trust the robust version --- it doesn't assume $\text{Var}(e_i \mid X_i)$ is constant.</span>
<span id="cb87-58"><a href="#cb87-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-59"><a href="#cb87-59" aria-hidden="true" tabindex="-1"></a>You can also use <span class="in">`linearHypothesis()`</span> for the same test, which makes the Wald structure explicit:</span>
<span id="cb87-60"><a href="#cb87-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-63"><a href="#cb87-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-64"><a href="#cb87-64" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: single-linearHypothesis</span></span>
<span id="cb87-65"><a href="#cb87-65" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="st">"sexMale = 0"</span>, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-66"><a href="#cb87-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-67"><a href="#cb87-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-68"><a href="#cb87-68" aria-hidden="true" tabindex="-1"></a>This tests $H_0: \beta_{\text{Male}} = 0$ against $H_1: \beta_{\text{Male}} \neq 0$ using the robust covariance matrix. The Chisq column is the Wald statistic; divide by 1 (one restriction) and you get the squared t-statistic.</span>
<span id="cb87-69"><a href="#cb87-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-70"><a href="#cb87-70" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing against a non-zero value</span></span>
<span id="cb87-71"><a href="#cb87-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-72"><a href="#cb87-72" aria-hidden="true" tabindex="-1"></a>Suppose theory predicts a gender gap of \$5,000. The null is $H_0: \beta_{\text{Male}} = 5000$:</span>
<span id="cb87-73"><a href="#cb87-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-76"><a href="#cb87-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-77"><a href="#cb87-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: test-nonzero</span></span>
<span id="cb87-78"><a href="#cb87-78" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="st">"sexMale = 5000"</span>, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-79"><a href="#cb87-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-80"><a href="#cb87-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-81"><a href="#cb87-81" aria-hidden="true" tabindex="-1"></a>The test is not significant if the confidence interval from Chapter 8 already contains \$5,000. Test and CI carry exactly the same information --- they are duals.</span>
<span id="cb87-82"><a href="#cb87-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-83"><a href="#cb87-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-84"><a href="#cb87-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Testing multiple restrictions: the F-test</span></span>
<span id="cb87-85"><a href="#cb87-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-86"><a href="#cb87-86" aria-hidden="true" tabindex="-1"></a>Individual t-tests tell you about one coefficient at a time. But sometimes you need a *joint* test. Does rank matter at all? That means testing two coefficients simultaneously (since rank is a three-level factor with two dummies):</span>
<span id="cb87-87"><a href="#cb87-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-88"><a href="#cb87-88" aria-hidden="true" tabindex="-1"></a>$$H_0: \beta_{\text{AssocProf}} = \beta_{\text{Prof}} = 0$$</span>
<span id="cb87-89"><a href="#cb87-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-90"><a href="#cb87-90" aria-hidden="true" tabindex="-1"></a><span class="fu">### By hand: comparing two regressions</span></span>
<span id="cb87-91"><a href="#cb87-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-92"><a href="#cb87-92" aria-hidden="true" tabindex="-1"></a>The F-test compares the fit of an **unrestricted** model to a **restricted** model that imposes $H_0$:</span>
<span id="cb87-93"><a href="#cb87-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-94"><a href="#cb87-94" aria-hidden="true" tabindex="-1"></a>$$F = \frac{(\text{SSE}_R - \text{SSE}_U) / q}{\text{SSE}_U / (n - k)}$$</span>
<span id="cb87-95"><a href="#cb87-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-96"><a href="#cb87-96" aria-hidden="true" tabindex="-1"></a>where $q$ is the number of restrictions.</span>
<span id="cb87-97"><a href="#cb87-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-100"><a href="#cb87-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-101"><a href="#cb87-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: f-test-manual</span></span>
<span id="cb87-102"><a href="#cb87-102" aria-hidden="true" tabindex="-1"></a><span class="do">## Unrestricted model (full)</span></span>
<span id="cb87-103"><a href="#cb87-103" aria-hidden="true" tabindex="-1"></a>mod_U <span class="ot">&lt;-</span> mod</span>
<span id="cb87-104"><a href="#cb87-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-105"><a href="#cb87-105" aria-hidden="true" tabindex="-1"></a><span class="do">## Restricted model: drop rank</span></span>
<span id="cb87-106"><a href="#cb87-106" aria-hidden="true" tabindex="-1"></a>mod_R <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> discipline <span class="sc">+</span> yrs.since.phd <span class="sc">+</span> yrs.service <span class="sc">+</span> sex,</span>
<span id="cb87-107"><a href="#cb87-107" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> Salaries)</span>
<span id="cb87-108"><a href="#cb87-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-109"><a href="#cb87-109" aria-hidden="true" tabindex="-1"></a><span class="do">## Manual F-stat</span></span>
<span id="cb87-110"><a href="#cb87-110" aria-hidden="true" tabindex="-1"></a>SSE_U <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">resid</span>(mod_U)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb87-111"><a href="#cb87-111" aria-hidden="true" tabindex="-1"></a>SSE_R <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">resid</span>(mod_R)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb87-112"><a href="#cb87-112" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">2</span>                              <span class="co"># two restrictions</span></span>
<span id="cb87-113"><a href="#cb87-113" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nobs</span>(mod_U)</span>
<span id="cb87-114"><a href="#cb87-114" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">coef</span>(mod_U))</span>
<span id="cb87-115"><a href="#cb87-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-116"><a href="#cb87-116" aria-hidden="true" tabindex="-1"></a>F_stat <span class="ot">&lt;-</span> ((SSE_R <span class="sc">-</span> SSE_U) <span class="sc">/</span> q) <span class="sc">/</span> (SSE_U <span class="sc">/</span> (n <span class="sc">-</span> k))</span>
<span id="cb87-117"><a href="#cb87-117" aria-hidden="true" tabindex="-1"></a>p_val  <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pf</span>(F_stat, q, n <span class="sc">-</span> k)</span>
<span id="cb87-118"><a href="#cb87-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-119"><a href="#cb87-119" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"F ="</span>, <span class="fu">round</span>(F_stat, <span class="dv">2</span>), <span class="st">"  df1 ="</span>, q, <span class="st">"  df2 ="</span>, n <span class="sc">-</span> k,</span>
<span id="cb87-120"><a href="#cb87-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"  p ="</span>, <span class="fu">format.pval</span>(p_val), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-121"><a href="#cb87-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-122"><a href="#cb87-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-123"><a href="#cb87-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### The easy way: `anova()` and `linearHypothesis()`</span></span>
<span id="cb87-124"><a href="#cb87-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-127"><a href="#cb87-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-128"><a href="#cb87-128" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: f-test-anova</span></span>
<span id="cb87-129"><a href="#cb87-129" aria-hidden="true" tabindex="-1"></a><span class="do">## Nested model comparison</span></span>
<span id="cb87-130"><a href="#cb87-130" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(mod_R, mod_U)</span>
<span id="cb87-131"><a href="#cb87-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-132"><a href="#cb87-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-135"><a href="#cb87-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-136"><a href="#cb87-136" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: f-test-linearHypothesis</span></span>
<span id="cb87-137"><a href="#cb87-137" aria-hidden="true" tabindex="-1"></a><span class="do">## Same test via linearHypothesis (with robust SEs)</span></span>
<span id="cb87-138"><a href="#cb87-138" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="fu">c</span>(<span class="st">"rankAssocProf = 0"</span>, <span class="st">"rankProf = 0"</span>),</span>
<span id="cb87-139"><a href="#cb87-139" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-140"><a href="#cb87-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-141"><a href="#cb87-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-142"><a href="#cb87-142" aria-hidden="true" tabindex="-1"></a>Note that <span class="in">`anova()`</span> uses the classical (homoskedastic) F-test, while <span class="in">`linearHypothesis()`</span> with a robust <span class="in">`vcov.`</span> gives the heteroskedasticity-robust Wald test. In this example they agree; with strongly heteroskedastic data they might not.</span>
<span id="cb87-143"><a href="#cb87-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-144"><a href="#cb87-144" aria-hidden="true" tabindex="-1"></a><span class="fu">### Equality constraints</span></span>
<span id="cb87-145"><a href="#cb87-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-146"><a href="#cb87-146" aria-hidden="true" tabindex="-1"></a>Does the return to years since PhD equal the return to years of service? This is $H_0: \beta_{\text{yrs.phd}} = \beta_{\text{yrs.service}}$:</span>
<span id="cb87-147"><a href="#cb87-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-150"><a href="#cb87-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-151"><a href="#cb87-151" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: equality-test</span></span>
<span id="cb87-152"><a href="#cb87-152" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod, <span class="st">"yrs.since.phd = yrs.service"</span>,</span>
<span id="cb87-153"><a href="#cb87-153" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-154"><a href="#cb87-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-155"><a href="#cb87-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-156"><a href="#cb87-156" aria-hidden="true" tabindex="-1"></a>This works because <span class="in">`linearHypothesis()`</span> can test *any* linear restriction $\mathbf{R}\boldsymbol{\beta} = \mathbf{r}$.  Under the hood it constructs the restriction matrix $\mathbf{R}$ and computes:</span>
<span id="cb87-157"><a href="#cb87-157" aria-hidden="true" tabindex="-1"></a>$$W = (\mathbf{R}\hat{\boldsymbol{\beta}} - \mathbf{r})' <span class="co">[</span><span class="ot">\mathbf{R}\hat{\mathbf{V}}\mathbf{R}'</span><span class="co">]</span>^{-1} (\mathbf{R}\hat{\boldsymbol{\beta}} - \mathbf{r}) \;\xrightarrow{d}\; \chi^2_q$$ {#eq-wald}</span>
<span id="cb87-158"><a href="#cb87-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-159"><a href="#cb87-159" aria-hidden="true" tabindex="-1"></a>::: {#thm-wald}</span>
<span id="cb87-160"><a href="#cb87-160" aria-hidden="true" tabindex="-1"></a><span class="fu">## Wald Statistic</span></span>
<span id="cb87-161"><a href="#cb87-161" aria-hidden="true" tabindex="-1"></a>For testing $H_0: R\beta = r$, the Wald statistic is $W = (R\hat\beta - r)'<span class="co">[</span><span class="ot">R\hat{V}R'</span><span class="co">]</span>^{-1}(R\hat\beta - r) \xrightarrow{d} \chi^2_q$ under $H_0$, where $q$ is the number of restrictions. With robust $\hat{V}$, the test is valid under heteroskedasticity.</span>
<span id="cb87-162"><a href="#cb87-162" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb87-163"><a href="#cb87-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-164"><a href="#cb87-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-165"><a href="#cb87-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## The test trinity: Wald, Score, and F</span></span>
<span id="cb87-166"><a href="#cb87-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-167"><a href="#cb87-167" aria-hidden="true" tabindex="-1"></a>Three classical approaches test the same null $H_0: \mathbf{R}\boldsymbol{\beta} = \mathbf{r}$:</span>
<span id="cb87-168"><a href="#cb87-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-169"><a href="#cb87-169" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Test <span class="pp">|</span> Estimates from <span class="pp">|</span> Measures <span class="pp">|</span></span>
<span id="cb87-170"><a href="#cb87-170" aria-hidden="true" tabindex="-1"></a><span class="pp">|------|----------------|----------|</span></span>
<span id="cb87-171"><a href="#cb87-171" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Wald** <span class="pp">|</span> Unrestricted model <span class="pp">|</span> How far $\hat{\boldsymbol{\beta}}$ is from $H_0$ <span class="pp">|</span></span>
<span id="cb87-172"><a href="#cb87-172" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Score (LM)** <span class="pp">|</span> Restricted model <span class="pp">|</span> Whether the objective function wants to move away from $H_0$ <span class="pp">|</span></span>
<span id="cb87-173"><a href="#cb87-173" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **F / LR** <span class="pp">|</span> Both models <span class="pp">|</span> How much the fit worsens when we impose $H_0$ <span class="pp">|</span></span>
<span id="cb87-174"><a href="#cb87-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-175"><a href="#cb87-175" aria-hidden="true" tabindex="-1"></a>For linear restrictions in a normal linear model, they are **monotone transformations of each other** and always give the same accept/reject decision.  Let's verify:</span>
<span id="cb87-176"><a href="#cb87-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-179"><a href="#cb87-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-180"><a href="#cb87-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: trinity-comparison</span></span>
<span id="cb87-181"><a href="#cb87-181" aria-hidden="true" tabindex="-1"></a><span class="do">## Test: rank doesn't matter (q = 2 restrictions)</span></span>
<span id="cb87-182"><a href="#cb87-182" aria-hidden="true" tabindex="-1"></a><span class="do">## Wald (homoskedastic, for comparability)</span></span>
<span id="cb87-183"><a href="#cb87-183" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">linearHypothesis</span>(mod_U, <span class="fu">c</span>(<span class="st">"rankAssocProf = 0"</span>, <span class="st">"rankProf = 0"</span>))</span>
<span id="cb87-184"><a href="#cb87-184" aria-hidden="true" tabindex="-1"></a>W_stat <span class="ot">&lt;-</span> W<span class="sc">$</span>F[<span class="dv">2</span>] <span class="sc">*</span> q  <span class="co"># linearHypothesis reports F; multiply by q for chi-sq scale</span></span>
<span id="cb87-185"><a href="#cb87-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-186"><a href="#cb87-186" aria-hidden="true" tabindex="-1"></a><span class="do">## F from anova</span></span>
<span id="cb87-187"><a href="#cb87-187" aria-hidden="true" tabindex="-1"></a>Ftest <span class="ot">&lt;-</span> <span class="fu">anova</span>(mod_R, mod_U)</span>
<span id="cb87-188"><a href="#cb87-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-189"><a href="#cb87-189" aria-hidden="true" tabindex="-1"></a><span class="do">## Score test (LM): use restricted residuals</span></span>
<span id="cb87-190"><a href="#cb87-190" aria-hidden="true" tabindex="-1"></a><span class="do">## S = n * (1 - SSE_U / SSE_R) under homoskedasticity</span></span>
<span id="cb87-191"><a href="#cb87-191" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> n <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> SSE_U <span class="sc">/</span> SSE_R)</span>
<span id="cb87-192"><a href="#cb87-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-193"><a href="#cb87-193" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Wald statistic (chi-sq scale):"</span>, <span class="fu">round</span>(W_stat, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-194"><a href="#cb87-194" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"F statistic (x q):           "</span>, <span class="fu">round</span>(Ftest<span class="sc">$</span>F[<span class="dv">2</span>] <span class="sc">*</span> q, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-195"><a href="#cb87-195" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Score statistic:             "</span>, <span class="fu">round</span>(S, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-196"><a href="#cb87-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-197"><a href="#cb87-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-198"><a href="#cb87-198" aria-hidden="true" tabindex="-1"></a>The three numbers are close but not identical --- they use different variance estimates (unrestricted $s^2$, restricted $\tilde{\sigma}^2$, or pooled). Asymptotically they converge. Under normality, we have the <span class="co">[</span><span class="ot">exact distributions</span><span class="co">](ch06-small-sample.qmd#thm-exact-distributions)</span> that make the F-test slightly more conservative in finite samples, which is why <span class="in">`anova()`</span> uses $F_{q, n-k}$ critical values instead of $\chi^2_q / q$.</span>
<span id="cb87-199"><a href="#cb87-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-200"><a href="#cb87-200" aria-hidden="true" tabindex="-1"></a><span class="fu">### When do they diverge?</span></span>
<span id="cb87-201"><a href="#cb87-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-202"><a href="#cb87-202" aria-hidden="true" tabindex="-1"></a>For **non-normal** models, the trinity can disagree because the three test statistics are no longer monotone transformations of each other. Here is an example using a joint test in the probit model from Chapter 7:</span>
<span id="cb87-203"><a href="#cb87-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-206"><a href="#cb87-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-207"><a href="#cb87-207" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: trinity-probit</span></span>
<span id="cb87-208"><a href="#cb87-208" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Mroz)</span>
<span id="cb87-209"><a href="#cb87-209" aria-hidden="true" tabindex="-1"></a>probit <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp <span class="sc">~</span> k5 <span class="sc">+</span> k618 <span class="sc">+</span> age <span class="sc">+</span> wc <span class="sc">+</span> lwg <span class="sc">+</span> inc,</span>
<span id="cb87-210"><a href="#cb87-210" aria-hidden="true" tabindex="-1"></a>              <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>), <span class="at">data =</span> Mroz)</span>
<span id="cb87-211"><a href="#cb87-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-212"><a href="#cb87-212" aria-hidden="true" tabindex="-1"></a><span class="do">## Test H0: k5 = 0, k618 = 0 (joint, q = 2)</span></span>
<span id="cb87-213"><a href="#cb87-213" aria-hidden="true" tabindex="-1"></a>probit_r <span class="ot">&lt;-</span> <span class="fu">glm</span>(lfp <span class="sc">~</span> age <span class="sc">+</span> wc <span class="sc">+</span> lwg <span class="sc">+</span> inc,</span>
<span id="cb87-214"><a href="#cb87-214" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>), <span class="at">data =</span> Mroz)</span>
<span id="cb87-215"><a href="#cb87-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-216"><a href="#cb87-216" aria-hidden="true" tabindex="-1"></a><span class="do">## Wald</span></span>
<span id="cb87-217"><a href="#cb87-217" aria-hidden="true" tabindex="-1"></a>W_probit <span class="ot">&lt;-</span> <span class="fu">linearHypothesis</span>(probit, <span class="fu">c</span>(<span class="st">"k5 = 0"</span>, <span class="st">"k618 = 0"</span>))</span>
<span id="cb87-218"><a href="#cb87-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-219"><a href="#cb87-219" aria-hidden="true" tabindex="-1"></a><span class="do">## LR</span></span>
<span id="cb87-220"><a href="#cb87-220" aria-hidden="true" tabindex="-1"></a>LR <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(<span class="fu">logLik</span>(probit_r) <span class="sc">-</span> <span class="fu">logLik</span>(probit))</span>
<span id="cb87-221"><a href="#cb87-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-222"><a href="#cb87-222" aria-hidden="true" tabindex="-1"></a><span class="do">## Score (Rao)</span></span>
<span id="cb87-223"><a href="#cb87-223" aria-hidden="true" tabindex="-1"></a>S_probit <span class="ot">&lt;-</span> <span class="fu">anova</span>(probit_r, probit, <span class="at">test =</span> <span class="st">"Rao"</span>)</span>
<span id="cb87-224"><a href="#cb87-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-225"><a href="#cb87-225" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Wald chi-sq: "</span>, <span class="fu">round</span>(W_probit<span class="sc">$</span>Chisq[<span class="dv">2</span>], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-226"><a href="#cb87-226" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"LR chi-sq:   "</span>, <span class="fu">round</span>(LR, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-227"><a href="#cb87-227" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Score chi-sq:"</span>, <span class="fu">round</span>(S_probit<span class="sc">$</span>Rao[<span class="dv">2</span>], <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-228"><a href="#cb87-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-229"><a href="#cb87-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-230"><a href="#cb87-230" aria-hidden="true" tabindex="-1"></a>The three statistics differ noticeably: the Wald statistic (58.5) is substantially smaller than the LR (65.8) and Score (65.0). All three reject decisively here, but in borderline cases they could lead to different conclusions. The LR test tends to be the most reliable in nonlinear models because it directly measures the change in the log-likelihood.</span>
<span id="cb87-231"><a href="#cb87-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-232"><a href="#cb87-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-233"><a href="#cb87-233" aria-hidden="true" tabindex="-1"></a><span class="fu">## Confidence regions and test inversion</span></span>
<span id="cb87-234"><a href="#cb87-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-235"><a href="#cb87-235" aria-hidden="true" tabindex="-1"></a>A 95% confidence interval is the set of values $\theta_0$ that would *not be rejected* at the 5% level:</span>
<span id="cb87-236"><a href="#cb87-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-237"><a href="#cb87-237" aria-hidden="true" tabindex="-1"></a>$$\hat{C} = <span class="sc">\{</span>\theta_0 : |T(\theta_0)| \leq 1.96<span class="sc">\}</span>$$</span>
<span id="cb87-238"><a href="#cb87-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-239"><a href="#cb87-239" aria-hidden="true" tabindex="-1"></a>This is **test inversion**. For a single linear coefficient, test inversion gives the familiar $\hat{\beta} \pm 1.96 \cdot \widehat{\text{se}}$. But for *nonlinear* functions of parameters, test inversion is more reliable than the delta method.</span>
<span id="cb87-240"><a href="#cb87-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-241"><a href="#cb87-241" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb87-242"><a href="#cb87-242" aria-hidden="true" tabindex="-1"></a><span class="fu">## Test Inversion Gives Confidence Sets</span></span>
<span id="cb87-243"><a href="#cb87-243" aria-hidden="true" tabindex="-1"></a>A 95% confidence set is exactly the set of parameter values not rejected at the 5% level. For linear parameters, this gives the familiar $\hat\beta \pm 1.96 \cdot \text{SE}$. For nonlinear functions, Fieller's method (test inversion over a grid) is more reliable than the delta method.</span>
<span id="cb87-244"><a href="#cb87-244" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb87-245"><a href="#cb87-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-246"><a href="#cb87-246" aria-hidden="true" tabindex="-1"></a><span class="fu">### Confidence ellipses for two coefficients</span></span>
<span id="cb87-247"><a href="#cb87-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-248"><a href="#cb87-248" aria-hidden="true" tabindex="-1"></a>For two parameters tested jointly, the confidence region is an **ellipse** --- the set of $(\beta_1, \beta_2)$ values consistent with the Wald test:</span>
<span id="cb87-249"><a href="#cb87-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-252"><a href="#cb87-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-253"><a href="#cb87-253" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: confidence-ellipse</span></span>
<span id="cb87-254"><a href="#cb87-254" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb87-255"><a href="#cb87-255" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5.5</span></span>
<span id="cb87-256"><a href="#cb87-256" aria-hidden="true" tabindex="-1"></a><span class="do">## Joint confidence region for the two experience variables</span></span>
<span id="cb87-257"><a href="#cb87-257" aria-hidden="true" tabindex="-1"></a><span class="fu">confidenceEllipse</span>(mod, <span class="at">which.coef =</span> <span class="fu">c</span>(<span class="st">"yrs.since.phd"</span>, <span class="st">"yrs.service"</span>),</span>
<span id="cb87-258"><a href="#cb87-258" aria-hidden="true" tabindex="-1"></a>                  <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>),</span>
<span id="cb87-259"><a href="#cb87-259" aria-hidden="true" tabindex="-1"></a>                  <span class="at">main =</span> <span class="st">"95% joint confidence region"</span>,</span>
<span id="cb87-260"><a href="#cb87-260" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlab =</span> <span class="st">"Coefficient on yrs.since.phd"</span>,</span>
<span id="cb87-261"><a href="#cb87-261" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ylab =</span> <span class="st">"Coefficient on yrs.service"</span>,</span>
<span id="cb87-262"><a href="#cb87-262" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="st">"steelblue"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb87-263"><a href="#cb87-263" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"gray50"</span>)</span>
<span id="cb87-264"><a href="#cb87-264" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"gray50"</span>)</span>
<span id="cb87-265"><a href="#cb87-265" aria-hidden="true" tabindex="-1"></a><span class="do">## Add the 45-degree line for equality</span></span>
<span id="cb87-266"><a href="#cb87-266" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">"coral"</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span>
<span id="cb87-267"><a href="#cb87-267" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"95% joint region"</span>, <span class="st">"equality line"</span>),</span>
<span id="cb87-268"><a href="#cb87-268" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"coral"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="at">lwd =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">1.5</span>))</span>
<span id="cb87-269"><a href="#cb87-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-270"><a href="#cb87-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-271"><a href="#cb87-271" aria-hidden="true" tabindex="-1"></a>The dashed lines at zero show the individual null values. The coral line shows where the two coefficients are equal. If the ellipse crosses a line, the corresponding null cannot be rejected.</span>
<span id="cb87-272"><a href="#cb87-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-273"><a href="#cb87-273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Test inversion for a nonlinear parameter: Fieller's method</span></span>
<span id="cb87-274"><a href="#cb87-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-275"><a href="#cb87-275" aria-hidden="true" tabindex="-1"></a>Suppose we want a confidence interval for the **ratio** $\theta = \beta_{\text{Prof}} / \beta_{\text{AssocProf}}$ --- how many times larger is the full professor salary premium than the associate professor premium? The delta method (Chapter 8) gives a quick CI, but it can be unreliable when the denominator is imprecisely estimated.</span>
<span id="cb87-276"><a href="#cb87-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-277"><a href="#cb87-277" aria-hidden="true" tabindex="-1"></a>**Fieller's trick**: rewrite $\theta = \beta_1 / \beta_2$ as the linear restriction $\beta_1 - \theta \beta_2 = 0$, then *invert* the Wald test over a grid of $\theta$ values:</span>
<span id="cb87-278"><a href="#cb87-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-281"><a href="#cb87-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-282"><a href="#cb87-282" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fieller-inversion</span></span>
<span id="cb87-283"><a href="#cb87-283" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod)</span>
<span id="cb87-284"><a href="#cb87-284" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>)</span>
<span id="cb87-285"><a href="#cb87-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-286"><a href="#cb87-286" aria-hidden="true" tabindex="-1"></a><span class="do">## Delta method CI for comparison</span></span>
<span id="cb87-287"><a href="#cb87-287" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(mod, <span class="st">"rankProf / rankAssocProf"</span>,</span>
<span id="cb87-288"><a href="#cb87-288" aria-hidden="true" tabindex="-1"></a>                  <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-289"><a href="#cb87-289" aria-hidden="true" tabindex="-1"></a>dm_ci <span class="ot">&lt;-</span> <span class="fu">c</span>(dm<span class="sc">$</span>Estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> dm<span class="sc">$</span>SE, dm<span class="sc">$</span>Estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> dm<span class="sc">$</span>SE)</span>
<span id="cb87-290"><a href="#cb87-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-291"><a href="#cb87-291" aria-hidden="true" tabindex="-1"></a><span class="do">## Grid search: invert the Wald test</span></span>
<span id="cb87-292"><a href="#cb87-292" aria-hidden="true" tabindex="-1"></a>theta_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="at">by =</span> <span class="fl">0.01</span>)</span>
<span id="cb87-293"><a href="#cb87-293" aria-hidden="true" tabindex="-1"></a>idx_prof <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"rankProf"</span>)</span>
<span id="cb87-294"><a href="#cb87-294" aria-hidden="true" tabindex="-1"></a>idx_assoc <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"rankAssocProf"</span>)</span>
<span id="cb87-295"><a href="#cb87-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-296"><a href="#cb87-296" aria-hidden="true" tabindex="-1"></a>in_CI <span class="ot">&lt;-</span> <span class="fu">sapply</span>(theta_grid, <span class="cf">function</span>(th) {</span>
<span id="cb87-297"><a href="#cb87-297" aria-hidden="true" tabindex="-1"></a>  r_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b))</span>
<span id="cb87-298"><a href="#cb87-298" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_prof] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-299"><a href="#cb87-299" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_assoc] <span class="ot">&lt;-</span> <span class="sc">-</span>th</span>
<span id="cb87-300"><a href="#cb87-300" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> (<span class="fu">sum</span>(r_vec <span class="sc">*</span> b))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb87-301"><a href="#cb87-301" aria-hidden="true" tabindex="-1"></a>  den <span class="ot">&lt;-</span> <span class="fu">t</span>(r_vec) <span class="sc">%*%</span> V <span class="sc">%*%</span> r_vec</span>
<span id="cb87-302"><a href="#cb87-302" aria-hidden="true" tabindex="-1"></a>  num <span class="sc">/</span> den <span class="sc">&lt;=</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>)</span>
<span id="cb87-303"><a href="#cb87-303" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-304"><a href="#cb87-304" aria-hidden="true" tabindex="-1"></a>fieller_ci <span class="ot">&lt;-</span> <span class="fu">range</span>(theta_grid[in_CI])</span>
<span id="cb87-305"><a href="#cb87-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-306"><a href="#cb87-306" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Point estimate:  "</span>, <span class="fu">round</span>(dm<span class="sc">$</span>Estimate, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-307"><a href="#cb87-307" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Delta method CI: "</span>, <span class="fu">round</span>(dm_ci, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-308"><a href="#cb87-308" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Fieller CI:      "</span>, <span class="fu">round</span>(fieller_ci, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-309"><a href="#cb87-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-310"><a href="#cb87-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-311"><a href="#cb87-311" aria-hidden="true" tabindex="-1"></a>Here the two CIs are similar because the denominator ($\beta_{\text{AssocProf}}$) is precisely estimated. The ratio tells us that the full professor premium is about 3.5 times the associate professor premium.</span>
<span id="cb87-312"><a href="#cb87-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-315"><a href="#cb87-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-316"><a href="#cb87-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fieller-plot</span></span>
<span id="cb87-317"><a href="#cb87-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb87-318"><a href="#cb87-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3.5</span></span>
<span id="cb87-319"><a href="#cb87-319" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot the Wald statistic over theta</span></span>
<span id="cb87-320"><a href="#cb87-320" aria-hidden="true" tabindex="-1"></a>wald_vals <span class="ot">&lt;-</span> <span class="fu">sapply</span>(theta_grid, <span class="cf">function</span>(th) {</span>
<span id="cb87-321"><a href="#cb87-321" aria-hidden="true" tabindex="-1"></a>  r_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b))</span>
<span id="cb87-322"><a href="#cb87-322" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_prof] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-323"><a href="#cb87-323" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_assoc] <span class="ot">&lt;-</span> <span class="sc">-</span>th</span>
<span id="cb87-324"><a href="#cb87-324" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> (<span class="fu">sum</span>(r_vec <span class="sc">*</span> b))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb87-325"><a href="#cb87-325" aria-hidden="true" tabindex="-1"></a>  den <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">t</span>(r_vec) <span class="sc">%*%</span> V <span class="sc">%*%</span> r_vec)</span>
<span id="cb87-326"><a href="#cb87-326" aria-hidden="true" tabindex="-1"></a>  num <span class="sc">/</span> den</span>
<span id="cb87-327"><a href="#cb87-327" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-328"><a href="#cb87-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-329"><a href="#cb87-329" aria-hidden="true" tabindex="-1"></a>df_fieller <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">theta =</span> theta_grid, <span class="at">W =</span> wald_vals)</span>
<span id="cb87-330"><a href="#cb87-330" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_fieller, <span class="fu">aes</span>(theta, W)) <span class="sc">+</span></span>
<span id="cb87-331"><a href="#cb87-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb87-332"><a href="#cb87-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb87-333"><a href="#cb87-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">6.5</span>, <span class="at">y =</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">label =</span> <span class="st">"95% critical value"</span>,</span>
<span id="cb87-334"><a href="#cb87-334" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb87-335"><a href="#cb87-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb87-336"><a href="#cb87-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Test inversion: Wald statistic as a function of θ₀"</span>,</span>
<span id="cb87-337"><a href="#cb87-337" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"The Fieller CI is the set of θ₀ values below the dashed line"</span>,</span>
<span id="cb87-338"><a href="#cb87-338" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(theta[<span class="dv">0</span>] <span class="sc">==</span> beta[Prof] <span class="sc">/</span> beta[AssocProf]),</span>
<span id="cb87-339"><a href="#cb87-339" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Wald statistic"</span>)</span>
<span id="cb87-340"><a href="#cb87-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-341"><a href="#cb87-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-342"><a href="#cb87-342" aria-hidden="true" tabindex="-1"></a><span class="fu">### When Fieller and the delta method disagree</span></span>
<span id="cb87-343"><a href="#cb87-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-344"><a href="#cb87-344" aria-hidden="true" tabindex="-1"></a>The real value of Fieller's method appears when the **denominator is imprecise**. Consider $\theta = \beta_{\text{yrs.phd}} / \beta_{\text{yrs.service}}$ --- the ratio of the two experience coefficients. Both are individually insignificant:</span>
<span id="cb87-345"><a href="#cb87-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-348"><a href="#cb87-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-349"><a href="#cb87-349" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fieller-unbounded</span></span>
<span id="cb87-350"><a href="#cb87-350" aria-hidden="true" tabindex="-1"></a><span class="do">## Experience coefficients are imprecise</span></span>
<span id="cb87-351"><a href="#cb87-351" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"yrs.since.phd: estimate ="</span>, <span class="fu">round</span>(b[<span class="st">"yrs.since.phd"</span>]),</span>
<span id="cb87-352"><a href="#cb87-352" aria-hidden="true" tabindex="-1"></a>    <span class="st">"  SE ="</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(V[<span class="st">"yrs.since.phd"</span>, <span class="st">"yrs.since.phd"</span>])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-353"><a href="#cb87-353" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"yrs.service:   estimate ="</span>, <span class="fu">round</span>(b[<span class="st">"yrs.service"</span>]),</span>
<span id="cb87-354"><a href="#cb87-354" aria-hidden="true" tabindex="-1"></a>    <span class="st">"  SE ="</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(V[<span class="st">"yrs.service"</span>, <span class="st">"yrs.service"</span>])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-355"><a href="#cb87-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-356"><a href="#cb87-356" aria-hidden="true" tabindex="-1"></a><span class="do">## Delta method gives a finite CI</span></span>
<span id="cb87-357"><a href="#cb87-357" aria-hidden="true" tabindex="-1"></a>dm2 <span class="ot">&lt;-</span> <span class="fu">deltaMethod</span>(mod, <span class="st">"yrs.since.phd / yrs.service"</span>,</span>
<span id="cb87-358"><a href="#cb87-358" aria-hidden="true" tabindex="-1"></a>                   <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-359"><a href="#cb87-359" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Delta method CI:"</span>, <span class="fu">round</span>(<span class="fu">c</span>(dm2<span class="sc">$</span>Estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> dm2<span class="sc">$</span>SE,</span>
<span id="cb87-360"><a href="#cb87-360" aria-hidden="true" tabindex="-1"></a>                                  dm2<span class="sc">$</span>Estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> dm2<span class="sc">$</span>SE), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-361"><a href="#cb87-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-362"><a href="#cb87-362" aria-hidden="true" tabindex="-1"></a><span class="do">## Fieller: check a wide grid</span></span>
<span id="cb87-363"><a href="#cb87-363" aria-hidden="true" tabindex="-1"></a>theta_wide <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">50</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb87-364"><a href="#cb87-364" aria-hidden="true" tabindex="-1"></a>idx_phd <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"yrs.since.phd"</span>)</span>
<span id="cb87-365"><a href="#cb87-365" aria-hidden="true" tabindex="-1"></a>idx_svc <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(b) <span class="sc">==</span> <span class="st">"yrs.service"</span>)</span>
<span id="cb87-366"><a href="#cb87-366" aria-hidden="true" tabindex="-1"></a>in_CI2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(theta_wide, <span class="cf">function</span>(th) {</span>
<span id="cb87-367"><a href="#cb87-367" aria-hidden="true" tabindex="-1"></a>  r_vec <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(b))</span>
<span id="cb87-368"><a href="#cb87-368" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_phd] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-369"><a href="#cb87-369" aria-hidden="true" tabindex="-1"></a>  r_vec[idx_svc] <span class="ot">&lt;-</span> <span class="sc">-</span>th</span>
<span id="cb87-370"><a href="#cb87-370" aria-hidden="true" tabindex="-1"></a>  num <span class="ot">&lt;-</span> (<span class="fu">sum</span>(r_vec <span class="sc">*</span> b))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb87-371"><a href="#cb87-371" aria-hidden="true" tabindex="-1"></a>  den <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">t</span>(r_vec) <span class="sc">%*%</span> V <span class="sc">%*%</span> r_vec)</span>
<span id="cb87-372"><a href="#cb87-372" aria-hidden="true" tabindex="-1"></a>  num <span class="sc">/</span> den <span class="sc">&lt;=</span> <span class="fu">qchisq</span>(<span class="fl">0.95</span>, <span class="dv">1</span>)</span>
<span id="cb87-373"><a href="#cb87-373" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-374"><a href="#cb87-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-375"><a href="#cb87-375" aria-hidden="true" tabindex="-1"></a><span class="do">## Check if CI covers entire grid (unbounded)</span></span>
<span id="cb87-376"><a href="#cb87-376" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(in_CI2)) {</span>
<span id="cb87-377"><a href="#cb87-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Fieller CI: (-∞, +∞)  [unbounded!]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-378"><a href="#cb87-378" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">any</span>(in_CI2)) {</span>
<span id="cb87-379"><a href="#cb87-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Fieller CI:"</span>, <span class="fu">range</span>(theta_wide[in_CI2]), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-380"><a href="#cb87-380" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-381"><a href="#cb87-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-382"><a href="#cb87-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-383"><a href="#cb87-383" aria-hidden="true" tabindex="-1"></a>The delta method reports a finite CI of width ~1.3, but the Fieller CI is **unbounded** --- the entire real line. This is the correct answer: since $\beta_{\text{yrs.service}}$ is not significantly different from zero, the ratio could be anything. The delta method's finite interval is overconfident.</span>
<span id="cb87-384"><a href="#cb87-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-385"><a href="#cb87-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-386"><a href="#cb87-386" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multiple testing {#sec-multiple-testing}</span></span>
<span id="cb87-387"><a href="#cb87-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-388"><a href="#cb87-388" aria-hidden="true" tabindex="-1"></a>When you look at many coefficients, some will be "significant" by chance.</span>
<span id="cb87-389"><a href="#cb87-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-390"><a href="#cb87-390" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulation: false discoveries under the null</span></span>
<span id="cb87-391"><a href="#cb87-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-392"><a href="#cb87-392" aria-hidden="true" tabindex="-1"></a>To make this concrete: generate 20 pure-noise regressors, test each at 5%, and count how many reject:</span>
<span id="cb87-393"><a href="#cb87-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-396"><a href="#cb87-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-397"><a href="#cb87-397" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multiple-testing-sim</span></span>
<span id="cb87-398"><a href="#cb87-398" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">303</span>)</span>
<span id="cb87-399"><a href="#cb87-399" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb87-400"><a href="#cb87-400" aria-hidden="true" tabindex="-1"></a>k_noise <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb87-401"><a href="#cb87-401" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-402"><a href="#cb87-402" aria-hidden="true" tabindex="-1"></a>X_noise <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> k_noise), <span class="at">nrow =</span> n)</span>
<span id="cb87-403"><a href="#cb87-403" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X_noise) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"X"</span>, <span class="dv">1</span><span class="sc">:</span>k_noise)</span>
<span id="cb87-404"><a href="#cb87-404" aria-hidden="true" tabindex="-1"></a>dat_noise <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(Y, X_noise)</span>
<span id="cb87-405"><a href="#cb87-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-406"><a href="#cb87-406" aria-hidden="true" tabindex="-1"></a>mod_noise <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> ., <span class="at">data =</span> dat_noise)</span>
<span id="cb87-407"><a href="#cb87-407" aria-hidden="true" tabindex="-1"></a>pvals <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod_noise)<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]  <span class="co"># drop intercept</span></span>
<span id="cb87-408"><a href="#cb87-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-409"><a href="#cb87-409" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of regressors with p &lt; 0.05:"</span>, <span class="fu">sum</span>(pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>), <span class="st">"out of"</span>, k_noise, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-410"><a href="#cb87-410" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Significant variables:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(pvals[pvals <span class="sc">&lt;</span> <span class="fl">0.05</span>]), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-411"><a href="#cb87-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-412"><a href="#cb87-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-413"><a href="#cb87-413" aria-hidden="true" tabindex="-1"></a>Under the global null, we *expect* $20 \times 0.05 = 1$ false rejection on average. Repeat this many times to see the problem clearly:</span>
<span id="cb87-414"><a href="#cb87-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-417"><a href="#cb87-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-418"><a href="#cb87-418" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fwer-simulation</span></span>
<span id="cb87-419"><a href="#cb87-419" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb87-420"><a href="#cb87-420" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb87-421"><a href="#cb87-421" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb87-422"><a href="#cb87-422" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb87-423"><a href="#cb87-423" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb87-424"><a href="#cb87-424" aria-hidden="true" tabindex="-1"></a>k_noise <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb87-425"><a href="#cb87-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-426"><a href="#cb87-426" aria-hidden="true" tabindex="-1"></a>false_rejections <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb87-427"><a href="#cb87-427" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-428"><a href="#cb87-428" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> k_noise), <span class="at">nrow =</span> n)</span>
<span id="cb87-429"><a href="#cb87-429" aria-hidden="true" tabindex="-1"></a>  pv <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(Y <span class="sc">~</span> X))<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb87-430"><a href="#cb87-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(pv <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb87-431"><a href="#cb87-431" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-432"><a href="#cb87-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-433"><a href="#cb87-433" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"P(at least one false rejection):"</span>, <span class="fu">mean</span>(false_rejections <span class="sc">&gt;=</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-434"><a href="#cb87-434" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Expected:"</span>, <span class="fu">round</span>(<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.05</span>)<span class="sc">^</span>k_noise, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-435"><a href="#cb87-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-436"><a href="#cb87-436" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">rejections =</span> false_rejections), <span class="fu">aes</span>(rejections)) <span class="sc">+</span></span>
<span id="cb87-437"><a href="#cb87-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb87-438"><a href="#cb87-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb87-439"><a href="#cb87-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"False rejections when all 20 nulls are true"</span>,</span>
<span id="cb87-440"><a href="#cb87-440" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"P(≥1 false rejection) = "</span>,</span>
<span id="cb87-441"><a href="#cb87-441" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">round</span>(<span class="fu">mean</span>(false_rejections <span class="sc">&gt;=</span> <span class="dv">1</span>), <span class="dv">3</span>)),</span>
<span id="cb87-442"><a href="#cb87-442" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Number of rejections at α = 0.05"</span>,</span>
<span id="cb87-443"><a href="#cb87-443" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Frequency"</span>)</span>
<span id="cb87-444"><a href="#cb87-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-445"><a href="#cb87-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-446"><a href="#cb87-446" aria-hidden="true" tabindex="-1"></a>With 20 tests at 5%, you have about a <span class="in">`r round(100 * (1 - (1 - 0.05)^20))`</span>% chance of at least one false rejection. This is the **familywise error rate (FWER)** problem.</span>
<span id="cb87-447"><a href="#cb87-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-448"><a href="#cb87-448" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb87-449"><a href="#cb87-449" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multiple Testing Inflates the Familywise Error Rate</span></span>
<span id="cb87-450"><a href="#cb87-450" aria-hidden="true" tabindex="-1"></a>With $k$ independent tests at level $\alpha$, the probability of at least one false rejection is $1 - (1 - \alpha)^k$. With 20 tests at 5%, this exceeds 60%. Use Holm's correction (uniformly more powerful than Bonferroni) to control the FWER.</span>
<span id="cb87-451"><a href="#cb87-451" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb87-452"><a href="#cb87-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-453"><a href="#cb87-453" aria-hidden="true" tabindex="-1"></a><span class="fu">### Corrections: Bonferroni and Holm</span></span>
<span id="cb87-454"><a href="#cb87-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-455"><a href="#cb87-455" aria-hidden="true" tabindex="-1"></a>The **Bonferroni correction** rejects the $j$th hypothesis only if $p_j &lt; \alpha / k$. It controls the FWER for any dependence structure:</span>
<span id="cb87-456"><a href="#cb87-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-459"><a href="#cb87-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-460"><a href="#cb87-460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bonferroni-holm</span></span>
<span id="cb87-461"><a href="#cb87-461" aria-hidden="true" tabindex="-1"></a><span class="do">## Back to our salary model</span></span>
<span id="cb87-462"><a href="#cb87-462" aria-hidden="true" tabindex="-1"></a>pvals_salary <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod)<span class="sc">$</span>coefficients[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb87-463"><a href="#cb87-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-464"><a href="#cb87-464" aria-hidden="true" tabindex="-1"></a>corrections <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb87-465"><a href="#cb87-465" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw =</span> <span class="fu">round</span>(pvals_salary, <span class="dv">4</span>),</span>
<span id="cb87-466"><a href="#cb87-466" aria-hidden="true" tabindex="-1"></a>  <span class="at">bonferroni =</span> <span class="fu">round</span>(<span class="fu">p.adjust</span>(pvals_salary, <span class="at">method =</span> <span class="st">"bonferroni"</span>), <span class="dv">4</span>),</span>
<span id="cb87-467"><a href="#cb87-467" aria-hidden="true" tabindex="-1"></a>  <span class="at">holm =</span> <span class="fu">round</span>(<span class="fu">p.adjust</span>(pvals_salary, <span class="at">method =</span> <span class="st">"holm"</span>), <span class="dv">4</span>)</span>
<span id="cb87-468"><a href="#cb87-468" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-469"><a href="#cb87-469" aria-hidden="true" tabindex="-1"></a>corrections</span>
<span id="cb87-470"><a href="#cb87-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-471"><a href="#cb87-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-472"><a href="#cb87-472" aria-hidden="true" tabindex="-1"></a>**Holm's method** is uniformly more powerful than Bonferroni while still controlling the FWER. It works by ordering the p-values from smallest to largest and comparing the $j$th smallest to $\alpha / (k - j + 1)$. Use Holm whenever you would use Bonferroni.</span>
<span id="cb87-473"><a href="#cb87-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-474"><a href="#cb87-474" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to worry about multiple testing</span></span>
<span id="cb87-475"><a href="#cb87-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-476"><a href="#cb87-476" aria-hidden="true" tabindex="-1"></a>Multiple testing corrections matter when you:</span>
<span id="cb87-477"><a href="#cb87-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-478"><a href="#cb87-478" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Examine many coefficients and report the "most significant"</span>
<span id="cb87-479"><a href="#cb87-479" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Try many specifications and present the one that "works"</span>
<span id="cb87-480"><a href="#cb87-480" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Test across subgroups (by age, gender, region, ...)</span>
<span id="cb87-481"><a href="#cb87-481" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use stepwise selection procedures</span>
<span id="cb87-482"><a href="#cb87-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-483"><a href="#cb87-483" aria-hidden="true" tabindex="-1"></a>They matter *less* when you have a small number of pre-specified hypotheses motivated by theory.</span>
<span id="cb87-484"><a href="#cb87-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-485"><a href="#cb87-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-486"><a href="#cb87-486" aria-hidden="true" tabindex="-1"></a><span class="fu">## Power: can you detect the effect?</span></span>
<span id="cb87-487"><a href="#cb87-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-488"><a href="#cb87-488" aria-hidden="true" tabindex="-1"></a>A test's **power** is the probability it rejects when $H_0$ is false:</span>
<span id="cb87-489"><a href="#cb87-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-490"><a href="#cb87-490" aria-hidden="true" tabindex="-1"></a>$$\text{Power}(\theta) = P<span class="co">[</span><span class="ot">\text{Reject } H_0 \mid \theta \neq \theta_0</span><span class="co">]</span>$$</span>
<span id="cb87-491"><a href="#cb87-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-492"><a href="#cb87-492" aria-hidden="true" tabindex="-1"></a>Power depends on four things: the true effect size, the standard error, the significance level, and the sample size. In OLS, for a two-sided test of $H_0: \beta = 0$:</span>
<span id="cb87-493"><a href="#cb87-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-494"><a href="#cb87-494" aria-hidden="true" tabindex="-1"></a>$$\delta = \frac{|\beta|}{\text{se}(\hat{\beta})} \approx \frac{|\beta| \cdot \text{sd}(X) \cdot \sqrt{n}}{\sigma_e}$$</span>
<span id="cb87-495"><a href="#cb87-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-496"><a href="#cb87-496" aria-hidden="true" tabindex="-1"></a>Power $\approx \Phi(\delta - z_{\alpha/2}) + \Phi(-\delta - z_{\alpha/2})$, where $\delta$ is the signal-to-noise ratio.</span>
<span id="cb87-497"><a href="#cb87-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-498"><a href="#cb87-498" aria-hidden="true" tabindex="-1"></a>::: {#thm-power}</span>
<span id="cb87-499"><a href="#cb87-499" aria-hidden="true" tabindex="-1"></a><span class="fu">## Power of a Two-Sided Test</span></span>
<span id="cb87-500"><a href="#cb87-500" aria-hidden="true" tabindex="-1"></a>For testing $H_0: \beta = 0$ at level $\alpha$, the power against alternative $\beta \neq 0$ is approximately $\Phi(\delta - z_{\alpha/2}) + \Phi(-\delta - z_{\alpha/2})$, where $\delta = |\beta|/\text{SE}(\hat\beta)$ is the signal-to-noise ratio.</span>
<span id="cb87-501"><a href="#cb87-501" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb87-502"><a href="#cb87-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-505"><a href="#cb87-505" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-506"><a href="#cb87-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: power-function</span></span>
<span id="cb87-507"><a href="#cb87-507" aria-hidden="true" tabindex="-1"></a><span class="do">## Power for a two-sided t-test in OLS</span></span>
<span id="cb87-508"><a href="#cb87-508" aria-hidden="true" tabindex="-1"></a>power_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(effect, sigma_e, sd_x, n, <span class="at">alpha =</span> <span class="fl">0.05</span>) {</span>
<span id="cb87-509"><a href="#cb87-509" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> sigma_e <span class="sc">/</span> (sd_x <span class="sc">*</span> <span class="fu">sqrt</span>(n))</span>
<span id="cb87-510"><a href="#cb87-510" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">abs</span>(effect) <span class="sc">/</span> se</span>
<span id="cb87-511"><a href="#cb87-511" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="dv">1</span> <span class="sc">-</span> alpha <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb87-512"><a href="#cb87-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pnorm</span>(delta <span class="sc">-</span> z) <span class="sc">+</span> <span class="fu">pnorm</span>(<span class="sc">-</span>delta <span class="sc">-</span> z)</span>
<span id="cb87-513"><a href="#cb87-513" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-514"><a href="#cb87-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-515"><a href="#cb87-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-516"><a href="#cb87-516" aria-hidden="true" tabindex="-1"></a><span class="fu">### Power curves</span></span>
<span id="cb87-517"><a href="#cb87-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-518"><a href="#cb87-518" aria-hidden="true" tabindex="-1"></a>How does power vary with sample size and effect size?</span>
<span id="cb87-519"><a href="#cb87-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-522"><a href="#cb87-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-523"><a href="#cb87-523" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: power-curves</span></span>
<span id="cb87-524"><a href="#cb87-524" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Power curves for a two-sided OLS t-test"</span></span>
<span id="cb87-525"><a href="#cb87-525" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb87-526"><a href="#cb87-526" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb87-527"><a href="#cb87-527" aria-hidden="true" tabindex="-1"></a>n_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">20</span>, <span class="dv">500</span>, <span class="at">by =</span> <span class="dv">5</span>)</span>
<span id="cb87-528"><a href="#cb87-528" aria-hidden="true" tabindex="-1"></a>effects <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.20</span>, <span class="fl">0.40</span>)</span>
<span id="cb87-529"><a href="#cb87-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-530"><a href="#cb87-530" aria-hidden="true" tabindex="-1"></a>df_power <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(effects, <span class="cf">function</span>(eff) {</span>
<span id="cb87-531"><a href="#cb87-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb87-532"><a href="#cb87-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> n_seq,</span>
<span id="cb87-533"><a href="#cb87-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> <span class="fu">sapply</span>(n_seq, <span class="cf">function</span>(nn) <span class="fu">power_ols</span>(eff, <span class="at">sigma_e =</span> <span class="dv">1</span>, <span class="at">sd_x =</span> <span class="dv">1</span>, nn)),</span>
<span id="cb87-534"><a href="#cb87-534" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect =</span> <span class="fu">paste0</span>(<span class="st">"β = "</span>, eff)</span>
<span id="cb87-535"><a href="#cb87-535" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb87-536"><a href="#cb87-536" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb87-537"><a href="#cb87-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-538"><a href="#cb87-538" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_power, <span class="fu">aes</span>(n, power, <span class="at">color =</span> effect)) <span class="sc">+</span></span>
<span id="cb87-539"><a href="#cb87-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb87-540"><a href="#cb87-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.80</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb87-541"><a href="#cb87-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">480</span>, <span class="at">y =</span> <span class="fl">0.82</span>, <span class="at">label =</span> <span class="st">"80% power"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb87-542"><a href="#cb87-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.05</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb87-543"><a href="#cb87-543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">480</span>, <span class="at">y =</span> <span class="fl">0.07</span>, <span class="at">label =</span> <span class="st">"α = 0.05"</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb87-544"><a href="#cb87-544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb87-545"><a href="#cb87-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power curves for a two-sided OLS t-test"</span>,</span>
<span id="cb87-546"><a href="#cb87-546" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"σ_e = 1, sd(X) = 1"</span>,</span>
<span id="cb87-547"><a href="#cb87-547" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Sample size (n)"</span>, <span class="at">y =</span> <span class="st">"Power"</span>, <span class="at">color =</span> <span class="st">"True effect"</span>) <span class="sc">+</span></span>
<span id="cb87-548"><a href="#cb87-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb87-549"><a href="#cb87-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-550"><a href="#cb87-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-551"><a href="#cb87-551" aria-hidden="true" tabindex="-1"></a>Small effects require enormous samples. With $\beta = 0.10$ and $\sigma_e / \text{sd}(X) = 1$, you need roughly $n = 800$ for 80% power.</span>
<span id="cb87-552"><a href="#cb87-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-553"><a href="#cb87-553" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb87-554"><a href="#cb87-554" aria-hidden="true" tabindex="-1"></a><span class="fu">## The 80% Power Rule of Thumb</span></span>
<span id="cb87-555"><a href="#cb87-555" aria-hidden="true" tabindex="-1"></a>A study should have at least 80% power to detect the smallest effect of scientific interest. This requires $n \approx 16\sigma_e^2 / (\beta^2 \cdot \text{Var}(X))$ for a two-sided 5% test. Adding relevant controls reduces $\sigma_e$ and boosts power for free.</span>
<span id="cb87-556"><a href="#cb87-556" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb87-557"><a href="#cb87-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-558"><a href="#cb87-558" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulation: observing power</span></span>
<span id="cb87-559"><a href="#cb87-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-560"><a href="#cb87-560" aria-hidden="true" tabindex="-1"></a>Let's verify the formula with a Monte Carlo simulation:</span>
<span id="cb87-561"><a href="#cb87-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-564"><a href="#cb87-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-565"><a href="#cb87-565" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: power-simulation</span></span>
<span id="cb87-566"><a href="#cb87-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb87-567"><a href="#cb87-567" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb87-568"><a href="#cb87-568" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12</span>)</span>
<span id="cb87-569"><a href="#cb87-569" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb87-570"><a href="#cb87-570" aria-hidden="true" tabindex="-1"></a>true_beta <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb87-571"><a href="#cb87-571" aria-hidden="true" tabindex="-1"></a>sigma_e <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-572"><a href="#cb87-572" aria-hidden="true" tabindex="-1"></a>n_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>)</span>
<span id="cb87-573"><a href="#cb87-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-574"><a href="#cb87-574" aria-hidden="true" tabindex="-1"></a>sim_power <span class="ot">&lt;-</span> <span class="cf">function</span>(n, B) {</span>
<span id="cb87-575"><a href="#cb87-575" aria-hidden="true" tabindex="-1"></a>  rejections <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B, {</span>
<span id="cb87-576"><a href="#cb87-576" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-577"><a href="#cb87-577" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> true_beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> sigma_e)</span>
<span id="cb87-578"><a href="#cb87-578" aria-hidden="true" tabindex="-1"></a>    pval <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb87-579"><a href="#cb87-579" aria-hidden="true" tabindex="-1"></a>    pval <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb87-580"><a href="#cb87-580" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb87-581"><a href="#cb87-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(rejections)</span>
<span id="cb87-582"><a href="#cb87-582" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-583"><a href="#cb87-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-584"><a href="#cb87-584" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb87-585"><a href="#cb87-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> n_vals,</span>
<span id="cb87-586"><a href="#cb87-586" aria-hidden="true" tabindex="-1"></a>  <span class="at">simulated =</span> <span class="fu">sapply</span>(n_vals, sim_power, <span class="at">B =</span> B),</span>
<span id="cb87-587"><a href="#cb87-587" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> <span class="fu">sapply</span>(n_vals, <span class="cf">function</span>(nn) <span class="fu">power_ols</span>(true_beta, sigma_e, <span class="dv">1</span>, nn))</span>
<span id="cb87-588"><a href="#cb87-588" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-589"><a href="#cb87-589" aria-hidden="true" tabindex="-1"></a>results</span>
<span id="cb87-590"><a href="#cb87-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-591"><a href="#cb87-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-592"><a href="#cb87-592" aria-hidden="true" tabindex="-1"></a>The simulated power matches the formula closely.</span>
<span id="cb87-593"><a href="#cb87-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-594"><a href="#cb87-594" aria-hidden="true" tabindex="-1"></a><span class="fu">### Controls boost power</span></span>
<span id="cb87-595"><a href="#cb87-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-596"><a href="#cb87-596" aria-hidden="true" tabindex="-1"></a>Adding a relevant control variable reduces $\sigma_e$ without reducing $\text{sd}(X)$, giving a free power boost:</span>
<span id="cb87-597"><a href="#cb87-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-600"><a href="#cb87-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-601"><a href="#cb87-601" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: controls-power</span></span>
<span id="cb87-602"><a href="#cb87-602" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">99</span>)</span>
<span id="cb87-603"><a href="#cb87-603" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb87-604"><a href="#cb87-604" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb87-605"><a href="#cb87-605" aria-hidden="true" tabindex="-1"></a>beta_x <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb87-606"><a href="#cb87-606" aria-hidden="true" tabindex="-1"></a>beta_z <span class="ot">&lt;-</span> <span class="fl">1.0</span>  <span class="co"># strong control</span></span>
<span id="cb87-607"><a href="#cb87-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-608"><a href="#cb87-608" aria-hidden="true" tabindex="-1"></a><span class="do">## Without control</span></span>
<span id="cb87-609"><a href="#cb87-609" aria-hidden="true" tabindex="-1"></a>power_no_ctrl <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">replicate</span>(B, {</span>
<span id="cb87-610"><a href="#cb87-610" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n); z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-611"><a href="#cb87-611" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> beta_x <span class="sc">*</span> x <span class="sc">+</span> beta_z <span class="sc">*</span> z <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-612"><a href="#cb87-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb87-613"><a href="#cb87-613" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb87-614"><a href="#cb87-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-615"><a href="#cb87-615" aria-hidden="true" tabindex="-1"></a><span class="do">## With control</span></span>
<span id="cb87-616"><a href="#cb87-616" aria-hidden="true" tabindex="-1"></a>power_with_ctrl <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">replicate</span>(B, {</span>
<span id="cb87-617"><a href="#cb87-617" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n); z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-618"><a href="#cb87-618" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> beta_x <span class="sc">*</span> x <span class="sc">+</span> beta_z <span class="sc">*</span> z <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb87-619"><a href="#cb87-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb87-620"><a href="#cb87-620" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb87-621"><a href="#cb87-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-622"><a href="#cb87-622" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Power without control:"</span>, <span class="fu">round</span>(power_no_ctrl, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-623"><a href="#cb87-623" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Power with control:   "</span>, <span class="fu">round</span>(power_with_ctrl, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-624"><a href="#cb87-624" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Residual SD without z:"</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(beta_z<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-625"><a href="#cb87-625" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Residual SD with z:   "</span>, <span class="fu">round</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-626"><a href="#cb87-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-627"><a href="#cb87-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-628"><a href="#cb87-628" aria-hidden="true" tabindex="-1"></a>The control cuts the residual standard deviation roughly in half, dramatically increasing power. This is why pre-treatment covariates help in experiments even though they are unnecessary for unbiasedness.</span>
<span id="cb87-629"><a href="#cb87-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-630"><a href="#cb87-630" aria-hidden="true" tabindex="-1"></a><span class="fu">### Joint tests have less power</span></span>
<span id="cb87-631"><a href="#cb87-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-632"><a href="#cb87-632" aria-hidden="true" tabindex="-1"></a>Testing more restrictions simultaneously dilutes power. Fix the total non-centrality parameter and compare:</span>
<span id="cb87-633"><a href="#cb87-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-636"><a href="#cb87-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-637"><a href="#cb87-637" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: joint-test-power</span></span>
<span id="cb87-638"><a href="#cb87-638" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb87-639"><a href="#cb87-639" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb87-640"><a href="#cb87-640" aria-hidden="true" tabindex="-1"></a>lambda_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">15</span>, <span class="at">by =</span> <span class="fl">0.1</span>)</span>
<span id="cb87-641"><a href="#cb87-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-642"><a href="#cb87-642" aria-hidden="true" tabindex="-1"></a>df_joint <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="cf">function</span>(q) {</span>
<span id="cb87-643"><a href="#cb87-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb87-644"><a href="#cb87-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> lambda_seq,</span>
<span id="cb87-645"><a href="#cb87-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">power =</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(<span class="fu">qchisq</span>(<span class="fl">0.95</span>, q), q, <span class="at">ncp =</span> lambda_seq),</span>
<span id="cb87-646"><a href="#cb87-646" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="fu">paste0</span>(<span class="st">"q = "</span>, q)</span>
<span id="cb87-647"><a href="#cb87-647" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb87-648"><a href="#cb87-648" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb87-649"><a href="#cb87-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-650"><a href="#cb87-650" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_joint, <span class="fu">aes</span>(lambda, power, <span class="at">color =</span> q)) <span class="sc">+</span></span>
<span id="cb87-651"><a href="#cb87-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb87-652"><a href="#cb87-652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.80</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb87-653"><a href="#cb87-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb87-654"><a href="#cb87-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Power vs. non-centrality for joint tests"</span>,</span>
<span id="cb87-655"><a href="#cb87-655" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"More restrictions require a larger signal to achieve the same power"</span>,</span>
<span id="cb87-656"><a href="#cb87-656" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"Non-centrality parameter "</span>, lambda)),</span>
<span id="cb87-657"><a href="#cb87-657" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Power"</span>, <span class="at">color =</span> <span class="st">"Restrictions"</span>)</span>
<span id="cb87-658"><a href="#cb87-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-659"><a href="#cb87-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-660"><a href="#cb87-660" aria-hidden="true" tabindex="-1"></a>A single-coefficient t-test is more powerful than a joint F-test that lumps in other restrictions. Test exactly what you care about.</span>
<span id="cb87-661"><a href="#cb87-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-662"><a href="#cb87-662" aria-hidden="true" tabindex="-1"></a><span class="fu">## Statistical vs. economic significance</span></span>
<span id="cb87-663"><a href="#cb87-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-664"><a href="#cb87-664" aria-hidden="true" tabindex="-1"></a>With a large enough sample, *any* nonzero coefficient becomes statistically significant. This is test consistency: $P<span class="co">[</span><span class="ot">\text{Reject}</span><span class="co">]</span> \to 1$ whenever $\beta \neq 0$.</span>
<span id="cb87-665"><a href="#cb87-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-668"><a href="#cb87-668" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-669"><a href="#cb87-669" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: stat-vs-econ</span></span>
<span id="cb87-670"><a href="#cb87-670" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb87-671"><a href="#cb87-671" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 4</span></span>
<span id="cb87-672"><a href="#cb87-672" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">77</span>)</span>
<span id="cb87-673"><a href="#cb87-673" aria-hidden="true" tabindex="-1"></a>true_beta <span class="ot">&lt;-</span> <span class="fl">0.01</span>   <span class="co"># tiny effect</span></span>
<span id="cb87-674"><a href="#cb87-674" aria-hidden="true" tabindex="-1"></a>n_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">1000</span>, <span class="dv">5000</span>, <span class="dv">20000</span>)</span>
<span id="cb87-675"><a href="#cb87-675" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb87-676"><a href="#cb87-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-677"><a href="#cb87-677" aria-hidden="true" tabindex="-1"></a>rejection_rate <span class="ot">&lt;-</span> <span class="fu">sapply</span>(n_vals, <span class="cf">function</span>(nn) {</span>
<span id="cb87-678"><a href="#cb87-678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">replicate</span>(B, {</span>
<span id="cb87-679"><a href="#cb87-679" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nn)</span>
<span id="cb87-680"><a href="#cb87-680" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> true_beta <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(nn)</span>
<span id="cb87-681"><a href="#cb87-681" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(<span class="fu">lm</span>(y <span class="sc">~</span> x))<span class="sc">$</span>coefficients[<span class="st">"x"</span>, <span class="st">"Pr(&gt;|t|)"</span>] <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb87-682"><a href="#cb87-682" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb87-683"><a href="#cb87-683" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-684"><a href="#cb87-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-685"><a href="#cb87-685" aria-hidden="true" tabindex="-1"></a>df_consist <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">n =</span> n_vals, <span class="at">rejection_rate =</span> rejection_rate)</span>
<span id="cb87-686"><a href="#cb87-686" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_consist, <span class="fu">aes</span>(n, rejection_rate)) <span class="sc">+</span></span>
<span id="cb87-687"><a href="#cb87-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb87-688"><a href="#cb87-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb87-689"><a href="#cb87-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.05</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"coral"</span>) <span class="sc">+</span></span>
<span id="cb87-690"><a href="#cb87-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb87-691"><a href="#cb87-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Test consistency: even β = 0.01 gets rejected eventually"</span>,</span>
<span id="cb87-692"><a href="#cb87-692" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"With enough data, statistical significance is guaranteed for any nonzero effect"</span>,</span>
<span id="cb87-693"><a href="#cb87-693" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Sample size (log scale)"</span>, <span class="at">y =</span> <span class="st">"Rejection rate at α = 0.05"</span>)</span>
<span id="cb87-694"><a href="#cb87-694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-695"><a href="#cb87-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-696"><a href="#cb87-696" aria-hidden="true" tabindex="-1"></a>A $p$-value tells you whether the data are inconsistent with $H_0$. It tells you nothing about whether the effect is large enough to matter. Always report the **magnitude** alongside the significance.</span>
<span id="cb87-697"><a href="#cb87-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-698"><a href="#cb87-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-699"><a href="#cb87-699" aria-hidden="true" tabindex="-1"></a><span class="fu">## Applied workflow: the salary example</span></span>
<span id="cb87-700"><a href="#cb87-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-701"><a href="#cb87-701" aria-hidden="true" tabindex="-1"></a>Let's bring everything together with a thorough analysis of the professor salary data.</span>
<span id="cb87-702"><a href="#cb87-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-703"><a href="#cb87-703" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 1: Fit and inspect</span></span>
<span id="cb87-704"><a href="#cb87-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-707"><a href="#cb87-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-708"><a href="#cb87-708" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-full</span></span>
<span id="cb87-709"><a href="#cb87-709" aria-hidden="true" tabindex="-1"></a>mod_full <span class="ot">&lt;-</span> <span class="fu">lm</span>(salary <span class="sc">~</span> rank <span class="sc">+</span> discipline <span class="sc">+</span> yrs.since.phd <span class="sc">+</span> yrs.service <span class="sc">+</span> sex,</span>
<span id="cb87-710"><a href="#cb87-710" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> Salaries)</span>
<span id="cb87-711"><a href="#cb87-711" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(mod_full, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-712"><a href="#cb87-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-713"><a href="#cb87-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-714"><a href="#cb87-714" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 2: Key hypotheses</span></span>
<span id="cb87-715"><a href="#cb87-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-716"><a href="#cb87-716" aria-hidden="true" tabindex="-1"></a>**Does rank matter?** (joint test, $q = 2$)</span>
<span id="cb87-717"><a href="#cb87-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-720"><a href="#cb87-720" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-721"><a href="#cb87-721" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-rank-test</span></span>
<span id="cb87-722"><a href="#cb87-722" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod_full, <span class="fu">c</span>(<span class="st">"rankAssocProf = 0"</span>, <span class="st">"rankProf = 0"</span>),</span>
<span id="cb87-723"><a href="#cb87-723" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-724"><a href="#cb87-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-725"><a href="#cb87-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-726"><a href="#cb87-726" aria-hidden="true" tabindex="-1"></a>**Does discipline matter?** (single restriction)</span>
<span id="cb87-727"><a href="#cb87-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-730"><a href="#cb87-730" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-731"><a href="#cb87-731" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-discipline-test</span></span>
<span id="cb87-732"><a href="#cb87-732" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod_full, <span class="st">"disciplineB = 0"</span>,</span>
<span id="cb87-733"><a href="#cb87-733" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-734"><a href="#cb87-734" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-735"><a href="#cb87-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-736"><a href="#cb87-736" aria-hidden="true" tabindex="-1"></a>**Are the two experience measures interchangeable?** ($\beta_{\text{phd}} = \beta_{\text{svc}}$)</span>
<span id="cb87-737"><a href="#cb87-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-740"><a href="#cb87-740" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-741"><a href="#cb87-741" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-experience-test</span></span>
<span id="cb87-742"><a href="#cb87-742" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(mod_full, <span class="st">"yrs.since.phd = yrs.service"</span>,</span>
<span id="cb87-743"><a href="#cb87-743" aria-hidden="true" tabindex="-1"></a>                 <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-744"><a href="#cb87-744" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-745"><a href="#cb87-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-746"><a href="#cb87-746" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 3: Confidence intervals</span></span>
<span id="cb87-747"><a href="#cb87-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-750"><a href="#cb87-750" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-751"><a href="#cb87-751" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-ci</span></span>
<span id="cb87-752"><a href="#cb87-752" aria-hidden="true" tabindex="-1"></a><span class="do">## Robust CIs</span></span>
<span id="cb87-753"><a href="#cb87-753" aria-hidden="true" tabindex="-1"></a>ci_robust <span class="ot">&lt;-</span> <span class="fu">coefci</span>(mod_full, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb87-754"><a href="#cb87-754" aria-hidden="true" tabindex="-1"></a>ci_robust</span>
<span id="cb87-755"><a href="#cb87-755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-756"><a href="#cb87-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-757"><a href="#cb87-757" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 4: Multiple testing adjustment</span></span>
<span id="cb87-758"><a href="#cb87-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-759"><a href="#cb87-759" aria-hidden="true" tabindex="-1"></a>If we're testing all six regressors simultaneously:</span>
<span id="cb87-760"><a href="#cb87-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-763"><a href="#cb87-763" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-764"><a href="#cb87-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-multiple</span></span>
<span id="cb87-765"><a href="#cb87-765" aria-hidden="true" tabindex="-1"></a>pvals_all <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(mod_full, <span class="at">vcov. =</span> <span class="fu">vcovHC</span>(mod_full, <span class="at">type =</span> <span class="st">"HC1"</span>))[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">4</span>]</span>
<span id="cb87-766"><a href="#cb87-766" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb87-767"><a href="#cb87-767" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw_p =</span> <span class="fu">round</span>(pvals_all, <span class="dv">4</span>),</span>
<span id="cb87-768"><a href="#cb87-768" aria-hidden="true" tabindex="-1"></a>  <span class="at">holm_p =</span> <span class="fu">round</span>(<span class="fu">p.adjust</span>(pvals_all, <span class="at">method =</span> <span class="st">"holm"</span>), <span class="dv">4</span>),</span>
<span id="cb87-769"><a href="#cb87-769" aria-hidden="true" tabindex="-1"></a>  <span class="at">significant_raw =</span> <span class="fu">ifelse</span>(pvals_all <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>),</span>
<span id="cb87-770"><a href="#cb87-770" aria-hidden="true" tabindex="-1"></a>  <span class="at">significant_holm =</span> <span class="fu">ifelse</span>(<span class="fu">p.adjust</span>(pvals_all, <span class="at">method =</span> <span class="st">"holm"</span>) <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"*"</span>, <span class="st">""</span>)</span>
<span id="cb87-771"><a href="#cb87-771" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-772"><a href="#cb87-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-773"><a href="#cb87-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-774"><a href="#cb87-774" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 5: Power assessment for the gender gap</span></span>
<span id="cb87-775"><a href="#cb87-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-776"><a href="#cb87-776" aria-hidden="true" tabindex="-1"></a>Suppose the "true" gender gap is \$5,000 (about 5% of mean salary). Could we detect it?</span>
<span id="cb87-777"><a href="#cb87-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-780"><a href="#cb87-780" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb87-781"><a href="#cb87-781" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: salary-power</span></span>
<span id="cb87-782"><a href="#cb87-782" aria-hidden="true" tabindex="-1"></a>sigma_e <span class="ot">&lt;-</span> <span class="fu">sigma</span>(mod_full)</span>
<span id="cb87-783"><a href="#cb87-783" aria-hidden="true" tabindex="-1"></a>sd_sex <span class="ot">&lt;-</span> <span class="fu">sd</span>(<span class="fu">as.numeric</span>(Salaries<span class="sc">$</span>sex <span class="sc">==</span> <span class="st">"Male"</span>))</span>
<span id="cb87-784"><a href="#cb87-784" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Salaries)</span>
<span id="cb87-785"><a href="#cb87-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-786"><a href="#cb87-786" aria-hidden="true" tabindex="-1"></a>power_sex <span class="ot">&lt;-</span> <span class="fu">power_ols</span>(<span class="at">effect =</span> <span class="dv">5000</span>, <span class="at">sigma_e =</span> sigma_e,</span>
<span id="cb87-787"><a href="#cb87-787" aria-hidden="true" tabindex="-1"></a>                       <span class="at">sd_x =</span> sd_sex, <span class="at">n =</span> n, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb87-788"><a href="#cb87-788" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated power to detect a $5,000 gender gap:"</span>, <span class="fu">round</span>(power_sex, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-789"><a href="#cb87-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-790"><a href="#cb87-790" aria-hidden="true" tabindex="-1"></a><span class="do">## What sample size for 80% power?</span></span>
<span id="cb87-791"><a href="#cb87-791" aria-hidden="true" tabindex="-1"></a>n_needed <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">5000</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb87-792"><a href="#cb87-792" aria-hidden="true" tabindex="-1"></a>pow_curve <span class="ot">&lt;-</span> <span class="fu">sapply</span>(n_needed, <span class="cf">function</span>(nn)</span>
<span id="cb87-793"><a href="#cb87-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">power_ols</span>(<span class="dv">5000</span>, sigma_e, sd_sex, nn, <span class="fl">0.05</span>))</span>
<span id="cb87-794"><a href="#cb87-794" aria-hidden="true" tabindex="-1"></a>n80 <span class="ot">&lt;-</span> n_needed[<span class="fu">which</span>(pow_curve <span class="sc">&gt;=</span> <span class="fl">0.80</span>)[<span class="dv">1</span>]]</span>
<span id="cb87-795"><a href="#cb87-795" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size for 80% power:"</span>, n80, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb87-796"><a href="#cb87-796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb87-797"><a href="#cb87-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-798"><a href="#cb87-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-799"><a href="#cb87-799" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical advice (after Hansen)</span></span>
<span id="cb87-800"><a href="#cb87-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-801"><a href="#cb87-801" aria-hidden="true" tabindex="-1"></a>A checklist for reporting regression results:</span>
<span id="cb87-802"><a href="#cb87-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-803"><a href="#cb87-803" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Report standard errors, not just t-ratios.** Standard errors convey precision; t-statistics reduce everything to a binary yes/no.</span>
<span id="cb87-804"><a href="#cb87-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-805"><a href="#cb87-805" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Report p-values, not asterisks.** The difference between $p = 0.049$ and $p = 0.051$ is not meaningful. Stars obscure this.</span>
<span id="cb87-806"><a href="#cb87-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-807"><a href="#cb87-807" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Focus on substantive hypotheses.** Don't mechanically test every coefficient against zero. Test things that answer a scientific question.</span>
<span id="cb87-808"><a href="#cb87-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-809"><a href="#cb87-809" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**"Fail to reject" $\neq$ "accept."** Low power can explain non-rejection. Always ask: could we have detected a meaningful effect?</span>
<span id="cb87-810"><a href="#cb87-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-811"><a href="#cb87-811" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Statistical significance $\neq$ economic significance.** A tiny but significant coefficient may be policy-irrelevant. A large but insignificant coefficient may reflect low power.</span>
<span id="cb87-812"><a href="#cb87-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-813"><a href="#cb87-813" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Use robust inference by default.** There is rarely a good reason to report classical SEs when $n$ is not tiny. Use HC1/HC2 or the bootstrap.</span>
<span id="cb87-814"><a href="#cb87-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-815"><a href="#cb87-815" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Account for multiple testing.** If you report the "most significant" result from many tests, apply Holm or Bonferroni corrections.</span>
<span id="cb87-816"><a href="#cb87-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-817"><a href="#cb87-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-818"><a href="#cb87-818" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connection to GMM</span></span>
<span id="cb87-819"><a href="#cb87-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-820"><a href="#cb87-820" aria-hidden="true" tabindex="-1"></a>The Wald test has a natural GMM interpretation. In GMM, testing $H_0: \mathbf{R}\boldsymbol{\beta} = \mathbf{r}$ is equivalent to testing whether the restricted moment conditions $E<span class="co">[</span><span class="ot">\mathbf{Z}'(Y - \mathbf{X}\boldsymbol{\beta})</span><span class="co">]</span> = \mathbf{0}$ with $\mathbf{R}\boldsymbol{\beta} = \mathbf{r}$ are compatible with the data. The J-test of overidentifying restrictions, which we'll meet in Chapter 11, generalizes the F-test to the setting where there are more moment conditions than parameters.</span>
<span id="cb87-821"><a href="#cb87-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-822"><a href="#cb87-822" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> OLS test <span class="pp">|</span> GMM counterpart <span class="pp">|</span></span>
<span id="cb87-823"><a href="#cb87-823" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------|-----------------|</span></span>
<span id="cb87-824"><a href="#cb87-824" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> F-test (restricted vs. unrestricted) <span class="pp">|</span> Distance test (restricted vs. unrestricted GMM) <span class="pp">|</span></span>
<span id="cb87-825"><a href="#cb87-825" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Wald test <span class="pp">|</span> Wald test (same formula, different $\hat{\mathbf{V}}$) <span class="pp">|</span></span>
<span id="cb87-826"><a href="#cb87-826" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Score / LM test <span class="pp">|</span> Score test from restricted GMM <span class="pp">|</span></span>
<span id="cb87-827"><a href="#cb87-827" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Overall F-statistic <span class="pp">|</span> J-test of overidentifying restrictions <span class="pp">|</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>